<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ÎÇòÏùò Ïö¥Îèô Í∏∞Î°ù v17 (Í∏∞Îä• Í∞úÏÑ† ÏôÑÎ£å)</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.0.3/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="exercises.js" defer></script>

    <style>
        body, html { margin:0; padding:0; height:100%; }
        body { 
            overflow-y:auto; 
            scroll-behavior: smooth; 
            background-color: #f7fafc; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
            font-size: 1.05em; /* Ï†ÑÏ≤¥Ï†ÅÏù∏ Í∏ÄÏî® ÌÅ¨Í∏∞ Ï¶ùÍ∞Ä */
        }
        .card { padding:24px; border-radius:12px; background:white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        #calendar { display:grid; grid-template-columns: repeat(7,1fr); gap:10px; }
        .calendar-day { text-align:center; padding:12px 5px; border:1px solid #e2e8f0; border-radius:8px;
            cursor:pointer; transition: all 0.2s; min-height:95px; display:flex; flex-direction:column; justify-content:space-between;
        }
        .calendar-day:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .calendar-day.selected { background:#4299e1; color:white; font-weight:700; border-color: #4299e1; }
        .calendar-day.has-log { border-bottom:4px solid #63b3ed; }
        .calendar-day.today { box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5) inset; }
        .calendar-day.future { color: #cbd5e0; pointer-events: none; background-color: #f7fafc; }
        .day-number { font-size:1.1rem; font-weight:700; }
        .day-volume { font-size:0.85rem; color:#4a5568; font-weight:600; }
        .calendar-day.selected .day-volume { color:white; }

        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center;
            padding:1rem; visibility:hidden; opacity:0; transition: all 0.2s ease-in-out; z-index:50;
        }
        .modal-overlay.open { visibility:visible; opacity:1; }
        .modal-content { background:white; border-radius:12px; padding: 24px; width:100%; max-width:720px; max-height:90vh; overflow:auto; box-shadow:0 25px 50px -12px rgba(0,0,0,0.25); }
        
        #workout-session-modal { z-index: 50; }
        #add-to-session-modal, #custom-confirm-modal, #pr-celebration-modal { z-index: 60; }

        #workout-session-modal .modal-content { padding: 0; max-width: 900px; height: 80vh; max-height: 700px; overflow: hidden; }

        .text-btn, .icon-btn { background:none; border:none; cursor:pointer; padding:4px; transition: all 0.2s; }
        .icon-btn:hover { transform: scale(1.1); }
        .text-btn { font-size: 0.9rem; font-weight: 600; color: #4a5568; }
        .stats-selector-btn { padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; background-color:#edf2f7; transition: all 0.2s;}
        .stats-selector-btn.active { background:#4299e1; color:white; }
        
        .summary-item { display:flex; gap:12px; align-items:center; }
        .summary-item img { width:64px; height:64px; object-fit:cover; border-radius:8px; background:#edf2f7; }
        
        .session-set-input { width: 70px; text-align: center; border: 1px solid #cbd5e0; border-radius: 6px; padding: 6px; font-size: 1.05rem; transition: all 0.2s; }
        .session-set-input:focus { border-color: #4299e1; box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5); outline: none; }
        
        #floating-timer { position: fixed; top: 80px; left: 20px; z-index: 100; transition: transform 0.1s; user-select: none;}
        #floating-timer.dragging { transition: none; }

        .warmup-set-text { color: #3b82f6; font-weight: 600; }
        
        .session-action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 80px; /* ÌÅ¨Í∏∞ Í≥†Ï†ï */
            height: 44px; /* ÌÅ¨Í∏∞ Í≥†Ï†ï */
            padding: 0 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            font-size: 1rem;
        }

        .add-warmup-btn {
            color: #3b82f6;
            background-color: transparent;
            border: 1px solid #3b82f6;
        }
        .add-warmup-btn:hover {
             background-color: rgba(59, 130, 246, 0.1);
        }
        
        .delete-warmup-btn {
            background-color: #ef4444; /* red-500 */
            color: white;
            font-size: 1.5rem; /* X ÏïÑÏù¥ÏΩò ÌÅ¨Í∏∞ */
        }
         .delete-warmup-btn:hover {
            background-color: #dc2626; /* red-600 */
        }
        
        .timer-adjust-btn {
            background-color: #e5e7eb; /* gray-200 */
            color: #4b5563; /* gray-600 */
            border-radius: 9999px; /* fully rounded */
            width: 36px;
            height: 36px;
            font-size: 1.25rem;
            font-weight: bold;
        }
        .timer-adjust-btn:hover {
             background-color: #d1d5db; /* gray-300 */
        }


        @media (max-width: 768px) {
            body { font-size: 1em; } /* Î™®Î∞îÏùºÏóêÏÑúÎäî Í∏∞Î≥∏ Ìè∞Ìä∏ ÌÅ¨Í∏∞ Ïú†ÏßÄ */
            .modal-content { max-width: 95%; padding:16px; }
            #workout-session-modal .modal-content { flex-direction: column; padding:0; }
            #workout-session-modal .timer-panel { width: 100%; border-right: none; border-bottom: 1px solid #e2e8f0; }
            #workout-session-modal .workout-panel { width: 100%; }
        }
    </style>
</head>
<body>
    <header class="bg-blue-500 text-white p-4 relative text-center shadow-md">
        <button id="back-to-main-btn" class="absolute left-4 top-1/2 transform -translate-y-1/2 bg-white text-blue-500 px-3 py-1 rounded-md shadow-sm hover:bg-gray-100 transition">‚Üê Îí§Î°úÍ∞ÄÍ∏∞</button>
        <h1 class="text-3xl font-semibold">ÎÇòÏùò Ïö¥Îèô Í∏∞Î°ù</h1>
    </header>

    <div id="floating-timer" class="hidden cursor-pointer">
        <div class="relative w-24 h-24">
            <svg class="w-full h-full" viewBox="0 0 100 100">
                <circle class="text-gray-200" stroke-width="8" stroke="currentColor" fill="transparent" r="42" cx="50" cy="50"/>
                <circle id="floating-timer-progress" class="text-blue-500" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="42" cx="50" cy="50" style="transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dashoffset 1s linear;"/>
            </svg>
            <div id="floating-timer-display" class="absolute inset-0 flex items-center justify-center font-mono font-bold text-2xl text-gray-800"></div>
            <button id="close-floating-timer" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full h-6 w-6 flex items-center justify-center font-bold text-sm shadow-md">&times;</button>
        </div>
    </div>
    
    <main class="max-w-7xl mx-auto px-4 mt-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2">
            <section class="card">
                <div class="flex items-center justify-between mb-4 gap-4">
                    <div class="flex items-center gap-2">
                        <button id="prev-month-btn" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition text-lg">‚Äπ</button>
                        <h3 id="calendar-title" class="text-2xl font-bold w-48 text-center"></h3>
                        <button id="next-month-btn" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition text-lg">‚Ä∫</button>
                    </div>
                    <div class="flex items-center gap-2 bg-gray-100 p-1 rounded-lg">
                        <button id="today-btn" class="px-4 py-1.5 bg-white rounded-md shadow-sm text-blue-600 font-semibold hover:bg-gray-50 transition">Ïò§Îäò</button>
                        <button id="date-search-btn" class="p-2 bg-white rounded-md shadow-sm hover:bg-gray-50 transition text-lg">üìÖ</button>
                        <input id="date-search-input" type="date" class="absolute opacity-0 -z-10 w-0 h-0">
                    </div>
                </div>
                <div class="grid grid-cols-7 text-center font-bold mb-2 text-gray-500">
                    <span>Ïùº</span><span>Ïõî</span><span>Ìôî</span><span>Ïàò</span><span>Î™©</span><span>Í∏à</span><span>ÌÜ†</span>
                </div>
                <div id="calendar"></div>
            </section>
        </div>
        <div class="space-y-6">
            <section class="card">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xl font-bold">üóíÔ∏è ÎÇòÏùò Î£®Ìã¥</h3>
                    <button id="open-stats-modal-btn" class="bg-gray-100 px-3 py-1 rounded-md font-semibold hover:bg-gray-200 transition">üìä ÌÜµÍ≥Ñ</button>
                </div>
                <div id="routine-template-list" class="space-y-3"></div>
                <button id="create-new-template-btn" class="mt-4 w-full bg-gray-200 hover:bg-gray-300 p-3 rounded-lg font-bold transition">+ ÏÉà Î£®Ìã¥ ÎßåÎì§Í∏∞</button>
            </section>
        </div>
    </main>

    <!-- Modals -->
    <div id="daily-log-modal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="daily-log-modal-title" class="text-2xl font-bold"></h3>
                <button class="close-modal-btn text-2xl">&times;</button>
            </div>
            <div id="daily-log-modal-list" class="space-y-4"></div>
        </div>
    </div>
    
    <div id="pr-celebration-modal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content text-center">
            <h2 class="text-3xl font-bold mb-2">üéâ PR Îã¨ÏÑ±! üéâ</h2>
            <p class="text-gray-600 mb-4">ÏÉàÎ°úÏö¥ 1RM Í∏∞Î°ùÏùÑ Ï∂ïÌïòÌï©ÎãàÎã§!</p>
            <div id="pr-list" class="space-y-2 text-left bg-gray-50 p-4 rounded-lg"></div>
            <button id="close-pr-modal" class="mt-5 w-full bg-blue-500 text-white p-3 rounded-lg">ÌôïÏù∏</button>
        </div>
    </div>

    <div id="template-editor-modal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="template-modal-title" class="text-2xl font-bold"></h3>
                <button class="close-modal-btn text-2xl">&times;</button>
            </div>
            <input id="template-title-input" class="w-full p-3 border rounded-md mb-4" placeholder="Î£®Ìã¥ Ïù¥Î¶Ñ (ÎπÑÏõåÎëêÎ©¥ ÏûêÎèô ÏÉùÏÑ±)" />
            <div class="flex justify-between items-center mb-2">
                <h4 class="font-bold">Ïö¥Îèô Ï∂îÍ∞Ä</h4>
                <button id="open-add-exercise-modal-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md transition">+ ÏÉà Ïö¥Îèô ÎßåÎì§Í∏∞</button>
            </div>
            <div class="bg-gray-100 p-3 rounded-md mb-4 grid grid-cols-2 gap-3">
                <select id="exercise-category-select" class="p-2 border rounded-md"></select>
                <select id="exercise-list-select" class="p-2 border rounded-md"></select>
            </div>
            <div class="grid grid-cols-3 gap-3 my-4">
                <input id="template-weight-input" type="number" placeholder="Î¨¥Í≤å(kg)" class="p-2 border rounded-md" />
                <input id="template-reps-input" type="number" placeholder="ÌöüÏàò" class="p-2 border rounded-md" />
                <input id="template-sets-input" type="number" placeholder="ÏÑ∏Ìä∏" class="p-2 border rounded-md" />
            </div>
            <button id="add-update-exercise-btn" class="w-full bg-gray-700 hover:bg-gray-800 text-white p-3 rounded-lg mb-4 transition">Ïö¥Îèô Ï∂îÍ∞Ä</button>
            <h4 class="font-bold mb-2">ÌòÑÏû¨ Î£®Ìã¥ Î™©Î°ù</h4>
            <div id="template-exercise-list" class="flex-col space-y-2 max-h-56 overflow-y-auto border-t pt-3"></div>
            <div class="mt-5 flex gap-3">
                <button id="save-template-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-lg font-semibold transition">ÌÖúÌîåÎ¶ø Ï†ÄÏû•</button>
            </div>
        </div>
    </div>
    
    <div id="add-to-session-modal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content" style="max-width: 500px;">
             <div class="flex justify-between items-center mb-4">
                <h3 id="add-to-session-modal-title" class="text-xl font-bold">ÏÑ∏ÏÖòÏóê Ïö¥Îèô Ï∂îÍ∞Ä</h3>
                <button class="close-modal-btn text-2xl">&times;</button>
            </div>
            <div class="bg-gray-100 p-3 rounded-md mb-4 grid grid-cols-2 gap-3">
                <select id="session-ex-category-select" class="p-2 border rounded-md"></select>
                <select id="session-ex-list-select" class="p-2 border rounded-md"></select>
            </div>
            <div class="grid grid-cols-3 gap-3 my-4">
                <input id="session-weight-input" type="number" placeholder="Î¨¥Í≤å(kg)" class="p-2 border rounded-md" />
                <input id="session-reps-input" type="number" placeholder="ÌöüÏàò" class="p-2 border rounded-md" />
                <input id="session-sets-input" type="number" placeholder="ÏÑ∏Ìä∏" class="p-2 border rounded-md" />
            </div>
            <button id="save-to-session-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-lg transition">Ï∂îÍ∞Ä</button>
        </div>
    </div>

    <div id="add-exercise-modal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">ÏÉà Ïö¥Îèô ÎßåÎì§Í∏∞</h3>
                <button class="close-modal-btn text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block font-bold mb-1">Ïö¥Îèô Î∂ÄÏúÑ</label>
                    <select id="new-exercise-part" class="w-full p-2 border rounded-md"></select>
                </div>
                <div>
                    <label class="block font-bold mb-1">Ïö¥Îèô Ïù¥Î¶Ñ</label>
                    <input id="new-exercise-name" class="w-full p-2 border rounded-md" placeholder="Ïòà: ÎÇòÎßåÏùò Î≤§ÏπòÌîÑÎ†àÏä§" />
                </div>
            </div>
            <div class="flex gap-3 mt-5">
                <button id="save-new-exercise-btn" class="w-1/2 bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-lg transition">Ï†ÄÏû•</button>
                <button id="cancel-add-exercise-btn" class="w-1/2 bg-gray-300 hover:bg-gray-400 p-3 rounded-lg transition">Ï∑®ÏÜå</button>
            </div>
        </div>
    </div>

    <div id="summary-modal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Ïò§ÎäòÏùò Ïö¥Îèô ÏöîÏïΩ</h3>
                <button class="close-modal-btn text-2xl">&times;</button>
            </div>
            <div id="summary-content" class="space-y-3"></div>
            <button id="close-summary-btn" class="w-full mt-4 bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-lg transition">ÌôïÏù∏</button>
        </div>
    </div>
    
    <div id="stats-modal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Ïö¥Îèô ÌÜµÍ≥Ñ</h3>
                <div class="flex items-center gap-2">
                    <input type="date" id="stats-start-date" class="p-1.5 border rounded-md">
                    <span>~</span>
                    <input type="date" id="stats-end-date" class="p-1.5 border rounded-md">
                    <button id="stats-reset-btn" class="p-2 rounded-md hover:bg-gray-200 transition">üîÑ</button>
                </div>
                 <button class="close-modal-btn text-2xl">&times;</button>
            </div>
            <div class="mb-4">
                <label class="font-bold block mb-2">1. Î∂ÄÏúÑ ÏÑ†ÌÉù</label>
                <div id="stats-part-selector" class="flex flex-wrap gap-2"></div>
            </div>
            <div class="mb-4">
                <label class="font-bold block mb-2">2. Ï¢ÖÎ™© ÏÑ†ÌÉù (ÏÑ†ÌÉù ÏÇ¨Ìï≠)</label>
                <select id="stats-exercise-select" class="w-full p-2 border rounded-md bg-gray-50"></select>
            </div>
            <div style="height:280px">
                <canvas id="stats-chart-canvas"></canvas>
            </div>
        </div>
    </div>

    <div id="custom-confirm-modal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content" style="max-width: 400px;">
            <p id="confirm-message" class="text-xl mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="confirm-ok-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">ÌôïÏù∏</button>
                <button id="confirm-cancel-btn" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded-lg transition">Ï∑®ÏÜå</button>
            </div>
        </div>
    </div>

    <div id="workout-session-modal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content">
            <div class="flex h-full">
                <div class="w-1/3 flex flex-col items-center justify-center p-6 bg-gray-50 rounded-l-lg border-r timer-panel">
                    <p id="timer-digital-display" class="text-6xl font-mono font-bold text-gray-800 mb-4">00:00</p>
                    <div id="analog-clock" class="relative w-48 h-48">
                        <div class="absolute inset-0 border-8 border-gray-200 rounded-full"></div>
                        <div class="absolute inset-2 border-2 border-gray-300 rounded-full"></div>
                        <div id="clock-second-hand" class="absolute bottom-1/2 left-1/2 w-1 h-20 bg-blue-500 rounded-full origin-bottom transform"></div>
                        <div class="absolute top-1/2 left-1/2 w-3 h-3 bg-gray-800 rounded-full -mt-1.5 -ml-1.5"></div>
                    </div>
                    <div class="mt-6 w-full text-center">
                        <label for="timer-input" class="block font-semibold mb-2">Ìú¥Ïãù ÏãúÍ∞Ñ (Ï¥à)</label>
                        <div class="flex items-center justify-center gap-3">
                             <button id="timer-minus-30" class="timer-adjust-btn">-</button>
                             <input id="timer-input" type="number" class="w-24 p-2 text-lg text-center bg-white border rounded-md" value="60" />
                             <button id="timer-plus-30" class="timer-adjust-btn">+</button>
                        </div>
                    </div>
                </div>
                <div class="w-2/3 p-6 flex flex-col workout-panel">
                    <div class="flex justify-between items-start mb-4">
                        <h3 id="workout-session-title" class="text-3xl font-bold"></h3>
                        <button id="hide-session-btn" class="text-3xl font-light -mt-2">&times;</button>
                    </div>
                    <div id="workout-session-list" class="flex-grow space-y-4 overflow-y-auto pr-2"></div>
                    <div class="mt-4 pt-4 border-t flex gap-3">
                        <button id="add-exercise-to-session-btn" class="w-1/3 bg-gray-200 hover:bg-gray-300 p-3 rounded-lg font-semibold transition">Ïö¥Îèô Ï∂îÍ∞Ä</button>
                        <button id="save-session-btn" class="w-2/3 bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-lg font-semibold transition">Ïö¥Îèô ÏôÑÎ£å Î∞è Ï†ÄÏû•</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    const elements = {
        backBtn: document.getElementById('back-to-main-btn'),
        calendarTitle: document.getElementById('calendar-title'),
        calendarBody: document.getElementById('calendar'),
        prevMonthBtn: document.getElementById('prev-month-btn'),
        nextMonthBtn: document.getElementById('next-month-btn'),
        todayBtn: document.getElementById('today-btn'),
        dateSearchBtn: document.getElementById('date-search-btn'),
        dateSearchInput: document.getElementById('date-search-input'),
        routineTemplateList: document.getElementById('routine-template-list'),
        createNewTemplateBtn: document.getElementById('create-new-template-btn'),
        openStatsModalBtn: document.getElementById('open-stats-modal-btn'),
        floatingTimer: document.getElementById('floating-timer'),
        floatingTimerDisplay: document.getElementById('floating-timer-display'),
        floatingTimerProgress: document.getElementById('floating-timer-progress'),
        closeFloatingTimer: document.getElementById('close-floating-timer'),
        dailyLogModal: document.getElementById('daily-log-modal'),
        templateEditorModal: document.getElementById('template-editor-modal'),
        statsModal: document.getElementById('stats-modal'),
        workoutSessionModal: document.getElementById('workout-session-modal'),
        addExerciseModal: document.getElementById('add-exercise-modal'),
        summaryModal: document.getElementById('summary-modal'),
        addToSessionModal: document.getElementById('add-to-session-modal'),
        customConfirmModal: document.getElementById('custom-confirm-modal'),
        prCelebrationModal: document.getElementById('pr-celebration-modal'),
        prList: document.getElementById('pr-list'),
        closePrModal: document.getElementById('close-pr-modal'),
        dailyLogModalTitle: document.getElementById('daily-log-modal-title'),
        dailyLogModalList: document.getElementById('daily-log-modal-list'),
        statsPartSelector: document.getElementById('stats-part-selector'),
        statsExerciseSelect: document.getElementById('stats-exercise-select'),
        statsChartCanvas: document.getElementById('stats-chart-canvas'),
        statsStartDate: document.getElementById('stats-start-date'),
        statsEndDate: document.getElementById('stats-end-date'),
        statsResetBtn: document.getElementById('stats-reset-btn'),
        templateModalTitle: document.getElementById('template-modal-title'),
        templateTitleInput: document.getElementById('template-title-input'),
        templateExerciseList: document.getElementById('template-exercise-list'),
        exerciseCategorySelect: document.getElementById('exercise-category-select'),
        exerciseListSelect: document.getElementById('exercise-list-select'),
        templateWeightInput: document.getElementById('template-weight-input'),
        templateRepsInput: document.getElementById('template-reps-input'),
        templateSetsInput: document.getElementById('template-sets-input'),
        addUpdateExerciseBtn: document.getElementById('add-update-exercise-btn'),
        saveTemplateBtn: document.getElementById('save-template-btn'),
        workoutSessionTitle: document.getElementById('workout-session-title'),
        timerInput: document.getElementById('timer-input'),
        timerMinus30Btn: document.getElementById('timer-minus-30'),
        timerPlus30Btn: document.getElementById('timer-plus-30'),
        timerDigitalDisplay: document.getElementById('timer-digital-display'),
        clockSecondHand: document.getElementById('clock-second-hand'),
        workoutSessionList: document.getElementById('workout-session-list'),
        hideSessionBtn: document.getElementById('hide-session-btn'),
        addExerciseToSessionBtn: document.getElementById('add-exercise-to-session-btn'),
        saveSessionBtn: document.getElementById('save-session-btn'),
        addToSessionModalTitle: document.getElementById('add-to-session-modal-title'),
        sessionExCategorySelect: document.getElementById('session-ex-category-select'),
        sessionExListSelect: document.getElementById('session-ex-list-select'),
        sessionWeightInput: document.getElementById('session-weight-input'),
        sessionRepsInput: document.getElementById('session-reps-input'),
        sessionSetsInput: document.getElementById('session-sets-input'),
        saveToSessionBtn: document.getElementById('save-to-session-btn'),
        openAddExerciseModalBtn: document.getElementById('open-add-exercise-modal-btn'),
        newExercisePart: document.getElementById('new-exercise-part'),
        newExerciseName: document.getElementById('new-exercise-name'),
        saveNewExerciseBtn: document.getElementById('save-new-exercise-btn'),
        cancelAddExerciseBtn: document.getElementById('cancel-add-exercise-btn'),
        summaryContent: document.getElementById('summary-content'),
        closeSummaryBtn: document.getElementById('close-summary-btn'),
        confirmMessage: document.getElementById('confirm-message'),
        confirmOkBtn: document.getElementById('confirm-ok-btn'),
        confirmCancelBtn: document.getElementById('confirm-cancel-btn'),
    };

    const ROUTINE_TEMPLATE_KEY = 'my_fitness_templates_v15';
    const LOG_KEY = 'my_fitness_logs_v18_warmup'; // Key updated for new structure
    const CUSTOM_EXERCISES_KEY = 'my_fitness_custom_exercises_v9';
    const PR_KEY = 'my_fitness_prs_v10_1rm';

    let routineTemplates = [], workoutLogs = {}, customExercises = {}, personalRecords = {}, combinedExercises = {};
    let calendarDate = new Date();
    let selectedDate = new Date().toLocaleDateString('en-CA');
    let statsChart = null, currentEditingTemplate = { id: null, exercises: [] };
    let currentWorkoutSession = { log: null, originalLogIndex: null, originalTemplateExercises: null };
    let currentlyEditingExerciseIndex = null, sessionEditingExIndex = null; 
    let timerInterval = null, clickTimer = null, confirmCallback = null;
    const floatingTimerProgressCircle = elements.floatingTimerProgress;
    const circumference = floatingTimerProgressCircle ? 2 * Math.PI * floatingTimerProgressCircle.r.baseVal.value : 0;

    const BODY_PART_COLORS = {
        "Í∞ÄÏä¥": 'rgba(239, 68, 68, 0.8)',      // red-500
        "Îì±": 'rgba(59, 130, 246, 0.8)',     // blue-500
        "Ïñ¥Íπ®": 'rgba(245, 158, 11, 0.8)',   // amber-500
        "ÌïòÏ≤¥": 'rgba(16, 185, 129, 0.8)',   // green-500
        "Ìåî": 'rgba(139, 92, 246, 0.8)',    // violet-500
        "Î≥µÍ∑º/ÏΩîÏñ¥": 'rgba(249, 115, 22, 0.8)', // orange-500
        "Ï†ÑÏ≤¥": 'rgba(107, 114, 128, 0.8)'   // gray-500
    };
    Chart.register(ChartDataLabels);

    const saveToLocalStorage = (key, data) => localStorage.setItem(key, JSON.stringify(data));
    const loadFromLocalStorage = (key, defaultValue) => { try { return JSON.parse(localStorage.getItem(key)) || defaultValue; } catch { return defaultValue; } };

    const mergeExercises = () => {
        if (typeof exercisesData === 'undefined' || typeof bodyPartImages === 'undefined') return;
        combinedExercises = {};
        Object.keys(exercisesData).forEach(part => {
            combinedExercises[part] = exercisesData[part].map(e => ({ name: e.name, image: e.image || bodyPartImages[part] || '', part }));
        });
        Object.keys(customExercises).forEach(part => {
            if (!combinedExercises[part]) combinedExercises[part] = [];
            combinedExercises[part].push(...customExercises[part].map(e => ({ name: e.name, image: bodyPartImages[part] || '', custom: true, part })));
        });
    };
    
    const getPartForExercise = (exerciseName) => {
        for (const part in combinedExercises) {
            if (combinedExercises[part].some(e => e.name === exerciseName)) {
                return part;
            }
        }
        return "Ï†ÑÏ≤¥";
    }

    const formatDate = (d) => new Date(d).toLocaleDateString('en-CA');
    const openModal = (el) => el?.classList.add('open');
    const closeModal = (el) => el?.classList.remove('open');
    
    const showConfirm = (message, onConfirm) => {
        elements.confirmMessage.textContent = message;
        confirmCallback = onConfirm;
        openModal(elements.customConfirmModal);
    };

    const calculate1RM = (weight, reps) => {
        if (reps <= 0) return 0;
        if (reps === 1) return weight;
        return weight * (1 + reps / 30);
    };

    const checkAndUpdatePRs = (sessionLog) => {
        let newPRs = [];
        sessionLog.sets.forEach(set => {
            if (set.completed && set.reps > 0 && !set.isWarmup) {
                const estimated1RM = calculate1RM(set.weight, set.reps);
                if (!personalRecords[set.name] || estimated1RM > personalRecords[set.name].max1RM) {
                    personalRecords[set.name] = { max1RM: estimated1RM };
                    newPRs.push({ name: set.name, value: estimated1RM });
                }
            }
        });

        if (newPRs.length > 0) {
            saveToLocalStorage(PR_KEY, personalRecords);
            elements.prList.innerHTML = newPRs.map(pr => 
                `<div class="flex justify-between items-center text-lg">
                    <span class="font-bold">${pr.name}</span>
                    <span class="text-blue-500 font-semibold">${pr.value.toFixed(1)}kg (1RM)</span>
                </div>`
            ).join('');
            openModal(elements.prCelebrationModal);
        }
    };

    const updateStatsView = () => {
        const activePartBtn = document.querySelector('#stats-part-selector .active');
        const selectedExercise = elements.statsExerciseSelect.value;
        
        let type = 'Ï†ÑÏ≤¥';
        let value = 'Ï†ÑÏ≤¥';

        if (selectedExercise) {
            type = 'exercise';
            value = selectedExercise;
        } else if (activePartBtn) {
            type = 'part';
            value = activePartBtn.dataset.part;
        }
        
        renderStatsGraph({
            type: type,
            value: value,
            startDate: elements.statsStartDate.value,
            endDate: elements.statsEndDate.value,
        });
    };

    const renderStatsGraph = ({ type, value, startDate = null, endDate = null }) => {
        if (statsChart) statsChart.destroy();

        let relevantDates = Object.keys(workoutLogs).filter(date => {
            return (workoutLogs[date] || []).some(log =>
                (log.sets || []).some(set => {
                    if (!set.completed || set.isWarmup) return false;
                    const part = getPartForExercise(set.name);
                    if (type === 'Ï†ÑÏ≤¥') return true;
                    if (type === 'part') return part === value;
                    if (type === 'exercise') return set.name === value;
                    return false;
                })
            );
        }).sort();

        let datesToProcess;
        if (startDate && endDate) {
            datesToProcess = relevantDates.filter(date => date >= startDate && date <= endDate);
        } else {
            datesToProcess = relevantDates.slice(-10);
        }

        const datasets = [];
        const labels = datesToProcess.map(d => d.substring(5));

        if (type === 'Ï†ÑÏ≤¥') {
            const partVolumes = {};
            datesToProcess.forEach((date, dateIndex) => {
                (workoutLogs[date] || []).forEach(log => {
                    (log.sets || []).forEach(set => {
                        if (set.completed && !set.isWarmup) {
                            const part = getPartForExercise(set.name);
                            if (!partVolumes[part]) {
                                partVolumes[part] = Array(datesToProcess.length).fill(0);
                            }
                            partVolumes[part][dateIndex] += set.weight * set.reps;
                        }
                    });
                });
            });

            Object.keys(partVolumes).forEach(part => {
                if (partVolumes[part].reduce((a, b) => a + b, 0) > 0) {
                    datasets.push({
                        label: part,
                        data: partVolumes[part],
                        backgroundColor: BODY_PART_COLORS[part] || BODY_PART_COLORS['Ï†ÑÏ≤¥'],
                    });
                }
            });
        } else if (type === 'part') {
            const exercisesInPart = combinedExercises[value].map(e => e.name);
            const exerciseVolumes = {};
            datesToProcess.forEach((date, dateIndex) => {
                (workoutLogs[date] || []).forEach(log => {
                    (log.sets || []).forEach(set => {
                        if (set.completed && !set.isWarmup && exercisesInPart.includes(set.name)) {
                            if (!exerciseVolumes[set.name]) {
                                exerciseVolumes[set.name] = Array(datesToProcess.length).fill(0);
                            }
                            exerciseVolumes[set.name][dateIndex] += set.weight * set.reps;
                        }
                    });
                });
            });
            const baseColor = BODY_PART_COLORS[value] || BODY_PART_COLORS['Ï†ÑÏ≤¥'];
            const shades = generateShades(baseColor, Object.keys(exerciseVolumes).length);
            let i = 0;
            Object.keys(exerciseVolumes).forEach(exerciseName => {
                if (exerciseVolumes[exerciseName].reduce((a, b) => a + b, 0) > 0) {
                    datasets.push({
                        label: exerciseName,
                        data: exerciseVolumes[exerciseName],
                        backgroundColor: shades[i++] || baseColor,
                    });
                }
            });
        } else { // 'exercise'
            const data = datesToProcess.map(date => {
                let dailyVol = 0;
                (workoutLogs[date] || []).forEach(log => {
                    (log.sets || []).forEach(set => {
                        if (set.completed && !set.isWarmup && set.name === value) {
                            dailyVol += set.weight * set.reps;
                        }
                    });
                });
                return dailyVol;
            });
            datasets.push({
                label: value,
                data: data,
                backgroundColor: BODY_PART_COLORS[getPartForExercise(value)] || BODY_PART_COLORS['Ï†ÑÏ≤¥'],
            });
        }
        
        statsChart = new Chart(elements.statsChartCanvas, {
            type: 'bar',
            data: { labels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        formatter: (value, context) => {
                             const datasetArray = [];
                             context.chart.data.datasets.forEach((dataset) => {
                                 const val = dataset.data[context.dataIndex];
                                 if(val > 0) datasetArray.push(val);
                             });
                             const total = datasetArray.reduce((a, b) => a + b, 0);
                             if (value === datasetArray[datasetArray.length - 1] && total > 0) { 
                                return `${Math.round(total)}kg`;
                             } else {
                                return '';
                             }
                        },
                        color: '#4a5568',
                        font: { weight: 'bold' }
                    },
                    legend: {
                        display: (type === 'Ï†ÑÏ≤¥' || type === 'part') && datasets.length > 1,
                    }
                },
                scales: {
                    x: { stacked: true },
                    y: { 
                        stacked: true, 
                        beginAtZero: true,
                        grace: '20%'
                    }
                }
            }
        });
    };
    
     const initializeStatsView = () => {
        elements.statsPartSelector.innerHTML = Object.keys(BODY_PART_COLORS).filter(p => p !== 'Ï†ÑÏ≤¥').map(part => `<button class="stats-selector-btn" data-part="${part}">${part}</button>`).join('');
        elements.statsExerciseSelect.innerHTML = '<option value="">-- Î∂ÄÏúÑ Î®ºÏ†Ä ÏÑ†ÌÉù --</option>';
        elements.statsStartDate.value = '';
        elements.statsEndDate.value = '';
        renderStatsGraph({ type: 'Ï†ÑÏ≤¥', value: 'Ï†ÑÏ≤¥' });
    };

    const renderCalendar = () => {
        const year = calendarDate.getFullYear(), month = calendarDate.getMonth();
        elements.calendarTitle.textContent = `${year}ÎÖÑ ${month + 1}Ïõî`;
        elements.calendarBody.innerHTML = '';
        const firstDay = new Date(year, month, 1).getDay(), lastDate = new Date(year, month + 1, 0).getDate();
        const todayStr = formatDate(new Date());

        for (let i = 0; i < firstDay; i++) elements.calendarBody.appendChild(document.createElement('div'));
        for (let d = 1; d <= lastDate; d++) {
            const dateStr = formatDate(new Date(year, month, d));
            const dayEl = document.createElement('div');
            let totalVolume = 0;
            if (workoutLogs[dateStr]?.length > 0) {
                workoutLogs[dateStr].forEach(log => (log.sets || []).forEach(s => { if(s.completed && !s.isWarmup) totalVolume += (s.weight || 0) * (s.reps || 0)}));
            }
            
            let dayClasses = 'calendar-day';
            if(workoutLogs[dateStr]?.length > 0) dayClasses += ' has-log';
            if(dateStr === todayStr) dayClasses += ' today';
            if(dateStr === selectedDate) dayClasses += ' selected';
            if(dateStr > todayStr) dayClasses += ' future';

            dayEl.className = dayClasses;
            dayEl.dataset.date = dateStr;
            dayEl.innerHTML = `<div class="day-number">${d}</div>` + (totalVolume > 0 ? `<div class="day-volume">${totalVolume.toLocaleString()}kg</div>` : '');
            elements.calendarBody.appendChild(dayEl);
        }
    };

    const renderRoutineTemplates = () => {
        elements.routineTemplateList.innerHTML = !routineTemplates?.length ? '<p class="text-gray-500 text-sm">ÌÖúÌîåÎ¶øÏù¥ ÏóÜÏäµÎãàÎã§.</p>' :
            routineTemplates.map(t => `
                <div class="p-4 border rounded-lg mb-2" data-id="${t.id}">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-lg">${t.title}</span>
                        <div class="flex items-center gap-2">
                            <button class="start-routine-btn text-green-500 font-bold hover:text-green-600 transition" data-id="${t.id}">‚ñ∂ ÏãúÏûë</button>
                            <button class="edit-template-btn text-btn hover:text-blue-500 transition" data-id="${t.id}">Ìé∏Ïßë</button>
                            <button class="delete-template-btn text-btn text-red-500 hover:text-red-600 transition" data-id="${t.id}">ÏÇ≠Ï†ú</button>
                        </div>
                    </div>
                    <div class="mt-2 space-y-1 text-gray-600">${t.exercises.map(ex => `<div class="flex justify-between"><span>${ex.name}</span><span>${ex.weight}kg x ${ex.reps}Ìöå x ${ex.sets}ÏÑ∏Ìä∏</span></div>`).join('')}</div>
                </div>
            `).join('');
    };
    
    const openDailyLogModal = (date) => {
        elements.dailyLogModalTitle.textContent = `${date} Ïö¥Îèô Í∏∞Î°ù`;
        const logs = workoutLogs[date] || [];
        elements.dailyLogModalList.innerHTML = logs.length === 0 ? '<p class="text-gray-500">Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</p>' :
            logs.map((log, logIdx) => {
                const exercisesHtml = (log.exercises || []).map((ex, exIdx) => {
                    const setsForExercise = (log.sets || []).filter(s => s.exerciseIndex === exIdx);
                    const setsHtml = setsForExercise.map(s => `
                        <li class="flex justify-between items-center ${s.isWarmup ? 'warmup-set-text' : ''}">
                            <span>
                                <span class="font-bold inline-block w-12">${s.isWarmup ? 'ÏõúÏóÖ' : s.setNumber + 'ÏÑ∏Ìä∏'}</span>
                                ${s.weight}kg √ó ${s.reps}Ìöå
                            </span>
                            <span class="font-bold text-lg ${s.completed ? 'text-green-500' : 'text-gray-300'}">‚úì</span>
                        </li>
                    `).join('');
                    
                    const warmupsDone = setsForExercise.filter(s => s.isWarmup && s.completed).length;
                    
                    return `
                        <div class="mb-3">
                            <h5 class="font-bold text-lg">${ex.name} ${warmupsDone > 0 ? `<span class="text-sm font-normal text-blue-500">(ÏõúÏóÖ ${warmupsDone}ÏÑ∏Ìä∏)</span>` : ''}</h5>
                            <ul class="space-y-1 mt-1 pl-2">${setsHtml}</ul>
                        </div>`;
                }).join('');

                return `
                    <div class="mb-3 pb-3 border-b">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-xl">${log.title}</h4>
                            <div class="flex gap-2">
                                <button class="text-btn text-red-500 delete-log-btn" data-log-index="${logIdx}">ÏÇ≠Ï†ú</button>
                            </div>
                        </div>
                        <div class="mt-2">${exercisesHtml}</div>
                    </div>`;
            }).join('');
        openModal(elements.dailyLogModal);
    };


    const createLogFromTemplate = (template) => {
        const newLog = {
            id: template.id, title: template.title,
            exercises: JSON.parse(JSON.stringify(template.exercises)),
            sets: []
        };
        newLog.exercises.forEach((ex, exIndex) => {
            for (let i = 0; i < ex.sets; i++) {
                newLog.sets.push({
                    name: ex.name, exerciseIndex: exIndex, setNumber: i + 1,
                    weight: ex.weight, reps: ex.reps, completed: false, isWarmup: false
                });
            }
        });
        return newLog;
    }

    const openWorkoutSessionModal = (logTemplate, originalLogIndex = null) => {
        if (currentWorkoutSession.log) {
            showConfirm("ÏßÑÌñâ Ï§ëÏù∏ Ïö¥ÎèôÏù¥ ÏûàÏäµÎãàÎã§. Ïù¥Ïñ¥ÏÑú ÌïòÏãúÍ≤†ÏäµÎãàÍπå?", () => {
                reOpenWorkoutSessionModal();
            });
            return;
        }
        const log = createLogFromTemplate(logTemplate);
        currentWorkoutSession = { 
            log: log, 
            originalLogIndex,
            originalTemplateExercises: JSON.stringify(log.exercises),
        };
        renderWorkoutSession();
        openModal(elements.workoutSessionModal);
    };

    const reOpenWorkoutSessionModal = () => {
        if (currentWorkoutSession.log) {
            elements.floatingTimer.classList.add('hidden');
            openModal(elements.workoutSessionModal);
        }
    };

    const hideWorkoutSessionModal = () => {
        closeModal(elements.workoutSessionModal);
        if (currentWorkoutSession.log) {
            elements.floatingTimer.classList.remove('hidden');
        }
    };

    const cancelWorkoutSession = () => {
        clearInterval(timerInterval);
        currentWorkoutSession = { log: null, originalLogIndex: null, originalTemplateExercises: null };
        elements.floatingTimer.classList.add('hidden');
        elements.timerDigitalDisplay.textContent = '00:00';
        if (elements.clockSecondHand) elements.clockSecondHand.style.transform = 'rotate(0deg)';
        if (floatingTimerProgressCircle) floatingTimerProgressCircle.style.strokeDashoffset = circumference;
    };
    
    const renderWorkoutSession = () => {
        elements.workoutSessionTitle.textContent = currentWorkoutSession.log.title || 'Î£®Ìã¥';
        elements.workoutSessionList.innerHTML = '';
        currentWorkoutSession.log.exercises.forEach((ex, exIndex) => {
            const container = document.createElement('div');
            container.className = 'border-b border-gray-200 pb-4 mb-4';
            container.innerHTML = `<div class="flex justify-between items-center mb-3">
                <p class="text-2xl font-bold text-gray-800">${ex.name}</p>
                <div class="flex items-center gap-2">
                    <button class="complete-all-sets-btn bg-gray-200 hover:bg-gray-300 text-xs px-2 py-1 rounded-md font-semibold transition" data-exercise-index="${exIndex}">Ï†ÑÏ≤¥ ÏôÑÎ£å</button>
                    <button class="icon-btn edit-session-ex-btn" data-exercise-index="${exIndex}">‚úèÔ∏è</button>
                    <button class="icon-btn delete-session-ex-btn text-red-500 font-bold" data-exercise-index="${exIndex}">√ó</button>
                </div>
            </div>`;

            const setsForExercise = currentWorkoutSession.log.sets.filter(s => s.exerciseIndex === exIndex);
            
            // Render warm-up sets first
            setsForExercise.filter(s => s.isWarmup).forEach(set => {
                const setDiv = createSetElement(set, true);
                container.appendChild(setDiv);
            });

            // Render main sets
            const mainSets = setsForExercise.filter(s => !s.isWarmup);
            mainSets.forEach((set, mainSetIndex) => {
                const setDiv = createSetElement(set, false, mainSetIndex === 0, exIndex);
                container.appendChild(setDiv);
            });
            
            elements.workoutSessionList.appendChild(container);
        });
    };

    const createSetElement = (set, isWarmup, isFirstMainSet = false, exerciseIndex = -1) => {
        const setDiv = document.createElement('div');
        setDiv.className = `flex items-center justify-between mb-2 p-2 rounded-lg transition-colors duration-300 ${isWarmup ? 'warmup-set-text' : ''}`;
        const setIndex = currentWorkoutSession.log.sets.indexOf(set);
        
        let actionButtonHtml = '';
        if (isWarmup) {
            actionButtonHtml = `<button class="session-action-btn delete-warmup-btn" data-set-index="${setIndex}">√ó</button>`;
        } else {
             const warmupBtnHtml = isFirstMainSet 
                ? `<button class="session-action-btn add-warmup-btn" data-exercise-index="${exerciseIndex}">ÏõúÏóÖ</button>` 
                : `<div class="w-20"></div>`; // Placeholder to align buttons
            
            actionButtonHtml = `
                ${warmupBtnHtml}
                <button class="session-action-btn ${set.completed ? 'bg-blue-500 text-white' : 'bg-gray-300 hover:bg-gray-400'} set-complete-btn" data-set-index="${setIndex}">‚úì</button>
            `;
        }

        setDiv.innerHTML = `
            <div class="flex items-center gap-3">
                <span class="font-bold text-lg w-12 text-center ${isWarmup ? '' : 'text-gray-500'}">${isWarmup ? 'ÏõúÏóÖ' : `${set.setNumber}`}</span>
                <input type="number" class="session-set-input weight-input" value="${set.weight}" data-set-index="${setIndex}"> <span class="text-gray-600">kg</span>
                <input type="number" class="session-set-input reps-input" value="${set.reps}" data-set-index="${setIndex}"> <span class="text-gray-600">Ìöå</span>
            </div>
            <div class="flex items-center gap-2">
                ${actionButtonHtml}
            </div>
        `;
        return setDiv;
    };
    
    const openWorkoutSummaryModal = (log) => {
        let totalVolume = 0;
        const allExercisesFlat = Object.values(combinedExercises).flat();
        let html = (log.exercises || []).map(ex => {
            let exerciseVolume = 0;
            const completedSets = (log.sets || []).filter(s => s.name === ex.name && s.completed && !s.isWarmup);
            completedSets.forEach(s => exerciseVolume += (s.weight || 0) * (s.reps || 0));
            totalVolume += exerciseVolume;
            const exerciseInfo = allExercisesFlat.find(e => e.name === ex.name);
            return `<div class="summary-item p-2 border-b"><img src="${exerciseInfo?.image || ''}" alt="${ex.name}" onerror="this.style.display='none'">
                <div><p class="font-bold text-lg">${ex.name}</p><p class="text-gray-600">${completedSets.length} / ${ex.sets} ÏÑ∏Ìä∏ (Î≥ºÎ•®: ${exerciseVolume.toLocaleString()}kg)</p></div></div>`;
        }).join('');
        elements.summaryContent.innerHTML = `<div class="text-center mb-3"><h4 class="font-bold">Ï¥ù Î≥ºÎ•®</h4><p class="text-3xl font-bold text-blue-600">${totalVolume.toLocaleString()} kg</p></div>` + html;
        openModal(elements.summaryModal);
    };
    
    const openTemplateEditorModal = (templateId) => {
        currentEditingTemplate.id = templateId;
        if (templateId) {
            const template = routineTemplates.find(t => t.id === templateId);
            elements.templateModalTitle.textContent = "Î£®Ìã¥ Ìé∏Ïßë";
            elements.templateTitleInput.value = template?.title || '';
            currentEditingTemplate.exercises = JSON.parse(JSON.stringify(template?.exercises || []));
        } else {
            elements.templateModalTitle.textContent = "ÏÉà Î£®Ìã¥ ÎßåÎì§Í∏∞";
            elements.templateTitleInput.value = "";
            currentEditingTemplate.exercises = [];
            currentEditingTemplate.id = null;
        }
        populateExerciseSelectors(elements.exerciseCategorySelect, elements.exerciseListSelect);
        renderTemplateExerciseList();
        resetExerciseInputs(elements.templateWeightInput, elements.templateRepsInput, elements.templateSetsInput, elements.addUpdateExerciseBtn);
        openModal(elements.templateEditorModal);
    };

    const openAddToSessionModal = (exIndex = null) => {
        sessionEditingExIndex = exIndex;
        populateExerciseSelectors(elements.sessionExCategorySelect, elements.sessionExListSelect);
        if (exIndex !== null) {
            const ex = currentWorkoutSession.log.exercises[exIndex];
            elements.addToSessionModalTitle.textContent = "Ïö¥Îèô Ìé∏Ïßë";
            elements.sessionWeightInput.value = ex.weight;
            elements.sessionRepsInput.value = ex.reps;
            elements.sessionSetsInput.value = ex.sets;
            elements.saveToSessionBtn.textContent = "ÏàòÏ†ï";
        } else {
            elements.addToSessionModalTitle.textContent = "ÏÑ∏ÏÖòÏóê Ïö¥Îèô Ï∂îÍ∞Ä";
            elements.sessionWeightInput.value = '';
            elements.sessionRepsInput.value = '';
            elements.sessionSetsInput.value = '';
            elements.saveToSessionBtn.textContent = "Ï∂îÍ∞Ä";
        }
        openModal(elements.addToSessionModal);
    };

    const populateExerciseSelectors = (categorySelect, listSelect) => {
        const parts = Object.keys(combinedExercises);
        categorySelect.innerHTML = parts.map(p => `<option value="${p}">${p}</option>`).join('');
        const updateList = () => {
            const selectedPart = categorySelect.value;
            listSelect.innerHTML = (combinedExercises[selectedPart] || []).map(e => `<option value="${e.name}">${e.name}</option>`).join('');
        };
        categorySelect.onchange = updateList;
        updateList();
    };

    const resetExerciseInputs = (weightInput, repsInput, setsInput, button) => {
        weightInput.value = ''; repsInput.value = ''; setsInput.value = '';
        if(button) button.textContent = 'Ïö¥Îèô Ï∂îÍ∞Ä';
        currentlyEditingExerciseIndex = null;
    };

    const renderTemplateExerciseList = () => {
        elements.templateExerciseList.innerHTML = !currentEditingTemplate.exercises?.length ? '<p class="text-gray-500">Ïö¥ÎèôÏùÑ Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî.</p>' :
            currentEditingTemplate.exercises.map((ex, idx) => `
                <div class="flex justify-between items-center p-2 border-b">
                    <span>${ex.name} (${ex.weight}kg x ${ex.reps}Ìöå x ${ex.sets}ÏÑ∏Ìä∏)</span>
                    <div>
                        <button class="edit-exercise-btn text-btn hover:text-blue-500 transition" data-index="${idx}">Ìé∏Ïßë</button>
                        <button class="delete-template-ex-btn text-red-500 font-bold" data-index="${idx}">√ó</button>
                    </div>
                </div>
            `).join('');
    };
    
     const bindEventListeners = () => {
        elements.backBtn.addEventListener('click', () => history.back());
        elements.prevMonthBtn.addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() - 1); renderCalendar(); });
        elements.nextMonthBtn.addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() + 1); renderCalendar(); });
        elements.todayBtn.addEventListener('click', () => { calendarDate = new Date(); selectedDate = formatDate(new Date()); renderCalendar(); });
        elements.dateSearchBtn.addEventListener('click', () => elements.dateSearchInput.showPicker?.());
        elements.dateSearchInput.addEventListener('change', (e) => { const d = new Date(e.target.value); if (!isNaN(d)) { calendarDate = d; selectedDate = e.target.value; renderCalendar(); } });
        elements.calendarBody.addEventListener('click', (e) => {
            const dayEl = e.target.closest('.calendar-day');
            if (!dayEl?.dataset.date || dayEl.classList.contains('future')) return;
            clearTimeout(clickTimer);
            if (e.detail === 1) clickTimer = setTimeout(() => { selectedDate = dayEl.dataset.date; renderCalendar(); }, 220);
            else if (e.detail === 2) { selectedDate = dayEl.dataset.date; renderCalendar(); openDailyLogModal(selectedDate); }
        });

        document.querySelectorAll('.modal-overlay').forEach(m => {
            m.addEventListener('click', (e) => {
                if (e.target !== m) return;
                if (m.id === 'workout-session-modal' && currentWorkoutSession.log) {
                    hideWorkoutSessionModal();
                } else if (m.id !== 'workout-session-modal') {
                    closeModal(m);
                }
            });
        });
        document.querySelectorAll('.close-modal-btn').forEach(b => b.addEventListener('click', (e) => closeModal(e.target.closest('.modal-overlay'))));
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && document.querySelector('.modal-overlay.open:not(#workout-session-modal)')) { document.querySelector('.modal-overlay.open:not(#workout-session-modal)').classList.remove('open'); }});
        
        elements.closeSummaryBtn.addEventListener('click', () => closeModal(elements.summaryModal));
        elements.openStatsModalBtn.addEventListener('click', () => { initializeStatsView(); openModal(elements.statsModal); });
        elements.closePrModal.addEventListener('click', () => closeModal(elements.prCelebrationModal));


        [elements.statsStartDate, elements.statsEndDate].forEach(el => el.addEventListener('change', updateStatsView));
        elements.statsResetBtn.addEventListener('click', () => {
            elements.statsStartDate.value = '';
            elements.statsEndDate.value = '';
            updateStatsView();
        });

        elements.statsPartSelector.addEventListener('click', e => {
            const target = e.target.closest('.stats-selector-btn');
            if (!target) return;
            
            if(target.classList.contains('active')) {
                target.classList.remove('active');
                 elements.statsExerciseSelect.innerHTML = '<option value="">-- Î∂ÄÏúÑ Î®ºÏ†Ä ÏÑ†ÌÉù --</option>';
            } else {
                document.querySelectorAll('#stats-part-selector .stats-selector-btn').forEach(b => b.classList.remove('active'));
                target.classList.add('active');
                const part = target.dataset.part;
                elements.statsExerciseSelect.innerHTML = `<option value="">-- Ï†ÑÏ≤¥ Î∂ÄÏúÑ --</option>` + (combinedExercises[part] || []).map(ex => `<option value="${ex.name}">${ex.name}</option>`).join('');
            }
            updateStatsView();
        });
        elements.statsExerciseSelect.addEventListener('change', updateStatsView);

        elements.routineTemplateList.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            const templateId = btn?.closest('[data-id]')?.dataset.id;
            if (!templateId) return;
            if (btn.classList.contains('edit-template-btn')) openTemplateEditorModal(templateId);
            else if (btn.classList.contains('start-routine-btn')) {
                const templ = routineTemplates.find(t => t.id === templateId);
                if (templ) openWorkoutSessionModal(templ);
            } else if (btn.classList.contains('delete-template-btn')) {
                 showConfirm("Ïù¥ Î£®Ìã¥ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?", () => {
                    routineTemplates = routineTemplates.filter(t => t.id !== templateId);
                    saveToLocalStorage(ROUTINE_TEMPLATE_KEY, routineTemplates);
                    renderRoutineTemplates();
                });
            }
        });
        elements.createNewTemplateBtn.addEventListener('click', () => openTemplateEditorModal(null));

        const setupEnterKeyFlow = (weightId, repsId, setsId, buttonId) => {
            const weightInput = document.getElementById(weightId);
            const repsInput = document.getElementById(repsId);
            const setsInput = document.getElementById(setsId);
            const button = document.getElementById(buttonId);

            weightInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); repsInput.focus(); } });
            repsInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); setsInput.focus(); } });
            setsInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); button.click(); } });
        };
        setupEnterKeyFlow('template-weight-input', 'template-reps-input', 'template-sets-input', 'add-update-exercise-btn');
        setupEnterKeyFlow('session-weight-input', 'session-reps-input', 'session-sets-input', 'save-to-session-btn');


        elements.addUpdateExerciseBtn.addEventListener('click', () => {
            const name = elements.exerciseListSelect.value;
            const weight = Number(elements.templateWeightInput.value) || 0;
            const reps = Number(elements.templateRepsInput.value) || 0;
            const sets = Number(elements.templateSetsInput.value) || 0;
            if (!name || sets <= 0) return alert('Ïö¥ÎèôÏùÑ ÏÑ†ÌÉùÌïòÍ≥† ÏÑ∏Ìä∏ ÏàòÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
            const exObj = { name, weight, reps, sets };
            if (currentlyEditingExerciseIndex !== null) currentEditingTemplate.exercises[currentlyEditingExerciseIndex] = exObj;
            else currentEditingTemplate.exercises.push(exObj);
            renderTemplateExerciseList();
            resetExerciseInputs(elements.templateWeightInput, elements.templateRepsInput, elements.templateSetsInput, elements.addUpdateExerciseBtn);
        });
        elements.templateExerciseList.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-exercise-btn');
            const delBtn = e.target.closest('.delete-template-ex-btn');
            if (editBtn) {
                const idx = Number(editBtn.dataset.index);
                const ex = currentEditingTemplate.exercises[idx];
                elements.templateWeightInput.value = ex.weight;
                elements.templateRepsInput.value = ex.reps;
                elements.templateSetsInput.value = ex.sets;
                elements.addUpdateExerciseBtn.textContent = 'Ïö¥Îèô ÏàòÏ†ï';
                currentlyEditingExerciseIndex = idx;
            } else if (delBtn) {
                const idx = Number(delBtn.dataset.index);
                showConfirm("Ïù¥ Ïö¥ÎèôÏùÑ Î£®Ìã¥ÏóêÏÑú ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?", () => {
                    currentEditingTemplate.exercises.splice(idx, 1);
                    renderTemplateExerciseList();
                });
            }
        });
        elements.saveTemplateBtn.addEventListener('click', () => {
            let title = elements.templateTitleInput.value.trim();
            if (!title) {
                const partsInRoutine = new Set();
                currentEditingTemplate.exercises.forEach(ex => {
                    for (const part in combinedExercises) {
                        if (combinedExercises[part].some(e => e.name === ex.name)) {
                            partsInRoutine.add(part); break;
                        }
                    }
                });
                title = [...partsInRoutine].join(', ') || 'ÎÇòÏùò Î£®Ìã¥';
            }
            if (currentEditingTemplate.id) {
                const index = routineTemplates.findIndex(t => t.id === currentEditingTemplate.id);
                if (index > -1) routineTemplates[index] = { ...routineTemplates[index], title, exercises: currentEditingTemplate.exercises };
            } else {
                routineTemplates.push({ id: Date.now().toString(), title, exercises: currentEditingTemplate.exercises });
            }
            saveToLocalStorage(ROUTINE_TEMPLATE_KEY, routineTemplates);
            renderRoutineTemplates();
            closeModal(elements.templateEditorModal);
        });
        
        elements.openAddExerciseModalBtn.addEventListener('click', () => {
             populateExerciseSelectors(elements.newExercisePart, elements.newExerciseName);
             openModal(elements.addExerciseModal);
        });
        elements.cancelAddExerciseBtn.addEventListener('click', () => closeModal(elements.addExerciseModal));
        elements.saveNewExerciseBtn.addEventListener('click', () => {
            const part = elements.newExercisePart.value, name = elements.newExerciseName.value.trim();
            if (!name) return alert('Ïö¥Îèô Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
            if (Object.values(combinedExercises).flat().some(e => e.name === name)) return alert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî Ïö¥ÎèôÎ™ÖÏûÖÎãàÎã§.');
            if (!customExercises[part]) customExercises[part] = [];
            customExercises[part].push({ name });
            saveToLocalStorage(CUSTOM_EXERCISES_KEY, customExercises);
            mergeExercises();
            closeModal(elements.addExerciseModal);
        });
        
        elements.addExerciseToSessionBtn.addEventListener('click', () => openAddToSessionModal(null));
        elements.saveToSessionBtn.addEventListener('click', () => {
            const name = elements.sessionExListSelect.value;
            const weight = Number(elements.sessionWeightInput.value) || 0;
            const reps = Number(elements.sessionRepsInput.value) || 0;
            const setsCount = Number(elements.sessionSetsInput.value) || 0;
            if (!name || setsCount <= 0) return alert('Ïö¥ÎèôÍ≥º ÏÑ∏Ìä∏ ÏàòÎ•º Ïò¨Î∞îÎ•¥Í≤å ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');

            const exIndexToModify = (sessionEditingExIndex !== null) ? sessionEditingExIndex : currentWorkoutSession.log.exercises.length;
            
            if (sessionEditingExIndex !== null) {
                 currentWorkoutSession.log.sets = currentWorkoutSession.log.sets.filter(s => s.exerciseIndex !== sessionEditingExIndex);
                 currentWorkoutSession.log.exercises[sessionEditingExIndex] = { name, weight, reps, sets: setsCount };
            } else {
                 currentWorkoutSession.log.exercises.push({ name, weight, reps, sets: setsCount });
            }

            for (let i = 0; i < setsCount; i++) {
                currentWorkoutSession.log.sets.push({ name, exerciseIndex: exIndexToModify, setNumber: i + 1, weight, reps, completed: false, isWarmup: false });
            }
            renderWorkoutSession();
            closeModal(elements.addToSessionModal);
        });

        elements.workoutSessionList.addEventListener('click', e => {
            const completeBtn = e.target.closest('.set-complete-btn');
            const completeAllBtn = e.target.closest('.complete-all-sets-btn');
            const editBtn = e.target.closest('.edit-session-ex-btn');
            const deleteBtn = e.target.closest('.delete-session-ex-btn');
            const addWarmupBtn = e.target.closest('.add-warmup-btn');
            const deleteWarmupBtn = e.target.closest('.delete-warmup-btn');

            if (addWarmupBtn) {
                const exIndex = Number(addWarmupBtn.dataset.exerciseIndex);
                const firstMainSet = currentWorkoutSession.log.sets.find(s => s.exerciseIndex === exIndex && !s.isWarmup);
                if (firstMainSet) {
                    const newWarmupSet = {
                        ...firstMainSet,
                        isWarmup: true,
                        completed: false,
                        setNumber: 0 // Placeholder
                    };
                    const firstSetIndex = currentWorkoutSession.log.sets.indexOf(firstMainSet);
                    currentWorkoutSession.log.sets.splice(firstSetIndex, 0, newWarmupSet);
                    renderWorkoutSession();
                }
            }
            else if (deleteWarmupBtn) {
                const setIndex = Number(deleteWarmupBtn.dataset.setIndex);
                currentWorkoutSession.log.sets.splice(setIndex, 1);
                renderWorkoutSession();
            }
            else if (completeBtn) {
                const setIndex = Number(completeBtn.dataset.setIndex);
                const set = currentWorkoutSession.log.sets[setIndex];
                set.completed = !set.completed;
                if(set.completed && !set.isWarmup) { startTimer(); }
                renderWorkoutSession();
            } else if (completeAllBtn) {
                const exIndex = Number(completeAllBtn.dataset.exerciseIndex);
                currentWorkoutSession.log.sets.forEach(set => {
                    if(set.exerciseIndex === exIndex && !set.isWarmup) set.completed = true;
                });
                renderWorkoutSession();
            } else if (editBtn) {
                openAddToSessionModal(Number(editBtn.dataset.exerciseIndex));
            } else if (deleteBtn) {
                const exIndex = Number(deleteBtn.dataset.exerciseIndex);
                 showConfirm("Ïù¥ Ïö¥ÎèôÏùÑ ÏÑ∏ÏÖòÏóêÏÑú ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?", () => {
                    const exercises = currentWorkoutSession.log.exercises;
                    let sets = currentWorkoutSession.log.sets;
                    exercises.splice(exIndex, 1);
                    currentWorkoutSession.log.sets = sets.filter(s => s.exerciseIndex !== exIndex);
                    // Re-index sets
                    currentWorkoutSession.log.sets.forEach(s => {
                        if (s.exerciseIndex > exIndex) {
                            s.exerciseIndex--;
                        }
                    });
                    renderWorkoutSession();
                });
            }
        });
        
        elements.workoutSessionList.addEventListener('input', e => {
            const target = e.target;
            const setIndex = Number(target.dataset.setIndex);
            if(isNaN(setIndex)) return;
            const set = currentWorkoutSession.log.sets[setIndex];
            if (target.classList.contains('weight-input')) set.weight = Number(target.value);
            if (target.classList.contains('reps-input')) set.reps = Number(target.value);
        });

        elements.hideSessionBtn.addEventListener('click', () => {
             showConfirm("ÏßÑÌñâÏ§ëÏù∏ Ïö¥ÎèôÏùÑ Ï¢ÖÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå?", () => {
                closeModal(elements.workoutSessionModal);
                cancelWorkoutSession();
             });
        });
        
        elements.timerMinus30Btn.addEventListener('click', () => {
            let currentVal = parseInt(elements.timerInput.value);
            elements.timerInput.value = Math.max(0, currentVal - 30);
        });

        elements.timerPlus30Btn.addEventListener('click', () => {
            let currentVal = parseInt(elements.timerInput.value);
            elements.timerInput.value = currentVal + 30;
        });

        elements.floatingTimer.addEventListener('click', reOpenWorkoutSessionModal);
        elements.closeFloatingTimer.addEventListener('click', (e) => {
            e.stopPropagation();
            showConfirm("ÏßÑÌñâÏ§ëÏù∏ Ïö¥ÎèôÏùÑ Ï¢ÖÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå?", cancelWorkoutSession);
        });

        elements.confirmCancelBtn.addEventListener('click', () => closeModal(elements.customConfirmModal));
        elements.confirmOkBtn.addEventListener('click', () => {
            if(confirmCallback) confirmCallback();
            closeModal(elements.customConfirmModal);
        });

        elements.saveSessionBtn.addEventListener('click', () => {
            const { log, originalLogIndex } = currentWorkoutSession;
            checkAndUpdatePRs(log);

            const isModified = JSON.stringify(log.exercises) !== currentWorkoutSession.originalTemplateExercises;

            if (isModified && log.id) {
                showConfirm("Î£®Ìã¥Ïù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§. ÏõêÎ≥∏ Î£®Ìã¥Ïóê Ïù¥ Î≥ÄÍ≤ΩÏÇ¨Ìï≠ÏùÑ Ï†ÄÏû•ÌïòÏãúÍ≤†ÏäµÎãàÍπå?", () => {
                    const templateIndex = routineTemplates.findIndex(t => t.id === log.id);
                    if (templateIndex > -1) {
                        routineTemplates[templateIndex].exercises = log.exercises;
                        saveToLocalStorage(ROUTINE_TEMPLATE_KEY, routineTemplates);
                        renderRoutineTemplates();
                    }
                });
            }

            if (originalLogIndex !== null && workoutLogs[selectedDate]?.[originalLogIndex]) workoutLogs[selectedDate][originalLogIndex] = log;
            else {
                if (!workoutLogs[selectedDate]) workoutLogs[selectedDate] = [];
                workoutLogs[selectedDate].push(log);
            }
            saveToLocalStorage(LOG_KEY, workoutLogs);
            renderCalendar();
            closeModal(elements.workoutSessionModal);
            openWorkoutSummaryModal(log);
            cancelWorkoutSession();
        });
        
        elements.dailyLogModalList.addEventListener('click', e => {
             const delBtn = e.target.closest('.delete-log-btn');
             if (delBtn) {
                 const idx = Number(delBtn.dataset.logIndex);
                 showConfirm('Ïù¥ Í∏∞Î°ùÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?', () => {
                     workoutLogs[selectedDate].splice(idx, 1);
                     if (workoutLogs[selectedDate].length === 0) delete workoutLogs[selectedDate];
                     saveToLocalStorage(LOG_KEY, workoutLogs);
                     renderCalendar();
                     closeModal(elements.dailyLogModal);
                 });
             }
        });

        let isDragging = false, offsetX, offsetY;
        elements.floatingTimer.addEventListener('mousedown', (e) => {
            isDragging = true;
            offsetX = e.clientX - elements.floatingTimer.offsetLeft;
            offsetY = e.clientY - elements.floatingTimer.offsetTop;
            elements.floatingTimer.classList.add('dragging');
            elements.floatingTimer.style.cursor = 'grabbing';
        });
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            elements.floatingTimer.style.left = `${e.clientX - offsetX}px`;
            elements.floatingTimer.style.top = `${e.clientY - offsetY}px`;
        });
        document.addEventListener('mouseup', () => {
            isDragging = false;
            elements.floatingTimer.classList.remove('dragging');
            elements.floatingTimer.style.cursor = 'pointer';
        });
    };
    
    const startTimer = () => {
        clearInterval(timerInterval);
        const totalSeconds = Number(elements.timerInput.value) || 60;
        let remaining = totalSeconds;
        const hand = elements.clockSecondHand;
        
        if (floatingTimerProgressCircle) floatingTimerProgressCircle.style.strokeDasharray = `${circumference} ${circumference}`;

        const updateDisplay = () => {
            if (remaining < 0) return;
            const minutes = String(Math.floor(remaining / 60)).padStart(2, '0');
            const seconds = String(remaining % 60).padStart(2, '0');
            const timeString = `${minutes}:${seconds}`;
            elements.timerDigitalDisplay.textContent = timeString;
            elements.floatingTimerDisplay.textContent = timeString;

            const degrees = ((totalSeconds - remaining) / totalSeconds) * 360;
            if (hand) hand.style.transform = `rotate(${degrees}deg)`;

            if (floatingTimerProgressCircle) {
                const offset = circumference - (remaining / totalSeconds) * circumference;
                floatingTimerProgressCircle.style.strokeDashoffset = offset;
            }
        };
        updateDisplay();
        timerInterval = setInterval(() => {
            remaining--;
            updateDisplay();
            if (remaining < 0) {
                clearInterval(timerInterval);
                elements.timerDigitalDisplay.classList.add('text-red-500');
                elements.floatingTimerDisplay.parentElement.classList.add('animate-pulse');
                setTimeout(() => {
                    elements.timerDigitalDisplay.classList.remove('text-red-500');
                    elements.floatingTimerDisplay.parentElement.classList.remove('animate-pulse');
                    if (hand) hand.style.transform = 'rotate(0deg)';
                }, 2000);
            }
        }, 1000);
    };

    const generateShades = (baseColorRgba, count) => {
        const shades = [];
        const rgba = baseColorRgba.match(/\d+/g);
        if (!rgba) return Array(count).fill(baseColorRgba);
        const [r, g, b] = rgba.slice(0, 3).map(Number);
        
        for (let i = 0; i < count; i++) {
            const factor = 1 - (i / (count + 1)) * 0.5;
            const newR = Math.max(0, Math.min(255, Math.floor(r * factor + (i * 10))));
            const newG = Math.max(0, Math.min(255, Math.floor(g * factor + (i * 10))));
            const newB = Math.max(0, Math.min(255, Math.floor(b * factor + (i * 10))));
            shades.push(`rgba(${newR}, ${newG}, ${newB}, 0.8)`);
        }
        return shades;
    };


    const init = () => {
        if (floatingTimerProgressCircle) floatingTimerProgressCircle.style.strokeDashoffset = circumference;
        Object.assign(routineTemplates, loadFromLocalStorage(ROUTINE_TEMPLATE_KEY, []));
        Object.assign(workoutLogs, loadFromLocalStorage(LOG_KEY, {}));
        Object.assign(customExercises, loadFromLocalStorage(CUSTOM_EXERCISES_KEY, {}));
        Object.assign(personalRecords, loadFromLocalStorage(PR_KEY, {}));
        mergeExercises();
        renderCalendar();
        renderRoutineTemplates();
        bindEventListeners();
        populateExerciseSelectors(elements.newExercisePart, elements.newExerciseName);
    };

    init();
});
</script>
</body>
</html>

