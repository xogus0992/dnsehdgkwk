<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>나의 운동 기록 v7 (수정본)</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.0.3/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body, html { margin:0; padding:0; height:100%; }
        body { overflow-y:auto; scroll-behavior: smooth; background-color: #f3f4f6; }
        .card { padding:20px; border-radius:8px; background:white; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        #calendar { display:grid; grid-template-columns: repeat(7,1fr); gap:10px; }
        .calendar-day { text-align:center; padding:12px 5px; border:1px solid #e2e8f0; border-radius:8px;
            cursor:pointer; transition: all 0.18s; min-height:90px; display:flex; flex-direction:column; justify-content:space-between;
        }
        .calendar-day:hover { transform: translateY(-3px); box-shadow:0 6px 12px rgba(0,0,0,0.08); }
        .calendar-day.selected { background:#3b82f6; color:white; font-weight:700; }
        .calendar-day.has-log { border-bottom:4px solid #63b3ed; }
        .calendar-day.today { box-shadow: 0 0 0 3px #bfdbfe inset; }
        .day-number { font-size:1.05rem; font-weight:700; }
        .day-volume { font-size:0.8rem; color:#4a5568; font-weight:600; }
        .calendar-day.selected .day-volume { color:white; }

        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center;
            padding:1rem; visibility:hidden; opacity:0; transition: all 0.18s; z-index:50;
        }
        .modal-overlay.open { visibility:visible; opacity:1; }
        .modal-content { background:white; border-radius:8px; padding:20px; width:100%; max-width:720px; max-height:90vh; overflow:auto; box-shadow:0 10px 25px rgba(0,0,0,0.12); }

        .set-btn { width:34px; height:34px; border-radius:50%; border:1px solid #ddd; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; margin-right:6px; }
        .set-btn.completed { background:#3b82f6; color:white; border-color:#3b82f6; }

        .icon-btn { background:none; border:none; cursor:pointer; padding:4px; }
        .tab-btn { padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:600; }
        .tab-btn.active { background:#3b82f6; color:white; }

        .exercise-list-item { padding:6px; border-radius:6px; cursor:pointer; }
        .exercise-list-item.selected { background:#dbeafe; }

        .summary-item { display:flex; gap:12px; align-items:center; }
        .summary-item img { width:64px; height:64px; object-fit:cover; border-radius:8px; background:#efefef; }

        /* responsive tweaks */
        @media (max-width: 768px) {
            .modal-content { max-width: 95%; padding:12px; }
        }
    </style>
</head>
<body>

    <header class="bg-blue-600 text-white p-4 relative text-center">
        <button id="back-to-main-btn" class="absolute left-4 top-1/2 transform -translate-y-1/2 bg-white text-blue-600 px-3 py-1 rounded shadow">← 뒤로가기</button>
        <h1 class="text-2xl font-semibold">나의 운동 기록 v7</h1>
    </header>

    <main class="max-w-7xl mx-auto px-4 mt-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2">
            <section class="card">
                <div class="flex items-center justify-between mb-4 gap-4">
                    <div class="flex items-center gap-2">
                        <button id="prev-month-btn" class="px-3 py-2 bg-gray-200 rounded-lg">‹</button>
                        <h3 id="calendar-title" class="text-xl font-bold w-48 text-center"></h3>
                        <button id="next-month-btn" class="px-3 py-2 bg-gray-200 rounded-lg">›</button>
                    </div>
                    <div class="flex items-center gap-2 bg-gray-100 p-1 rounded">
                        <button id="today-btn" class="px-4 py-1 bg-white rounded shadow-sm text-blue-600 font-semibold">오늘</button>
                        <button id="date-search-btn" class="p-1.5 bg-white rounded shadow-sm">
                            📅
                        </button>
                        <input id="date-search-input" type="date" class="absolute opacity-0 -z-10 w-0 h-0">
                    </div>
                </div>

                <div class="grid grid-cols-7 text-center font-bold mb-2 text-sm text-gray-500">
                    <span>일</span><span>월</span><span>화</span><span>수</span><span>목</span><span>금</span><span>토</span>
                </div>

                <div id="calendar"></div>
            </section>
        </div>

        <div class="space-y-6">
            <section class="card">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-bold">🗒️ 나의 루틴</h3>
                    <button id="open-stats-modal-btn" class="bg-gray-100 px-2 py-1 rounded">📊 통계</button>
                </div>
                <div id="routine-template-list" class="space-y-3"></div>
                <button id="create-new-template-btn" class="mt-4 w-full bg-gray-200 p-2 rounded font-bold">+ 새 루틴 만들기</button>
            </section>
        </div>
    </main>

    <!-- Daily Log Modal -->
    <div id="daily-log-modal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="daily-log-modal-title" class="text-xl font-bold"></h3>
                <button class="close-modal-btn text-xl">&times;</button>
            </div>
            <div id="daily-log-modal-list" class="space-y-3"></div>
        </div>
    </div>

    <!-- Template Editor Modal -->
    <div id="template-editor-modal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-3">
                <h3 id="template-modal-title" class="text-xl font-bold"></h3>
                <button class="close-modal-btn text-xl">&times;</button>
            </div>

            <input id="template-title-input" class="w-full p-2 border rounded mb-3" placeholder="루틴 이름 (예: 가슴 세션)" />

            <div class="flex justify-between items-center mb-2">
                <h4 class="font-bold">운동 추가</h4>
                <button id="open-add-exercise-modal-btn" class="bg-blue-500 text-white px-2 py-1 rounded">+ 새 운동 만들기</button>
            </div>

            <div class="bg-gray-100 p-2 rounded mb-3">
                <div id="exercise-category-tabs" class="flex flex-wrap gap-2 mb-2"></div>
                <div id="exercise-list-by-category" class="max-h-36 overflow-y-auto border-t pt-2"></div>
            </div>

            <div class="grid grid-cols-4 gap-2 my-3">
                <input id="template-exercise-name-input" type="text" readonly placeholder="운동 선택" class="col-span-4 p-2 border rounded bg-gray-100" />
                <input id="template-weight-input" type="number" placeholder="무게(kg)" class="p-2 border rounded" />
                <input id="template-reps-input" type="number" placeholder="횟수" class="p-2 border rounded" />
                <input id="template-sets-input" type="number" placeholder="세트" class="p-2 border rounded" />
            </div>
            <button id="add-update-exercise-btn" class="w-full bg-gray-500 text-white p-2 rounded mb-3">운동 추가</button>

            <h4 class="font-bold mb-2">현재 루틴 목록</h4>
            <div id="template-exercise-list" class="flex-col space-y-2 max-h-56 overflow-y-auto border-t pt-2"></div>

            <div class="mt-4 flex gap-2">
                <button id="save-template-btn" class="w-full bg-blue-600 text-white p-2 rounded">템플릿 저장</button>
            </div>
        </div>
    </div>

    <!-- Add Exercise Modal -->
    <div id="add-exercise-modal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-xl font-bold">새 운동 만들기</h3>
                <button class="close-modal-btn text-xl">&times;</button>
            </div>

            <div class="space-y-3">
                <div>
                    <label class="block font-bold mb-1">운동 부위</label>
                    <select id="new-exercise-part" class="w-full p-2 border rounded"></select>
                </div>
                <div>
                    <label class="block font-bold mb-1">운동 이름</label>
                    <input id="new-exercise-name" class="w-full p-2 border rounded" placeholder="예: 나만의 벤치프레스" />
                </div>
            </div>

            <div class="flex gap-2 mt-4">
                <button id="cancel-add-exercise-btn" class="w-1/2 bg-gray-300 p-2 rounded">취소</button>
                <button id="save-new-exercise-btn" class="w-1/2 bg-blue-600 text-white p-2 rounded">저장</button>
            </div>
        </div>
    </div>

    <!-- Summary Modal -->
    <div id="summary-modal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-xl font-bold">오늘의 운동 요약</h3>
                <button class="close-modal-btn text-xl">&times;</button>
            </div>
            <div id="summary-content" class="space-y-3"></div>
            <button id="close-summary-btn" class="w-full mt-3 bg-blue-600 text-white p-2 rounded">확인</button>
        </div>
    </div>

    <!-- Stats Modal -->
    <div id="stats-modal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-xl font-bold">통계</h3>
                <button class="close-modal-btn text-xl">&times;</button>
            </div>

            <div class="flex justify-center bg-gray-100 p-1 rounded mb-3">
                <button class="tab-btn active" data-tab="by-part">부위별</button>
                <button class="tab-btn" data-tab="by-exercise">종목별</button>
            </div>

            <div id="stats-by-part" class="stats-tab-content">
                <select id="stats-body-part-select" class="w-full p-2 border rounded mb-3"></select>
                <div style="height:260px"><canvas id="volume-chart-part"></canvas></div>
            </div>

            <div id="stats-by-exercise" class="stats-tab-content hidden">
                <select id="stats-exercise-select" class="w-full p-2 border rounded mb-3"></select>
                <div style="height:260px"><canvas id="volume-chart-exercise"></canvas></div>
            </div>
        </div>
    </div>

    <!-- Workout Session Modal -->
    <div id="workout-session-modal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-3">
                <h3 id="workout-session-title" class="text-xl font-bold"></h3>
                <button class="close-modal-btn text-xl">&times;</button>
            </div>
            <div class="text-center mb-3">
                <input id="timer-input" type="number" class="w-full p-3 text-2xl font-bold text-center bg-gray-100 rounded" value="60" />
                <p class="text-sm text-gray-500">휴식 시간 (초)</p>
            </div>

            <div id="workout-session-list" class="space-y-3 max-h-60 overflow-y-auto"></div>

            <div class="mt-3 flex gap-2">
                <button id="edit-session-routine-btn" class="w-1/3 bg-gray-200 p-2 rounded">수정</button>
                <button id="save-session-btn" class="w-2/3 bg-blue-600 text-white p-2 rounded">운동 완료 및 저장</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ---------- 데이터(내장) ----------
    // exercisesData: 부위별 기본 운동 목록 (각 항목은 {name, image?} 형태로 사용)
    const exercisesData = {
        "가슴": [{name:"벤치프레스"},{name:"인클라인 벤치프레스"},{name:"덤벨 플라이"}],
        "등": [{name:"데드리프트"},{name:"풀업"},{name:"바벨 로우"}],
        "어깨": [{name:"오버헤드 프레스"},{name:"사이드 레터럴 레이즈"}],
        "하체": [{name:"스쿼트"},{name:"레그 프레스"},{name:"런지"}],
        "팔": [{name:"바벨 컬"},{name:"덤벨 컬"}],
        "코어": [{name:"플랭크"},{name:"시트업"}]
    };
    // bodyPartImages: 기본 부위 이미지(옵션)
    const bodyPartImages = {
        "가슴": "https://via.placeholder.com/96?text=Chest",
        "등": "https://via.placeholder.com/96?text=Back",
        "어깨": "https://via.placeholder.com/96?text=Shoulder",
        "하체": "https://via.placeholder.com/96?text=Legs",
        "팔": "https://via.placeholder.com/96?text=Arms",
        "코어": "https://via.placeholder.com/96?text=Core"
    };

    // ---------- DOM 요소 ----------
    const elements = {
        backBtn: document.getElementById('back-to-main-btn'),
        calendarTitle: document.getElementById('calendar-title'),
        calendarBody: document.getElementById('calendar'),
        prevMonthBtn: document.getElementById('prev-month-btn'),
        nextMonthBtn: document.getElementById('next-month-btn'),
        todayBtn: document.getElementById('today-btn'),
        dateSearchBtn: document.getElementById('date-search-btn'),
        dateSearchInput: document.getElementById('date-search-input'),
        dailyLogModal: document.getElementById('daily-log-modal'),
        templateEditorModal: document.getElementById('template-editor-modal'),
        statsModal: document.getElementById('stats-modal'),
        workoutSessionModal: document.getElementById('workout-session-modal'),
        openStatsModalBtn: document.getElementById('open-stats-modal-btn'),
        dailyLogModalTitle: document.getElementById('daily-log-modal-title'),
        dailyLogModalList: document.getElementById('daily-log-modal-list'),
        routineTemplateList: document.getElementById('routine-template-list'),
        createNewTemplateBtn: document.getElementById('create-new-template-btn'),
        statsBodyPartSelect: document.getElementById('stats-body-part-select'),
        statsExerciseSelect: document.getElementById('stats-exercise-select'),
        volumeChartPartCanvas: document.getElementById('volume-chart-part'),
        volumeChartExerciseCanvas: document.getElementById('volume-chart-exercise'),
        templateModalTitle: document.getElementById('template-modal-title'),
        templateTitleInput: document.getElementById('template-title-input'),
        templateExerciseList: document.getElementById('template-exercise-list'),
        exerciseCategoryTabs: document.getElementById('exercise-category-tabs'),
        exerciseListByCategory: document.getElementById('exercise-list-by-category'),
        templateExerciseNameInput: document.getElementById('template-exercise-name-input'),
        templateWeightInput: document.getElementById('template-weight-input'),
        templateRepsInput: document.getElementById('template-reps-input'),
        templateSetsInput: document.getElementById('template-sets-input'),
        addUpdateExerciseBtn: document.getElementById('add-update-exercise-btn'),
        saveTemplateBtn: document.getElementById('save-template-btn'),
        workoutSessionTitle: document.getElementById('workout-session-title'),
        timerInput: document.getElementById('timer-input'),
        workoutSessionList: document.getElementById('workout-session-list'),
        editSessionRoutineBtn: document.getElementById('edit-session-routine-btn'),
        saveSessionBtn: document.getElementById('save-session-btn'),
        openAddExerciseModalBtn: document.getElementById('open-add-exercise-modal-btn'),
        addExerciseModal: document.getElementById('add-exercise-modal'),
        newExercisePart: document.getElementById('new-exercise-part'),
        newExerciseName: document.getElementById('new-exercise-name'),
        saveNewExerciseBtn: document.getElementById('save-new-exercise-btn'),
        cancelAddExerciseBtn: document.getElementById('cancel-add-exercise-btn'),
        summaryModal: document.getElementById('summary-modal'),
        summaryContent: document.getElementById('summary-content'),
        closeSummaryBtn: document.getElementById('close-summary-btn'),
    };

    // ---------- 상태 변수 ----------
    const ROUTINE_TEMPLATE_KEY = 'my_fitness_templates_v7';
    const LOG_KEY = 'my_fitness_logs_v9';
    const CUSTOM_EXERCISES_KEY = 'my_fitness_custom_exercises_v1';
    const PR_KEY = 'my_fitness_prs_v1';

    let routineTemplates = [];
    let workoutLogs = {};
    let customExercises = {}; // {부위: [{name, image, custom:true}, ...]}
    let personalRecords = {}; // { exerciseName: {maxWeight: number} }
    let combinedExercises = {}; // exercisesData + custom

    let calendarDate = new Date();
    let selectedDate = new Date().toISOString().split('T')[0];
    let volumeChartPart = null;
    let volumeChartExercise = null;
    let currentEditingTemplate = { id: null, exercises: [] };
    let currentWorkoutSession = { log: null, originalLogIndex: null };
    let currentlyEditingExerciseIndex = null;
    let timerInterval = null;
    let clickTimer = null;

    // ---------- 로컬 스토리지 처리 ----------
    const saveTemplates = () => localStorage.setItem(ROUTINE_TEMPLATE_KEY, JSON.stringify(routineTemplates));
    const loadTemplates = () => { try { routineTemplates = JSON.parse(localStorage.getItem(ROUTINE_TEMPLATE_KEY) || '[]'); } catch { routineTemplates = []; } };
    const saveLogs = () => localStorage.setItem(LOG_KEY, JSON.stringify(workoutLogs));
    const loadLogs = () => { try { workoutLogs = JSON.parse(localStorage.getItem(LOG_KEY) || '{}'); } catch { workoutLogs = {}; } };
    const saveCustomExercises = () => localStorage.setItem(CUSTOM_EXERCISES_KEY, JSON.stringify(customExercises));
    const loadCustomExercises = () => { try { customExercises = JSON.parse(localStorage.getItem(CUSTOM_EXERCISES_KEY) || '{}'); } catch { customExercises = {}; } };
    const savePRs = () => localStorage.setItem(PR_KEY, JSON.stringify(personalRecords));
    const loadPRs = () => { try { personalRecords = JSON.parse(localStorage.getItem(PR_KEY) || '{}'); } catch { personalRecords = {}; } };

    // ---------- 유틸 / 병합 ----------
    const mergeExercises = () => {
        // combinedExercises는 {부위: [{name, image?, custom?}, ...], ...}
        combinedExercises = {};
        Object.keys(exercisesData).forEach(part => {
            combinedExercises[part] = exercisesData[part].map(e => ({ name: e.name, image: e.image || bodyPartImages[part] || '' }));
        });
        // customExercises의 구조는 {part: [{name, image, custom:true}, ...]}
        Object.keys(customExercises).forEach(part => {
            if (!combinedExercises[part]) combinedExercises[part] = [];
            // push each custom exercise
            combinedExercises[part].push(...customExercises[part].map(e => ({ name: e.name, image: e.image || bodyPartImages[part] || '', custom: true })));
        });
    };

    const formatDate = (d) => {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        return `${y}-${m}-${dd}`;
    };

    // ---------- 모달 오픈/닫기 ----------
    const openModal = (el) => {
        if (!el) return;
        el.classList.add('open');
    };
    const closeModal = (el) => {
        if (!el) return;
        el.classList.remove('open');
    };

    // ---------- PR 업데이트 ----------
    const checkAndUpdatePR = (exercise) => {
        const { name, weight } = exercise;
        if (!name) return;
        if (!personalRecords[name]) personalRecords[name] = { maxWeight: 0 };
        if (weight > 0 && weight > personalRecords[name].maxWeight) {
            personalRecords[name].maxWeight = weight;
            savePRs();
            setTimeout(() => alert(`🎉 PR 달성! [${name}] 최고 무게 ${weight}kg 달성!`), 80);
        }
    };

    // ---------- 통계 그래프 헬퍼 ----------
    const getChartData = (volumeCalculator) => {
        const labels = [];
        const data = [];
        Object.keys(workoutLogs).sort().forEach(date => {
            let dailyVol = 0;
            workoutLogs[date].forEach(log => {
                dailyVol += volumeCalculator(log);
            });
            if (dailyVol > 0) {
                labels.push(date.substring(5));
                data.push(dailyVol);
            }
        });
        return { labels, data };
    };

    const renderPartStatsGraph = () => {
        const selectedBodyPart = elements.statsBodyPartSelect.value;
        if (volumeChartPart) volumeChartPart.destroy();
        if (!selectedBodyPart) return;
        const { labels, data } = getChartData(log => {
            let v = 0;
            if (log.exercises) {
                log.exercises.forEach(ex => {
                    // find body part from combinedExercises
                    const part = Object.keys(combinedExercises).find(p => combinedExercises[p].some(e => e.name === ex.name));
                    if (part === selectedBodyPart) v += (ex.weight||0) * (ex.reps||0) * (ex.completedSets||0);
                });
            }
            return v;
        });
        volumeChartPart = new Chart(elements.volumeChartPartCanvas.getContext('2d'), {
            type: 'line',
            data: { labels, datasets: [{ label: `${selectedBodyPart} 볼륨`, data, borderColor: 'rgb(59,130,246)', fill:false, tension:0.2 }] },
            options: { responsive:true, maintainAspectRatio:false }
        });
    };

    const renderExerciseStatsGraph = () => {
        const selectedExercise = elements.statsExerciseSelect.value;
        if (volumeChartExercise) volumeChartExercise.destroy();
        if (!selectedExercise) return;
        const { labels, data } = getChartData(log => {
            let v=0;
            if (log.exercises) {
                log.exercises.forEach(ex => {
                    if (ex.name === selectedExercise) v += (ex.weight||0) * (ex.reps||0) * (ex.completedSets||0);
                });
            }
            return v;
        });
        volumeChartExercise = new Chart(elements.volumeChartExerciseCanvas.getContext('2d'), {
            type: 'line',
            data: { labels, datasets: [{ label: `${selectedExercise} 볼륨`, data, borderColor: 'rgb(22,163,74)', fill:false, tension:0.2 }] },
            options: { responsive:true, maintainAspectRatio:false }
        });
    };

    // ---------- 캘린더 렌더링 ----------
    const renderCalendar = () => {
        const year = calendarDate.getFullYear();
        const month = calendarDate.getMonth();
        elements.calendarTitle.textContent = `${year}년 ${month+1}월`;
        elements.calendarBody.innerHTML = '';
        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month+1, 0).getDate();

        for (let i=0;i<firstDay;i++) {
            const el = document.createElement('div');
            el.className = 'calendar-day opacity-25 pointer-events-none';
            elements.calendarBody.appendChild(el);
        }

        for (let d=1; d<=lastDate; d++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const dayEl = document.createElement('div');
            let dayClass = 'calendar-day';
            let totalVolume = 0;
            if (workoutLogs[dateStr] && workoutLogs[dateStr].length>0) {
                dayClass += ' has-log';
                workoutLogs[dateStr].forEach(log => {
                    if (log.exercises) log.exercises.forEach(ex => totalVolume += (ex.weight||0)*(ex.reps||0)*(ex.completedSets||0));
                });
            }
            const today = new Date();
            if (year===today.getFullYear() && month===today.getMonth() && d===today.getDate()) dayClass += ' today';
            if (dateStr === selectedDate) dayClass += ' selected';

            dayEl.className = dayClass;
            dayEl.dataset.date = dateStr;
            dayEl.innerHTML = `<div class="day-number">${d}</div>` + (totalVolume>0? `<div class="day-volume">${totalVolume}kg</div>` : '');
            elements.calendarBody.appendChild(dayEl);
        }
    };

    // ---------- 루틴(템플릿) 렌더링 ----------
    const renderRoutineTemplates = () => {
        elements.routineTemplateList.innerHTML = '';
        if (!routineTemplates || routineTemplates.length===0) {
            elements.routineTemplateList.innerHTML = '<p class="text-gray-500 text-sm">템플릿이 없습니다. 새로 만들어보세요.</p>';
            return;
        }
        routineTemplates.forEach(t => {
            const container = document.createElement('div');
            container.className = 'p-3 border rounded mb-2';
            container.dataset.id = t.id;
            const exercisesPreview = t.exercises.map(ex => `<div class="text-sm text-gray-600 flex justify-between"><span>${ex.name}</span><span>${ex.weight}kg x ${ex.reps}회 x ${ex.sets}세트</span></div>`).join('');
            container.innerHTML = `<div class="flex justify-between items-center"><span class="font-bold">${t.title}</span>
                <div>
                    <button class="start-routine-btn text-green-500 text-sm font-bold mr-2" data-id="${t.id}">▶ 시작</button>
                    <button class="edit-template-btn icon-btn" data-id="${t.id}">✏️</button>
                </div></div>
                <div class="mt-2 space-y-1">${exercisesPreview}</div>`;
            elements.routineTemplateList.appendChild(container);
        });
    };

    // ---------- 일별 기록 보기 ----------
    const openDailyLogModal = (date) => {
        elements.dailyLogModalTitle.textContent = `${date} 운동 기록`;
        elements.dailyLogModalList.innerHTML = '';
        const logs = workoutLogs[date] || [];
        if (logs.length===0) {
            elements.dailyLogModalList.innerHTML = '<p class="text-gray-500">기록된 운동이 없습니다. 루틴을 시작하세요.</p>';
        } else {
            logs.forEach((log, idx) => {
                const div = document.createElement('div');
                div.className = 'mb-3 pb-3 border-b';
                const exercisesDetail = (log.exercises || []).map(ex => {
                    return `<div class="text-sm text-gray-800">
                        <div class="flex justify-between items-center">
                            <span>${ex.name} (${ex.weight}kg x ${ex.reps}회)</span>
                            <span class="font-bold ${ (ex.completedSets||0) >= (ex.sets||0) ? 'text-green-500' : '' }">${ex.completedSets||0} / ${ex.sets||0} 세트</span>
                        </div>
                        ${ex.memo? `<p class="text-xs text-gray-500 pl-2">- ${ex.memo}</p>` : ''}
                    </div>`;
                }).join('');
                div.innerHTML = `<div class="flex justify-between items-start">
                    <h4 class="font-bold text-lg">${log.title}</h4>
                    <div class="flex gap-2">
                        <button class="edit-log-btn icon-btn" data-log-index="${idx}">✏️</button>
                        <button class="delete-log-btn text-red-500 font-bold" data-log-index="${idx}">삭제</button>
                    </div>
                </div><div class="mt-2">${exercisesDetail}</div>`;
                elements.dailyLogModalList.appendChild(div);
            });
        }
        openModal(elements.dailyLogModal);
    };

    // ---------- 워크아웃 세션 열기(실행) ----------
    const openWorkoutSessionModal = (log, originalLogIndex = null) => {
        // log: { id, title, exercises: [{name, weight, reps, sets, completedSets, memo}], ... }
        currentWorkoutSession = { log: JSON.parse(JSON.stringify(log)), originalLogIndex };
        elements.workoutSessionTitle.textContent = currentWorkoutSession.log.title || '루틴';
        elements.workoutSessionList.innerHTML = '';

        (currentWorkoutSession.log.exercises || []).forEach((ex, exIndex) => {
            const container = document.createElement('div');
            container.className = 'border-b pb-2';
            // sets buttons
            let setsHtml = '';
            for (let i=1;i<= (ex.sets || 0); i++) {
                const completed = (ex.completedSets || 0) >= i;
                setsHtml += `<button class="set-btn ${completed? 'completed':''}" data-exercise-index="${exIndex}" data-set-number="${i}">${i}</button>`;
            }
            container.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <div>
                        <p class="font-bold">${ex.name}</p>
                        <p class="text-gray-600">${ex.weight}kg x ${ex.reps}회</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="add-memo-btn icon-btn" data-exercise-index="${exIndex}">📝</button>
                        <button class="complete-all-sets-btn bg-gray-200 text-xs px-2 py-1 rounded" data-exercise-index="${exIndex}">전체 완료</button>
                    </div>
                </div>
                ${ex.memo ? `<p class="text-xs text-gray-500 pl-2 mb-2">- ${ex.memo}</p>` : ''}
                <div class="flex gap-2 flex-wrap">${setsHtml}</div>
            `;
            elements.workoutSessionList.appendChild(container);
        });

        openModal(elements.workoutSessionModal);
    };

    // ---------- 요약(서머리) 모달 ----------
    const openWorkoutSummaryModal = (log) => {
        let totalVolume = 0;
        let html = '';
        const allExercisesFlat = Object.values(combinedExercises).flat();
        (log.exercises || []).forEach(ex => {
            const exerciseInfo = allExercisesFlat.find(e => e.name === ex.name);
            const part = Object.keys(combinedExercises).find(p => combinedExercises[p].some(e => e.name === ex.name)) || '기타';
            const imageSrc = exerciseInfo?.image || bodyPartImages[part] || 'https://via.placeholder.com/96?text=Img';
            const volume = (ex.weight||0) * (ex.reps||0) * (ex.completedSets||0);
            totalVolume += volume;
            html += `<div class="summary-item p-2 border-b">
                <img src="${imageSrc}" alt="${ex.name}" onerror="this.src='https://via.placeholder.com/96?text=Img'">
                <div>
                    <p class="font-bold">${ex.name}</p>
                    <p class="text-sm text-gray-600">${ex.weight}kg x ${ex.reps}회 x ${ex.completedSets||0}세트 (볼륨: ${volume.toLocaleString()}kg)</p>
                </div>
            </div>`;
        });
        elements.summaryContent.innerHTML = `<div class="text-center mb-3"><h4 class="font-bold">총 볼륨</h4><p class="text-2xl font-bold text-blue-600">${totalVolume.toLocaleString()} kg</p></div>` + html;
        openModal(elements.summaryModal);
    };

    // ---------- 템플릿 편집 관련 렌더/리셋 ----------
    const resetExerciseInputs = () => {
        elements.templateExerciseNameInput.value = '';
        elements.templateWeightInput.value = '';
        elements.templateRepsInput.value = '';
        elements.templateSetsInput.value = '';
        elements.addUpdateExerciseBtn.textContent = '운동 추가';
        currentlyEditingExerciseIndex = null;
    };

    const renderTemplateExerciseList = () => {
        elements.templateExerciseList.innerHTML = '';
        if (!currentEditingTemplate.exercises || currentEditingTemplate.exercises.length === 0) {
            elements.templateExerciseList.innerHTML = '<p class="text-gray-500">운동을 추가해주세요.</p>';
            return;
        }
        currentEditingTemplate.exercises.forEach((ex, idx) => {
            const item = document.createElement('div');
            item.className = 'flex justify-between items-center p-2 border-b';
            item.innerHTML = `<span>${ex.name} (${ex.weight}kg x ${ex.reps}회 x ${ex.sets}세트)</span>
                <div>
                    <button class="edit-exercise-btn icon-btn" data-index="${idx}">✏️</button>
                    <button class="delete-template-ex-btn text-red-500 font-bold" data-index="${idx}">×</button>
                </div>`;
            elements.templateExerciseList.appendChild(item);
        });
    };

    const renderExerciseCategoryTabs = (activeCategory) => {
        const parts = Object.keys(combinedExercises);
        if (!activeCategory) activeCategory = parts[0] || '';
        elements.exerciseCategoryTabs.innerHTML = parts.map(p => `<button class="tab-btn ${p===activeCategory? 'active':''}" data-category="${p}">${p}</button>`).join('');
        renderExerciseListForCategory(activeCategory);
    };

    const renderExerciseListForCategory = (category) => {
        if (!combinedExercises[category]) { elements.exerciseListByCategory.innerHTML = ''; return; }
        elements.exerciseListByCategory.innerHTML = combinedExercises[category].map(e => `<div class="exercise-list-item" data-name="${e.name}">${e.name}</div>`).join('');
    };

    // ---------- 이벤트 바인딩 ----------
    const bindEventListeners = () => {
        // 네비게이션
        elements.backBtn.addEventListener('click', () => { window.location.href = 'health.html'; });

        // 달력 조작
        elements.prevMonthBtn.addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth()-1); renderCalendar(); });
        elements.nextMonthBtn.addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth()+1); renderCalendar(); });
        elements.todayBtn.addEventListener('click', () => { calendarDate = new Date(); selectedDate = formatDate(new Date()); renderCalendar(); });

        // date picker
        elements.dateSearchBtn.addEventListener('click', () => { elements.dateSearchInput.showPicker ? elements.dateSearchInput.showPicker() : elements.dateSearchInput.click(); });
        elements.dateSearchInput.addEventListener('change', (e) => {
            const d = new Date(e.target.value);
            if (!isNaN(d)) { calendarDate = d; selectedDate = e.target.value; renderCalendar(); }
        });

        // 캘린더 클릭 (단일/더블)
        elements.calendarBody.addEventListener('click', (e) => {
            const dayEl = e.target.closest('.calendar-day');
            if (!dayEl || !dayEl.dataset.date) return;
            clearTimeout(clickTimer);
            if (e.detail === 1) {
                clickTimer = setTimeout(() => {
                    selectedDate = dayEl.dataset.date;
                    renderCalendar();
                }, 220);
            } else if (e.detail === 2) {
                selectedDate = dayEl.dataset.date;
                renderCalendar();
                openDailyLogModal(selectedDate);
            }
        });

        // 모달 닫기(오버레이 클릭/버튼)
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (ev) => {
                if (ev.target === modal) closeModal(modal);
            });
            modal.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', () => closeModal(modal)));
        });

        // 키보드 단축(스페이스로 오늘)
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && !e.target.closest('input,select,button,.modal-overlay.open')) {
                e.preventDefault();
                elements.todayBtn.click();
            }
            if (e.key === 'Escape') {
                const openModals = Array.from(document.querySelectorAll('.modal-overlay.open'));
                if (openModals.length) closeModal(openModals[openModals.length-1]);
            }
        });

        // 통계 모달
        elements.openStatsModalBtn.addEventListener('click', () => {
            renderStats();
            openModal(elements.statsModal);
        });
        document.querySelectorAll('#stats-modal .tab-btn').forEach(btn => {
            btn.addEventListener('click', (ev) => {
                document.querySelectorAll('#stats-modal .tab-btn').forEach(b => b.classList.remove('active'));
                ev.target.classList.add('active');
                renderStats();
            });
        });

        // 루틴 리스트 클릭(시작/수정)
        elements.routineTemplateList.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            const itemWrapper = e.target.closest('[data-id]') || target.closest('[data-id]');
            const templateId = itemWrapper?.dataset?.id || target.dataset?.id;
            if (!templateId) return;
            if (target.classList.contains('edit-template-btn')) {
                openTemplateEditorModal(templateId);
            } else if (target.classList.contains('start-routine-btn')) {
                const templ = routineTemplates.find(t => t.id === templateId);
                if (templ) openWorkoutSessionModal(templ);
            }
        });

        // 새 템플릿 만들기
        elements.createNewTemplateBtn.addEventListener('click', () => openTemplateEditorModal(null));

        // 템플릿 모달: 카테고/종목 선택
        elements.exerciseCategoryTabs.addEventListener('click', (e) => {
            if (e.target.classList.contains('tab-btn')) renderExerciseListForCategory(e.target.dataset.category);
        });
        elements.exerciseListByCategory.addEventListener('click', (e) => {
            if (e.target.classList.contains('exercise-list-item')) {
                document.querySelectorAll('.exercise-list-item').forEach(el=>el.classList.remove('selected'));
                e.target.classList.add('selected');
                elements.templateExerciseNameInput.value = e.target.dataset.name;
            }
        });

        // 템플릿 모달: 운동 추가/수정
        elements.addUpdateExerciseBtn.addEventListener('click', () => {
            const name = elements.templateExerciseNameInput.value.trim();
            const weight = Number(elements.templateWeightInput.value) || 0;
            const reps = Number(elements.templateRepsInput.value) || 0;
            const sets = Number(elements.templateSetsInput.value) || 0;
            if (!name) { alert('운동을 선택해주세요.'); return; }
            if (sets <= 0) { alert('세트 수를 입력해주세요.'); return; }

            const exObj = { name, weight, reps, sets, completedSets: 0, memo: '' };
            if (currentlyEditingExerciseIndex !== null) {
                currentEditingTemplate.exercises[currentlyEditingExerciseIndex] = exObj;
            } else {
                currentEditingTemplate.exercises.push(exObj);
            }
            renderTemplateExerciseList();
            resetExerciseInputs();
        });

        // 템플릿 내 운동 수정/삭제 (위임)
        elements.templateExerciseList.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-exercise-btn');
            const delBtn = e.target.closest('.delete-template-ex-btn');
            if (editBtn) {
                const idx = Number(editBtn.dataset.index);
                const ex = currentEditingTemplate.exercises[idx];
                if (ex) {
                    elements.templateExerciseNameInput.value = ex.name;
                    elements.templateWeightInput.value = ex.weight;
                    elements.templateRepsInput.value = ex.reps;
                    elements.templateSetsInput.value = ex.sets;
                    elements.addUpdateExerciseBtn.textContent = '운동 수정';
                    currentlyEditingExerciseIndex = idx;
                }
            } else if (delBtn) {
                const idx = Number(delBtn.dataset.index);
                if (confirm('삭제하시겠습니까?')) {
                    currentEditingTemplate.exercises.splice(idx,1);
                    renderTemplateExerciseList();
                }
            }
        });

        // 템플릿 저장
        elements.saveTemplateBtn.addEventListener('click', () => {
            const title = elements.templateTitleInput.value.trim();
            if (!title) { alert('루틴 이름을 입력해주세요.'); return; }

            if (currentEditingTemplate.id) {
                const index = routineTemplates.findIndex(t => t.id === currentEditingTemplate.id);
                if (index > -1) {
                    routineTemplates[index].title = title;
                    routineTemplates[index].exercises = currentEditingTemplate.exercises;
                }
            } else {
                const newTemplate = { id: Date.now().toString(), title, exercises: currentEditingTemplate.exercises };
                routineTemplates.push(newTemplate);
            }
            saveTemplates();
            renderRoutineTemplates();
            closeModal(elements.templateEditorModal);
        });

        // 워크아웃 세션 내 버튼(세트 클릭, 전체 완료, 메모)
        elements.workoutSessionList.addEventListener('click', (e) => {
            const setBtn = e.target.closest('.set-btn');
            const completeAllBtn = e.target.closest('.complete-all-sets-btn');
            const addMemoBtn = e.target.closest('.add-memo-btn');
            if (setBtn) {
                const exIndex = Number(setBtn.dataset.exerciseIndex);
                const setNumber = Number(setBtn.dataset.setNumber);
                const ex = currentWorkoutSession.log.exercises[exIndex];
                if (!ex) return;
                const prev = ex.completedSets || 0;
                if (prev >= setNumber && setBtn.classList.contains('completed')) {
                    ex.completedSets = setNumber - 1;
                } else {
                    ex.completedSets = setNumber;
                    if (ex.completedSets > prev) checkAndUpdatePR(ex);
                }
                openWorkoutSessionModal(currentWorkoutSession.log, currentWorkoutSession.originalLogIndex);
                startTimer();
            } else if (completeAllBtn) {
                const exIndex = Number(completeAllBtn.dataset.exerciseIndex);
                const ex = currentWorkoutSession.log.exercises[exIndex];
                if (!ex) return;
                ex.completedSets = ex.sets;
                openWorkoutSessionModal(currentWorkoutSession.log, currentWorkoutSession.originalLogIndex);
            } else if (addMemoBtn) {
                const exIndex = Number(addMemoBtn.dataset.exerciseIndex);
                const ex = currentWorkoutSession.log.exercises[exIndex];
                const memo = prompt('운동 메모:', ex.memo || '');
                if (memo !== null) {
                    ex.memo = memo;
                }
                openWorkoutSessionModal(currentWorkoutSession.log, currentWorkoutSession.originalLogIndex);
            }
        });

        // 편집 버튼 - 워크아웃 세션에서 템플릿 편집
        elements.editSessionRoutineBtn.addEventListener('click', () => {
            if (currentWorkoutSession.log && currentWorkoutSession.log.id) openTemplateEditorModal(currentWorkoutSession.log.id, true);
            else openTemplateEditorModal(currentWorkoutSession.log.id, true);
        });

        // 세션 저장(완료)
        elements.saveSessionBtn.addEventListener('click', () => {
            const { log, originalLogIndex } = currentWorkoutSession;
            if (originalLogIndex !== null && workoutLogs[selectedDate] && workoutLogs[selectedDate][originalLogIndex]) {
                workoutLogs[selectedDate][originalLogIndex] = log;
            } else {
                if (!workoutLogs[selectedDate]) workoutLogs[selectedDate] = [];
                workoutLogs[selectedDate].push(log);
            }
            saveLogs();
            renderCalendar();
            closeModal(elements.workoutSessionModal);
            openWorkoutSummaryModal(log);
        });

        // Summary modal 닫기
        elements.closeSummaryBtn.addEventListener('click', () => closeModal(elements.summaryModal));

        // Add exercise modal open
        elements.openAddExerciseModalBtn.addEventListener('click', () => {
            elements.newExercisePart.innerHTML = Object.keys(combinedExercises).map(p => `<option value="${p}">${p}</option>`).join('');
            elements.newExerciseName.value = '';
            openModal(elements.addExerciseModal);
        });
        elements.cancelAddExerciseBtn.addEventListener('click', () => closeModal(elements.addExerciseModal));

        // Save new exercise (custom)
        elements.saveNewExerciseBtn.addEventListener('click', () => {
            const part = elements.newExercisePart.value;
            const name = elements.newExerciseName.value.trim();
            if (!name) { alert('운동 이름을 입력하세요.'); return; }
            const duplicate = Object.values(combinedExercises).flat().some(e => e.name === name);
            if (duplicate) { alert('이미 존재하는 운동명입니다.'); return; }
            if (!customExercises[part]) customExercises[part] = [];
            customExercises[part].push({ name, image: bodyPartImages[part] || '', custom: true });
            saveCustomExercises();
            mergeExercises();
            renderExerciseCategoryTabs(part);
            closeModal(elements.addExerciseModal);
        });

        // daily modal: edit/delete log
        elements.dailyLogModalList.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-log-btn');
            const delBtn = e.target.closest('.delete-log-btn');
            if (editBtn) {
                const idx = Number(editBtn.dataset.logIndex);
                const logs = workoutLogs[selectedDate] || [];
                const log = logs[idx];
                if (log) openWorkoutSessionModal(log, idx);
            } else if (delBtn) {
                const idx = Number(delBtn.dataset.logIndex);
                if (confirm('이 기록을 삭제하시겠습니까?')) {
                    workoutLogs[selectedDate].splice(idx,1);
                    if (workoutLogs[selectedDate].length===0) delete workoutLogs[selectedDate];
                    saveLogs();
                    renderCalendar();
                    closeModal(elements.dailyLogModal);
                }
            }
        });

        // stats selects
        elements.statsBodyPartSelect.addEventListener('change', renderPartStatsGraph);
        elements.statsExerciseSelect.addEventListener('change', renderExerciseStatsGraph);
    };

    // ---------- 템플릿 모달 열기 ----------
    const openTemplateEditorModal = (templateId, fromSession=false) => {
        currentEditingTemplate.id = templateId;
        if (templateId) {
            const template = fromSession && currentWorkoutSession.log ? currentWorkoutSession.log : routineTemplates.find(t => t.id === templateId);
            elements.templateModalTitle.textContent = "루틴 수정";
            elements.templateTitleInput.value = template?.title || '';
            currentEditingTemplate.exercises = JSON.parse(JSON.stringify(template?.exercises || []));
        } else {
            elements.templateModalTitle.textContent = "새 루틴 만들기";
            elements.templateTitleInput.value = "";
            currentEditingTemplate.exercises = [];
        }
        renderExerciseCategoryTabs();
        renderTemplateExerciseList();
        resetExerciseInputs();
        openModal(elements.templateEditorModal);
    };

    // ---------- 타이머 ----------
    const startTimer = () => {
        clearInterval(timerInterval);
        let remaining = Number(elements.timerInput.value) || 60;
        timerInterval = setInterval(() => {
            remaining--;
            if (remaining <= 0) clearInterval(timerInterval);
        }, 1000);
    };

    // ---------- 렌더 통합 함수 ----------
    const renderStats = () => {
        const activeTab = document.querySelector('#stats-modal .tab-btn.active')?.dataset?.tab || 'by-part';
        if (activeTab === 'by-part') {
            document.getElementById('stats-by-part').classList.remove('hidden');
            document.getElementById('stats-by-exercise').classList.add('hidden');
            renderPartStatsGraph();
        } else {
            document.getElementById('stats-by-part').classList.add('hidden');
            document.getElementById('stats-by-exercise').classList.remove('hidden');
            renderExerciseStatsGraph();
        }
    };

    // ---------- 초기화 ----------
    const init = () => {
        loadTemplates();
        loadLogs();
        loadCustomExercises();
        loadPRs();
        mergeExercises();

        // populate selects
        const allExerciseNames = Array.from(new Set(Object.values(combinedExercises).flat().map(e => e.name))).sort((a,b)=> a.localeCompare(b));
        elements.statsExerciseSelect.innerHTML = '<option value="">-- 종목 선택 --</option>' + allExerciseNames.map(n => `<option value="${n}">${n}</option>`).join('');
        elements.statsBodyPartSelect.innerHTML = '<option value="">-- 부위 선택 --</option>' + Object.keys(combinedExercises).map(p => `<option value="${p}">${p}</option>`).join('');

        renderCalendar();
        renderRoutineTemplates();
        bindEventListeners();
    };

    // ---------- 시작 ----------
    init();

});
</script>
</body>
</html>
