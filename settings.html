<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>POKE RUN: SETTINGS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined|Material+Icons" rel="stylesheet">
    
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:ital,wght@0,400;0,700;1,900&family=Inter:wght@400;700;900&family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
     
    <link rel="stylesheet" href="layout.css">

    <style>
        /* --- 테마 설정 (White Mode Fixed) --- */
        :root { 
            --volt: #2563eb;         /* 파랑 */
            --bg-main: #f0f4f8;      /* 밝은 배경 */
            --bg-card: #ffffff;      /* 흰색 카드 */
            --bg-sub: #e5e7eb;       /* 서브 배경 */
            --text-main: #1a1a1a;    /* 검정 텍스트 */
            --text-sub: #4b5563;     /* 회색 텍스트 */
            --border-color: #cccccc; /* 경계선 */
            --danger: #ef4444;       /* 빨강 (위험/삭제) */
        }

        body { 
            font-family: 'Inter', 'Noto Sans KR', sans-serif; 
            background: var(--bg-main); 
            color: var(--text-main); 
        }
        
        .font-sport { font-family: 'Chakra Petch', sans-serif; }

        /* 토글 스위치 스타일 */
        .toggle-checkbox:checked {
            right: 0;
            border-color: var(--volt);
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: var(--volt);
        }
        .toggle-checkbox {
            right: 0;
            z-index: 1;
            border-color: #e5e7eb;
            transition: all 0.3s;
        }
        .toggle-label {
            width: 44px;
            height: 24px;
            background-color: #d1d5db;
            border-radius: 9999px;
            transition: all 0.3s;
        }
        .toggle-checkbox:checked {
            right: -20px; /* 위치 조정 */
            transform: translateX(100%);
        }
        
        /* 스위치 커스텀 (Tailwind와 결합) */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--volt);
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* 섹션 스타일 */
        .settings-section {
            background-color: var(--bg-card);
            border-radius: 16px;
            padding: 0 16px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            border: 1px solid var(--border-color);
        }
        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            border-bottom: 1px solid var(--bg-main);
        }
        .settings-row:last-child { border-bottom: none; }
        
        .row-title { font-size: 14px; font-weight: 600; color: var(--text-main); }
        .row-desc { font-size: 11px; color: var(--text-sub); margin-top: 2px; }
        
        .select-box {
            background: var(--bg-sub);
            border: none;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-main);
            outline: none;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-[var(--bg-main)]">

    <div class="w-full max-w-md mx-auto p-5 pb-32">
        <h1 class="text-2xl font-black italic font-sport tracking-tighter mb-6">SETTINGS</h1>

        <div class="bg-[var(--bg-card)] rounded-2xl p-5 mb-6 flex items-center gap-4 border border-[var(--border-color)] shadow-sm relative overflow-hidden">
            <div class="absolute top-0 right-0 w-24 h-24 bg-[var(--volt)] opacity-10 blur-2xl rounded-full pointer-events-none"></div>

            <div class="w-16 h-16 rounded-full p-[2px] bg-gradient-to-tr from-[var(--volt)] to-cyan-400">
                <img id="user-avatar" class="w-full h-full rounded-full bg-[var(--bg-sub)] object-cover">
            </div>
            <div class="flex-1">
                <h2 id="user-name" class="text-lg font-bold text-[var(--text-main)]">-</h2>
                <p id="user-email" class="text-xs text-[var(--text-sub)] mb-2">-</p>
                <div class="inline-flex items-center gap-1 bg-[var(--bg-sub)] px-2 py-1 rounded-lg">
                    <span class="text-yellow-500 font-bold">●</span>
                    <span class="text-xs font-bold text-[var(--text-main)]">보유 코인:</span>
                    <span id="my-coin" class="text-sm font-black text-[var(--volt)] font-sport italic">0</span>
                </div>
            </div>
            <button onclick="location.href='profile.html'" class="text-[var(--text-sub)] hover:text-[var(--volt)]">
                <i data-lucide="chevron-right"></i>
            </button>
        </div>

        <div class="text-xs font-bold text-[var(--text-sub)] mb-2 ml-1">WORKOUT</div>
        <div class="settings-section">
            <div class="settings-row">
                <div>
                    <div class="row-title">러닝 음성 안내 (TTS)</div>
                    <div class="row-desc">1km마다 페이스와 시간을 알려줍니다.</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="set-voice" onchange="updateSetting('voiceGuide', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-row">
                <div>
                    <div class="row-title">화면 켜짐 유지</div>
                    <div class="row-desc">운동 중 화면이 꺼지지 않습니다.</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="set-screen" onchange="updateSetting('screenAlwaysOn', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-row">
                <div class="row-title">시작 전 카운트다운</div>
                <select id="set-countdown" class="select-box" onchange="updateSetting('countdown', this.value)">
                    <option value="0">없음</option>
                    <option value="3">3초</option>
                    <option value="5">5초</option>
                    <option value="10">10초</option>
                </select>
            </div>
            <div class="settings-row">
                <div>
                    <div class="row-title">웨이트 기본 휴식시간</div>
                    <div class="row-desc">세트 간 휴식 타이머 기본값</div>
                </div>
                <div class="flex items-center gap-1">
                    <input type="number" id="set-rest" class="select-box w-14 text-center" value="60" onchange="updateSetting('restTime', this.value)">
                    <span class="text-xs font-bold">초</span>
                </div>
            </div>
        </div>

        <div class="text-xs font-bold text-[var(--text-sub)] mb-2 ml-1">SOCIAL & FEED</div>
        <div class="settings-section">
            <div class="settings-row">
                <div>
                    <div class="row-title">계정 비공개</div>
                    <div class="row-desc">팔로워에게만 피드를 공개합니다.</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="set-private" onchange="updateSetting('privateAccount', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-row">
                <div>
                    <div class="row-title">릴스 자동 재생</div>
                    <div class="row-desc">데이터 사용량이 증가할 수 있습니다.</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="set-autoplay" onchange="updateSetting('autoPlay', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="text-xs font-bold text-[var(--text-sub)] mb-2 ml-1">NOTIFICATION</div>
        <div class="settings-section">
            <div class="settings-row">
                <div class="row-title">활동 알림 (좋아요, 팔로우)</div>
                <label class="switch">
                    <input type="checkbox" id="set-push-act" onchange="updateSetting('pushActivity', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-row">
                <div class="row-title">마케팅 정보 수신</div>
                <label class="switch">
                    <input type="checkbox" id="set-push-mkt" onchange="updateSetting('pushMarketing', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="text-xs font-bold text-[var(--text-sub)] mb-2 ml-1">ACCOUNT</div>
        <div class="settings-section">
            <button onclick="clearAppCache()" class="w-full flex items-center justify-between py-4 text-left border-b border-[var(--bg-main)]">
                <span class="row-title">캐시 데이터 삭제</span>
                <i data-lucide="trash-2" class="w-4 h-4 text-[var(--text-sub)]"></i>
            </button>
            <button onclick="handleLogout()" class="w-full flex items-center justify-between py-4 text-left border-b border-[var(--bg-main)]">
                <span class="row-title text-[var(--danger)]">로그아웃</span>
                <i data-lucide="log-out" class="w-4 h-4 text-[var(--danger)]"></i>
            </button>
            <button onclick="handleDeleteAccount()" class="w-full flex items-center justify-between py-4 text-left">
                <span class="row-title text-[var(--text-sub)] text-xs">회원 탈퇴</span>
                <i data-lucide="chevron-right" class="w-4 h-4 text-[var(--text-sub)]"></i>
            </button>
        </div>

        <div class="text-center text-[10px] text-[var(--text-sub)] mt-6 mb-10">
            POKE RUN Version 1.2.0<br>
            © 2025 POKE RUN Corp.
        </div>
    </div>

    <script src="layout.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, deleteUser } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, update, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyAbHwLLXIH8rBQ8gNMVqE5SE208aIbfFZ0", 
            authDomain: "pokbattle.firebaseapp.com", 
            databaseURL: "https://pokbattle-default-rtdb.firebaseio.com", 
            projectId: "pokbattle" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        let currentUser = null;

        // 1. 초기화 및 데이터 로드
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadUserData(user.uid);
            } else {
                location.href = 'log.html';
            }
        });

        function loadUserData(uid) {
            const userRef = ref(db, `users/${uid}`);
            
            onValue(userRef, (snap) => {
                const data = snap.val();
                if (!data) return;

                // 프로필 정보
                document.getElementById('user-name').innerText = data.nickname || "러너";
                document.getElementById('user-email').innerText = data.email || "";
                document.getElementById('user-avatar').src = data.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${uid}`;
                
                // 코인 정보 (없으면 0)
                const coins = data.coins || 0;
                document.getElementById('my-coin').innerText = coins.toLocaleString();

                // 설정값 반영 (없으면 기본값)
                const s = data.settings || {};
                
                // 체크박스 (true/false)
                document.getElementById('set-voice').checked = s.voiceGuide !== false; // 기본 true
                document.getElementById('set-screen').checked = s.screenAlwaysOn === true; // 기본 false
                document.getElementById('set-private').checked = s.privateAccount === true; 
                document.getElementById('set-autoplay').checked = s.autoPlay !== false; 
                document.getElementById('set-push-act').checked = s.pushActivity !== false;
                document.getElementById('set-push-mkt').checked = s.pushMarketing === true;

                // 선택값
                document.getElementById('set-countdown').value = s.countdown || "3";
                document.getElementById('set-rest').value = s.restTime || "60";
            });
        }

        // 2. 설정 업데이트 (전역 함수)
        window.updateSetting = (key, value) => {
            if (!currentUser) return;
            
            // 숫자형 변환 (restTime 등)
            if (key === 'restTime') value = parseInt(value) || 60;
            
            update(ref(db, `users/${currentUser.uid}/settings`), {
                [key]: value
            }).then(() => {
                // 로컬 스토리지에도 백업 (오프라인/빠른 로딩용)
                const currentSettings = JSON.parse(localStorage.getItem('userSettings') || '{}');
                currentSettings[key] = value;
                localStorage.setItem('userSettings', JSON.stringify(currentSettings));
            }).catch(err => console.error("설정 저장 실패:", err));
        };

        // 3. 계정 관리 기능
        window.clearAppCache = () => {
            if(confirm("앱의 임시 데이터를 정리하시겠습니까?\n로그인 정보는 유지됩니다.")) {
                // settings, records 등 핵심 키 제외하고 삭제하거나,
                // 간단하게 관련 없는 키만 지우는 로직. 여기선 단순 알림.
                localStorage.removeItem('myWorkoutRecords'); // 로컬 운동기록 초기화 예시
                alert("캐시 데이터가 삭제되었습니다.");
                location.reload();
            }
        };

        window.handleLogout = () => {
            if(confirm("로그아웃 하시겠습니까?")) {
                signOut(auth).then(() => location.href='log.html');
            }
        };

        window.handleDeleteAccount = async () => {
            const msg = "정말로 탈퇴하시겠습니까?\n모든 데이터(코인, 기록, 친구)가 즉시 삭제되며 복구할 수 없습니다.";
            if(confirm(msg)) {
                const uid = currentUser.uid;
                try {
                    // DB 데이터 삭제
                    await remove(ref(db, `users/${uid}`));
                    // 인증 계정 삭제
                    await deleteUser(currentUser);
                    alert("탈퇴가 완료되었습니다. 이용해 주셔서 감사합니다.");
                    location.href = 'log.html';
                } catch (e) {
                    alert("탈퇴 실패: " + e.message + "\n(재로그인 후 다시 시도해주세요)");
                }
            }
        };

        lucide.createIcons();
    </script>
</body>
</html>