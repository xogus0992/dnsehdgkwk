<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>운동 기록 시작하기</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.0.3/dist/tailwind.min.css" rel="stylesheet">
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c96c999113980d67c697b2f5a3d385f1&autoload=false"></script>
<style>
body, html { margin:0; padding:0; height:100%; overflow:hidden; }
.routine-card{margin-top:20px; padding:20px; border:1px solid #ddd; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); background:white;}
.exercise-item{display:flex; justify-content:space-between; padding:12px 8px; border-bottom:1px solid #f0f0f0; cursor:grab; user-select:none;}
.exercise-item.dragging{opacity:0.5;background-color:#e0e7ff;}
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:1000;}
.modal-content{background:white;padding:30px;border-radius:8px;width:90%;max-width:500px;box-shadow:0 4px 15px rgba(0,0,0,0.2);}
.modal-content h3{font-size:1.75rem;font-weight:bold;margin-bottom:20px;}
.modal-exercise-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;}
.total-volume{text-align:right;font-size:1.2rem;font-weight:bold;margin-top:15px;color:#3b82f6;}
.saved-routine-item{display:flex;justify-content:space-between;align-items:center;padding:20px;background:white;border:1px solid #ddd;border-radius:8px;margin-top:10px;cursor:pointer;transition:background-color .2s;}
.saved-routine-item:hover{background:#f9fafb;}
.saved-routine-title{font-size:1.2rem;font-weight:600;flex-grow:1;}
.delete-btn{background:#ef4444;color:white;border:none;border-radius:50%;width:30px;height:30px;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:10;flex-shrink:0;}
.fullscreen-container{position:absolute;top:0;left:0;width:100%;height:100%;}
#selection-screen{display:flex;justify-content:center;align-items:center;}
#health-tracker-app{overflow-y:auto;}
</style>
</head>
<body class="bg-gray-100">

<div id="selection-screen" class="fullscreen-container">
  <div class="flex space-x-8">
    <button id="diet-btn" class="w-48 h-48 bg-green-500 text-white rounded-full flex justify-center items-center text-3xl font-bold shadow-lg transform hover:scale-105 transition-transform">다이어1트</button>
    <button id="health-btn" class="w-48 h-48 bg-blue-500 text-white rounded-full flex justify-center items-center text-3xl font-bold shadow-lg transform hover:scale-105 transition-transform">헬스</button>
  </div>
</div>

<div id="diet-map-screen" class="fullscreen-container hidden">
  <div id="map" style="width:100%;height:100%;"></div>
  <button id="back-to-selection-from-diet-btn" class="absolute top-4 left-4 bg-white p-2 rounded-md shadow-lg z-10">← 뒤로가기</button>
</div>

<div id="health-tracker-app" class="fullscreen-container hidden">
  <header class="bg-blue-600 text-white p-4 text-center relative">
    <button id="back-to-selection-from-health-btn" class="absolute top-1/2 left-4 -translate-y-1/2 bg-white text-blue-600 p-2 rounded-md shadow-lg z-10">← 뒤로가기</button>
    <h1 class="text-3xl font-semibold">나의 운동 볼륨 기록</h1>
  </header>
  <section class="mt-8 px-4 max-w-2xl mx-auto">
    <h2 class="text-2xl font-bold">새로운 루틴 만들기</h2>
    <div class="routine-card">
      <div class="mb-4">
        <label for="routine-title" class="block text-gray-700 font-bold">루틴 이름</label>
        <input type="text" id="routine-title" placeholder="예: 불타는 하체 데이" class="w-full p-2 border rounded mt-1">
      </div>
      <div class="border-t border-b py-4 my-4">
        <h4 class="text-lg font-semibold text-gray-800 mb-2">운동 추가하기</h4>
        <select id="exercise-select" class="w-full p-2 border rounded"></select>
        <div class="flex space-x-2 mt-2">
          <input type="number" id="exercise-weight" placeholder="무게(kg, 선택)" class="w-1/3 p-2 border rounded" min="0" step="0.5">
          <input type="number" id="exercise-reps" placeholder="횟수" class="w-1/3 p-2 border rounded" min="1">
          <input type="number" id="exercise-sets" placeholder="세트" class="w-1/3 p-2 border rounded" min="1">
        </div>
        <button id="add-exercise-btn" class="mt-4 w-full bg-gray-500 text-white p-2 rounded hover:bg-gray-600">운동 추가</button>
      </div>
      <div id="current-exercises-container">
        <h4 class="text-lg font-semibold text-gray-800">추가된 운동 (드래그해서 순서 변경)</h4>
        <div id="current-exercises-list" class="mt-2 text-gray-600"><p>아직 추가된 운동이 없습니다.</p></div>
      </div>
      <button id="save-routine-btn" class="mt-6 w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 text-lg font-bold">이 루틴 저장하기</button>
    </div>
  </section>
  <section class="mt-8 px-4 max-w-2xl mx-auto pb-10">
    <h2 class="text-2xl font-bold">저장된 나의 루틴</h2>
    <div id="routine-list"></div>
  </section>
</div>

<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const selectionScreen=document.getElementById('selection-screen');
  const healthTrackerApp=document.getElementById('health-tracker-app');
  const dietMapScreen=document.getElementById('diet-map-screen');
  const dietBtn=document.getElementById('diet-btn');
  const healthBtn=document.getElementById('health-btn');
  const dietBackBtn=document.getElementById('back-to-selection-from-diet-btn');
  const healthBackBtn=document.getElementById('back-to-selection-from-health-btn');

  let kakaoMap=null;
  let userMarker=null;

  const initKakaoMap=()=>{
    const container=document.getElementById('map');
    const defaultCenter=new kakao.maps.LatLng(37.5665,126.9780);
    if(!kakaoMap){
      kakaoMap=new kakao.maps.Map(container,{center:defaultCenter,level:5});
    }else{
      kakao.maps.event.trigger(kakaoMap,'resize');
      kakaoMap.setCenter(defaultCenter);
    }
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        const userPos=new kakao.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
        kakaoMap.setCenter(userPos);
        if(userMarker) userMarker.setMap(null);
        userMarker=new kakao.maps.Marker({map:kakaoMap,position:userPos});
      },()=>{alert('위치 정보를 가져올 수 없습니다. 기본 위치로 표시됩니다.');});
    }
  };

  healthBtn.addEventListener('click',()=>{
    selectionScreen.classList.add('hidden');
    healthTrackerApp.classList.remove('hidden');
  });

  dietBtn.addEventListener('click',()=>{
    selectionScreen.classList.add('hidden');
    dietMapScreen.classList.remove('hidden');
    kakao.maps.load(()=>{initKakaoMap();});
  });

  dietBackBtn.addEventListener('click',()=>{
    dietMapScreen.classList.add('hidden');
    selectionScreen.classList.remove('hidden');
  });

  healthBackBtn.addEventListener('click',()=>{
    healthTrackerApp.classList.add('hidden');
    selectionScreen.classList.remove('hidden');
  });

  // --- 헬스 앱 ---
  const exercisesData={
    "가슴":["벤치프레스","인클라인 벤치프레스","딥스","덤벨 플라이","푸쉬업","케이블 크로스오버"],
    "등":["데드리프트","풀업","바벨 로우","랫 풀 다운","시티드 케이블 로우"],
    "어깨":["오버헤드 프레스","사이드 레터럴 레이즈","벤트 오버 레터럴 레이즈","프론트 레이즈"],
    "하체":["스쿼트","런지","레그 프레스","레그 익스텐션","레그 컬","카프 레이즈"],
    "팔":["바벨 컬","덤벨 컬","케이블 푸쉬다운","라잉 트라이셉스 익스텐션"]
  };

  const exerciseSelect=document.getElementById('exercise-select');
  const routineTitleInput=document.getElementById('routine-title');
  const weightInput=document.getElementById('exercise-weight');
  const repsInput=document.getElementById('exercise-reps');
  const setsInput=document.getElementById('exercise-sets');
  const addExerciseBtn=document.getElementById('add-exercise-btn');
  const saveRoutineBtn=document.getElementById('save-routine-btn');
  const currentExercisesList=document.getElementById('current-exercises-list');
  const routineList=document.getElementById('routine-list');

  let currentExercises=[];
  let routines=[];
  const STORAGE_KEY='my_fitness_routines_v1';

  const saveRoutinesToStorage=()=>{try{localStorage.setItem(STORAGE_KEY,JSON.stringify(routines));}catch(e){console.error(e);}};
  const loadRoutinesFromStorage=()=>{try{const raw=localStorage.getItem(STORAGE_KEY); const parsed=JSON.parse(raw||'[]'); if(Array.isArray(parsed)) routines=parsed;}catch(e){console.error(e);}};

  const populateExercises=()=>{
    exerciseSelect.innerHTML='';
    Object.keys(exercisesData).forEach(cat=>{
      const og=document.createElement('optgroup'); og.label=cat;
      exercisesData[cat].forEach(ex=>{const o=document.createElement('option');o.value=ex;o.textContent=ex;og.appendChild(o);});
      exerciseSelect.appendChild(og);
    });
  };

  const displayCurrentExercises=()=>{
    currentExercisesList.innerHTML='';
    if(currentExercises.length===0){currentExercisesList.innerHTML='<p>아직 추가된 운동이 없습니다.</p>'; return;}
    currentExercises.forEach((ex,i)=>{
      const item=document.createElement('div'); item.className='exercise-item'; item.draggable=true; item.dataset.index=i;
      const wtxt=(ex.weight===0)?'체중':ex.weight+'kg'; const vol=ex.weight*ex.reps*ex.sets;
      item.innerHTML=`<span>${ex.name} (${wtxt} x ${ex.reps}회 x ${ex.sets}세트)</span><span class="font-semibold">볼륨: ${vol}</span>`;
      currentExercisesList.appendChild(item);
    });
  };

  const displaySavedRoutines=()=>{
    routineList.innerHTML='';
    if(routines.length===0){routineList.innerHTML='<p class="text-gray-600">저장된 루틴이 없습니다.</p>'; return;}
    routines.forEach((rt,i)=>{
      const item=document.createElement('div'); item.className='saved-routine-item'; item.dataset.index=i;
      item.innerHTML=`<span class="saved-routine-title">${rt.title}</span><button class="delete-btn" data-index="${i}">X</button>`;
      routineList.appendChild(item);
    });
  };

  const createAndShowModal=(index)=>{
    const rt=routines[index]; const overlay=document.createElement('div'); overlay.className='modal-overlay';
    const content=document.createElement('div'); content.className='modal-content';
    const title=document.createElement('h3'); title.textContent=rt.title;
    const exDiv=document.createElement('div'); let total=0;
    rt.exercises.forEach(ex=>{const v=ex.weight*ex.reps*ex.sets; total+=v; const d=document.createElement('div'); d.className='modal-exercise-item'; d.innerHTML=`<span>${ex.name} (${ex.weight}kg x ${ex.reps}회 x ${ex.sets}세트)</span><span class="font-semibold">볼륨: ${v}</span>`; exDiv.appendChild(d);});
    const totalEl=document.createElement('p'); totalEl.className='total-volume'; totalEl.textContent=`총 볼륨: ${total}`;
    const closeBtn=document.createElement('button'); closeBtn.className='mt-6 w-full bg-gray-300 text-gray-800 p-2 rounded hover:bg-gray-400'; closeBtn.textContent='닫기';
    content.appendChild(title); content.appendChild(exDiv); content.appendChild(totalEl); content.appendChild(closeBtn); overlay.appendChild(content); document.body.appendChild(overlay);
    const closeModal=()=>{document.body.removeChild(overlay);};
    closeBtn.addEventListener('click',closeModal); overlay.addEventListener('click',e=>{if(e.target===overlay) closeModal();});
  };

  const addExercise=()=>{
    const name=exerciseSelect.value; const weight=parseFloat(weightInput.value)||0; const reps=parseInt(repsInput.value)||0; const sets=parseInt(setsInput.value)||0;
    if(!name||reps<=0||sets<=0){alert('운동, 횟수, 세트를 모두 입력해주세요.'); return;}
    currentExercises.push({name,weight,reps,sets}); displayCurrentExercises(); weightInput.value=''; repsInput.value=''; setsInput.value=''; weightInput.focus();
  };
  addExerciseBtn.addEventListener('click',addExercise);
  [weightInput,repsInput,setsInput].forEach(inp=>inp.addEventListener('keydown',e=>{if(e.key==='Enter') addExercise();}));

  saveRoutineBtn.addEventListener('click',()=>{
    const title=routineTitleInput.value.trim(); if(!title){alert('루틴 이름 입력'); return;} if(currentExercises.length===0){alert('운동 추가'); return;}
    routines.push({title,exercises:JSON.parse(JSON.stringify(currentExercises))}); currentExercises=[]; routineTitleInput.value=''; displayCurrentExercises(); displaySavedRoutines(); saveRoutinesToStorage(); alert('루틴 저장 완료');
  });

  routineList.addEventListener('click',e=>{
    const item=e.target.closest('.saved-routine-item'); if(!item) return;
    const index=Number(item.dataset.index);
    if(e.target.classList.contains('delete-btn')){e.stopPropagation(); if(confirm('삭제?')){routines.splice(index,1); displaySavedRoutines(); saveRoutinesToStorage();}}else{createAndShowModal(index);}
  });

  let draggedIndex=null;
  currentExercisesList.addEventListener('dragstart',e=>{const item=e.target.closest('.exercise-item'); if(!item) return; draggedIndex=Number(item.dataset.index); item.classList.add('dragging');});
  currentExercisesList.addEventListener('dragover',e=>{e.preventDefault();});
  const getDropIndex=(e)=>{
    const items=Array.from(currentExercisesList.querySelectorAll('.exercise-item:not(.dragging)')); if(items.length===0) return 0;
    const closest=items.reduce((closest,child)=>{const box=child.getBoundingClientRect(); const offset=e.clientY-box.top-box.height/2; if(offset<0&&offset>closest.offset) return {offset,element:child}; return closest;},{offset:Number.NEGATIVE_INFINITY}).element;
    return closest?items.indexOf(closest):items.length;
  };
  currentExercisesList.addEventListener('drop',e=>{e.preventDefault(); if(draggedIndex===null) return; const dropIndex=getDropIndex(e); const [moved]=currentExercises.splice(draggedIndex,1); currentExercises.splice(dropIndex,0,moved); draggedIndex=null; displayCurrentExercises();});
  currentExercisesList.addEventListener('dragend',()=>{document.querySelector('.exercise-item.dragging')?.classList.remove('dragging'); draggedIndex=null;});

  populateExercises(); loadRoutinesFromStorage(); displaySavedRoutines();
});
</script>
</body>
</html>
