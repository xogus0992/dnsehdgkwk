<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë‹¤ì´ì–´íŠ¸ ë‚´ë¹„ê²Œì´ì…˜ - Kakao ê¸¸ì°¾ê¸° ë²„ì „</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Noto Sans KR -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet" />
  <!-- Kakao Maps SDK (JavaScript í‚¤) -->
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c96c999113980d67c697b2f5a3d385f1&libraries=services"></script>
  <style>
    :root {
      --primary: #2563eb;
      --primary-soft: #dbeafe;
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --text-main: #111827;
      --text-sub: #6b7280;
      --danger: #ef4444;
      --success: #22c55e;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: "Noto Sans KR", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    body {
      display: flex;
      flex-direction: column;
    }

    .app-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 960px;
      margin: 0 auto;
      width: 100%;
      padding: 12px 12px 72px;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .section-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 16px 18px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
      border: 1px solid var(--border);
      margin-bottom: 16px;
    }

    .section-title {
      margin: 0 0 12px;
      font-size: 1.05rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title span.emoji {
      font-size: 1.2rem;
    }

    #map {
      width: 100%;
      height: 360px;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .form-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .form-row.column {
      flex-direction: column;
    }

    .input-group {
      flex: 1;
      position: relative;
    }

    label.input-label {
      display: block;
      font-size: 0.8rem;
      color: var(--text-sub);
      margin-bottom: 4px;
    }

    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
      background: #f9fafb;
    }

    input[type="text"]:focus,
    input[type="number"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.15);
      background: #ffffff;
    }

    .btn {
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--primary);
      color: #ffffff;
      box-shadow: 0 6px 14px rgba(37, 99, 235, 0.28);
    }

    .btn-primary:hover {
      background: #1d4ed8;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-secondary:hover {
      background: #d1d5db;
      transform: translateY(-1px);
    }

    .btn-ghost {
      background: #f9fafb;
      color: var(--text-sub);
      border: 1px dashed var(--border);
    }

    .btn-ghost:hover {
      background: #f3f4f6;
    }

    .btn-sm {
      padding: 7px 10px;
      font-size: 0.8rem;
      border-radius: 999px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .badge-outline {
      border: 1px solid var(--border);
      color: var(--text-sub);
    }

    .badge-primary {
      background: var(--primary-soft);
      color: var(--primary);
    }

    .text-sub {
      font-size: 0.8rem;
      color: var(--text-sub);
    }

    .route-summary {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: #f3f4f6;
      font-size: 0.78rem;
      color: #4b5563;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .pill strong {
      font-weight: 700;
    }

    .route-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .message {
      font-size: 0.82rem;
      margin-top: 6px;
    }

    .message.error {
      color: var(--danger);
    }

    .message.info {
      color: var(--text-sub);
    }

    #bottom-nav {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 60px;
      background: #ffffff;
      border-top: 1px solid var(--border);
      display: flex;
      z-index: 100;
      box-shadow: 0 -4px 12px rgba(15, 23, 42, 0.08);
    }

    .nav-btn {
      flex: 1;
      border: none;
      background: transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
      font-size: 0.75rem;
      color: var(--text-sub);
      cursor: pointer;
    }

    .nav-btn span.icon {
      font-size: 1.3rem;
    }

    .nav-btn.active {
      color: var(--primary);
      font-weight: 600;
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .history-item {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #ffffff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .history-main {
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 0;
    }

    .history-title {
      font-size: 0.9rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .history-meta {
      font-size: 0.75rem;
      color: var(--text-sub);
    }

    .group-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .group-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #ffffff;
    }

    .group-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #22c55e);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-size: 0.9rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    .group-info {
      flex: 1;
      min-width: 0;
    }

    .group-name {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .group-meta {
      font-size: 0.75rem;
      color: var(--text-sub);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 8px;
    }

    .stat-card {
      background: #f9fafb;
      border-radius: 12px;
      padding: 10px;
      border: 1px solid var(--border);
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-sub);
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 1rem;
      font-weight: 700;
    }

    .profile-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .profile-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    @media (min-width: 768px) {
      .app-container {
        padding: 16px 16px 80px;
      }
      #map {
        height: 420px;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div id="page-home" class="page active">
      <div class="section-card" style="margin-bottom: 12px;">
        <h2 class="section-title"><span class="emoji">ğŸ—ºï¸</span> ê²½ë¡œ ê²€ìƒ‰</h2>
        <div class="form-row">
          <div class="input-group">
            <label class="input-label">ì¶œë°œì§€</label>
            <input type="text" id="start-input" placeholder="ì˜ˆ: ì„œìš¸ì—­" />
          </div>
          <button id="btn-my-location" class="btn btn-secondary" style="align-self: flex-end;">
            ğŸ“ ë‚´ ìœ„ì¹˜
          </button>
        </div>
        <div class="form-row">
          <div class="input-group">
            <label class="input-label">ë„ì°©ì§€</label>
            <input type="text" id="end-input" placeholder="ì˜ˆ: ë‚¨ì‚°íƒ€ì›Œ" />
          </div>
        </div>
        <div class="form-row">
          <div class="input-group">
            <label class="input-label">ì™•ë³µ ë£¨í”„ ëª©í‘œ ê±°ë¦¬ (km, ì„ íƒ)</label>
            <input type="number" id="loop-distance" min="1" max="50" value="5" />
          </div>
        </div>
        <div class="form-row">
          <button id="btn-search-route" class="btn btn-primary" style="flex: 1;">
            ğŸš¶ ê²½ë¡œ ê¸¸ì°¾ê¸°
          </button>
          <button id="btn-loop-route" class="btn btn-ghost">
            â¬› ì‚¬ê°í˜• ì™•ë³µ ì½”ìŠ¤
          </button>
        </div>
        <div class="route-summary" id="route-summary"></div>
        <div class="route-actions">
          <div class="message info" id="route-message">ì¶œë°œì§€ì™€ ë„ì°©ì§€ë¥¼ ì…ë ¥í•˜ê³  ê²½ë¡œë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”.</div>
          <button id="btn-save-route" class="btn btn-sm btn-secondary" disabled>ğŸ’¾ ê¸°ë¡ ì €ì¥</button>
        </div>
      </div>
      <div class="section-card" style="padding: 10px;">
        <div id="map"></div>
      </div>
    </div>

    <div id="page-history" class="page">
      <div class="section-card">
        <h2 class="section-title"><span class="emoji">ğŸ“š</span> ë‚˜ì˜ ê¸°ë¡</h2>
        <p class="text-sub" style="margin-bottom: 8px;">
          ì €ì¥í•œ ì½”ìŠ¤ë¥¼ í•œëˆˆì— ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>
        <div id="history-list" class="history-list"></div>
        <div id="history-empty" class="text-sub" style="margin-top: 8px;">
          ì•„ì§ ì €ì¥ëœ ì½”ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>
      </div>
    </div>

    <div id="page-group" class="page">
      <div class="section-card">
        <h2 class="section-title"><span class="emoji">ğŸ‘¥</span> ê·¸ë£¹ ë­í‚¹</h2>
        <p class="text-sub" style="margin-bottom: 8px;">
          ì¹œêµ¬ë“¤ê³¼ ê·¸ë£¹ì„ ë§Œë“¤ì–´ ì˜¤ëŠ˜ì˜ ê±¸ìŒ ìˆ˜ì™€ ì½”ìŠ¤ ê¸¸ì´ë¥¼ ë¹„êµí•´ ë³´ì„¸ìš”. (ë°ëª¨ ë°ì´í„°)
        </p>
        <div class="group-list" id="group-list"></div>
      </div>
    </div>

    <div id="page-me" class="page">
      <div class="section-card">
        <h2 class="section-title"><span class="emoji">ğŸ‘¤</span> ë‚´ ì •ë³´</h2>
        <div class="profile-row">
          <div class="profile-avatar">ğŸ™‚</div>
          <div>
            <div style="font-weight: 600; font-size: 0.95rem;">ë‚˜ì˜ ê±·ê¸° í”„ë¡œí•„</div>
            <div class="text-sub" id="profile-sub">ì¹´ì¹´ì˜¤ ê¸¸ì°¾ê¸°ë¡œ ê±¸ìŒ ë°ì´í„°ë¥¼ ëª¨ìœ¼ëŠ” ì¤‘</div>
          </div>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">ëˆ„ì  ê±°ë¦¬</div>
            <div class="stat-value" id="stat-total-distance">0 km</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ëˆ„ì  ì‹œê°„</div>
            <div class="stat-value" id="stat-total-time">0 ë¶„</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ì €ì¥í•œ ì½”ìŠ¤</div>
            <div class="stat-value" id="stat-total-routes">0 ê°œ</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">í‰ê·  ê±°ë¦¬</div>
            <div class="stat-value" id="stat-avg-distance">0 km</div>
          </div>
        </div>
        <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
          <button id="btn-reset-stats" class="btn btn-ghost btn-sm">í†µê³„ ì´ˆê¸°í™”</button>
        </div>
      </div>
    </div>
  </div>

  <nav id="bottom-nav">
    <button class="nav-btn active" data-target="home">
      <span class="icon">ğŸ—ºï¸</span>
      <span>í™ˆ</span>
    </button>
    <button class="nav-btn" data-target="history">
      <span class="icon">ğŸ“š</span>
      <span>ê¸°ë¡</span>
    </button>
    <button class="nav-btn" data-target="group">
      <span class="icon">ğŸ‘¥</span>
      <span>ê·¸ë£¹</span>
    </button>
    <button class="nav-btn" data-target="me">
      <span class="icon">ğŸ‘¤</span>
      <span>ë‚´ ì •ë³´</span>
    </button>
  </nav>

  <script>
    const KAKAO_REST_API_KEY = "71b46fcb7202af130ab7c6c18bf5163a";

    let map;
    let placesService;
    let geocoder;
    let currentRoute = null;
    let routeOverlays = [];
    let routeHistory = [];

    function clearRouteOverlays() {
      routeOverlays.forEach((o) => o.setMap && o.setMap(null));
      routeOverlays = [];
    }

    function haversineDistance(lat1, lng1, lat2, lng2) {
      const R = 6371000;
      const toRad = (v) => (v * Math.PI) / 180;
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) *
          Math.cos(toRad(lat2)) *
          Math.sin(dLng / 2) *
          Math.sin(dLng / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function initMap() {
      const container = document.getElementById("map");
      const center = new kakao.maps.LatLng(37.5665, 126.9780);
      const options = { center, level: 4 };
      map = new kakao.maps.Map(container, options);
      placesService = new kakao.maps.services.Places();
      geocoder = new kakao.maps.services.Geocoder();

      const marker = new kakao.maps.Marker({ position: center, map: map });
      routeOverlays.push(marker);
    }

    function searchPlacePromise(query) {
      return new Promise((resolve, reject) => {
        if (!query || !query.trim()) {
          reject(new Error("ê²€ìƒ‰ì–´ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤."));
          return;
        }
        placesService.keywordSearch(
          query,
          (data, status) => {
            if (status === kakao.maps.services.Status.OK && data.length > 0) {
              resolve(data[0]);
            } else {
              reject(new Error("'" + query + "' ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤."));
            }
          },
          { size: 5 }
        );
      });
    }

    async function getCurrentLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error("ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."));
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            resolve({ lat, lng });
          },
          () => {
            reject(new Error("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."));
          },
          { enableHighAccuracy: true, timeout: 5000 }
        );
      });
    }

    async function callKakaoDirections(origin, destination, waypoints) {
      const params = new URLSearchParams();
      params.append("origin", origin.join(","));
      params.append("destination", destination.join(","));
      params.append("priority", "TIME");
      params.append("car_fuel", "GASOLINE");
      params.append("car_hipass", "false");
      params.append("alternatives", "false");
      params.append("road_details", "false");
      if (waypoints && waypoints.length > 0) {
        params.append(
          "waypoints",
          waypoints.map((w) => w.join(",")).join("|")
        );
      }

      const response = await fetch(
        "https://apis-navi.kakaomobility.com/v1/directions?" + params.toString(),
        {
          method: "GET",
          headers: { Authorization: "KakaoAK " + KAKAO_REST_API_KEY },
        }
      );

      if (!response.ok) {
        throw new Error("ê¸¸ì°¾ê¸° API ì˜¤ë¥˜: " + response.status);
      }
      const data = await response.json();
      if (!data.routes || data.routes.length === 0) {
        throw new Error("ê²½ë¡œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
      }
      return data.routes[0];
    }

    function drawRouteOnMap(route, labelOptions) {
      clearRouteOverlays();

      const bounds = new kakao.maps.LatLngBounds();
      const path = [];

      route.sections.forEach((section) => {
        section.roads.forEach((road) => {
          const v = road.vertexes;
          for (let i = 0; i < v.length; i += 2) {
            const lng = v[i];
            const lat = v[i + 1];
            const latlng = new kakao.maps.LatLng(lat, lng);
            path.push(latlng);
            bounds.extend(latlng);
          }
        });
      });

      if (path.length === 0) {
        throw new Error("ê²½ë¡œ ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
      }

      const polyline = new kakao.maps.Polyline({
        path,
        strokeWeight: 6,
        strokeColor: "#2563eb",
        strokeOpacity: 0.9,
        strokeStyle: "solid",
      });
      polyline.setMap(map);
      routeOverlays.push(polyline);

      const startMarker = new kakao.maps.Marker({ position: path[0], map });
      const endMarker = new kakao.maps.Marker({
        position: path[path.length - 1],
        map,
      });
      routeOverlays.push(startMarker, endMarker);

      if (labelOptions && labelOptions.startLabel) {
        const overlay = new kakao.maps.CustomOverlay({
          position: path[0],
          content:
            '<div style="padding:4px 8px;background:#111827;color:#fff;border-radius:999px;font-size:11px;">' +
            labelOptions.startLabel +
            "</div>",
          yAnchor: 1.5,
        });
        overlay.setMap(map);
        routeOverlays.push(overlay);
      }
      if (labelOptions && labelOptions.endLabel) {
        const overlay2 = new kakao.maps.CustomOverlay({
          position: path[path.length - 1],
          content:
            '<div style="padding:4px 8px;background:#111827;color:#fff;border-radius:999px;font-size:11px;">' +
            labelOptions.endLabel +
            "</div>",
          yAnchor: 1.5,
        });
        overlay2.setMap(map);
        routeOverlays.push(overlay2);
      }

      map.setBounds(bounds, 50, 50, 50, 50);
    }

    function updateRouteSummary(route, options) {
      const summary = route.summary || {};
      const distanceM = summary.distance || 0;
      const durationS = summary.duration || 0;
      const distanceKm = distanceM / 1000;
      const durationMin = Math.round(durationS / 60);
      const paceMinPerKm =
        distanceKm > 0 ? (durationMin / distanceKm).toFixed(1) : "-";

      const summaryEl = document.getElementById("route-summary");
      summaryEl.innerHTML =
        '<span class="pill"><strong>' +
        (options && options.label ? options.label : "ì¼ë°˜ ê²½ë¡œ") +
        "</strong></span>" +
        '<span class="pill">ê±°ë¦¬: <strong>' +
        distanceKm.toFixed(2) +
        ' km</strong></span>' +
        '<span class="pill">ì˜ˆìƒ ì‹œê°„: <strong>' +
        durationMin +
        " ë¶„</strong></span>" +
        '<span class="pill">í˜ì´ìŠ¤: <strong>' +
        paceMinPerKm +
        " ë¶„/km</strong></span>";

      const msgEl = document.getElementById("route-message");
      msgEl.textContent = "ê²½ë¡œê°€ ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤. ì§€ë„ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.";
      msgEl.className = "message info";

      currentRoute = {
        type: options && options.type ? options.type : "normal",
        label: options && options.label ? options.label : "ì¼ë°˜ ê²½ë¡œ",
        distance: distanceM,
        duration: durationS,
        createdAt: new Date(),
      };

      document.getElementById("btn-save-route").disabled = false;
      updateStatsPreview();
    }

    async function handleSearchRoute() {
      const startInput = document.getElementById("start-input").value.trim();
      const endInput = document.getElementById("end-input").value.trim();
      const msgEl = document.getElementById("route-message");
      msgEl.className = "message info";

      if (!startInput || !endInput) {
        msgEl.textContent = "ì¶œë°œì§€ì™€ ë„ì°©ì§€ë¥¼ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
        msgEl.className = "message error";
        return;
      }

      msgEl.textContent = "ê²½ë¡œë¥¼ ê²€ìƒ‰í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...";

      try {
        const startPlace = await searchPlacePromise(startInput);
        const endPlace = await searchPlacePromise(endInput);

        const origin = [parseFloat(startPlace.x), parseFloat(startPlace.y)];
        const destination = [parseFloat(endPlace.x), parseFloat(endPlace.y)];

        const route = await callKakaoDirections(origin, destination, null);
        drawRouteOnMap(route, { startLabel: "ì¶œë°œ", endLabel: "ë„ì°©" });
        updateRouteSummary(route, {
          label: "ì¹´ì¹´ì˜¤ ê¸¸ì°¾ê¸°",
          type: "normal",
        });
      } catch (err) {
        console.error(err);
        msgEl.textContent =
          err.message || "ê²½ë¡œ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        msgEl.className = "message error";
      }
    }

    async function handleLoopRoute() {
      const startInputValue = document.getElementById("start-input").value.trim();
      const loopDistanceKm = parseFloat(
        document.getElementById("loop-distance").value
      );
      const msgEl = document.getElementById("route-message");
      msgEl.className = "message info";

      if (!startInputValue) {
        msgEl.textContent = "ì¶œë°œì§€ë¥¼ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”.";
        msgEl.className = "message error";
        return;
      }
      if (isNaN(loopDistanceKm) || loopDistanceKm <= 0) {
        msgEl.textContent = "ìœ íš¨í•œ ì™•ë³µ ê±°ë¦¬(km)ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
        msgEl.className = "message error";
        return;
      }

      msgEl.textContent = "ì‚¬ê°í˜• ë£¨í”„ ì½”ìŠ¤ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...";

      try {
        const startPlace = await searchPlacePromise(startInputValue);
        const centerLat = parseFloat(startPlace.y);
        const centerLng = parseFloat(startPlace.x);

        const perimeterM = loopDistanceKm * 1000;
        const sideM = perimeterM / 4;

        const latPerDeg = 111000;
        const latDelta = sideM / latPerDeg;
        const lngPerDeg = 111000 * Math.cos((centerLat * Math.PI) / 180);
        const lngDelta = sideM / lngPerDeg;

        const p1 = { lat: centerLat + latDelta / 2, lng: centerLng - lngDelta / 2 };
        const p2 = { lat: centerLat + latDelta / 2, lng: centerLng + lngDelta / 2 };
        const p3 = { lat: centerLat - latDelta / 2, lng: centerLng + lngDelta / 2 };
        const p4 = { lat: centerLat - latDelta / 2, lng: centerLng - lngDelta / 2 };

        const points = [p1, p2, p3, p4, p1];

        const vertexes = [];
        let totalDist = 0;
        for (let i = 0; i < points.length; i++) {
          const { lng, lat } = points[i];
          vertexes.push(lng, lat);
          if (i > 0) {
            const prev = points[i - 1];
            totalDist += haversineDistance(prev.lat, prev.lng, lat, lng);
          }
        }

        const avgSpeedMps = (4.5 * 1000) / 3600;
        const durationSec = totalDist / avgSpeedMps;

        const route = {
          summary: {
            distance: Math.round(totalDist),
            duration: Math.round(durationSec),
          },
          sections: [
            {
              distance: Math.round(totalDist),
              duration: Math.round(durationSec),
              roads: [{ vertexes }],
            },
          ],
        };

        drawRouteOnMap(route, {
          startLabel: "ë£¨í”„ ì‹œì‘",
          endLabel: "ë£¨í”„ ì¢…ë£Œ",
        });
        updateRouteSummary(route, {
          label: "ì‚¬ê°í˜• ì™•ë³µ ë£¨í”„",
          type: "loop",
        });
      } catch (err) {
        console.error(err);
        msgEl.textContent =
          err.message ||
          "ë£¨í”„ ì½”ìŠ¤ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        msgEl.className = "message error";
      }
    }

    function saveCurrentRoute() {
      if (!currentRoute) return;
      routeHistory.push({ ...currentRoute });
      renderHistory();
      updateStatsPreview();
      const msgEl = document.getElementById("route-message");
      msgEl.textContent = "í˜„ì¬ ì½”ìŠ¤ë¥¼ ê¸°ë¡ì— ì €ì¥í–ˆìŠµë‹ˆë‹¤.";
      msgEl.className = "message info";
    }

    function renderHistory() {
      const listEl = document.getElementById("history-list");
      const emptyEl = document.getElementById("history-empty");
      listEl.innerHTML = "";

      if (routeHistory.length === 0) {
        emptyEl.style.display = "block";
        return;
      }
      emptyEl.style.display = "none";

      routeHistory
        .slice()
        .reverse()
        .forEach((item) => {
          const distanceKm = (item.distance / 1000).toFixed(2);
          const durationMin = Math.round(item.duration / 60);
          const dateStr = item.createdAt.toLocaleString("ko-KR");

          const div = document.createElement("div");
          div.className = "history-item";
          div.innerHTML =
            '<div class="history-main">' +
            '<div class="history-title">' +
            item.label +
            "</div>" +
            '<div class="history-meta">' +
            distanceKm +
            " km Â· " +
            durationMin +
            " ë¶„ Â· " +
            dateStr +
            "</div>" +
            "</div>" +
            '<span class="badge badge-outline">' +
            (item.type === "loop" ? "ë£¨í”„" : "ì¼ë°˜") +
            "</span>";
          listEl.appendChild(div);
        });
    }

    function initGroupDemo() {
      const groupData = [
        { name: "ê°•ì²  ì²´ë ¥ íŒ€", todayKm: 14.2, members: 8 },
        { name: "ì¶œí‡´ê·¼ ì›Œì»¤ìŠ¤", todayKm: 9.6, members: 5 },
        { name: "ì ì‹¬ ì‚°ì±…ëŸ¬", todayKm: 6.1, members: 4 },
      ];
      const listEl = document.getElementById("group-list");
      listEl.innerHTML = "";
      groupData.forEach((g, idx) => {
        const div = document.createElement("div");
        div.className = "group-item";
        div.innerHTML =
          '<div class="group-avatar">' +
          (idx + 1) +
          "</div>" +
          '<div class="group-info">' +
          '<div class="group-name">' +
          g.name +
          "</div>" +
          '<div class="group-meta">ì˜¤ëŠ˜ ëˆ„ì  ' +
          g.todayKm.toFixed(1) +
          " km Â· " +
          g.members +
          "ëª… ì°¸ì—¬</div>" +
          "</div>";
        listEl.appendChild(div);
      });
    }

    function updateStatsPreview() {
      let totalDistance = 0;
      let totalDuration = 0;
      routeHistory.forEach((r) => {
        totalDistance += r.distance || 0;
        totalDuration += r.duration || 0;
      });
      if (currentRoute) {
        totalDistance += currentRoute.distance || 0;
        totalDuration += currentRoute.duration || 0;
      }

      const totalKm = totalDistance / 1000;
      const totalMin = Math.round(totalDuration / 60);
      const count = routeHistory.length + (currentRoute ? 1 : 0);
      const avgKm = count > 0 ? totalKm / count : 0;

      document.getElementById("stat-total-distance").textContent =
        totalKm.toFixed(2) + " km";
      document.getElementById("stat-total-time").textContent =
        totalMin + " ë¶„";
      document.getElementById("stat-total-routes").textContent =
        count + " ê°œ";
      document.getElementById("stat-avg-distance").textContent =
        avgKm.toFixed(2) + " km";
    }

    function resetStats() {
      routeHistory = [];
      currentRoute = null;
      document.getElementById("route-summary").innerHTML = "";
      document.getElementById("route-message").textContent =
        "ì¶œë°œì§€ì™€ ë„ì°©ì§€ë¥¼ ì…ë ¥í•˜ê³  ê²½ë¡œë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”.";
      document.getElementById("route-message").className = "message info";
      document.getElementById("btn-save-route").disabled = true;
      renderHistory();
      updateStatsPreview();
    }

    function initTabNavigation() {
      const buttons = document.querySelectorAll("#bottom-nav .nav-btn");
      const pages = {
        home: document.getElementById("page-home"),
        history: document.getElementById("page-history"),
        group: document.getElementById("page-group"),
        me: document.getElementById("page-me"),
      };

      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          buttons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");

          const target = btn.getAttribute("data-target");
          Object.keys(pages).forEach((key) => {
            pages[key].classList.toggle("active", key === target);
          });
        });
      });
    }

    async function handleMyLocation() {
      const msgEl = document.getElementById("route-message");
      msgEl.className = "message info";
      msgEl.textContent = "í˜„ì¬ ìœ„ì¹˜ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...";

      const btn = document.getElementById("btn-my-location");
      btn.disabled = true;

      try {
        const { lat, lng } = await getCurrentLocation();
        const coord = new kakao.maps.LatLng(lat, lng);
        map.panTo(coord);

        const marker = new kakao.maps.Marker({ position: coord, map });
        routeOverlays.push(marker);

        geocoder.coord2Address(lng, lat, (result, status) => {
          if (status === kakao.maps.services.Status.OK && result[0]) {
            const address =
              (result[0].road_address && result[0].road_address.address_name) ||
              (result[0].address && result[0].address.address_name) ||
              "";
            document.getElementById("start-input").value =
              address || "ë‚´ ìœ„ì¹˜";
          } else {
            document.getElementById("start-input").value = "ë‚´ ìœ„ì¹˜";
          }
        });

        msgEl.textContent = "í˜„ì¬ ìœ„ì¹˜ë¥¼ ì¶œë°œì§€ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.";
      } catch (err) {
        msgEl.textContent =
          err.message || "í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
        msgEl.className = "message error";
      } finally {
        btn.disabled = false;
      }
    }

    document.addEventListener("DOMContentLoaded", function () {
      kakao.maps.load(function () {
        initMap();
      });

      initTabNavigation();
      initGroupDemo();
      updateStatsPreview();

      document
        .getElementById("btn-search-route")
        .addEventListener("click", handleSearchRoute);
      document
        .getElementById("btn-loop-route")
        .addEventListener("click", handleLoopRoute);
      document
        .getElementById("btn-save-route")
        .addEventListener("click", saveCurrentRoute);
      document
        .getElementById("btn-reset-stats")
        .addEventListener("click", resetStats);
      document
        .getElementById("btn-my-location")
        .addEventListener("click", handleMyLocation);
    });
  </script>
</body>
</html>
