<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>RunMate Â· ì†Œì…œ ëŸ¬ë‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet" />
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c96c999113980d67c697b2f5a3d385f1&libraries=services"></script>
  
  <style>
    :root {
      --primary: #0095f6;
      --bg: #ffffff;
      --border: #dbdbdb;
      --text-main: #262626;
      --text-sub: #8e8e8e;
      --danger: #ed4956;
      --story-ring: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
      --chat-me: #0095f6;
      --chat-other: #efefef;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; padding: 0; font-family: "Noto Sans KR", sans-serif;
      background: #fafafa; color: var(--text-main);
      height: 100vh; display: flex; flex-direction: column; overflow: hidden;
    }

    /* === í—¤ë” === */
    .app-header {
      height: 50px; background: #fff; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between; padding: 0 16px;
      font-weight: 700; font-size: 1.1rem; flex-shrink: 0; z-index: 50;
    }
    .header-btn { background:none; border:none; font-size:1.2rem; cursor:pointer; padding:0; color:var(--text-main); }

    /* === ë©”ì¸ ì»¨í…Œì´ë„ˆ === */
    .app-main { flex: 1; overflow-y: auto; position: relative; padding-bottom: 60px; background: #fff; }

    /* === ê³µí†µ UI === */
    .page { display: none; animation: fadeIn 0.2s; height: 100%; overflow-y: auto; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .btn {
      width: 100%; padding: 10px; border: none; border-radius: 8px;
      font-weight: 600; cursor: pointer; font-size: 0.9rem; margin-top: 8px;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: #efefef; color: var(--text-main); }
    .btn-outline { background: transparent; border: 1px solid var(--border); }

    .input-group { margin-bottom: 12px; }
    .form-input {
      width: 100%; padding: 12px; border: 1px solid var(--border);
      border-radius: 8px; background: #fafafa; outline: none; font-size: 0.95rem;
    }

    /* í•´ì‹œíƒœê·¸ ìŠ¤íƒ€ì¼ */
    .hashtag { color: #00376b; font-weight: 500; cursor: pointer; }
    
    /* === ì§€ë„ === */
    #map { width: 100%; height: 320px; background: #eee; }

    /* === í”„ë¡œí•„ (ì¸ìŠ¤íƒ€ ìŠ¤íƒ€ì¼) === */
    .profile-header { padding: 20px 16px 0; }
    .profile-top { display: flex; align-items: center; margin-bottom: 16px; }
    
    .avatar-wrap { margin-right: 20px; position: relative; }
    .avatar-ring {
      width: 84px; height: 84px; border-radius: 50%;
      background: var(--story-ring); padding: 2px;
    }
    .avatar-img {
      width: 100%; height: 100%; border-radius: 50%; border: 2px solid #fff;
      background: #eee; object-fit: cover;
    }
    
    .stats-wrap { flex: 1; display: flex; justify-content: space-around; text-align: center; }
    .stat-num { font-weight: 700; font-size: 1.1rem; display: block; }
    .stat-label { font-size: 0.8rem; color: var(--text-main); }

    .bio-wrap { font-size: 0.9rem; padding: 0 4px; margin-bottom: 16px; line-height: 1.4; }
    .bio-name { font-weight: 700; font-size: 0.95rem; }

    .profile-btns { display: flex; gap: 8px; margin-bottom: 16px; }
    .p-btn {
      flex: 1; background: #efefef; border: none; padding: 7px;
      border-radius: 6px; font-weight: 600; font-size: 0.9rem; cursor: pointer;
    }

    /* í•˜ì´ë¼ì´íŠ¸ */
    .highlights {
      display: flex; gap: 16px; overflow-x: auto; padding: 0 16px 16px;
      scrollbar-width: none; border-bottom: 1px solid #efefef;
    }
    .highlights::-webkit-scrollbar { display: none; }
    .hl-item { display: flex; flex-direction: column; align-items: center; min-width: 60px; cursor: pointer; }
    .hl-circle {
      width: 60px; height: 60px; border-radius: 50%; border: 1px solid #dbdbdb;
      padding: 3px; margin-bottom: 4px;
    }
    .hl-inner {
      width: 100%; height: 100%; border-radius: 50%; background: #fafafa; object-fit: cover;
      display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
    }
    .hl-text { font-size: 0.75rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 60px; }

    /* íƒ­ & ê·¸ë¦¬ë“œ */
    .profile-tabs { display: flex; border-bottom: 1px solid var(--border); }
    .p-tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: #aaa; }
    .p-tab.active { color: var(--text-main); border-bottom: 1px solid var(--text-main); }
    
    .grid-container {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; padding-bottom: 20px;
    }
    .grid-item {
      position: relative; padding-bottom: 100%; background: #eee; overflow: hidden; cursor: pointer;
    }
    .grid-item img { position: absolute; width: 100%; height: 100%; object-fit: cover; }
    .grid-icon { position: absolute; top: 6px; right: 6px; color: #fff; filter: drop-shadow(0 0 2px rgba(0,0,0,0.5)); font-size: 12px; }

    /* === í”¼ë“œ (ê²Œì‹œë¬¼) === */
    .feed-item { border-bottom: 1px solid #efefef; padding-bottom: 16px; margin-bottom: 16px; }
    .feed-header { display: flex; align-items: center; padding: 10px 16px; gap: 10px; }
    .feed-avatar { width: 32px; height: 32px; border-radius: 50%; background: #eee; object-fit: cover; }
    .feed-name { font-weight: 600; font-size: 0.9rem; }
    .feed-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #fafafa; }
    .feed-actions { padding: 10px 16px 6px; display: flex; gap: 16px; font-size: 1.5rem; }
    .feed-content { padding: 0 16px; font-size: 0.9rem; line-height: 1.4; }
    .course-tag { 
      display: inline-block; background: #e0f2fe; color: #0095f6; 
      padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; margin-top: 6px; cursor: pointer; font-weight: 600;
    }

    /* === ì±„íŒ… & ê·¸ë£¹ === */
    .chat-list-item {
      display: flex; align-items: center; padding: 12px 16px; gap: 12px; border-bottom: 1px solid #efefef; cursor: pointer;
    }
    .chat-avatar { width: 48px; height: 48px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
    
    .chat-room { display: flex; flex-direction: column; height: 100%; }
    .chat-msgs { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 10px; background: #fff; }
    .msg-bubble { max-width: 70%; padding: 10px 14px; border-radius: 18px; font-size: 0.9rem; line-height: 1.4; position: relative; word-break: break-word; }
    .msg-bubble.me { align-self: flex-end; background: var(--chat-me); color: white; border-bottom-right-radius: 4px; }
    .msg-bubble.other { align-self: flex-start; background: var(--chat-other); color: black; border-bottom-left-radius: 4px; }
    
    .course-share-card { background: white; color: black; border-radius: 8px; padding: 8px; margin-top: 4px; font-size: 0.8rem; border: 1px solid #eee; cursor: pointer; }
    
    .chat-input-area {
      padding: 10px; background: #fff; border-top: 1px solid var(--border); display: flex; gap: 8px; align-items: center;
    }
    .chat-input { flex: 1; border: 1px solid var(--border); border-radius: 20px; padding: 8px 16px; outline: none; }
    
    /* === ëª¨ë‹¬ (ë¦´ìŠ¤, ê¸€ì“°ê¸°) === */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: #fff; z-index: 200; flex-direction: column;
    }
    .modal-header {
      height: 50px; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; border-bottom: 1px solid var(--border); font-weight: 700;
    }

    /* í•˜ë‹¨ íƒ­ë°” */
    .tab-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: #fff; border-top: 1px solid var(--border);
      display: flex; height: 50px; z-index: 100; align-items: center;
    }
    .tab-item { flex: 1; display: flex; justify-content: center; align-items: center; color: #aaa; cursor: pointer; }
    .tab-item.active { color: var(--text-main); }
    .tab-item svg { width: 24px; height: 24px; stroke-width: 2; }
    .tab-item.active svg { stroke-width: 2.5; }
    
    /* íŒŒì¼ ì¸í’‹ ìˆ¨ê¹€ */
    #file-input, #post-file-input { display: none; }
  </style>
</head>
<body>

  <header class="app-header">
    <button class="header-btn" id="back-btn" style="display:none;">â†</button>
    <span id="header-title">RunMate</span>
    <button class="header-btn" id="write-btn" style="display:none;">â•</button>
  </header>

  <main class="app-main">
    
    <div id="page-home" class="page active">
      <div style="display:flex; border-bottom:1px solid #eee; margin-bottom:10px;">
        <div class="p-tab active" onclick="switchHomeTab('map')">ì½”ìŠ¤ ì°¾ê¸°</div>
        <div class="p-tab" onclick="switchHomeTab('feed')">í”¼ë“œ</div>
      </div>

      <div id="home-map-section">
        <div style="padding:0 16px;">
          <div class="input-group">
            <input type="text" id="start-input" class="form-input" placeholder="ì¶œë°œì§€ (ì˜ˆ: í•œê°•ê³µì›)" />
          </div>
          <div style="display:flex; gap:8px; margin-bottom:10px;">
            <input type="number" id="target-dist" class="form-input" value="3" placeholder="km" style="flex:1;" />
            <button id="btn-search" class="btn btn-primary" style="margin-top:0; flex:1;">ì½”ìŠ¤ ìƒì„±</button>
          </div>
        </div>
        <div id="map"></div>
        <div style="padding:16px;">
          <div id="route-info" style="font-size:0.9rem; margin-bottom:8px; color:#0095f6; font-weight:bold;"></div>
          <button id="btn-save" class="btn btn-secondary" disabled>ì´ ì½”ìŠ¤ ì €ì¥í•˜ê¸°</button>
        </div>
      </div>

      <div id="home-feed-section" style="display:none;">
        <div id="feed-list" style="padding-bottom:20px;">
          </div>
      </div>
    </div>

    <div id="page-group" class="page">
      <div style="padding:16px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee;">
        <h2 style="margin:0; font-size:1.2rem;">ëŸ¬ë‹ íŒŒí‹°</h2>
        <button class="btn btn-primary" style="width:auto; margin:0; padding:6px 12px; font-size:0.8rem;" onclick="createParty()">íŒŒí‹° ë§Œë“¤ê¸°</button>
      </div>
      <div id="party-list">
        </div>
    </div>

    <div id="page-me" class="page">
      <div class="profile-header">
        <div class="profile-top">
          <div class="avatar-wrap" onclick="document.getElementById('file-input').click()">
            <div class="avatar-ring">
              <img id="profile-img" src="https://via.placeholder.com/100?text=ME" class="avatar-img" />
            </div>
            <div style="position:absolute; bottom:0; right:0; background:#0095f6; color:white; border-radius:50%; width:24px; height:24px; text-align:center; line-height:22px; font-size:14px; border:2px solid white;">+</div>
          </div>
          <div class="stats-wrap">
            <div><span class="stat-num" id="p-count">0</span><span class="stat-label">ê²Œì‹œë¬¼</span></div>
            <div><span class="stat-num" id="p-km">0.0</span><span class="stat-label">ì´ km</span></div>
            <div><span class="stat-num">128</span><span class="stat-label">íŒ”ë¡œì›Œ</span></div>
          </div>
        </div>
        <div class="bio-wrap">
          <div class="bio-name" id="profile-name">ëŸ¬ë‹í•˜ëŠ” ë‹¤ì´ì–´í„°</div>
          <div id="profile-bio">ì˜¤ëŠ˜ë„ ë‹¬ë¦°ë‹¤... ğŸƒâ€â™‚ï¸ğŸ’¨<br>#ì˜¤ìš´ì™„ #ëŸ¬ë‹ìŠ¤íƒ€ê·¸ë¨</div>
        </div>
        <div class="profile-btns">
          <button class="p-btn" onclick="editProfile()">í”„ë¡œí•„ í¸ì§‘</button>
          <button class="p-btn" onclick="shareProfile()">ê³µìœ </button>
        </div>
      </div>

      <div class="highlights" id="highlight-list">
        <div class="hl-item" onclick="addHighlight()">
          <div class="hl-circle" style="border-color:#ccc;"><div class="hl-inner">â•</div></div>
          <span class="hl-text">ì‹ ê·œ</span>
        </div>
        </div>

      <div class="profile-tabs">
        <div class="p-tab active" onclick="switchProfileTab('grid')">ğŸ“¸</div>
        <div class="p-tab" onclick="switchProfileTab('reels')">ğŸ¬</div>
        <div class="p-tab" onclick="switchProfileTab('stats')">ğŸ“Š</div>
      </div>

      <div id="tab-grid" class="grid-container">
        </div>

      <div id="tab-reels" class="grid-container" style="display:none;">
        </div>

      <div id="tab-stats" style="display:none; padding:16px;">
        <canvas id="activityChart" height="200"></canvas>
        <div style="margin-top:20px;">
          <h3>ì €ì¥ëœ ì½”ìŠ¤</h3>
          <ul id="saved-course-list" style="padding-left:20px; color:#555;"></ul>
        </div>
        <button class="btn btn-outline" style="color:red; border-color:red; margin-top:20px;" onclick="resetAllData()">ì´ˆê¸°í™”</button>
      </div>
    </div>
    
    <div id="page-chat-room" class="page" style="background:#fff; z-index:60;">
      <div class="chat-room">
        <div class="chat-msgs" id="chat-msg-container"></div>
        
        <div id="course-select-panel" style="display:none; background:#f9f9f9; padding:10px; border-top:1px solid #eee; max-height:120px; overflow-y:auto;">
          <div style="font-size:0.8rem; color:#666; margin-bottom:5px;">ê³µìœ í•  ì½”ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”:</div>
          <div id="chat-course-list"></div>
        </div>

        <div class="chat-input-area">
          <button class="header-btn" onclick="toggleCourseSelect()">ğŸš©</button>
          <input type="text" class="chat-input" id="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." />
          <button class="btn-primary" style="width:auto; border-radius:20px; padding:8px 16px; margin:0;" onclick="sendMsg()">ì „ì†¡</button>
        </div>
      </div>
    </div>

  </main>

  <div id="post-modal" class="modal-overlay">
    <div class="modal-header">
      <span onclick="closePostModal()" style="cursor:pointer;">ì·¨ì†Œ</span>
      <span>ìƒˆ ê²Œì‹œë¬¼</span>
      <span onclick="submitPost()" style="color:#0095f6; cursor:pointer;">ê³µìœ </span>
    </div>
    <div style="flex:1; overflow-y:auto; padding:16px;">
      <div style="background:#eee; width:100%; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; margin-bottom:16px; border-radius:8px; overflow:hidden; cursor:pointer;" onclick="document.getElementById('post-file-input').click()">
        <img id="post-preview" style="width:100%; height:100%; object-fit:cover; display:none;" />
        <div id="post-placeholder" style="color:#888;">ğŸ“¸ ì‚¬ì§„ ì„ íƒ</div>
      </div>
      <textarea id="post-caption" class="form-input" rows="4" placeholder="ë¬¸êµ¬ ì…ë ¥... #ëŸ¬ë‹ #ì˜¤ìš´ì™„"></textarea>
      
      <div style="margin-top:16px;">
        <label style="font-size:0.9rem; font-weight:bold;">ì½”ìŠ¤ íƒœê·¸í•˜ê¸°</label>
        <select id="post-course-select" class="form-input" style="margin-top:8px;">
          <option value="">ì½”ìŠ¤ ì„ íƒ ì•ˆí•¨</option>
        </select>
      </div>
    </div>
  </div>

  <div id="reels-modal" class="modal-overlay" style="background:#000;">
    <div style="position:absolute; top:10px; left:10px; color:white; z-index:210; font-size:1.5rem; cursor:pointer;" onclick="closeReels()">âœ•</div>
    <div style="flex:1; display:flex; align-items:center; justify-content:center; width:100%; height:100%;">
      <iframe id="reels-iframe" width="100%" height="100%" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
    </div>
  </div>

  <input type="file" id="file-input" accept="image/*" onchange="handleProfileImage(this)" />
  <input type="file" id="post-file-input" accept="image/*" onchange="handlePostImage(this)" />

  <nav class="tab-nav" id="main-nav">
    <div class="tab-item active" onclick="goPage('home')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>
    </div>
    <div class="tab-item" onclick="goPage('group')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
    </div>
    <div class="tab-item" onclick="goPage('me')">
      <div style="width:24px; height:24px; border-radius:50%; border:1px solid #aaa; overflow:hidden;">
        <img id="nav-profile-img" src="https://via.placeholder.com/100?text=ME" style="width:100%; height:100%; object-fit:cover;">
      </div>
    </div>
  </nav>

  <script>
    // === ë°ì´í„° ìƒíƒœ ê´€ë¦¬ (Local Storage ì‹œëŠ‰) ===
    let user = {
      name: "ëŸ¬ë‹í•˜ëŠ” ë‹¤ì´ì–´í„°",
      bio: "ì˜¤ëŠ˜ë„ ë‹¬ë¦°ë‹¤... ğŸƒâ€â™‚ï¸ğŸ’¨\n#ì˜¤ìš´ì™„ #ëŸ¬ë‹ìŠ¤íƒ€ê·¸ë¨",
      img: null, // base64 string
      totalKm: 0,
      posts: [] 
    };

    let courses = []; // {id, title, dist, date}
    let feeds = [];   // {id, img, caption, courseId, date, user}
    let parties = [
      {id:1, title:"ğŸŒ… ìƒˆë²½ í•œê°• ëŸ¬ë‹", time:"06:00 AM", members:4, km:"5km"},
      {id:2, title:"ğŸŒ™ í‡´ê·¼ í›„ 3km", time:"08:00 PM", members:2, km:"3km"},
    ];
    let chatMsgs = []; // {text, isMe, type, courseData}

    // Kakao Map
    let map, ps, currentRoute;

    // === ì´ˆê¸°í™” ===
    window.onload = function() {
      kakao.maps.load(initMap);
      initChart();
      loadData(); // ë°ì´í„° ë¡œë“œ (ê°€ì •)
      renderFeeds();
      renderParties();
      renderGrid();
      renderReelsGrid();
      updateProfileUI();

      // í˜ì´ì§€ ì´ë²¤íŠ¸ ì—°ê²°
      document.getElementById('write-btn').addEventListener('click', openPostModal);
      document.getElementById('back-btn').addEventListener('click', handleBack);
    };

    // === ë„¤ë¹„ê²Œì´ì…˜ ===
    let historyStack = ['home'];

    function goPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-' + pageId).classList.add('active');
      document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
      
      // íƒ­ë°” ì•„ì´ì½˜ í™œì„±í™”
      if(pageId === 'home') document.querySelector('.tab-nav div:nth-child(1)').classList.add('active');
      if(pageId === 'group') document.querySelector('.tab-nav div:nth-child(2)').classList.add('active');
      if(pageId === 'me') document.querySelector('.tab-nav div:nth-child(3)').classList.add('active');

      // í—¤ë” ë²„íŠ¼ ìƒíƒœ
      const writeBtn = document.getElementById('write-btn');
      const backBtn = document.getElementById('back-btn');
      const title = document.getElementById('header-title');

      backBtn.style.display = 'none';
      document.getElementById('main-nav').style.display = 'flex';

      if(pageId === 'home') {
        title.textContent = "RunMate";
        writeBtn.style.display = 'block';
      } else if(pageId === 'group') {
        title.textContent = "ëŸ¬ë‹ íŒŒí‹°";
        writeBtn.style.display = 'none';
      } else if(pageId === 'me') {
        title.textContent = user.name;
        writeBtn.style.display = 'block';
      } else if(pageId === 'chat-room') {
        title.textContent = "ì±„íŒ…ë°©";
        writeBtn.style.display = 'none';
        backBtn.style.display = 'block';
        document.getElementById('main-nav').style.display = 'none';
      }
      
      // ì°¨íŠ¸ ë¦¬ì‚¬ì´ì¦ˆ
      if(pageId === 'me' && myChart) myChart.resize();
      if(pageId === 'home' && map) setTimeout(() => map.relayout(), 0);
    }

    function handleBack() {
      goPage('group'); // ê°„ë‹¨íˆ ê·¸ë£¹ìœ¼ë¡œ ëŒì•„ê°€ê¸° ì„¤ì •
    }

    // === í™ˆ íƒ­ (ì§€ë„/í”¼ë“œ) ===
    function switchHomeTab(tab) {
      document.querySelectorAll('#page-home .p-tab').forEach(el => el.classList.remove('active'));
      event.target.classList.add('active');
      if(tab === 'map') {
        document.getElementById('home-map-section').style.display = 'block';
        document.getElementById('home-feed-section').style.display = 'none';
        map.relayout();
      } else {
        document.getElementById('home-map-section').style.display = 'none';
        document.getElementById('home-feed-section').style.display = 'block';
      }
    }

    // === ì§€ë„ ë¡œì§ ===
    function initMap() {
      const container = document.getElementById('map');
      const options = { center: new kakao.maps.LatLng(37.5665, 126.9780), level: 5 };
      map = new kakao.maps.Map(container, options);
      ps = new kakao.maps.services.Places();
    }

    document.getElementById('btn-search').addEventListener('click', () => {
      const start = document.getElementById('start-input').value;
      if(!start) return alert('ì¶œë°œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
      
      ps.keywordSearch(start, (data, status) => {
        if(status === kakao.maps.services.Status.OK) {
          const coords = new kakao.maps.LatLng(data[0].y, data[0].x);
          map.setCenter(coords);
          new kakao.maps.Marker({ position: coords, map: map });
          
          const dist = parseFloat(document.getElementById('target-dist').value) || 3;
          const info = document.getElementById('route-info');
          info.innerHTML = `ğŸš© <b>${start}</b> ì¶œë°œ ${dist}km ì¶”ì²œ ì½”ìŠ¤ ìƒì„± ì™„ë£Œ!`;
          
          currentRoute = { 
            id: Date.now(),
            title: start + " " + dist + "km ì½”ìŠ¤", 
            dist: dist * 1000, 
            date: new Date().toLocaleDateString()
          };
          document.getElementById('btn-save').disabled = false;
        } else {
          alert('ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
      });
    });

    document.getElementById('btn-save').addEventListener('click', () => {
      if(!currentRoute) return;
      courses.push(currentRoute);
      user.totalKm += (currentRoute.dist/1000);
      alert('ì½”ìŠ¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ë§ˆì´í˜ì´ì§€ë‚˜ ì±„íŒ…ì—ì„œ ê³µìœ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      document.getElementById('btn-save').disabled = true;
      updateProfileUI();
    });

    // === í”„ë¡œí•„ & ê°¤ëŸ¬ë¦¬ ===
    function handleProfileImage(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          user.img = e.target.result;
          updateProfileUI();
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    function updateProfileUI() {
      if(user.img) {
        document.getElementById('profile-img').src = user.img;
        document.getElementById('nav-profile-img').src = user.img;
      }
      document.getElementById('profile-name').textContent = user.name;
      document.getElementById('profile-bio').innerHTML = user.bio.replace(/\n/g, '<br>');
      document.getElementById('p-count').textContent = feeds.length; // ê²Œì‹œë¬¼ ìˆ˜
      document.getElementById('p-km').textContent = user.totalKm.toFixed(1);
      
      // ì €ì¥ëœ ì½”ìŠ¤ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
      const ul = document.getElementById('saved-course-list');
      ul.innerHTML = "";
      courses.forEach(c => {
        ul.innerHTML += `<li>${c.title} (${c.date})</li>`;
      });
    }

    function editProfile() {
      const newName = prompt("ë‹‰ë„¤ì„ ë³€ê²½", user.name);
      if(newName) user.name = newName;
      const newBio = prompt("ìê¸°ì†Œê°œ ë³€ê²½", user.bio);
      if(newBio) user.bio = newBio;
      updateProfileUI();
    }
    
    function shareProfile() {
      alert("í”„ë¡œí•„ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! (í´ë¦½ë³´ë“œ)");
    }

    // === í”¼ë“œ(ê²Œì‹œë¬¼) ì‘ì„± ===
    function openPostModal() {
      document.getElementById('post-modal').style.display = 'flex';
      document.getElementById('post-preview').style.display = 'none';
      document.getElementById('post-placeholder').style.display = 'block';
      document.getElementById('post-file-input').value = "";
      
      // ì½”ìŠ¤ ì„ íƒ ì˜µì…˜ ì±„ìš°ê¸°
      const select = document.getElementById('post-course-select');
      select.innerHTML = '<option value="">ì½”ìŠ¤ ì„ íƒ ì•ˆí•¨</option>';
      courses.forEach((c, idx) => {
        select.innerHTML += `<option value="${idx}">${c.title}</option>`;
      });
    }

    function closePostModal() {
      document.getElementById('post-modal').style.display = 'none';
    }

    let currentPostImg = null;
    function handlePostImage(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          currentPostImg = e.target.result;
          document.getElementById('post-preview').src = e.target.result;
          document.getElementById('post-preview').style.display = 'block';
          document.getElementById('post-placeholder').style.display = 'none';
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    function submitPost() {
      if(!currentPostImg) return alert("ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
      const caption = document.getElementById('post-caption').value;
      const courseIdx = document.getElementById('post-course-select').value;
      const courseData = courseIdx !== "" ? courses[courseIdx] : null;

      const newFeed = {
        id: Date.now(),
        img: currentPostImg,
        caption: caption,
        course: courseData,
        user: user,
        date: new Date().toISOString()
      };
      
      feeds.unshift(newFeed); // ìµœì‹ ìˆœ
      user.posts.push(newFeed); // ë‚´ ê²Œì‹œë¬¼
      
      renderFeeds();
      renderGrid();
      closePostModal();
      updateProfileUI();
      goPage('home'); // í™ˆìœ¼ë¡œ ì´ë™
    }

    // === í”¼ë“œ ë Œë”ë§ ===
    function renderFeeds() {
      const list = document.getElementById('feed-list');
      list.innerHTML = "";
      
      feeds.forEach(feed => {
        // í•´ì‹œíƒœê·¸ ì²˜ë¦¬
        const formattedCaption = feed.caption.replace(/#(\S+)/g, '<span class="hashtag">#$1</span>');
        const courseTag = feed.course ? `<div class="course-tag" onclick="alert('ì½”ìŠ¤ ì •ë³´: ${feed.course.title}')">ğŸ“ ${feed.course.title}</div>` : '';
        const userImg = feed.user.img || "https://via.placeholder.com/100";

        const html = `
          <div class="feed-item">
            <div class="feed-header">
              <img class="feed-avatar" src="${userImg}">
              <div class="feed-name">${feed.user.name}</div>
            </div>
            <img class="feed-img" src="${feed.img}">
            <div class="feed-actions">
              <span>â¤ï¸</span> <span>ğŸ’¬</span> <span>âœˆï¸</span>
            </div>
            <div class="feed-content">
              <div><b>${feed.user.name}</b> ${formattedCaption}</div>
              ${courseTag}
            </div>
          </div>
        `;
        list.innerHTML += html;
      });
    }

    // === í”„ë¡œí•„ íƒ­ ë¡œì§ ===
    function switchProfileTab(tab) {
      document.getElementById('tab-grid').style.display = 'none';
      document.getElementById('tab-reels').style.display = 'none';
      document.getElementById('tab-stats').style.display = 'none';
      
      if(tab === 'grid') document.getElementById('tab-grid').style.display = 'grid';
      if(tab === 'reels') document.getElementById('tab-reels').style.display = 'grid';
      if(tab === 'stats') document.getElementById('tab-stats').style.display = 'block';
    }

    function renderGrid() {
      const container = document.getElementById('tab-grid');
      container.innerHTML = "";
      // ë‚´ ê²Œì‹œë¬¼(user.posts) ì—­ìˆœ í‘œì‹œ
      [...user.posts].reverse().forEach(post => {
        container.innerHTML += `
          <div class="grid-item">
            <img src="${post.img}">
          </div>
        `;
      });
      // ë¹ˆ ìƒíƒœë©´ ë”ë¯¸
      if(user.posts.length === 0) {
        for(let i=0; i<3; i++) {
          container.innerHTML += `<div class="grid-item" style="background:#eee;"></div>`;
        }
      }
    }

    // === ë¦´ìŠ¤ (Shorts) ===
    // ì‹¤ì œ ì‘ë™í•˜ëŠ” ìœ íŠœë¸Œ ëŸ¬ë‹ ì‡¼ì¸  ID
    const shortsIds = ["ZfFvjC-JmXk", "S3xL4dK2G-M", "L8H2K5f2Wj8", "Vq7L5P-X1s0", "wXk5_8k7h8Q", "7j5tq3m_1w0"];
    
    function renderReelsGrid() {
      const container = document.getElementById('tab-reels');
      container.innerHTML = "";
      shortsIds.forEach(id => {
        container.innerHTML += `
          <div class="grid-item" onclick="openReels('${id}')">
            <img src="https://img.youtube.com/vi/${id}/hqdefault.jpg">
            <span class="grid-icon">â–¶ 2.1k</span>
          </div>
        `;
      });
    }

    function openReels(id) {
      document.getElementById('reels-modal').style.display = 'flex';
      document.getElementById('reels-iframe').src = `https://www.youtube.com/embed/${id}?autoplay=1&rel=0&loop=1&playlist=${id}`;
    }
    function closeReels() {
      document.getElementById('reels-modal').style.display = 'none';
      document.getElementById('reels-iframe').src = "";
    }

    // === í•˜ì´ë¼ì´íŠ¸ ===
    function addHighlight() {
      const name = prompt("í•˜ì´ë¼ì´íŠ¸ ì´ë¦„");
      if(name) {
        const container = document.getElementById('highlight-list');
        const div = document.createElement('div');
        div.className = 'hl-item';
        div.innerHTML = `
          <div class="hl-circle"><div class="hl-inner">ğŸƒâ€â™‚ï¸</div></div>
          <span class="hl-text">${name}</span>
        `;
        container.appendChild(div);
      }
    }

    // === ê·¸ë£¹ & ì±„íŒ… ===
    function renderParties() {
      const list = document.getElementById('party-list');
      list.innerHTML = "";
      parties.forEach(p => {
        list.innerHTML += `
          <div class="chat-list-item" onclick="enterChat('${p.title}')">
            <div class="chat-avatar">ğŸƒ</div>
            <div style="flex:1;">
              <div style="font-weight:bold;">${p.title}</div>
              <div style="font-size:0.8rem; color:#666;">${p.time} Â· ${p.km} Â· ${p.members}ëª… ì°¸ì—¬ ì¤‘</div>
            </div>
            <button class="btn-primary" style="width:auto; padding:6px 12px; margin:0; border-radius:20px;">ì°¸ì—¬</button>
          </div>
        `;
      });
    }

    function createParty() {
      const title = prompt("íŒŒí‹° ì´ë¦„ (ì˜ˆ: í•œê°• ë²ˆê°œ)");
      if(title) {
        parties.push({id: Date.now(), title: title, time:"ì‹œê°„ë¯¸ì •", members:1, km:"?"});
        renderParties();
      }
    }

    function enterChat(title) {
      goPage('chat-room');
      document.getElementById('header-title').textContent = title;
      renderMessages();
    }

    function renderMessages() {
      const container = document.getElementById('chat-msg-container');
      container.innerHTML = "";
      chatMsgs.forEach(msg => {
        let content = msg.text;
        // ì½”ìŠ¤ ê³µìœ  ë©”ì‹œì§€ì¸ ê²½ìš° UI ë‹¤ë¥´ê²Œ
        if(msg.type === 'course') {
          content = `
            <div style="font-weight:bold; margin-bottom:4px;">ğŸƒ ëŸ¬ë‹ ì½”ìŠ¤ ê³µìœ </div>
            <div class="course-share-card" onclick="alert('${msg.courseData.title} ìƒì„¸ ë³´ê¸°')">
              <div style="font-weight:bold;">${msg.courseData.title}</div>
              <div>ê±°ë¦¬: ${(msg.courseData.dist/1000).toFixed(1)}km</div>
              <div style="color:#0095f6;">ìì„¸íˆ ë³´ê¸° ></div>
            </div>
          `;
        }

        container.innerHTML += `
          <div class="msg-bubble ${msg.isMe ? 'me' : 'other'}">
            ${content}
          </div>
        `;
      });
      container.scrollTop = container.scrollHeight;
    }

    function sendMsg() {
      const input = document.getElementById('chat-input');
      const text = input.value.trim();
      if(!text) return;
      
      chatMsgs.push({ text: text, isMe: true, type: 'text' });
      input.value = "";
      renderMessages();
      
      // ìë™ ì‘ë‹µ ì‹œë®¬ë ˆì´ì…˜
      setTimeout(() => {
        chatMsgs.push({ text: "ì¢‹ì•„ìš”! ê°™ì´ ë›°ì–´ìš” ğŸ”¥", isMe: false, type: 'text' });
        renderMessages();
      }, 1000);
    }

    function toggleCourseSelect() {
      const panel = document.getElementById('course-select-panel');
      const list = document.getElementById('chat-course-list');
      
      if(panel.style.display === 'none') {
        if(courses.length === 0) return alert("ì €ì¥ëœ ì½”ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.");
        panel.style.display = 'block';
        list.innerHTML = "";
        courses.forEach((c, idx) => {
          list.innerHTML += `
            <div style="padding:6px; border-bottom:1px solid #eee; cursor:pointer;" onclick="shareCourse(${idx})">
              <b>${c.title}</b> (${(c.dist/1000).toFixed(1)}km)
            </div>
          `;
        });
      } else {
        panel.style.display = 'none';
      }
    }

    function shareCourse(idx) {
      const c = courses[idx];
      chatMsgs.push({ text: "", isMe: true, type: 'course', courseData: c });
      document.getElementById('course-select-panel').style.display = 'none';
      renderMessages();
    }

    // === ì°¨íŠ¸ & ê¸°íƒ€ ===
    let myChart;
    function initChart() {
      const ctx = document.getElementById('activityChart').getContext('2d');
      myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'],
          datasets: [{ label:'km', data:[3,0,5,2,0,7,0], backgroundColor:'#0095f6', borderRadius:4 }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: {display:false} },
          scales: { x:{grid:{display:false}}, y:{beginAtZero:true} }
        }
      });
    }

    function resetAllData() {
      if(confirm("ì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        user.posts = [];
        courses = [];
        feeds = [];
        user.totalKm = 0;
        chatMsgs = [];
        location.reload(); // ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ê¹”ë”í•˜ê²Œ
      }
    }

    function loadData() {
      // ë”ë¯¸ í”¼ë“œ 1ê°œ ì¶”ê°€
      feeds.push({
        id: 999,
        img: "https://images.unsplash.com/photo-1452626038306-9aae5e071dd3?w=600&q=80",
        caption: "ì•„ì¹¨ ì¡°ê¹… ìƒì¾Œí•˜ë‹¤! #MorningRun",
        user: { name: "RunHelper", img: null },
        course: null
      });
    }
  </script>
</body>
</html>