<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>RunMate : Diet & Social</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet" />
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c96c999113980d67c697b2f5a3d385f1&libraries=services"></script>

  <style>
    /* =========================================
       [1ë²ˆ ë””ìì¸ ë² ì´ìŠ¤] : ì „ì²´ í…Œë§ˆ ë° ë ˆì´ì•„ì›ƒ
       ========================================= */
    :root {
      --bg-main: #f4f7ff;
      --bg-card: #ffffff;
      --accent: #2f6bff; /* ë©”ì¸ ë¸”ë£¨ */
      --accent-soft: rgba(47, 107, 255, 0.12);
      --text-main: #111827;
      --text-sub: #6b7280;
      --border-soft: #e5e7eb;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.08);
      --radius-lg: 18px;
      --radius-pill: 999px;
      
      /* ì¸ìŠ¤íƒ€ ìŠ¤íƒ€ì¼ ì¶”ê°€ ë³€ìˆ˜ */
      --story-ring: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
      --chat-me: #2f6bff;
      --chat-other: #efefef;
      --danger: #ed4956;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: 'Noto Sans KR', sans-serif;
      background: radial-gradient(circle at top left, #e0ebff, #f8f9ff 40%, #eef3ff 70%, #e5ecff);
      color: var(--text-main);
      height: 100vh; display: flex; flex-direction: column; overflow: hidden;
    }

    /* í—¤ë” */
    .app-header {
      height: 60px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between;
      background: linear-gradient(90deg, #2f6bff, #4f8dff); color: #fff;
      box-shadow: 0 4px 20px rgba(47, 107, 255, 0.25); z-index: 50; flex-shrink: 0;
    }
    .app-title { font-size: 18px; font-weight: 700; }
    .header-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 13px; }

    /* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */
    .app-main { flex: 1; overflow-y: auto; padding-bottom: 70px; position: relative; }
    
    .page { display: none; padding: 20px; animation: fadeIn 0.3s ease; height: 100%; overflow-y: auto; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* ì¹´ë“œ ìŠ¤íƒ€ì¼ (1ë²ˆ ë””ìì¸) */
    .card {
      background: var(--bg-card); border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft); padding: 20px; margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.6);
    }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .card-title { font-size: 16px; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 8px; }
    .dot { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; }

    /* ì…ë ¥ í¼ */
    .text-input {
      width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border-soft);
      background: #f9fafb; outline: none; font-size: 14px; transition: 0.2s;
    }
    .text-input:focus { border-color: var(--accent); background: #fff; box-shadow: 0 0 0 3px var(--accent-soft); }
    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #4f46e5); color: white;
      border: none; padding: 12px; border-radius: var(--radius-pill);
      width: 100%; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    
    /* =========================================
       [2ë²ˆ & 3ë²ˆ ê¸°ëŠ¥ í†µí•©] : ì†Œì…œ, í”„ë¡œí•„, í”¼ë“œ
       ========================================= */
    
    /* íƒ­ ë°” (í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜) */
    .tab-nav {
      position: fixed; bottom: 0; left: 0; right: 0; height: 65px;
      background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
      border-top: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-around;
      align-items: center; z-index: 100; padding-bottom: 5px;
    }
    .tab-item {
      display: flex; flex-direction: column; align-items: center; gap: 4px;
      color: #9ca3af; cursor: pointer; flex: 1;
    }
    .tab-item svg { width: 24px; height: 24px; stroke-width: 2; }
    .tab-item.active { color: var(--accent); }
    .tab-label { font-size: 10px; font-weight: 600; }

    /* í”„ë¡œí•„ (ì¸ìŠ¤íƒ€ ìŠ¤íƒ€ì¼ + 1ë²ˆ ë””ìì¸ í„°ì¹˜) */
    .profile-header-wrap { display: flex; align-items: center; margin-bottom: 20px; }
    .avatar-wrap { position: relative; margin-right: 20px; cursor: pointer; }
    .avatar-ring {
      width: 88px; height: 88px; border-radius: 50%; padding: 3px;
      background: var(--story-ring);
    }
    .avatar-img {
      width: 100%; height: 100%; border-radius: 50%; border: 3px solid #fff;
      object-fit: cover; background: #eee;
    }
    .stats-row { flex: 1; display: flex; justify-content: space-around; text-align: center; }
    .stat-num { font-size: 18px; font-weight: 700; color: var(--text-main); }
    .stat-lbl { font-size: 12px; color: var(--text-sub); }

    .bio-section { margin-bottom: 20px; padding: 0 5px; }
    .bio-name { font-weight: 700; font-size: 15px; }
    .bio-text { font-size: 14px; color: #374151; white-space: pre-line; margin-top: 4px; }

    .action-btns { display: flex; gap: 10px; margin-bottom: 20px; }
    .btn-soft {
      flex: 1; padding: 8px; background: #f3f4f6; border: none; border-radius: 8px;
      font-weight: 600; color: #374151; cursor: pointer; font-size: 13px;
    }

    /* í•˜ì´ë¼ì´íŠ¸ */
    .highlights-scroll {
      display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px;
      scrollbar-width: none;
    }
    .hl-item { display: flex; flex-direction: column; align-items: center; min-width: 64px; cursor: pointer; }
    .hl-circle {
      width: 60px; height: 60px; border-radius: 50%; border: 1px solid #e5e7eb;
      padding: 2px; margin-bottom: 5px; display: flex; align-items: center; justify-content: center;
      background: #fff; font-size: 24px;
    }
    .hl-text { font-size: 11px; color: var(--text-main); }

    /* ê·¸ë¦¬ë“œ & íƒ­ */
    .profile-tabs { display: flex; border-bottom: 1px solid var(--border-soft); margin-bottom: 2px; }
    .p-tab { flex: 1; text-align: center; padding: 12px; cursor: pointer; color: #9ca3af; }
    .p-tab.active { border-bottom: 2px solid var(--text-main); color: var(--text-main); }
    
    .grid-view { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; }
    .grid-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #eee; cursor: pointer; position: relative; }
    .grid-icon { position: absolute; top: 5px; right: 5px; color: white; font-size: 12px; text-shadow: 0 0 2px rgba(0,0,0,0.5); }

    /* í”¼ë“œ ìŠ¤íƒ€ì¼ */
    .feed-item { background: #fff; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #eee; overflow: hidden; }
    .feed-header { padding: 12px 15px; display: flex; align-items: center; gap: 10px; }
    .feed-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
    .feed-user { font-weight: 600; font-size: 14px; }
    .feed-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; }
    .feed-actions { padding: 12px 15px 5px; display: flex; gap: 15px; font-size: 22px; }
    .feed-content { padding: 0 15px 15px; font-size: 14px; line-height: 1.5; }
    .course-pill { 
      display: inline-block; background: var(--accent-soft); color: var(--accent);
      padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; margin-top: 8px; cursor: pointer;
    }
    .hashtag { color: #00376b; cursor: pointer; }

    /* ì§€ë„ (Leaflet - 1ë²ˆ ì†ŒìŠ¤) */
    .map-wrapper { height: 400px; border-radius: 16px; overflow: hidden; position: relative; z-index: 1; margin-bottom: 15px; box-shadow: inset 0 0 20px rgba(0,0,0,0.1); }
    #map { width: 100%; height: 100%; }

    /* ì±„íŒ…ë°© */
    .chat-room { display: flex; flex-direction: column; height: 100%; background: #fff; }
    .chat-msgs { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #f9fafb; }
    .msg { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 14px; line-height: 1.4; position: relative; word-break: break-word; }
    .msg.me { align-self: flex-end; background: var(--chat-me); color: white; border-bottom-right-radius: 4px; }
    .msg.other { align-self: flex-start; background: var(--chat-other); color: #111; border-bottom-left-radius: 4px; }
    .chat-input-bar { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 8px; background: #fff; }

    /* ëª¨ë‹¬ (ê¸€ì“°ê¸°, ë¦´ìŠ¤) */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: #fff; z-index: 200; flex-direction: column;
    }
    .modal-dark { background: #000; color: #fff; }
    .modal-header { height: 50px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #eee; font-weight: 700; }
    
    /* íŒŒì¼ ì¸í’‹ ìˆ¨ê¹€ */
    #file-input, #post-file-input { display: none; }
  </style>
</head>
<body>

  <header class="app-header">
    <button class="header-btn" id="back-btn" style="display:none; font-size:18px;">â†</button>
    <div class="app-title" id="header-title">RunMate</div>
    <button class="header-btn" id="write-btn" style="display:none;">+ ê²Œì‹œë¬¼</button>
  </header>

  <main class="app-main">
    
    <div id="page-home" class="page active">
      <div style="display:flex; background:#fff; padding:5px; border-radius:12px; margin-bottom:15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
        <button class="btn-soft" onclick="switchHomeView('map')" id="btn-view-map" style="background:var(--accent); color:#fff;">ğŸ—ºï¸ ì½”ìŠ¤ ì°¾ê¸°</button>
        <button class="btn-soft" onclick="switchHomeView('feed')" id="btn-view-feed" style="background:transparent;">ğŸ“± í”¼ë“œ</button>
      </div>

      <div id="view-map">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><span class="dot"></span>ëŸ¬ë‹ ì½”ìŠ¤ ìƒì„±</h2>
          </div>
          <div style="display:flex; flex-direction:column; gap:10px;">
            <input type="text" id="start-input" class="text-input" placeholder="ì¶œë°œì§€ ê²€ìƒ‰ (ì˜ˆ: ì—¬ì˜ë„ í•œê°•ê³µì›)" />
            <div style="display:flex; gap:10px;">
              <input type="number" id="target-distance" class="text-input" value="3" placeholder="ëª©í‘œ km" style="flex:1;" />
              <select id="route-mode" class="text-input" style="flex:1;">
                <option value="loop">ì™•ë³µ ë£¨í”„</option>
                <option value="one-way">ì¼ì ì½”ìŠ¤</option>
              </select>
            </div>
            <div style="display:flex; gap:10px; margin-top:5px;">
              <button id="btn-gen-route" class="btn-primary">ì½”ìŠ¤ ìƒì„±</button>
              <button id="btn-save-route" class="btn-soft" disabled style="flex:1; background:#e0f2fe; color:#0095f6;">ì½”ìŠ¤ ì €ì¥</button>
            </div>
          </div>
        </div>

        <div class="map-wrapper">
          <div id="map"></div>
        </div>
        
        <div class="card" id="route-info-card" style="display:none;">
          <div class="card-title">ì½”ìŠ¤ ì •ë³´</div>
          <div style="display:flex; justify-content:space-between; margin-top:10px;">
            <span>ì´ ê±°ë¦¬: <b id="info-dist">0km</b></span>
            <span>ì˜ˆìƒ ì‹œê°„: <b id="info-time">0ë¶„</b></span>
          </div>
        </div>
      </div>

      <div id="view-feed" style="display:none;">
        <div id="feed-list">
          </div>
      </div>
    </div>

    <div id="page-group" class="page">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title"><span class="dot"></span>ëŸ¬ë‹ íŒŒí‹°</h2>
          <button class="btn-soft" style="width:auto; padding:5px 12px;" onclick="createParty()">+ íŒŒí‹° ë§Œë“¤ê¸°</button>
        </div>
        <div id="party-list" style="display:flex; flex-direction:column; gap:10px;">
          </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h2 class="card-title"><span class="dot"></span>ì¸ê¸° í¬ë£¨ ë­í‚¹</h2>
        </div>
        <div style="font-size:13px; color:#666;">
          <div style="padding:8px 0; border-bottom:1px dashed #eee;">ğŸ¥‡ ìƒˆë²½ ëŸ¬ë‹ë°˜ (1,204km)</div>
          <div style="padding:8px 0; border-bottom:1px dashed #eee;">ğŸ¥ˆ í‡´ê·¼ í›„ 3km (890km)</div>
          <div style="padding:8px 0;">ğŸ¥‰ ì£¼ë§ ë“±ì‚°ëŸ¬ (540km)</div>
        </div>
      </div>
    </div>

    <div id="page-me" class="page">
      <div class="card">
        <div class="profile-header-wrap">
          <div class="avatar-wrap" onclick="document.getElementById('file-input').click()">
            <div class="avatar-ring">
              <img id="profile-img" src="https://via.placeholder.com/150?text=ME" class="avatar-img" />
            </div>
            <div style="position:absolute; bottom:0; right:0; background:var(--accent); color:white; width:24px; height:24px; border-radius:50%; text-align:center; line-height:22px; border:2px solid #fff;">+</div>
          </div>
          <div class="stats-row">
            <div><div class="stat-num" id="stat-posts">0</div><div class="stat-lbl">ê²Œì‹œë¬¼</div></div>
            <div><div class="stat-num" id="stat-km">0.0</div><div class="stat-lbl">ì´ km</div></div>
            <div><div class="stat-num">128</div><div class="stat-lbl">íŒ”ë¡œì›Œ</div></div>
          </div>
        </div>
        
        <div class="bio-section">
          <div class="bio-name" id="profile-name">ëŸ¬ë‹í•˜ëŠ” ê°œë°œì</div>
          <div class="bio-text" id="profile-bio">ì˜¤ëŠ˜ë„ ë‹¬ë¦°ë‹¤... ğŸƒâ€â™‚ï¸ğŸ’¨<br>#ì˜¤ìš´ì™„ #ëŸ¬ë‹ìŠ¤íƒ€ê·¸ë¨</div>
        </div>

        <div class="action-btns">
          <button class="btn-soft" onclick="editProfile()">í”„ë¡œí•„ í¸ì§‘</button>
          <button class="btn-soft" onclick="alert('ë§í¬ ë³µì‚¬ë¨')">í”„ë¡œí•„ ê³µìœ </button>
        </div>

        <div class="highlights-scroll" id="highlight-list">
          <div class="hl-item" onclick="addHighlight()">
            <div class="hl-circle" style="border:1px dashed #ccc;">+</div>
            <span class="hl-text">ì‹ ê·œ</span>
          </div>
          </div>
      </div>

      <div class="card" style="padding:0; overflow:hidden;">
        <div class="profile-tabs">
          <div class="p-tab active" onclick="switchProfileTab('grid', this)">ğŸ“¸</div>
          <div class="p-tab" onclick="switchProfileTab('reels', this)">ğŸ¬</div>
          <div class="p-tab" onclick="switchProfileTab('stats', this)">ğŸ“Š</div>
        </div>

        <div id="tab-grid" class="grid-view" style="padding:2px;">
          </div>
        <div id="tab-reels" class="grid-view" style="display:none; padding:2px;">
          </div>
        <div id="tab-stats" style="display:none; padding:20px;">
          <canvas id="activityChart"></canvas>
          <div style="margin-top:20px;">
            <h4>ğŸ“ ì €ì¥ëœ ì½”ìŠ¤</h4>
            <ul id="saved-courses-list" style="padding-left:20px; font-size:13px; color:#555;"></ul>
          </div>
          <button class="btn-soft" style="width:100%; margin-top:15px; color:var(--danger);" onclick="resetData()">ë°ì´í„° ì´ˆê¸°í™”</button>
        </div>
      </div>
    </div>

    <div id="page-chat-room" class="page" style="padding:0; background:#fff; z-index:60;">
      <div class="chat-room">
        <div class="chat-msgs" id="chat-msgs-container"></div>
        
        <div id="course-share-panel" style="display:none; padding:10px; background:#f0f9ff; border-top:1px solid #eee;">
          <div style="font-size:12px; color:#666; margin-bottom:5px;">ê³µìœ í•  ì½”ìŠ¤ ì„ íƒ:</div>
          <div id="chat-course-list" style="display:flex; gap:10px; overflow-x:auto;"></div>
        </div>

        <div class="chat-input-bar">
          <button class="header-btn" style="background:#eee; color:#333;" onclick="toggleCourseShare()">ğŸ“</button>
          <input type="text" id="chat-input" class="text-input" style="border-radius:20px; padding:8px 15px;" placeholder="ë©”ì‹œì§€ ì…ë ¥..." />
          <button class="btn-primary" style="width:auto; padding:8px 15px; margin:0;" onclick="sendMsg()">ì „ì†¡</button>
        </div>
      </div>
    </div>

  </main>

  <div id="post-modal" class="modal-overlay">
    <div class="modal-header">
      <span onclick="closePostModal()" style="cursor:pointer;">ì·¨ì†Œ</span>
      <span>ìƒˆ ê²Œì‹œë¬¼</span>
      <span onclick="submitPost()" style="color:var(--accent); cursor:pointer;">ê³µìœ </span>
    </div>
    <div style="padding:20px;">
      <div style="width:100%; aspect-ratio:1/1; background:#f3f4f6; border-radius:12px; display:flex; align-items:center; justify-content:center; overflow:hidden; cursor:pointer;" onclick="document.getElementById('post-file-input').click()">
        <img id="post-preview" style="width:100%; height:100%; object-fit:cover; display:none;" />
        <div id="post-placeholder" style="color:#999;">ğŸ“¸ ì‚¬ì§„ ì„ íƒ (ê°¤ëŸ¬ë¦¬)</div>
      </div>
      <textarea id="post-caption" class="text-input" rows="4" style="margin-top:15px;" placeholder="ë¬¸êµ¬ ì…ë ¥... #ì˜¤ìš´ì™„"></textarea>
      
      <div style="margin-top:15px;">
        <label style="font-size:13px; font-weight:600;">ì½”ìŠ¤ íƒœê·¸</label>
        <select id="post-course-select" class="text-input" style="margin-top:5px;">
          <option value="">ì„ íƒ ì•ˆ í•¨</option>
        </select>
      </div>
    </div>
  </div>

  <div id="reels-modal" class="modal-overlay modal-dark">
    <div style="position:absolute; top:15px; left:15px; font-size:24px; cursor:pointer; z-index:210;" onclick="closeReels()">âœ•</div>
    <iframe id="reels-iframe" width="100%" height="100%" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
  </div>

  <input type="file" id="file-input" accept="image/*" onchange="handleProfileImg(this)" />
  <input type="file" id="post-file-input" accept="image/*" onchange="handlePostImg(this)" />

  <nav class="tab-nav" id="main-nav">
    <div class="tab-item active" onclick="goPage('home')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
      <span class="tab-label">í™ˆ</span>
    </div>
    <div class="tab-item" onclick="goPage('group')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
      <span class="tab-label">ê·¸ë£¹</span>
    </div>
    <div class="tab-item" onclick="goPage('me')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
      <span class="tab-label">ë§ˆì´</span>
    </div>
  </nav>

  <script>
    // ==================================================
    // [ì „ì—­ ì„¤ì • ë° ë°ì´í„° ìƒíƒœ]
    // ==================================================
    const ORS_API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6Ijk3NTU2OTk1ODQ1NjQ0YWE5NzA3ZTM1OWExMGE3NTU4IiwiaCI6Im11cm11cjY0In0="; 
    
    // ì‚¬ìš©ì ë°ì´í„° (ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì‹œë®¬ë ˆì´ì…˜)
    let user = {
      name: "ëŸ¬ë‹í•˜ëŠ” ê°œë°œì",
      bio: "ì˜¤ëŠ˜ë„ ë‹¬ë¦°ë‹¤... ğŸƒâ€â™‚ï¸ğŸ’¨\n#ì˜¤ìš´ì™„ #ëŸ¬ë‹ìŠ¤íƒ€ê·¸ë¨",
      img: null, 
      totalKm: 0,
      posts: []
    };
    
    // ì €ì¥ëœ ì½”ìŠ¤ ë°ì´í„°
    let savedCourses = [];
    // ì „ì²´ í”¼ë“œ ë°ì´í„°
    let feeds = [];
    // ì±„íŒ… ë©”ì‹œì§€
    let chatMsgs = [];

    let map, routeLayer;
    let currentRouteGeoJSON = null;
    let currentRouteSummary = null; // {dist, time}

    // ==================================================
    // [ì§€ë„ ë¡œì§] - 1ë²ˆ ì†ŒìŠ¤ (Leaflet + ORS) í™œìš©
    // ==================================================
    function initMap() {
      // Leaflet ì§€ë„ ìƒì„±
      map = L.map("map", { zoomControl: false }).setView([37.5665, 126.9780], 14);
      
      L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
        attribution: '&copy; OpenStreetMap, &copy; CARTO'
      }).addTo(map);

      routeLayer = L.geoJSON(null, {
        style: { color: "#2f6bff", weight: 5, opacity: 0.8 }
      }).addTo(map);

      // ë‚´ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° ì‹œë„
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const { latitude, longitude } = pos.coords;
          map.setView([latitude, longitude], 15);
          // ì—­ì§€ì˜¤ì½”ë”©ì€ ìƒëµí•˜ê³  ì‹œì‘ ìœ„ì¹˜ ë§ˆì»¤ í‘œì‹œ ê°€ëŠ¥
        });
      }
    }

    // ì¹´ì¹´ì˜¤ ì¥ì†Œ ê²€ìƒ‰ + ORS ê²½ë¡œ ìƒì„±
    document.getElementById("btn-gen-route").addEventListener("click", async () => {
      const startVal = document.getElementById("start-input").value;
      const distVal = parseFloat(document.getElementById("target-distance").value);
      const mode = document.getElementById("route-mode").value;

      if (!startVal) return alert("ì¶œë°œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      if (!distVal) return alert("ëª©í‘œ ê±°ë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

      // 1. ì¹´ì¹´ì˜¤ APIë¡œ ì¶œë°œì§€ ì¢Œí‘œ ì–»ê¸°
      const ps = new kakao.maps.services.Places();
      ps.keywordSearch(startVal, async (data, status) => {
        if (status === kakao.maps.services.Status.OK) {
          const startLat = parseFloat(data[0].y);
          const startLng = parseFloat(data[0].x);
          
          map.setView([startLat, startLng], 15);

          // 2. ORS APIë¡œ ê²½ë¡œ ìƒì„± (ëœë¤ ë£¨í”„ ë¡œì§ ê°„ì†Œí™”: ì‚¬ê°í˜• í¬ì¸íŠ¸ ìƒì„±)
          try {
            const points = generateLoopPoints(startLat, startLng, distVal, mode);
            const geojson = await fetchORSRoute(points);
            
            // ì§€ë„ì— í‘œì‹œ
            routeLayer.clearLayers();
            routeLayer.addData(geojson);
            map.fitBounds(routeLayer.getBounds(), { padding: [20, 20] });

            // ì •ë³´ í‘œì‹œ
            const props = geojson.features[0].properties;
            const distKm = (props.summary.distance / 1000).toFixed(2);
            const timeMin = Math.round(props.summary.duration / 60);
            
            document.getElementById("route-info-card").style.display = "block";
            document.getElementById("info-dist").textContent = distKm + "km";
            document.getElementById("info-time").textContent = timeMin + "ë¶„";
            
            // í˜„ì¬ ê²½ë¡œ ì„ì‹œ ì €ì¥
            currentRouteGeoJSON = geojson;
            currentRouteSummary = { 
              title: `${startVal} ${distKm}km ì½”ìŠ¤`,
              dist: props.summary.distance,
              time: timeMin,
              date: new Date().toLocaleDateString()
            };
            document.getElementById("btn-save-route").disabled = false;
            document.getElementById("btn-save-route").style.background = "#2f6bff";
            document.getElementById("btn-save-route").style.color = "#fff";

          } catch (e) {
            console.error(e);
            alert("ê²½ë¡œ ìƒì„± ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
          }
        } else {
          alert("ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
      });
    });

    // ORS ìš”ì²­ í•¨ìˆ˜
    async function fetchORSRoute(points) {
      const coords = points.map(p => [p.lng, p.lat]);
      const body = { coordinates: coords };
      
      const res = await fetch("https://api.openrouteservice.org/v2/directions/foot-walking/geojson", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": ORS_API_KEY },
        body: JSON.stringify(body)
      });
      if (!res.ok) throw new Error("API Error");
      return await res.json();
    }

    // ê°„ë‹¨ ì¢Œí‘œ ê³„ì‚° (Loop Points)
    function generateLoopPoints(lat, lng, km, mode) {
      if (mode === 'one-way') {
        // ì¼ìì˜ ê²½ìš° ì„ì˜ì˜ ë¶ë™ìª½ ì§€ì ìœ¼ë¡œ (ë‹¨ìˆœí™”)
        const offset = km / 111; 
        return [{lat, lng}, {lat: lat + offset/1.5, lng: lng + offset/1.5}];
      }
      // ì‚¬ê°í˜• ë£¨í”„
      const side = (km / 4) / 111; // ëŒ€ëµì  ë„ ë‹¨ìœ„ ë³€í™˜
      return [
        {lat, lng},
        {lat: lat + side, lng},
        {lat: lat + side, lng: lng + side},
        {lat, lng: lng + side},
        {lat, lng}
      ];
    }

    // ì½”ìŠ¤ ì €ì¥ ë²„íŠ¼
    document.getElementById("btn-save-route").addEventListener("click", () => {
      if (!currentRouteSummary) return;
      
      savedCourses.push(currentRouteSummary);
      user.totalKm += (currentRouteSummary.dist / 1000);
      
      alert("ì½”ìŠ¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ë§ˆì´í˜ì´ì§€ë‚˜ í”¼ë“œì—ì„œ í™•ì¸í•˜ì„¸ìš”.");
      document.getElementById("btn-save-route").disabled = true;
      document.getElementById("btn-save-route").style.background = "#e0f2fe";
      document.getElementById("btn-save-route").style.color = "#0095f6";
      
      updateProfileUI();
    });

    // ==================================================
    // [ì†Œì…œ & í”¼ë“œ ë¡œì§] - 3ë²ˆ ì†ŒìŠ¤ í†µí•©
    // ==================================================
    
    // í™ˆ ë·° ì „í™˜ (ì§€ë„ vs í”¼ë“œ)
    function switchHomeView(view) {
      if(view === 'map') {
        document.getElementById('view-map').style.display = 'block';
        document.getElementById('view-feed').style.display = 'none';
        document.getElementById('btn-view-map').style.background = 'var(--accent)';
        document.getElementById('btn-view-map').style.color = '#fff';
        document.getElementById('btn-view-feed').style.background = 'transparent';
        document.getElementById('btn-view-feed').style.color = '#333';
        if(map) map.invalidateSize();
      } else {
        document.getElementById('view-map').style.display = 'none';
        document.getElementById('view-feed').style.display = 'block';
        document.getElementById('btn-view-feed').style.background = 'var(--accent)';
        document.getElementById('btn-view-feed').style.color = '#fff';
        document.getElementById('btn-view-map').style.background = 'transparent';
        document.getElementById('btn-view-map').style.color = '#333';
        renderFeeds();
      }
    }

    // í”¼ë“œ ë Œë”ë§
    function renderFeeds() {
      const list = document.getElementById('feed-list');
      list.innerHTML = "";
      
      // ìµœì‹ ìˆœ ì •ë ¬
      const allFeeds = [...feeds].reverse();
      
      // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë”ë¯¸ í•˜ë‚˜ ë³´ì—¬ì£¼ê¸°
      if(allFeeds.length === 0) {
        list.innerHTML = `<div style="text-align:center; padding:30px; color:#999;">ì•„ì§ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ê²Œì‹œë¬¼ì„ ì˜¬ë ¤ë³´ì„¸ìš”!</div>`;
        return;
      }

      allFeeds.forEach(feed => {
        const courseHTML = feed.course ? `<div class="course-pill">ğŸ“ ${feed.course.title}</div>` : '';
        const captionHTML = feed.caption.replace(/#(\S+)/g, '<span class="hashtag">#$1</span>');
        const userImg = feed.user.img || "https://via.placeholder.com/50?text=U";

        const html = `
          <div class="feed-item">
            <div class="feed-header">
              <img src="${userImg}" class="feed-avatar">
              <div class="feed-user">${feed.user.name}</div>
            </div>
            <img src="${feed.img}" class="feed-img">
            <div class="feed-actions">
              <span>â¤ï¸</span> <span>ğŸ’¬</span> <span>âœˆï¸</span>
            </div>
            <div class="feed-content">
              <div><b>${feed.user.name}</b> ${captionHTML}</div>
              ${courseHTML}
            </div>
          </div>
        `;
        list.innerHTML += html;
      });
    }

    // ê²Œì‹œë¬¼ ì‘ì„± (ëª¨ë‹¬)
    function openPostModal() {
      document.getElementById('post-modal').style.display = 'flex';
      // ì½”ìŠ¤ ì„ íƒ ì…€ë ‰íŠ¸ë°•ìŠ¤ ê°±ì‹ 
      const sel = document.getElementById('post-course-select');
      sel.innerHTML = '<option value="">ì„ íƒ ì•ˆ í•¨</option>';
      savedCourses.forEach((c, idx) => {
        sel.innerHTML += `<option value="${idx}">${c.title}</option>`;
      });
    }
    function closePostModal() { document.getElementById('post-modal').style.display = 'none'; }
    
    let postTempImg = null;
    function handlePostImg(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
          postTempImg = e.target.result;
          document.getElementById('post-preview').src = postTempImg;
          document.getElementById('post-preview').style.display = 'block';
          document.getElementById('post-placeholder').style.display = 'none';
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    function submitPost() {
      if(!postTempImg) return alert("ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
      const caption = document.getElementById('post-caption').value;
      const courseIdx = document.getElementById('post-course-select').value;
      const course = courseIdx !== "" ? savedCourses[courseIdx] : null;

      const newFeed = {
        id: Date.now(),
        user: user,
        img: postTempImg,
        caption: caption,
        course: course,
        date: new Date()
      };

      feeds.push(newFeed);
      user.posts.push(newFeed);
      
      closePostModal();
      // ì…ë ¥ ì´ˆê¸°í™”
      document.getElementById('post-caption').value = "";
      postTempImg = null;
      document.getElementById('post-preview').style.display = 'none';
      document.getElementById('post-placeholder').style.display = 'block';
      
      updateProfileUI();
      switchHomeView('feed'); // í”¼ë“œë¡œ ì´ë™
      goPage('home');
    }

    // ==================================================
    // [í”„ë¡œí•„ & ê°¤ëŸ¬ë¦¬] - 2ë²ˆ ì†ŒìŠ¤ í†µí•©
    // ==================================================
    function handleProfileImg(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
          user.img = e.target.result;
          updateProfileUI();
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    function updateProfileUI() {
      if(user.img) document.getElementById('profile-img').src = user.img;
      document.getElementById('profile-name').textContent = user.name;
      document.getElementById('profile-bio').innerHTML = user.bio.replace(/\n/g, '<br>');
      document.getElementById('stat-posts').textContent = user.posts.length;
      document.getElementById('stat-km').textContent = user.totalKm.toFixed(1);

      // ì €ì¥ëœ ì½”ìŠ¤ ë¦¬ìŠ¤íŠ¸ (Stats íƒ­)
      const ul = document.getElementById('saved-courses-list');
      ul.innerHTML = "";
      savedCourses.forEach(c => {
        ul.innerHTML += `<li>${c.title} (${c.date})</li>`;
      });

      // ê·¸ë¦¬ë“œ íƒ­ ì—…ë°ì´íŠ¸
      const grid = document.getElementById('tab-grid');
      grid.innerHTML = "";
      [...user.posts].reverse().forEach(p => {
        grid.innerHTML += `<div class="grid-img" style="background-image:url('${p.img}'); background-size:cover;"></div>`;
      });
    }

    function editProfile() {
      const name = prompt("ë³€ê²½í•  ë‹‰ë„¤ì„", user.name);
      if(name) user.name = name;
      const bio = prompt("ë³€ê²½í•  ìê¸°ì†Œê°œ", user.bio);
      if(bio) user.bio = bio;
      updateProfileUI();
    }

    function switchProfileTab(tab, el) {
      document.querySelectorAll('.p-tab').forEach(e => e.classList.remove('active'));
      el.classList.add('active');
      
      document.getElementById('tab-grid').style.display = 'none';
      document.getElementById('tab-reels').style.display = 'none';
      document.getElementById('tab-stats').style.display = 'none';
      
      document.getElementById('tab-' + tab).style.display = (tab === 'grid' || tab === 'reels') ? 'grid' : 'block';
    }

    // í•˜ì´ë¼ì´íŠ¸ ì¶”ê°€
    function addHighlight() {
      const name = prompt("í•˜ì´ë¼ì´íŠ¸ ì´ë¦„");
      if(name) {
        const hl = document.createElement('div');
        hl.className = 'hl-item';
        hl.innerHTML = `<div class="hl-circle">â¤ï¸</div><span class="hl-text">${name}</span>`;
        document.getElementById('highlight-list').appendChild(hl);
      }
    }

    // ==================================================
    // [ê·¸ë£¹ & ì±„íŒ…]
    // ==================================================
    let parties = [
      {id:1, title:"í•œê°• 6ì‹œ ë²™ê°œ", info:"6ëª… ì°¸ì—¬ì¤‘"},
      {id:2, title:"ì£¼ë§ 10k ì±Œë¦°ì§€", info:"2ëª… ì°¸ì—¬ì¤‘"}
    ];

    function renderParties() {
      const list = document.getElementById('party-list');
      list.innerHTML = "";
      parties.forEach(p => {
        list.innerHTML += `
          <div style="display:flex; align-items:center; padding:10px; border-bottom:1px solid #eee; cursor:pointer;" onclick="enterChat('${p.title}')">
            <div style="width:40px; height:40px; background:#eee; border-radius:50%; display:flex; align-items:center; justify-content:center;">ğŸƒ</div>
            <div style="margin-left:10px; flex:1;">
              <div style="font-weight:bold; font-size:14px;">${p.title}</div>
              <div style="font-size:12px; color:#888;">${p.info}</div>
            </div>
            <button class="btn-soft" style="width:auto;">ì…ì¥</button>
          </div>
        `;
      });
    }

    function createParty() {
      const title = prompt("íŒŒí‹° ì´ë¦„");
      if(title) {
        parties.push({id:Date.now(), title:title, info:"1ëª… ì°¸ì—¬ì¤‘"});
        renderParties();
      }
    }

    function enterChat(title) {
      goPage('chat-room');
      document.getElementById('header-title').textContent = title;
      document.getElementById('back-btn').style.display = 'block';
      document.getElementById('main-nav').style.display = 'none'; // ì±„íŒ…ë°©ì—ì„  íƒ­ë°” ìˆ¨ê¹€
      
      // ì±„íŒ…ë°© ë“¤ì–´ì˜¤ë©´ ê¸°ì¡´ ë©”ì‹œì§€ ë Œë”ë§ (ì—¬ê¸°ì„  ë°ëª¨ë¼ ë¦¬ì…‹ ì•ˆí•¨)
    }

    function sendMsg() {
      const input = document.getElementById('chat-input');
      const text = input.value.trim();
      if(!text) return;
      
      addChatMsg(text, true);
      input.value = "";
      
      // ìë™ ì‘ë‹µ
      setTimeout(() => {
        addChatMsg("ë°˜ê°‘ìŠµë‹ˆë‹¤! ê°™ì´ ë‹¬ë ¤ìš” ğŸ”¥", false);
      }, 1000);
    }

    function addChatMsg(text, isMe, type = 'text') {
      const container = document.getElementById('chat-msgs-container');
      const div = document.createElement('div');
      div.className = `msg ${isMe ? 'me' : 'other'}`;
      div.innerHTML = text;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    function toggleCourseShare() {
      const panel = document.getElementById('course-share-panel');
      const list = document.getElementById('chat-course-list');
      
      if(panel.style.display === 'none') {
        if(savedCourses.length === 0) return alert("ì €ì¥ëœ ì½”ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.");
        panel.style.display = 'block';
        list.innerHTML = "";
        savedCourses.forEach(c => {
          list.innerHTML += `
            <div style="min-width:120px; padding:8px; background:#fff; border:1px solid #ddd; border-radius:8px; cursor:pointer;" onclick="shareCourseChat('${c.title}', '${(c.dist/1000).toFixed(1)}km')">
              <div style="font-weight:bold; font-size:12px;">${c.title}</div>
              <div style="font-size:11px; color:#666;">${(c.dist/1000).toFixed(1)}km</div>
            </div>
          `;
        });
      } else {
        panel.style.display = 'none';
      }
    }

    function shareCourseChat(title, dist) {
      addChatMsg(`<b>ğŸš© ì½”ìŠ¤ ê³µìœ </b><br>${title}<br>ê±°ë¦¬: ${dist}`, true);
      document.getElementById('course-share-panel').style.display = 'none';
    }

    // ==================================================
    // [ë¦´ìŠ¤ & ì°¨íŠ¸ & í˜ì´ì§€ ì´ë™]
    // ==================================================
    
    // ë¦´ìŠ¤ ë”ë¯¸ ë°ì´í„°
    const reelIds = ["ZfFvjC-JmXk", "L8H2K5f2Wj8", "S3xL4dK2G-M", "wXk5_8k7h8Q"];
    function initReels() {
      const grid = document.getElementById('tab-reels');
      reelIds.forEach(id => {
        grid.innerHTML += `
          <div class="grid-img" style="background-image:url('https://img.youtube.com/vi/${id}/hqdefault.jpg'); background-size:cover;" onclick="openReels('${id}')">
            <span class="grid-icon">â–¶</span>
          </div>
        `;
      });
    }
    function openReels(id) {
      document.getElementById('reels-modal').style.display = 'flex';
      document.getElementById('reels-iframe').src = `https://www.youtube.com/embed/${id}?autoplay=1&rel=0&loop=1&playlist=${id}`;
    }
    function closeReels() {
      document.getElementById('reels-modal').style.display = 'none';
      document.getElementById('reels-iframe').src = "";
    }

    // ì°¨íŠ¸ ì´ˆê¸°í™”
    let myChart;
    function initChart() {
      const ctx = document.getElementById('activityChart').getContext('2d');
      myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'],
          datasets: [{ label:'km', data:[3,2.5,0,4,1,5,0], backgroundColor:'#2f6bff', borderRadius:4 }]
        },
        options: { responsive:true, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}} }
      });
    }

    // ë„¤ë¹„ê²Œì´ì…˜
    function goPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-' + pageId).classList.add('active');
      
      document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
      // íƒ­ë°” í™œì„±í™” ì²˜ë¦¬
      if(pageId === 'home') document.querySelector('.tab-nav div:nth-child(1)').classList.add('active');
      if(pageId === 'group') document.querySelector('.tab-nav div:nth-child(2)').classList.add('active');
      if(pageId === 'me') document.querySelector('.tab-nav div:nth-child(3)').classList.add('active');

      // í—¤ë” ìƒíƒœ ê´€ë¦¬
      const title = document.getElementById('header-title');
      const writeBtn = document.getElementById('write-btn');
      const backBtn = document.getElementById('back-btn');
      const nav = document.getElementById('main-nav');

      backBtn.style.display = 'none';
      nav.style.display = 'flex';

      if(pageId === 'home') {
        title.textContent = "RunMate";
        writeBtn.style.display = 'block';
        if(map) map.invalidateSize();
      } else if(pageId === 'group') {
        title.textContent = "ê·¸ë£¹";
        writeBtn.style.display = 'none';
      } else if(pageId === 'me') {
        title.textContent = user.name;
        writeBtn.style.display = 'block';
        if(myChart) myChart.resize();
      } else if(pageId === 'chat-room') {
        // ì±„íŒ…ë°©ì€ ë³„ë„ ì²˜ë¦¬
        writeBtn.style.display = 'none';
      }
    }

    // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ (ì±„íŒ…ë°©ì—ì„œ ë‚˜ì˜¬ ë•Œ)
    document.getElementById('back-btn').addEventListener('click', () => {
      goPage('group');
    });

    // ê¸€ì“°ê¸° ë²„íŠ¼
    document.getElementById('write-btn').addEventListener('click', openPostModal);

    // ì´ˆê¸°í™”
    window.onload = function() {
      initMap();
      initChart();
      initReels();
      renderParties();
      updateProfileUI();
      
      // ê°¤ëŸ¬ë¦¬ ë”ë¯¸ ì´ë¯¸ì§€ í•˜ë‚˜ ì¶”ê°€
      feeds.push({
        id:999, user:{name:"ê´€ë¦¬ì", img:null},
        img:"https://images.unsplash.com/photo-1452626038306-9aae5e071dd3?w=600&q=80",
        caption:"RunMateì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! #ì²«ê²Œì‹œë¬¼",
        course:null, date:new Date()
      });
      renderFeeds();
    };

    function resetData() {
      if(confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) location.reload();
    }
  </script>
</body>
</html>