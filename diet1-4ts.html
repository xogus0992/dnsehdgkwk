<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë‹¤ì´ì–´íŠ¸ ë‚´ë¹„ê²Œì´ì…˜ Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet" />
  
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c96c999113980d67c697b2f5a3d385f1&libraries=services"></script>
  
  <style>
    /* --- ê³µí†µ ë³€ìˆ˜ ë° Reset (diet1 ê¸°ë°˜) --- */
    :root {
      --primary: #2563eb;
      --primary-soft: #dbeafe;
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --text-main: #111827;
      --text-sub: #6b7280;
      --danger: #ef4444;
      --success: #22c55e;
    }

    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: "Noto Sans KR", sans-serif;
      background: var(--bg); color: var(--text-main);
    }
    body { display: flex; flex-direction: column; }

    /* --- ë ˆì´ì•„ì›ƒ ì»¨í…Œì´ë„ˆ --- */
    .app-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 600px; /* ëª¨ë°”ì¼ ë·° ìµœì í™” */
      margin: 0 auto;
      width: 100%;
      padding: 12px 12px 80px; /* í•˜ë‹¨ íƒ­ë°” ê³µê°„ í™•ë³´ */
      overflow-y: auto;
    }

    .page { display: none; animation: fadeIn 0.2s; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* --- ì¹´ë“œ ìŠ¤íƒ€ì¼ (diet1) --- */
    .section-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      border: 1px solid var(--border);
      margin-bottom: 16px;
    }
    .section-title {
      margin: 0 0 12px; font-size: 1.1rem; font-weight: 700;
      display: flex; align-items: center; gap: 8px;
    }

    /* --- ì§€ë„ ê´€ë ¨ (diet1) --- */
    #map {
      width: 100%; height: 360px;
      border-radius: 12px; border: 1px solid var(--border);
      background: #eee; /* ë¡œë”© ì „ ë°°ê²½ */
    }
    .form-row { display: flex; gap: 8px; margin-bottom: 8px; }
    .input-group { flex: 1; }
    label.input-label { display: block; font-size: 0.8rem; color: var(--text-sub); margin-bottom: 4px; }
    input[type="text"], input[type="number"] {
      width: 100%; padding: 10px; border-radius: 10px;
      border: 1px solid var(--border); font-size: 0.9rem;
      background: #f9fafb; outline: none;
    }
    input:focus { border-color: var(--primary); background: #fff; }

    /* --- ë²„íŠ¼ (diet1) --- */
    .btn {
      border: none; border-radius: 10px; padding: 10px 14px;
      font-size: 0.9rem; font-weight: 600; cursor: pointer;
      display: inline-flex; align-items: center; justify-content: center; gap: 4px;
      transition: all 0.15s;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-secondary { background: #e5e7eb; color: #111827; }
    .btn-ghost { background: #f9fafb; color: var(--text-sub); border: 1px dashed var(--border); }
    .btn-sm { padding: 6px 10px; font-size: 0.8rem; border-radius: 999px; }

    /* --- ê²½ë¡œ ì •ë³´ ë±ƒì§€ --- */
    .route-summary { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .pill {
      padding: 4px 10px; border-radius: 999px; background: #f3f4f6;
      font-size: 0.75rem; color: #4b5563;
    }
    .message { font-size: 0.85rem; margin-top: 8px; }
    .message.error { color: var(--danger); }
    .message.info { color: var(--text-sub); }

    /* --- í•˜ë‹¨ íƒ­ë°” (diet1 ìŠ¤íƒ€ì¼ ìœ ì§€) --- */
    #bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0; height: 60px;
      background: #fff; border-top: 1px solid var(--border);
      display: flex; z-index: 100; max-width: 600px; margin: 0 auto;
    }
    .nav-btn {
      flex: 1; border: none; background: transparent;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 3px; font-size: 0.7rem; color: var(--text-sub); cursor: pointer;
    }
    .nav-btn .icon { font-size: 1.4rem; }
    .nav-btn.active { color: var(--primary); }

    /* --- diet1-4ts ìŠ¤íƒ€ì¼ í†µí•© (í”¼ë“œ, í”„ë¡œí•„) --- */
    
    /* í”¼ë“œ ì¹´ë“œ */
    .feed-item {
      border-bottom: 1px solid var(--border);
      padding-bottom: 16px; margin-bottom: 16px;
    }
    .feed-item:last-child { border-bottom: none; margin-bottom: 0; }
    .feed-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .feed-avatar { 
      width: 32px; height: 32px; border-radius: 50%; background: #ddd; 
      object-fit: cover;
    }
    .feed-user { font-weight: 600; font-size: 0.9rem; }
    .feed-img { width: 100%; border-radius: 12px; margin-bottom: 8px; object-fit: cover; aspect-ratio: 16/9; }
    .feed-text { font-size: 0.9rem; line-height: 1.4; }

    /* ë­í‚¹ ë¦¬ìŠ¤íŠ¸ */
    .rank-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 0; border-bottom: 1px dashed var(--border);
    }
    .rank-item:last-child { border-bottom: none; }
    .rank-badge { font-size: 1.2rem; margin-right: 8px; }

    /* í”„ë¡œí•„ ìƒë‹¨ */
    .profile-header { text-align: center; padding: 10px 0 20px; }
    .avatar-ring {
      width: 100px; height: 100px; border-radius: 50%; overflow: hidden;
      margin: 0 auto 12px; border: 3px solid var(--primary-soft);
    }
    .avatar-img { width: 100%; height: 100%; object-fit: cover; }
    .profile-stats-row { display: flex; justify-content: space-around; margin-bottom: 16px; }
    .p-stat-num { font-size: 1.1rem; font-weight: 700; }
    .p-stat-label { font-size: 0.75rem; color: var(--text-sub); }
    
    /* í†µê³„ ì¹´ë“œ ê·¸ë¦¬ë“œ (diet1) */
    .stats-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;
    }
    .stat-card {
      background: #f9fafb; border-radius: 12px; padding: 12px;
      border: 1px solid var(--border); text-align: center;
    }
    .stat-value { font-size: 1.1rem; font-weight: 700; color: var(--primary); }

    /* í”„ë¡œí•„ íƒ­ ë° ê·¸ë¦¬ë“œ (diet1-4ts) */
    .profile-tabs {
      display: flex; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
      margin-top: 10px;
    }
    .p-tab {
      flex: 1; text-align: center; padding: 12px; cursor: pointer; font-size: 1.2rem;
      color: var(--text-sub);
    }
    .p-tab.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
    .grid-view {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; margin-top: 2px;
    }
    .grid-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; cursor: pointer; background: #eee; }

    /* ê¸°ë¡ ë¦¬ìŠ¤íŠ¸ */
    .history-item {
      padding: 12px; border-radius: 12px; border: 1px solid var(--border);
      margin-bottom: 8px; background: #fff;
      display: flex; justify-content: space-between; align-items: center;
    }
    .badge { padding: 2px 8px; border-radius: 999px; font-size: 0.7rem; font-weight: 600; }
    .badge-loop { background: #e0f2fe; color: #0369a1; }
    .badge-normal { background: #f3f4f6; color: #4b5563; }

  </style>
</head>
<body>

  <div class="app-container">
    
    <div id="page-home" class="page active">
      <div class="section-card">
        <h2 class="section-title">ğŸ—ºï¸ ê²½ë¡œ ê²€ìƒ‰</h2>
        
        <div class="form-row">
          <div class="input-group">
            <label class="input-label">ì¶œë°œì§€</label>
            <input type="text" id="start-input" placeholder="ì˜ˆ: ì„œìš¸ì—­" />
          </div>
          <button id="btn-my-location" class="btn btn-secondary" style="align-self: flex-end;">
            ğŸ“ ë‚´ ìœ„ì¹˜
          </button>
        </div>
        
        <div class="form-row">
          <div class="input-group">
            <label class="input-label">ë„ì°©ì§€</label>
            <input type="text" id="end-input" placeholder="ì˜ˆ: ë‚¨ì‚°íƒ€ì›Œ (ë£¨í”„ ìƒì„±ì‹œ ìƒëµ)" />
          </div>
        </div>

        <div class="form-row">
          <div class="input-group">
            <label class="input-label">ëª©í‘œ ê±°ë¦¬ (km, ë£¨í”„ìš©)</label>
            <input type="number" id="loop-distance" min="1" max="50" value="3" />
          </div>
        </div>

        <div class="form-row">
          <button id="btn-search-route" class="btn btn-primary" style="flex: 1;">
            ğŸš¶ ê¸¸ì°¾ê¸°
          </button>
          <button id="btn-loop-route" class="btn btn-ghost">
            ğŸ”„ ì™•ë³µ ì½”ìŠ¤
          </button>
        </div>

        <div class="route-summary" id="route-summary"></div>
        <div class="message info" id="route-message">ì¶œë°œì§€ë¥¼ ì…ë ¥í•˜ê³  ê²½ë¡œë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</div>
        
        <div style="margin-top: 10px; text-align: right;">
          <button id="btn-save-route" class="btn btn-sm btn-secondary" disabled>ğŸ’¾ ê¸°ë¡ ì €ì¥</button>
        </div>
      </div>

      <div class="section-card" style="padding: 0; overflow: hidden;">
        <div id="map"></div>
      </div>
    </div>

    <div id="page-history" class="page">
      <div class="section-card">
        <h2 class="section-title">ğŸ“š ë‚˜ì˜ ìš´ë™ ê¸°ë¡</h2>
        <p class="text-sub" style="font-size: 0.9rem; margin-bottom: 12px;">
          ì €ì¥ëœ ì½”ìŠ¤ ëª©ë¡ì…ë‹ˆë‹¤.
        </p>
        <div id="history-list"></div>
        <div id="history-empty" class="text-sub" style="text-align: center; padding: 20px;">
          ì•„ì§ ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
        </div>
      </div>
    </div>

    <div id="page-group" class="page">
      <div class="section-card">
        <h2 class="section-title">ğŸ”¥ ì¸ê¸° ëŸ¬ë‹ í¬ë£¨</h2>
        <div class="rank-item">
          <div><span class="rank-badge">ğŸ¥‡</span> ì„œìš¸ ê°•ë¶ ëŸ¬ë‹í¬ë£¨</div>
          <span class="badge badge-loop">4,920ëª…</span>
        </div>
        <div class="rank-item">
          <div><span class="rank-badge">ğŸ¥ˆ</span> ì—¬ì˜ë„ í•œê°• Runners</div>
          <span class="badge badge-loop">3,410ëª…</span>
        </div>
        <div class="rank-item">
          <div><span class="rank-badge">ğŸ¥‰</span> ì ì‹¤ íƒ„ì²œ Crew</div>
          <span class="badge badge-loop">2,880ëª…</span>
        </div>
      </div>

      <div class="section-card">
        <h2 class="section-title">ğŸ“¢ ì‹¤ì‹œê°„ í”¼ë“œ</h2>
        
        <div class="feed-item">
          <div class="feed-header">
            <img class="feed-avatar" src="https://picsum.photos/50/50?random=1" />
            <div class="feed-user">í˜•ë¦¼</div>
            <span class="text-sub" style="font-size:0.8rem; margin-left:auto;">10ë¶„ ì „</span>
          </div>
          <img class="feed-img" src="https://picsum.photos/500/280?random=10" />
          <div class="feed-text">ì˜¤ëŠ˜ í•œê°• 7km ë›°ê³  ì™”ë‹¤! ë‚ ì”¨ ë„ˆë¬´ ì¢‹ìŒ ğŸ”¥ #ì˜¤ìš´ì™„</div>
        </div>

        <div class="feed-item">
          <div class="feed-header">
            <img class="feed-avatar" src="https://picsum.photos/50/50?random=2" />
            <div class="feed-user">Runner_J</div>
            <span class="text-sub" style="font-size:0.8rem; margin-left:auto;">1ì‹œê°„ ì „</span>
          </div>
          <div class="feed-text">ìƒˆë¡œìš´ ê¸°ë¡ ë„ì „ì¤‘ ğŸƒâ€â™‚ï¸ 5km 20ë¶„ ì»· ê°€ëŠ¥í• ê¹Œ?</div>
        </div>
      </div>
    </div>

    <div id="page-me" class="page">
      <div class="section-card">
        <div class="profile-header">
          <div class="avatar-ring">
            <img class="avatar-img" src="https://via.placeholder.com/150" alt="Profile" />
          </div>
          <h3 style="margin: 8px 0;">ë‹¤ì´ì–´í„° 101</h3>
          <p class="text-sub" style="margin: 0 0 16px;">ë‹¬ë¦¬ê¸° ì¢‹ì•„í•˜ëŠ” ê°œë°œì ğŸƒâ€â™‚ï¸</p>
          
          <div class="profile-stats-row">
            <div><div class="p-stat-num" id="ui-total-routes">0</div><div class="p-stat-label">ì½”ìŠ¤</div></div>
            <div><div class="p-stat-num">128</div><div class="p-stat-label">íŒ”ë¡œì›Œ</div></div>
            <div><div class="p-stat-num">96</div><div class="p-stat-label">íŒ”ë¡œì‰</div></div>
          </div>
        </div>

        <h4 style="margin: 0 0 8px; font-size: 0.9rem;">ğŸ“Š ë‚˜ì˜ í™œë™ í†µê³„</h4>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="p-stat-label">ëˆ„ì  ê±°ë¦¬</div>
            <div class="stat-value" id="stat-total-distance">0 km</div>
          </div>
          <div class="stat-card">
            <div class="p-stat-label">ëˆ„ì  ì‹œê°„</div>
            <div class="stat-value" id="stat-total-time">0 ë¶„</div>
          </div>
        </div>

        <div style="text-align: center;">
          <button id="btn-reset-stats" class="btn btn-ghost btn-sm">í†µê³„ ì´ˆê¸°í™”</button>
        </div>

        <div class="profile-tabs">
          <div id="tab-posts" class="p-tab active" onclick="switchProfileTab('posts')">ğŸ“·</div>
          <div id="tab-saved" class="p-tab" onclick="switchProfileTab('saved')">ğŸ”–</div>
        </div>

        <div id="profile-posts" class="grid-view">
          <img class="grid-img" src="https://picsum.photos/300?random=3" />
          <img class="grid-img" src="https://picsum.photos/300?random=4" />
          <img class="grid-img" src="https://picsum.photos/300?random=5" />
          <img class="grid-img" src="https://picsum.photos/300?random=6" />
          <img class="grid-img" src="https://picsum.photos/300?random=7" />
          <img class="grid-img" src="https://picsum.photos/300?random=8" />
        </div>

        <div id="profile-saved" class="grid-view" style="display:none;">
          <img class="grid-img" src="https://picsum.photos/300?random=11" />
          <img class="grid-img" src="https://picsum.photos/300?random=12" />
          <img class="grid-img" src="https://picsum.photos/300?random=13" />
        </div>
      </div>
    </div>

  </div>

  <nav id="bottom-nav">
    <button class="nav-btn active" data-target="home">
      <span class="icon">ğŸ—ºï¸</span>
      <span>í™ˆ</span>
    </button>
    <button class="nav-btn" data-target="history">
      <span class="icon">ğŸ“š</span>
      <span>ê¸°ë¡</span>
    </button>
    <button class="nav-btn" data-target="group">
      <span class="icon">ğŸ‘¥</span>
      <span>ê·¸ë£¹</span>
    </button>
    <button class="nav-btn" data-target="me">
      <span class="icon">ğŸ‘¤</span>
      <span>ë‚´ ì •ë³´</span>
    </button>
  </nav>

  <script>
    // --- [ì„¤ì •] ì¹´ì¹´ì˜¤ API í‚¤ ---
    const KAKAO_REST_API_KEY = "71b46fcb7202af130ab7c6c18bf5163a"; // REST API í‚¤ (ê¸¸ì°¾ê¸°ìš©)

    // --- [ì „ì—­ ë³€ìˆ˜] ---
    let map;
    let placesService;
    let geocoder;
    let currentRoute = null;
    let routeOverlays = [];
    let routeHistory = [];

    // --- 1. ì§€ë„ ë° ê¸¸ì°¾ê¸° ë¡œì§ (diet1) ---

    function initMap() {
      const container = document.getElementById("map");
      const center = new kakao.maps.LatLng(37.5665, 126.9780);
      const options = { center, level: 5 };
      map = new kakao.maps.Map(container, options);
      placesService = new kakao.maps.services.Places();
      geocoder = new kakao.maps.services.Geocoder();

      // ì´ˆê¸° ë§ˆì»¤
      new kakao.maps.Marker({ position: center, map: map });
    }

    function clearRouteOverlays() {
      routeOverlays.forEach(o => o.setMap && o.setMap(null));
      routeOverlays = [];
    }

    // Haversine ê³µì‹ (ê±°ë¦¬ ê³„ì‚°)
    function haversineDistance(lat1, lng1, lat2, lng2) {
      const R = 6371000; 
      const toRad = v => (v * Math.PI) / 180;
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function searchPlacePromise(query) {
      return new Promise((resolve, reject) => {
        if (!query.trim()) return reject(new Error("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        placesService.keywordSearch(query, (data, status) => {
          if (status === kakao.maps.services.Status.OK && data.length > 0) resolve(data[0]);
          else reject(new Error(`'${query}' ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.`));
        }, { size: 1 });
      });
    }

    async function getCurrentLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject(new Error("ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        navigator.geolocation.getCurrentPosition(
          pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
          () => reject(new Error("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."))
        );
      });
    }

    async function callKakaoDirections(origin, destination) {
      const params = new URLSearchParams({
        origin: origin.join(","),
        destination: destination.join(","),
        priority: "TIME",
        car_fuel: "GASOLINE",
        alternatives: "false"
      });

      const res = await fetch(`https://apis-navi.kakaomobility.com/v1/directions?${params}`, {
        headers: { Authorization: `KakaoAK ${KAKAO_REST_API_KEY}` }
      });
      
      if (!res.ok) throw new Error("ê¸¸ì°¾ê¸° API ì˜¤ë¥˜");
      const data = await res.json();
      if (!data.routes || data.routes.length === 0) throw new Error("ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return data.routes[0];
    }

    function drawRouteOnMap(route, labelOptions) {
      clearRouteOverlays();
      const bounds = new kakao.maps.LatLngBounds();
      const path = [];

      route.sections.forEach(section => {
        section.roads.forEach(road => {
          road.vertexes.forEach((v, i) => {
            if (i % 2 === 0) {
              const pt = new kakao.maps.LatLng(road.vertexes[i+1], road.vertexes[i]);
              path.push(pt);
              bounds.extend(pt);
            }
          });
        });
      });

      const polyline = new kakao.maps.Polyline({
        path, strokeWeight: 6, strokeColor: "#2563eb", strokeOpacity: 0.9
      });
      polyline.setMap(map);
      routeOverlays.push(polyline);

      // ì‹œì‘/ì¢…ë£Œ ë§ˆì»¤
      const startM = new kakao.maps.Marker({ position: path[0], map });
      const endM = new kakao.maps.Marker({ position: path[path.length-1], map });
      routeOverlays.push(startM, endM);

      map.setBounds(bounds, 50, 50, 50, 50);
    }

    function updateRouteUI(route, type, label) {
      const distM = route.summary ? route.summary.distance : route.sections[0].distance;
      const durSec = route.summary ? route.summary.duration : route.sections[0].duration;
      const distKm = (distM / 1000).toFixed(2);
      const durMin = Math.round(durSec / 60);

      const summaryEl = document.getElementById("route-summary");
      summaryEl.innerHTML = `
        <span class="pill"><strong>${label}</strong></span>
        <span class="pill">ê±°ë¦¬: <strong>${distKm} km</strong></span>
        <span class="pill">ì‹œê°„: <strong>${durMin} ë¶„</strong></span>
      `;

      const msgEl = document.getElementById("route-message");
      msgEl.textContent = "ê²½ë¡œê°€ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.";
      msgEl.className = "message info";
      
      document.getElementById("btn-save-route").disabled = false;

      currentRoute = {
        type, label, distance: distM, duration: durSec, createdAt: new Date()
      };
      updateStats();
    }

    // ì´ë²¤íŠ¸: ì¼ë°˜ ê¸¸ì°¾ê¸°
    async function handleSearchRoute() {
      const startTxt = document.getElementById("start-input").value;
      const endTxt = document.getElementById("end-input").value;
      const msgEl = document.getElementById("route-message");

      if (!startTxt || !endTxt) {
        msgEl.textContent = "ì¶œë°œì§€ì™€ ë„ì°©ì§€ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.";
        msgEl.className = "message error";
        return;
      }

      try {
        msgEl.textContent = "ê²½ë¡œ ê²€ìƒ‰ ì¤‘...";
        const start = await searchPlacePromise(startTxt);
        const end = await searchPlacePromise(endTxt);
        
        const route = await callKakaoDirections([start.x, start.y], [end.x, end.y]);
        drawRouteOnMap(route);
        updateRouteUI(route, "normal", "ì¼ë°˜ ê²½ë¡œ");
      } catch (err) {
        msgEl.textContent = err.message;
        msgEl.className = "message error";
      }
    }

    // ì´ë²¤íŠ¸: ë£¨í”„ ì½”ìŠ¤ ìƒì„±
    async function handleLoopRoute() {
      const startTxt = document.getElementById("start-input").value;
      const distKm = parseFloat(document.getElementById("loop-distance").value);
      const msgEl = document.getElementById("route-message");

      if (!startTxt) {
        msgEl.textContent = "ì¶œë°œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
        msgEl.className = "message error";
        return;
      }

      try {
        msgEl.textContent = "ì½”ìŠ¤ ìƒì„± ì¤‘...";
        const place = await searchPlacePromise(startTxt);
        const lat = parseFloat(place.y);
        const lng = parseFloat(place.x);
        
        // ê°„ë‹¨í•œ ì‚¬ê°í˜• ë£¨í”„ ë¡œì§
        const sideM = (distKm * 1000) / 4;
        const dLat = sideM / 111000;
        const dLng = sideM / (111000 * Math.cos(lat * Math.PI/180));

        const pts = [
          {lat: lat + dLat/2, lng: lng - dLng/2},
          {lat: lat + dLat/2, lng: lng + dLng/2},
          {lat: lat - dLat/2, lng: lng + dLng/2},
          {lat: lat - dLat/2, lng: lng - dLng/2},
          {lat: lat + dLat/2, lng: lng - dLng/2}
        ];

        const vertexes = [];
        let totalDist = 0;
        for(let i=0; i<pts.length; i++) {
          vertexes.push(pts[i].lng, pts[i].lat);
          if(i>0) totalDist += haversineDistance(pts[i-1].lat, pts[i-1].lng, pts[i].lat, pts[i].lng);
        }

        const routeMock = {
          sections: [{ roads: [{ vertexes }], distance: totalDist, duration: totalDist / 1.2 }] 
        }; // ëŒ€ëµ 1.2m/s ê±·ê¸° ì†ë„

        drawRouteOnMap(routeMock);
        updateRouteUI(routeMock, "loop", "ì™•ë³µ ë£¨í”„");

      } catch (err) {
        msgEl.textContent = "ë£¨í”„ ìƒì„± ì‹¤íŒ¨: " + err.message;
        msgEl.className = "message error";
      }
    }

    // ì´ë²¤íŠ¸: ë‚´ ìœ„ì¹˜ ì°¾ê¸°
    async function handleMyLocation() {
      const btn = document.getElementById("btn-my-location");
      const msgEl = document.getElementById("route-message");
      btn.disabled = true;
      msgEl.textContent = "ìœ„ì¹˜ í™•ì¸ ì¤‘...";
      
      try {
        const loc = await getCurrentLocation();
        const coord = new kakao.maps.LatLng(loc.lat, loc.lng);
        map.panTo(coord);
        new kakao.maps.Marker({ position: coord, map });
        
        geocoder.coord2Address(loc.lng, loc.lat, (res, status) => {
          if (status === kakao.maps.services.Status.OK) {
            document.getElementById("start-input").value = res[0].address.address_name || "ë‚´ ìœ„ì¹˜";
          }
        });
        msgEl.textContent = "í˜„ì¬ ìœ„ì¹˜ë¥¼ ì¶œë°œì§€ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.";
      } catch(err) {
        msgEl.textContent = err.message;
      } finally {
        btn.disabled = false;
      }
    }

    // --- 2. ë°ì´í„° ê´€ë¦¬ (History & Stats) ---

    function saveRoute() {
      if (!currentRoute) return;
      routeHistory.push(currentRoute);
      renderHistory();
      updateStats();
      document.getElementById("route-message").textContent = "ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.";
    }

    function renderHistory() {
      const list = document.getElementById("history-list");
      const empty = document.getElementById("history-empty");
      list.innerHTML = "";
      
      if (routeHistory.length === 0) {
        empty.style.display = "block";
        return;
      }
      empty.style.display = "none";

      [...routeHistory].reverse().forEach(item => {
        const date = item.createdAt.toLocaleDateString();
        const div = document.createElement("div");
        div.className = "history-item";
        div.innerHTML = `
          <div>
            <div style="font-weight:600; margin-bottom:4px;">${item.label}</div>
            <div class="text-sub" style="font-size:0.75rem;">
              ${(item.distance/1000).toFixed(2)}km Â· ${Math.round(item.duration/60)}ë¶„ Â· ${date}
            </div>
          </div>
          <span class="badge ${item.type === 'loop' ? 'badge-loop' : 'badge-normal'}">
            ${item.type === 'loop' ? 'ë£¨í”„' : 'ì¼ë°˜'}
          </span>
        `;
        list.appendChild(div);
      });
    }

    function updateStats() {
      let totalDist = 0;
      let totalTime = 0;
      
      // ì €ì¥ëœ ê¸°ë¡ + í˜„ì¬ ë³´ì—¬ì§€ëŠ” ê²½ë¡œ(ì €ì¥ ì•ˆëœ ê²½ìš°ë„ í¬í•¨í•˜ë ¤ë©´ ë¡œì§ ìˆ˜ì • í•„ìš”, ì—¬ê¸°ì„  ì €ì¥ëœ ê²ƒë§Œ)
      routeHistory.forEach(r => {
        totalDist += r.distance;
        totalTime += r.duration;
      });

      document.getElementById("stat-total-distance").textContent = (totalDist/1000).toFixed(2) + " km";
      document.getElementById("stat-total-time").textContent = Math.round(totalTime/60) + " ë¶„";
      document.getElementById("ui-total-routes").textContent = routeHistory.length;
    }

    function resetStats() {
      if(confirm("ëª¨ë“  ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        routeHistory = [];
        currentRoute = null;
        renderHistory();
        updateStats();
        document.getElementById("route-summary").innerHTML = "";
      }
    }

    // --- 3. UI ì¸í„°ë™ì…˜ (íƒ­ ì „í™˜ ë“±) ---

    // í”„ë¡œí•„ íƒ­ ì „í™˜ (diet1-4ts)
    window.switchProfileTab = function(tabName) {
      document.getElementById('profile-posts').style.display = tabName === 'posts' ? 'grid' : 'none';
      document.getElementById('profile-saved').style.display = tabName === 'saved' ? 'grid' : 'none';
      
      document.getElementById('tab-posts').classList.toggle('active', tabName === 'posts');
      document.getElementById('tab-saved').classList.toggle('active', tabName === 'saved');
    }

    // ë©”ì¸ íƒ­ ë„¤ë¹„ê²Œì´ì…˜
    function initTabs() {
      const btns = document.querySelectorAll(".nav-btn");
      const pages = document.querySelectorAll(".page");

      btns.forEach(btn => {
        btn.addEventListener("click", () => {
          btns.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");

          const targetId = "page-" + btn.dataset.target;
          pages.forEach(p => {
            p.classList.toggle("active", p.id === targetId);
          });

          // ì§€ë„ê°€ í¬í•¨ëœ íƒ­ì´ ë‹¤ì‹œ ë³´ì¼ ë•Œ ë ˆì´ì•„ì›ƒ ê°±ì‹  í•„ìš”
          if (targetId === "page-home" && map) {
            setTimeout(() => map.relayout(), 100);
          }
        });
      });
    }

    // --- ì´ˆê¸°í™” ---
    document.addEventListener("DOMContentLoaded", () => {
      kakao.maps.load(initMap);
      initTabs();
      
      document.getElementById("btn-search-route").addEventListener("click", handleSearchRoute);
      document.getElementById("btn-loop-route").addEventListener("click", handleLoopRoute);
      document.getElementById("btn-my-location").addEventListener("click", handleMyLocation);
      document.getElementById("btn-save-route").addEventListener("click", saveRoute);
      document.getElementById("btn-reset-stats").addEventListener("click", resetStats);
    });

  </script>
</body>
</html>