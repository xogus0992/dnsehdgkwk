<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í¬ì¼“ëª¬ ëŸ¬ë‹ ì•± V5</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 0;
        }

        /* === 1. ìŠ¤í”Œë˜ì‹œ ìŠ¤í¬ë¦° (V5 ìˆ˜ì •) === */
        #splashScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #007aff, #00c6ff);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #splashScreen img {
            width: 300px; /* ì´ë¯¸ì§€ í¬ê¸° ì¡°ì • */
            max-width: 80%;
            /* animation: bounce 1.5s infinite; (V5: ì œê±°) */
        }
        #splashScreen h1 {
            color: white;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            margin-top: 20px;
        }
        #enterAppButton {
            margin-top: 30px;
            padding: 15px 30px;
            font-size: 1.2em;
            background-color: #ffd700;
            color: #3b5998;
            border: none;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.2s ease, background-color 0.2s;
        }
        #enterAppButton:hover {
            transform: scale(1.05);
            background-color: #ffec8b;
        }

        /* === 2. ë©”ì¸ ì•± ì»¨í…Œì´ë„ˆ === */
        #appContainer {
            display: none;
            max-width: 900px;
            margin: 20px auto;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        h1, h2 {
            text-align: center;
            color: #1a1a1a;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .status {
            display: flex;
            justify-content: space-around;
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .status-item strong {
            font-size: 2em;
            color: #007aff;
            display: block;
        }

        /* === 3. ì¶œì„ ìº˜ë¦°ë” (V5 ìˆ˜ì •) === */
        #calendarContainer {
            margin: 30px 0;
            padding: 15px;
            background-color: #fafafa;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }
        #calendarHeader {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .calendar-day-name {
            font-weight: bold;
            text-align: center;
            color: #888;
            font-size: 0.9em;
            padding-bottom: 5px;
        }
        .calendar-day {
            height: 60px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            text-align: center;
            padding: 5px;
            font-size: 1.1em;
            position: relative;
            background-color: #fff;
            color: #555;
            transition: background-color 0.2s;
        }
        .calendar-day.empty { background-color: transparent; border: none; }
        
        /* (V5 ìˆ˜ì •) ê´€ë¦¬ììš©: ì¶œì„ ì•ˆí•œ ë‚ ì€ ëª¨ë‘ í´ë¦­ ê°€ëŠ¥ */
        .calendar-day.clickable {
            cursor: pointer;
        }
        .calendar-day.clickable:hover {
            background-color: #e6f2ff;
        }
        .calendar-day.today { /* 'ì˜¤ëŠ˜'ì€ ì‹œê°ì ìœ¼ë¡œë§Œ ê°•ì¡° */
            border: 2px solid #007aff;
            font-weight: bold;
            color: #007aff;
        }

        .calendar-day.stamped { /* ì¶œì„ ì™„ë£Œ */
            background-color: #4cd964;
            color: white;
            font-weight: bold;
            cursor: not-allowed;
            border-color: #34a853;
        }
        .calendar-day.stamped::after {
            content: 'ì¶œì„';
            font-size: 0.8em;
            display: block;
            margin-top: 5px;
        }
        .calendar-day .points-toast {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: #e63946;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: bold;
            animation: fadeOutUp 1.5s ease-out;
            z-index: 10;
        }

        /* === 4. ëª¬ìŠ¤í„°ë³¼ ë½‘ê¸° ë²„íŠ¼ (V5 ìˆ˜ì •) === */
        #shopSection {
            text-align: center;
            margin: 30px 0;
        }
        #shopButton { /* ì´ì œ ìƒì  ëª¨ë‹¬ì„ ì—¬ëŠ” ë²„íŠ¼ */
            width: 120px;
            height: 120px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        #shopButton:hover {
            transform: scale(1.1);
        }
        #shopMessage {
            font-weight: bold;
            font-size: 1.1em;
            margin-top: 10px;
        }

        /* === 5. ìƒì  ëª¨ë‹¬ (V5 ì‹ ê·œ) === */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 25px;
            border: 1px solid #888;
            width: 80%;
            max-width: 700px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
        }
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .shop-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            background: #f9f9f9;
        }
        .shop-item img {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }
        .shop-item h3 { margin: 10px 0 5px 0; }
        .shop-item p { font-size: 0.9em; color: #555; }
        .shop-item .buy-btn {
            background-color: #007aff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            width: 100%;
            transition: background-color 0.2s;
        }
        .shop-item .buy-btn:hover { background-color: #0056b3; }
        .shop-item.disabled {
            background: #e0e0e0;
            opacity: 0.7;
        }
        .shop-item .buy-btn:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }
        .placeholder-img {
            font-size: 50px;
            background: #ccc;
            width: 80px;
            height: 80px;
            line-height: 80px;
            border-radius: 50%;
            margin: 0 auto;
            color: #888;
        }

        /* Pokedex Grid (V4ì™€ ë™ì¼) */
        #pokedexGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .pokemon-grid-item {
            background: #f9f9f9; border: 1px solid #e0e0e0; border-radius: 10px;
            padding: 10px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s ease; position: relative;
        }
        .pokemon-grid-item:hover { transform: translateY(-5px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .pokemon-grid-item img {
            width: 90px; height: 90px; object-fit: contain;
            background-color: #e8e8e8; border-radius: 50%; margin-bottom: 10px;
        }
        .pokemon-grid-item .pokemon-id { font-size: 0.8em; color: #888; margin-bottom: 5px; }
        .pokemon-grid-item .pokemon-name { font-weight: bold; font-size: 1.1em; color: #333; }
        .pokemon-grid-item .pokemon-count {
            position: absolute; top: 5px; right: 5px; background: #e63946;
            color: white; font-weight: bold; border-radius: 50%;
            width: 28px; height: 28px; line-height: 28px; font-size: 0.9em;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .evolve-btn {
            background-color: #4cd964; width: calc(100% - 20px);
            margin-top: 10px; padding: 8px; font-size: 0.9em;
            border: none; border-radius: 5px; color: white; cursor: pointer;
        }
        .evolve-btn:hover { background-color: #34a853; }
        .evolve-btn.disabled { background-color: #aaa; cursor: not-allowed; }

        /* Admin & Log (V4ì™€ ë™ì¼) */
        #adminPanel {
            background: #fff8e1; border: 1px solid #ffecb3; border-radius: 10px;
            padding: 15px; margin-top: 30px;
        }
        #adminPanel h3 { margin-top: 0; text-align: center; color: #f57f17; }
        .admin-actions { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .admin-actions button {
            background-color: #f57f17; font-size: 0.9em; padding: 8px 12px;
            border: none; border-radius: 5px; color: white; cursor: pointer;
        }
        .admin-actions button:hover { background-color: #e65100; }
        #log {
            margin-top: 30px; background: #2a2a2a; color: #00ff00;
            padding: 15px; border-radius: 8px; font-family: 'Courier New', Courier, monospace;
            height: 150px; overflow-y: auto; font-size: 0.9em;
        }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeOutUp {
            0% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -30px); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px) rotate(-5deg); }
            20%, 40%, 60%, 80% { transform: translateX(5px) rotate(5deg); }
        }
    </style>
</head>
<body>

    <div id="splashScreen">
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ2SY_RrCezD8jz5_ZYsqv8iNndHEefsHqQpA&s" alt="Pokemon Trainer">
        <h1>í¬ì¼“ëª¬ ëŸ¬ë‹</h1>
        <button id="enterAppButton">ì•± ì‹œì‘í•˜ê¸°</button>
    </div>

    <div id="appContainer">
        <h1>ğŸƒâ€â™‚ï¸ í¬ì¼“ëª¬ ëŸ¬ë‹ ì•± V5</h1>

        <div class="status">
            <div class="status-item">
                <span>ë‚´ í¬ì¸íŠ¸</span>
                <strong id="pointsDisplay">0</strong>
            </div>
            <div class="status-item">
                <span>ì¶œì„ ì§„í–‰ë„ (ë‹¤ìŒ í¬ì¼“ëª¬ê¹Œì§€)</span>
                <strong id="attendanceProgress">0 / 3</strong>
            </div>
        </div>

        <div id="calendarContainer">
            <h2 id="calendarHeader">11ì›” 2025</h2>
            <div class="calendar-grid" id="calendarWeekdays">
                </div>
            <div class="calendar-grid" id="calendarGrid">
                </div>
        </div>

        <div id="shopSection">
            <h2>ğŸ›’ ìƒì  ë°”ë¡œê°€ê¸°</h2>
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTrh9SpQTEsdhlKv_gKbo2wbd3eWZoxkWVTXQ&s" 
                 alt="ìƒì  ê°€ê¸°" 
                 id="shopButton"> <p id="shopMessage">í´ë¦­í•˜ì—¬ ìƒì  ì—´ê¸°</p>
        </div>

        <div id="pokedex">
            <h2>ğŸ“œ ë‚˜ì˜ í¬ì¼“ëª¬ ë„ê° (Grid View)</h2>
            <div id="pokedexGrid"></div>
        </div>

        <div id="adminPanel">
            <h3>ğŸ”‘ ê´€ë¦¬ì í…ŒìŠ¤íŠ¸ íŒ¨ë„</h3>
            <div class="admin-actions">
                <button id="adminAddPoints">100 í¬ì¸íŠ¸ ì¶”ê°€</button>
                <button id="adminAddBasic">ê¸°ë³¸ í¬ì¼“ëª¬ 1ë§ˆë¦¬ íšë“</button>
                <button id="adminAddRandom">ëœë¤ í¬ì¼“ëª¬ 1ë§ˆë¦¬ íšë“</button>
                <button id="adminClearData">!! ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™” !!</button>
            </div>
        </div>

        <div id="log">ì‹œìŠ¤í…œ ë¡œê·¸...</div>
    </div>

    <div id="shopModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeShopModal">&times;</span>
            <h2>ğŸ›’ í¬ì¼“ëª¬ ìƒì  ğŸ›’</h2>
            <p>í¬ì¸íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ì•„ì´í…œì„ êµ¬ë§¤í•˜ì„¸ìš”!</p>
            
            <div class="shop-grid">
                <div class="shop-item" id="buyPokeballItem">
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTrh9SpQTEsdhlKv_gKbo2wbd3eWZoxkWVTXQ&s" alt="ëª¬ìŠ¤í„°ë³¼">
                    <h3>ëª¬ìŠ¤í„°ë³¼ ë½‘ê¸°</h3>
                    <p>ëœë¤ í¬ì¼“ëª¬ 1ë§ˆë¦¬ íšë“</p>
                    <button class="buy-btn">êµ¬ë§¤ (10P)</button>
                </div>
                
                <div class="shop-item disabled">
                    <div class="placeholder-img">ğŸ¥š</div>
                    <h3>í–‰ë³µì˜ ì•Œ</h3>
                    <p>30ë¶„ê°„ ê²½í—˜ì¹˜ 2ë°° (ì¤€ë¹„ì¤‘)</p>
                    <button class="buy-btn" disabled>50P</button>
                </div>

                <div class="shop-item disabled">
                    <div class="placeholder-img">ğŸŒ¸</div>
                    <h3>í–¥ë¡œ</h3>
                    <p>30ë¶„ê°„ í¬ì¼“ëª¬ ìœ ì¸ (ì¤€ë¹„ì¤‘)</p>
                    <button class="buy-btn" disabled>80P</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ì„¤ì • ê°’ ---
        const ATTENDANCE_REWARD_POINTS = 3;
        const ATTENDANCE_GOAL = 3;
        const SHOP_COST = 10;
        const EVOLVE_COST = 10;
        const POKEAPI_BASE_URL = 'https://pokeapi.co/api/v2/';

        const BASIC_POKEMON_IDS = [1, 4, 7, 25, 133];
        const RANDOM_POKEMON_IDS = [10, 13, 16, 19, 25, 54, 63, 79, 133, 147];

        // --- DOM ìš”ì†Œ ---
        const splashScreen = document.getElementById('splashScreen');
        const appContainer = document.getElementById('appContainer');
        const enterAppButton = document.getElementById('enterAppButton');
        
        const pointsDisplay = document.getElementById('pointsDisplay');
        const attendanceProgress = document.getElementById('attendanceProgress');
        const calendarHeader = document.getElementById('calendarHeader');
        const calendarWeekdays = document.getElementById('calendarWeekdays');
        const calendarGrid = document.getElementById('calendarGrid');
        
        const shopButton = document.getElementById('shopButton'); // ë©”ì¸ í™”ë©´ì˜ ìƒì  ë²„íŠ¼
        const pokedexGrid = document.getElementById('pokedexGrid');
        const log = document.getElementById('log');

        // (V5 ì‹ ê·œ) ìƒì  ëª¨ë‹¬ DOM
        const shopModal = document.getElementById('shopModal');
        const closeShopModal = document.getElementById('closeShopModal');
        const buyPokeballButton = document.getElementById('buyPokeballItem').querySelector('.buy-btn');

        // --- ê²Œì„ ë°ì´í„° (V5: lastAttendanceDate ì œê±°) ---
        let userPoints = 0;
        let attendanceCount = 0;
        let pokedex = {};
        let monthlyStamps = []; // [1, 5, 12] (ì¶œì„í•œ ë‚ ì§œ)
        let currentCalendarMonth = -1;

        // --- ì´ˆê¸°í™” ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. ìŠ¤í”Œë˜ì‹œ ìŠ¤í¬ë¦°
            enterAppButton.addEventListener('click', () => {
                splashScreen.style.display = 'none';
                appContainer.style.display = 'block';
                initializeGameData();
                updateUI();
                setupAdminButtons();
            });

            // 2. (V5 ìˆ˜ì •) ìƒì  ëª¨ë‹¬ ì´ë²¤íŠ¸
            shopButton.addEventListener('click', () => {
                shopModal.style.display = 'flex'; // ëª¨ë‹¬ ì—´ê¸°
            });
            closeShopModal.addEventListener('click', () => {
                shopModal.style.display = 'none'; // ëª¨ë‹¬ ë‹«ê¸°
            });
            window.addEventListener('click', (event) => { // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
                if (event.target == shopModal) {
                    shopModal.style.display = 'none';
                }
            });

            // 3. (V5 ìˆ˜ì •) ì‹¤ì œ êµ¬ë§¤ ë²„íŠ¼
            buyPokeballButton.addEventListener('click', handleShopBuy);
        });

        // 1. ë°ì´í„° ì´ˆê¸°í™” (V5: lastAttendanceDate ì œê±°)
        function initializeGameData() {
            userPoints = parseInt(localStorage.getItem('userPoints') || '100');
            attendanceCount = parseInt(localStorage.getItem('attendanceCount') || '0');
            pokedex = JSON.parse(localStorage.getItem('pokedex') || '{}');

            const today = new Date();
            const savedMonth = parseInt(localStorage.getItem('currentMonth') || '-1');
            currentCalendarMonth = today.getMonth(); // 0-11
            
            if (savedMonth === currentCalendarMonth) {
                monthlyStamps = JSON.parse(localStorage.getItem('monthlyStamps') || '[]');
            } else {
                monthlyStamps = [];
                localStorage.setItem('monthlyStamps', '[]');
                localStorage.setItem('currentMonth', currentCalendarMonth);
            }

            logMessage("ê²Œì„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ. (V5)");
        }

        // 2. ë°ì´í„° ì €ì¥ (V5: lastAttendanceDate ì œê±°)
        function saveData() {
            localStorage.setItem('userPoints', userPoints);
            localStorage.setItem('attendanceCount', attendanceCount);
            localStorage.setItem('pokedex', JSON.stringify(pokedex));
            localStorage.setItem('monthlyStamps', JSON.stringify(monthlyStamps));
            localStorage.setItem('currentMonth', currentCalendarMonth);
        }

        // 3. UI ì—…ë°ì´íŠ¸
        function updateUI() {
            pointsDisplay.textContent = userPoints;
            attendanceProgress.textContent = `${attendanceCount} / ${ATTENDANCE_GOAL}`;
            
            renderCalendar();
            renderPokedexGrid();
        }

        // === ìº˜ë¦°ë” ê¸°ëŠ¥ (V5 ê´€ë¦¬ììš© ìˆ˜ì •) ===
        // 4. ìº˜ë¦°ë” ê·¸ë¦¬ê¸°
        function renderCalendar() {
            calendarGrid.innerHTML = '';
            calendarWeekdays.innerHTML = ''; // V5: ìš”ì¼ í—¤ë” ë¶„ë¦¬
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();

            calendarHeader.textContent = `${year}ë…„ ${month + 1}ì›”`;

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const todayDate = today.getDate();

            // ìš”ì¼ í—¤ë” (ì¼~í† )
            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            calendarWeekdays.innerHTML = dayNames.map(name => `<div class="calendar-day-name">${name}</div>`).join('');

            // ë¹ˆ ì¹¸
            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarGrid.innerHTML += '<div class="calendar-day empty"></div>';
            }

            // ë‚ ì§œ
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                dayDiv.textContent = day;
                dayDiv.dataset.day = day;

                if (monthlyStamps.includes(day)) {
                    dayDiv.classList.add('stamped'); // ì´ë¯¸ ì¶œì„
                } else {
                    // (V5 ìˆ˜ì •) ê´€ë¦¬ì: ì¶œì„ ì•ˆí–ˆìœ¼ë©´ ëª¨ë‘ í´ë¦­ ê°€ëŠ¥
                    dayDiv.classList.add('clickable');
                    dayDiv.addEventListener('click', () => handleCalendarClick(dayDiv, day));
                }
                
                if (day === todayDate && !monthlyStamps.includes(day)) {
                    dayDiv.classList.add('today'); // ì˜¤ëŠ˜ ë‚ ì§œ ì‹œê°ì  ê°•ì¡°
                }
                
                calendarGrid.appendChild(dayDiv);
            }
        }

        // 5. ìº˜ë¦°ë” í´ë¦­ (V5 ê´€ë¦¬ììš© ìˆ˜ì •)
        function handleCalendarClick(dayDiv, day) {
            // (V5 ìˆ˜ì •) ì´ë¯¸ ì¶œì„í–ˆëŠ”ì§€ ì—¬ë¶€ë§Œ ì²´í¬
            if (monthlyStamps.includes(day)) {
                logMessage("ì´ë¯¸ ì¶œì„í•œ ë‚ ì§œì…ë‹ˆë‹¤.");
                return;
            }

            logMessage(`[Admin] ${day}ì¼ ì¶œì„! +${ATTENDANCE_REWARD_POINTS}P íšë“.`);
            userPoints += ATTENDANCE_REWARD_POINTS;
            attendanceCount += 1;
            monthlyStamps.push(day); // í•´ë‹¹ ë‚ ì§œë¥¼ ì¶œì„ ì²˜ë¦¬

            // í¬ì¸íŠ¸ íšë“ ì• ë‹ˆë©”ì´ì…˜
            const pointsToast = document.createElement('span');
            pointsToast.className = 'points-toast';
            pointsToast.textContent = `+${ATTENDANCE_REWARD_POINTS}P`;
            dayDiv.appendChild(pointsToast);
            setTimeout(() => pointsToast.remove(), 1500);

            // 3íšŒ ì¶œì„ ë³´ìƒ
            if (attendanceCount >= ATTENDANCE_GOAL) {
                logMessage(`${ATTENDANCE_GOAL}íšŒ ì¶œì„! ê¸°ë³¸ í¬ì¼“ëª¬ ì§€ê¸‰ ì¤‘...`);
                attendanceCount = 0; // ë¦¬ì…‹
                
                const randomId = BASIC_POKEMON_IDS[Math.floor(Math.random() * BASIC_POKEMON_IDS.length)];
                grantPokemonById(randomId); // ë¹„ë™ê¸° í˜¸ì¶œ
            }

            saveData();
            updateUI(); // UI(ìº˜ë¦°ë” í¬í•¨) ì¦‰ì‹œ ê°±ì‹ 
        }


        // === í¬ì¼“ëª¬ ê¸°ëŠ¥ (V4ì™€ ë™ì¼) ===
        // (ì—°ì† ì§„í™” ë¡œì§ì´ ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤)

        // 6. PokÃ©API ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì§„í™” ì²´ì¸ í¬í•¨)
        async function fetchPokemonData(pokemonId) {
            logMessage(`PokÃ©API í˜¸ì¶œ: ID ${pokemonId}...`);
            try {
                let cachedData = localStorage.getItem(`pokeCache_v4_${pokemonId}`);
                if (cachedData) {
                    logMessage(`ìºì‹œì—ì„œ ID ${pokemonId} ë°ì´í„° ë¡œë“œ.`);
                    return JSON.parse(cachedData);
                }

                const pokeResponse = await fetch(`${POKEAPI_BASE_URL}pokemon/${pokemonId}`);
                if (!pokeResponse.ok) throw new Error("Pokemon API ì‘ë‹µ ì‹¤íŒ¨");
                const pokeData = await pokeResponse.json();
                
                const speciesResponse = await fetch(pokeData.species.url);
                if (!speciesResponse.ok) throw new Error("Species API ì‘ë‹µ ì‹¤íŒ¨");
                const speciesData = await speciesResponse.json();
                
                const name = speciesData.names.find(n => n.language.name === 'ko')?.name || pokeData.name;
                const sprite = pokeData.sprites.front_default;

                let nextEvolutionId = null;
                if (speciesData.evolution_chain) {
                    const chainResponse = await fetch(speciesData.evolution_chain.url);
                    if (chainResponse.ok) {
                        const chainData = await chainResponse.json();
                        nextEvolutionId = findNextEvolution(chainData.chain, pokemonId);
                    }
                }

                const pokemonData = {
                    id: pokemonId, name: name, sprite: sprite, nextEvolutionId: nextEvolutionId
                };

                localStorage.setItem(`pokeCache_v4_${pokemonId}`, JSON.stringify(pokemonData));
                logMessage(`APIì—ì„œ ID ${pokemonId} ë°ì´í„° ë¡œë“œ (ë‹¤ìŒ ì§„í™”: ${nextEvolutionId})`);
                return pokemonData;

            } catch (error) {
                logMessage(`PokÃ©API ì˜¤ë¥˜: ${error.message}`);
                return null;
            }
        }

        // 7. ì§„í™” ì²´ì¸ íŒŒì‹± í•¨ìˆ˜ (ì¬ê·€)
        function findNextEvolution(chainNode, targetId) {
            const currentId = parseInt(chainNode.species.url.split('/')[6]);
            
            if (currentId === targetId) {
                if (chainNode.evolves_to.length > 0) {
                    const nextEvoId = parseInt(chainNode.evolves_to[0].species.url.split('/')[6]);
                    return nextEvoId;
                }
                return null;
            }
            for (const nextNode of chainNode.evolves_to) {
                const foundId = findNextEvolution(nextNode, targetId);
                if (foundId) return foundId;
            }
            return null;
        }

        // 8. (V5 ìˆ˜ì •) ìƒì  ë½‘ê¸° (ëª¨ë‹¬ ë‚´ë¶€ ë²„íŠ¼ì—ì„œ ì‹¤í–‰)
        async function handleShopBuy() {
            if (userPoints < SHOP_COST) {
                logMessage("í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
                return;
            }
            userPoints -= SHOP_COST;
            logMessage(`ëª¬ìŠ¤í„°ë³¼ ë½‘ê¸°! -${SHOP_COST}P...`);
            
            buyPokeballButton.disabled = true; // ëª¨ë‹¬ ë‚´ êµ¬ë§¤ ë²„íŠ¼ ë¹„í™œì„±í™”
            buyPokeballButton.textContent = "ë½‘ëŠ”ì¤‘...";
            shopButton.style.animation = "shake 0.5s"; // ë©”ì¸í™”ë©´ ë³¼ í”ë“¤ê¸°

            const randomId = RANDOM_POKEMON_IDS[Math.floor(Math.random() * RANDOM_POKEMON_IDS.length)];
            await grantPokemonById(randomId);
            
            setTimeout(() => {
                shopButton.style.animation = "";
                buyPokeballButton.disabled = false;
                buyPokeballButton.textContent = "êµ¬ë§¤ (10P)";
                shopModal.style.display = 'none'; // ë½‘ê¸° í›„ ëª¨ë‹¬ ë‹«ê¸°
            }, 500);

            saveData();
            updateUI();
        }

        // 9. IDë¡œ í¬ì¼“ëª¬ íšë“ (V4ì™€ ë™ì¼)
        async function grantPokemonById(pokemonId) {
            const pokemonData = await fetchPokemonData(pokemonId);
            if (!pokemonData) {
                logMessage("í¬ì¼“ëª¬ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                return;
            }

            if (pokedex[pokemonId]) {
                pokedex[pokemonId].count += 1;
                logMessage(`${pokemonData.name} íšë“! (ë³´ìœ : ${pokedex[pokemonId].count}ë§ˆë¦¬)`);
            } else {
                pokedex[pokemonId] = { ...pokemonData, count: 1 };
                logMessage(`ìƒˆë¡œìš´ í¬ì¼“ëª¬ ${pokemonData.name} íšë“!`);
            }
            
            saveData();
            updateUI();
        }

        // 10. í¬ì¼“ëª¬ ë„ê° ê·¸ë¦¬ê¸° (V4ì™€ ë™ì¼)
        function renderPokedexGrid() {
            pokedexGrid.innerHTML = '';
            const pokemonIds = Object.keys(pokedex).sort((a, b) => a - b);

            if (pokemonIds.length === 0) {
                pokedexGrid.innerHTML = '<p style="text-align: center; color: #777; grid-column: 1 / -1;">ì•„ì§ ì¡ì€ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            for (const id of pokemonIds) {
                const pokemon = pokedex[id];
                const card = document.createElement('div');
                card.className = 'pokemon-grid-item';
                
                let evolveButtonHtml = '';
                const canEvolve = pokemon.count >= 2 && pokemon.nextEvolutionId && userPoints >= EVOLVE_COST;
                const cantEvolveReason = pokemon.nextEvolutionId === null;
                
                if (cantEvolveReason) {
                    evolveButtonHtml = `<button class="evolve-btn disabled" disabled>ìµœì¢… ì§„í™”</button>`;
                } else if (canEvolve) {
                    evolveButtonHtml = `<button class="evolve-btn" onclick="handleEvolve('${id}')">ì§„í™” (10P)</button>`;
                }

                card.innerHTML = `
                    <div class="pokemon-count">${pokemon.count}</div>
                    <img src="${pokemon.sprite}" alt="${pokemon.name}">
                    <div class="pokemon-id">No. ${String(id).padStart(3, '0')}</div>
                    <div class="pokemon-name">${pokemon.name}</div>
                    ${evolveButtonHtml}
                `;
                pokedexGrid.appendChild(card);
            }
        }

        // 11. ì§„í™”í•˜ê¸° (V4ì™€ ë™ì¼)
        async function handleEvolve(pokemonId) {
            const pokemon = pokedex[pokemonId];
            const evolvedId = pokemon.nextEvolutionId;

            if (!pokemon || !evolvedId) {
                logMessage("ì§„í™” ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ìµœì¢… ì§„í™”ì…ë‹ˆë‹¤."); return;
            }
            if (userPoints < EVOLVE_COST) {
                logMessage("ì§„í™” í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."); return;
            }
            if (pokemon.count < 2) {
                logMessage("ì§„í™”ì— í•„ìš”í•œ í¬ì¼“ëª¬ì´ ë¶€ì¡±í•©ë‹ˆë‹¤."); return;
            }

            userPoints -= EVOLVE_COST;
            pokemon.count -= 2;
            logMessage(`${pokemon.name} 2ë§ˆë¦¬ë¥¼ ì‚¬ìš©í•´ ì§„í™”ë¥¼ ì‹œë„í•©ë‹ˆë‹¤... (-${EVOLVE_COST}P)`);

            if (pokemon.count <= 0) {
                delete pokedex[pokemonId];
            }

            await grantPokemonById(evolvedId);
            logMessage(`ì§„í™” ì„±ê³µ! ${pokemon.name}(ì´)ê°€ ìƒˆë¡œìš´ í¬ì¼“ëª¬ìœ¼ë¡œ ì§„í™”í–ˆìŠµë‹ˆë‹¤!`);

            saveData();
            updateUI();
        }
        
        // 12. ë¡œê·¸ ë©”ì‹œì§€
        function logMessage(message) {
            log.innerHTML = `<div>[${new Date().toLocaleTimeString()}] ${message}</div>` + log.innerHTML;
        }

        // 13. ê´€ë¦¬ì ë²„íŠ¼ ì„¤ì •
        function setupAdminButtons() {
            document.getElementById('adminAddPoints').addEventListener('click', () => {
                userPoints += 100;
                logMessage("[Admin] 100 í¬ì¸íŠ¸ ì¶”ê°€ë¨.");
                saveData(); updateUI();
            });
            document.getElementById('adminAddBasic').addEventListener('click', async () => {
                const randomId = BASIC_POKEMON_IDS[Math.floor(Math.random() * BASIC_POKEMON_IDS.length)];
                logMessage(`[Admin] ê¸°ë³¸ í¬ì¼“ëª¬(ID:${randomId}) ê°•ì œ íšë“.`);
                await grantPokemonById(randomId);
            });
            document.getElementById('adminAddRandom').addEventListener('click', async () => {
                const randomId = RANDOM_POKEMON_IDS[Math.floor(Math.random() * RANDOM_POKEMON_IDS.length)];
                logMessage(`[Admin] ëœë¤ í¬ì¼“ëª¬(ID:${randomId}) ê°•ì œ íšë“.`);
                await grantPokemonById(randomId);
            });
            document.getElementById('adminClearData').addEventListener('click', () => {
                if (confirm("!! ê²½ê³  !!\nëª¨ë“  ë°ì´í„°ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (í¬ì¸íŠ¸, ë„ê°, ì¶œì„)")) {
                    localStorage.clear();
                    // ë¦¬ì…‹ í›„ ì¬ì´ˆê¸°í™”
                    userPoints = 100;
                    attendanceCount = 0;
                    pokedex = {};
                    monthlyStamps = [];
                    currentCalendarMonth = new Date().getMonth();
                    logMessage("[Admin] ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ.");
                    saveData(); // ì´ˆê¸°í™”ëœ ìƒíƒœ ì €ì¥
                    updateUI(); // ê°•ì œ UI ë¦¬ì…‹
                }
            });
        }
    </script>
</body>
</html>