<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>POKE RUN: PROFILE</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:ital,wght@0,400;0,700;1,900&family=Inter:wght@400;700;900&family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <link rel="stylesheet" href="layout.css">

    <style>
        /* [ìŠ¤íƒ€ì¼] íƒ­ ë²„íŠ¼ ë””ìì¸ */
        .pokerun-icon-box {
            width: 34px; 
            height: 34px;
            border-radius: 10px;
            display: flex; 
            justify-content: center; 
            align-items: center;
            transition: transform 0.1s, opacity 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .pokerun-icon-box:active { transform: scale(0.95); }

        /* ì•„ì´ì½˜ ìƒ‰ìƒì€ ë¬´ì¡°ê±´ í°ìƒ‰ */
        .pokerun-icon-box .material-icons {
            color: white !important;
            font-size: 24px !important;
        }

        /* âš¡ï¸ 1ë²ˆ ë²„íŠ¼: íŒŒë€ìƒ‰ */
        .box-blue { background-color: #3586ff; box-shadow: 0 2px 4px rgba(53, 134, 255, 0.25); }
        
        /* ğŸ‘¤ 2ë²ˆ ë²„íŠ¼: ë³´ë¼ìƒ‰ */
        .box-purple { background-color: #8b5cf6; box-shadow: 0 2px 4px rgba(139, 92, 246, 0.25); }

        /* ëª¨ë‹¬ ì• ë‹ˆë©”ì´ì…˜ */
        .modal-enter { animation: modalFadeIn 0.2s ease-out forwards; }
        @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-[var(--bg-main)]">

    <main class="w-full h-full flex flex-col pb-20 overflow-y-auto scrollbar-hide">
        
        <div class="px-4 pt-6 pb-2">
            <div class="flex items-center justify-between mb-4">
                <div class="relative group cursor-pointer" onclick="openEditProfileModal()">
                    <div class="w-20 h-20 rounded-full p-[2px] bg-gradient-to-tr from-blue-500 to-purple-500">
                        <img id="my-profile-img" class="w-full h-full rounded-full border-2 border-white object-cover bg-gray-100">
                    </div>
                    <div class="absolute bottom-0 right-0 bg-blue-600 text-white rounded-full p-1 border-2 border-white">
                        <i data-lucide="pencil" class="w-3 h-3"></i>
                    </div>
                </div>
                
                <div class="flex-1 flex justify-around text-black ml-4">
                    <div class="flex flex-col items-center">
                        <span id="post-count" class="font-bold text-lg">0</span>
                        <span class="text-xs text-gray-500">ê²Œì‹œë¬¼</span>
                    </div>
                    <button onclick="openUserListModal('followers')" class="flex flex-col items-center hover:bg-gray-100 rounded-lg p-1 transition">
                        <span id="follower-count" class="font-bold text-lg">0</span>
                        <span class="text-xs text-gray-500">íŒ”ë¡œì›Œ</span>
                    </button>
                    <button onclick="openUserListModal('following')" class="flex flex-col items-center hover:bg-gray-100 rounded-lg p-1 transition">
                        <span id="following-count" class="font-bold text-lg">0</span>
                        <span class="text-xs text-gray-500">íŒ”ë¡œì‰</span>
                    </button>
                </div>
            </div>
            
            <div class="mb-5">
                <h3 id="my-profile-name" class="font-bold text-sm text-black">Loading...</h3>
                <p id="my-profile-bio" class="text-xs text-gray-500 mt-1">ìƒíƒœ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            </div>
            
            <div class="flex gap-2 text-sm font-bold">
                <button onclick="openEditProfileModal()" class="flex-1 bg-gray-100 py-1.5 rounded-lg border border-gray-300 active:scale-95 transition text-black">í”„ë¡œí•„ í¸ì§‘</button>
                <button class="flex-1 bg-gray-100 py-1.5 rounded-lg border border-gray-300 active:scale-95 transition text-black">í”„ë¡œí•„ ê³µìœ </button>
            </div>
        </div>

        <div class="flex border-t border-gray-200 items-center h-14 mt-2">
            <button id="tab-btn-posts" onclick="switchTab('posts')" class="flex-1 h-full border-b-2 border-black flex justify-center items-center text-black transition-all">
                <i data-lucide="grid-3x3" class="w-6 h-6"></i>
            </button>
            
            <button id="tab-btn-reels" onclick="switchTab('reels')" class="flex-1 h-full flex justify-center items-center transition-all opacity-50">
                <div class="pokerun-icon-box box-blue">
                    <span class="material-icons">bolt</span>
                </div>
            </button>
            
            <button id="tab-btn-tags" onclick="switchTab('tags')" class="flex-1 h-full flex justify-center items-center transition-all opacity-50">
                <div class="pokerun-icon-box box-purple">
                    <span class="material-icons">bolt</span>
                </div>
            </button>
        </div>

        <div id="tab-content-posts" class="w-full">
            <div id="my-post-grid" class="grid grid-cols-3 gap-0.5">
                <div class="bg-gray-100 aspect-square animate-pulse"></div>
                <div class="bg-gray-100 aspect-square animate-pulse"></div>
                <div class="bg-gray-100 aspect-square animate-pulse"></div>
            </div>
            <div id="no-posts-msg" class="hidden py-20 text-center text-gray-400">
                <div class="flex justify-center mb-2"><i data-lucide="camera" class="w-10 h-10 opacity-50"></i></div>
                <p class="text-sm">ì•„ì§ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </div>

        <div id="tab-content-reels" class="hidden w-full h-64 flex items-center justify-center text-gray-400">
            <p>ì €ì¥ëœ ë¦´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>

        <div id="tab-content-tags" class="hidden w-full h-64 flex items-center justify-center text-gray-400">
            <p>íƒœê·¸ëœ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
    </main>

    <div id="post-modal" class="fixed inset-0 z-50 bg-black/90 hidden flex items-center justify-center p-4 backdrop-blur-sm" onclick="closePostModal()">
        <div class="w-full max-w-sm bg-white rounded-xl overflow-hidden shadow-2xl border border-gray-200 modal-enter" onclick="event.stopPropagation()">
            <div class="px-4 py-3 flex items-center justify-between border-b border-gray-200">
                <div class="flex items-center gap-2">
                    <img id="modal-avatar" class="w-6 h-6 rounded-full bg-gray-200 object-cover">
                    <span id="modal-username" class="font-bold text-sm text-black">Username</span>
                </div>
                <button id="delete-post-btn" class="text-red-500 hidden hover:bg-gray-100 p-1 rounded transition" onclick="deleteCurrentPost()">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="w-full h-auto bg-black flex items-center justify-center relative min-h-[300px]">
                <img id="modal-image" class="w-full h-auto object-contain max-h-[70vh]">
            </div>
            <div class="p-4 bg-white">
                <div class="flex gap-4 mb-3">
                    <div class="flex items-center gap-1">
                        <i data-lucide="heart" class="w-6 h-6 text-blue-600 fill-blue-600"></i>
                        <span id="modal-likes" class="font-bold text-sm text-black">0</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <i data-lucide="message-circle" class="w-6 h-6 text-black"></i>
                        <span id="modal-comments" class="font-bold text-sm text-black">0</span>
                    </div>
                </div>
                <div id="modal-content" class="text-sm mt-2 text-black"></div>
                <div id="modal-date" class="text-[10px] text-gray-500 mt-2 uppercase"></div>
            </div>
        </div>
    </div>

    <div id="modal-user-list" class="fixed inset-0 z-50 bg-black/90 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="w-full max-w-sm bg-white rounded-xl overflow-hidden shadow-2xl border border-gray-200 flex flex-col max-h-[70vh]">
            <div class="px-4 py-3 flex items-center justify-between border-b border-gray-200">
                <span id="user-list-title" class="font-bold text-sm">ëª©ë¡</span>
                <button onclick="closeUserListModal()"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="user-list-content" class="flex-1 overflow-y-auto p-2 scrollbar-hide"></div>
        </div>
    </div>

    <div id="edit-profile-modal" class="fixed inset-0 z-50 bg-black/90 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="w-full max-w-sm bg-white rounded-xl overflow-hidden shadow-2xl border border-gray-200">
            <div class="px-4 py-3 flex items-center justify-between border-b border-gray-200">
                <span class="font-bold text-sm">í”„ë¡œí•„ í¸ì§‘</span>
                <button onclick="closeEditProfileModal()"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 flex flex-col items-center">
                <div class="relative group cursor-pointer mb-6" onclick="document.getElementById('edit-profile-img-input').click()">
                     <div class="w-24 h-24 rounded-full p-[2px] bg-gradient-to-tr from-blue-500 to-purple-500">
                        <img id="edit-profile-preview" class="w-full h-full rounded-full border-2 border-white object-cover bg-gray-100">
                    </div>
                    <div class="absolute bottom-0 right-0 bg-blue-600 text-white rounded-full p-1.5 border-2 border-white">
                        <i data-lucide="camera" class="w-4 h-4"></i>
                    </div>
                    <input type="file" id="edit-profile-img-input" class="hidden" accept="image/*" onchange="previewProfileImage(this)">
                </div>
                <div class="w-full space-y-4">
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">ë‹‰ë„¤ì„</label>
                        <input type="text" id="edit-nickname" class="w-full bg-gray-100 text-black rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="ë‹‰ë„¤ì„ ì…ë ¥">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">ìƒíƒœ ë©”ì‹œì§€</label>
                        <textarea id="edit-bio" rows="3" class="w-full bg-gray-100 text-black rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 resize-none" placeholder="ìì‹ ì„ ì†Œê°œí•´ë³´ì„¸ìš”."></textarea>
                    </div>
                </div>
                <button id="btn-save-profile" onclick="saveProfile()" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition active:scale-95">ì™„ë£Œ</button>
            </div>
        </div>
    </div>

    <script src="layout.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, query, orderByChild, equalTo, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        
        const firebaseConfig = { 
            apiKey: "AIzaSyAbHwLLXIH8rBQ8gNMVqE5SE208aIbfFZ0", 
            authDomain: "pokbattle.firebaseapp.com", 
            databaseURL: "https://pokbattle-default-rtdb.firebaseio.com", 
            projectId: "pokbattle" 
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let currentOpenPostId = null;

        onAuthStateChanged(auth, (user) => {
            if(user) {
                currentUser = user;
                updateProfileUI(user);
                loadMyPosts(user.uid);
                loadFollowStats(user.uid);
            } else {
                location.href = 'home.html';
            }
        });

        async function updateProfileUI(user) {
            document.getElementById('my-profile-name').innerText = user.displayName || "ëŸ¬ë„ˆ";
            const userRef = ref(db, `users/${user.uid}`);
            const snapshot = await get(userRef);
            let bio = "ìƒíƒœ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
            let profileImg = user.photoURL || `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.uid}`;
            if(snapshot.exists()) {
                const val = snapshot.val();
                if(val.bio) bio = val.bio;
                if(val.avatar) profileImg = val.avatar;
            }
            document.getElementById('my-profile-bio').innerText = bio;
            document.getElementById('my-profile-img').src = profileImg;
            document.getElementById('edit-profile-preview').src = profileImg;
        }

        function loadFollowStats(uid) {
            onValue(ref(db, `users/${uid}/followers`), (s) => document.getElementById('follower-count').innerText = s.exists() ? Object.keys(s.val()).length : 0);
            onValue(ref(db, `users/${uid}/following`), (s) => document.getElementById('following-count').innerText = s.exists() ? Object.keys(s.val()).length : 0);
        }

        // [í•µì‹¬] ê²Œì‹œë¬¼ ë¡œë“œ í•¨ìˆ˜ (í”„ë¡œí•„ ë³¸ ê¸°ëŠ¥)
        function loadMyPosts(userId) {
            const grid = document.getElementById('my-post-grid');
            onValue(ref(db, 'posts'), (snapshot) => {
                grid.innerHTML = "";
                const data = snapshot.val();
                if (!data) { showNoPosts(); return; }

                const myPosts = Object.entries(data)
                    .filter(([key, post]) => post.author === userId)
                    .sort((a, b) => b[1].timestamp - a[1].timestamp);
                
                document.getElementById('post-count').innerText = myPosts.length;
                if (myPosts.length === 0) { showNoPosts(); return; }

                document.getElementById('no-posts-msg').classList.add('hidden');
                myPosts.forEach(([key, post]) => {
                    const div = document.createElement('div');
                    div.className = "relative bg-black cursor-pointer group overflow-hidden aspect-square"; 
                    div.onclick = () => openPostModal(post, key);
                    const likesCount = post.likes ? Object.keys(post.likes).length : 0;
                    div.innerHTML = `<img src="${post.image}" class="w-full h-full object-cover">`;
                    grid.appendChild(div);
                });
            });
        }
        function showNoPosts() {
            document.getElementById('my-post-grid').innerHTML = "";
            document.getElementById('no-posts-msg').classList.remove('hidden');
            document.getElementById('post-count').innerText = "0";
        }

        // ê²Œì‹œë¬¼ ëª¨ë‹¬ ì—´ê¸°
        window.openPostModal = (post, postId) => {
            currentOpenPostId = postId;
            const modal = document.getElementById('post-modal');
            document.getElementById('modal-image').src = post.image;
            document.getElementById('modal-avatar').src = post.authorAvatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${post.author}`;
            document.getElementById('modal-username').innerText = post.authorName;
            document.getElementById('modal-content').innerText = post.content;
            document.getElementById('modal-date').innerText = new Date(post.timestamp).toLocaleDateString();
            
            const deleteBtn = document.getElementById('delete-post-btn');
            if(currentUser && post.author === currentUser.uid) deleteBtn.classList.remove('hidden');
            else deleteBtn.classList.add('hidden');
            
            modal.classList.remove('hidden');
            lucide.createIcons();
        };
        window.closePostModal = () => document.getElementById('post-modal').classList.add('hidden');

        // ê²Œì‹œë¬¼ ì‚­ì œ
        window.deleteCurrentPost = async () => {
            if(!currentOpenPostId) return;
            if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await remove(ref(db, `posts/${currentOpenPostId}`));
                closePostModal();
            }
        };

        // í”„ë¡œí•„ í¸ì§‘ ë° ìœ ì € ë¦¬ìŠ¤íŠ¸ ê´€ë ¨ í•¨ìˆ˜ë“¤
        window.openEditProfileModal = () => {
            document.getElementById('edit-nickname').value = document.getElementById('my-profile-name').innerText;
            document.getElementById('edit-bio').value = document.getElementById('my-profile-bio').innerText === "ìƒíƒœ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." ? "" : document.getElementById('my-profile-bio').innerText;
            document.getElementById('edit-profile-modal').classList.remove('hidden');
        };
        window.closeEditProfileModal = () => document.getElementById('edit-profile-modal').classList.add('hidden');
        window.previewProfileImage = (input) => {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => document.getElementById('edit-profile-preview').src = e.target.result;
                reader.readAsDataURL(input.files[0]);
            }
        };
        window.saveProfile = async () => {
            if (!currentUser) return;
            const newNick = document.getElementById('edit-nickname').value.trim();
            const newBio = document.getElementById('edit-bio').value.trim();
            const newPhoto = document.getElementById('edit-profile-preview').src;
            
            if(!newNick) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            
            const updates = {};
            updates[`users/${currentUser.uid}/nickname`] = newNick;
            updates[`users/${currentUser.uid}/bio`] = newBio;
            if(!newPhoto.startsWith("http")) updates[`users/${currentUser.uid}/avatar`] = newPhoto;

            await updateProfile(currentUser, { displayName: newNick });
            await update(ref(db), updates);
            
            updateProfileUI(currentUser);
            closeEditProfileModal();
        };

        window.openUserListModal = async (type) => {
            const modal = document.getElementById('modal-user-list');
            const title = document.getElementById('user-list-title');
            const content = document.getElementById('user-list-content');
            modal.classList.remove('hidden');
            content.innerHTML = "Loading...";
            title.innerText = type === 'followers' ? "íŒ”ë¡œì›Œ" : "íŒ”ë¡œì‰";
            
            const refPath = `users/${currentUser.uid}/${type}`;
            const snapshot = await get(ref(db, refPath));
            content.innerHTML = "";
            if(!snapshot.exists()) { content.innerHTML = "<div class='p-4 text-center text-gray-400'>ì—†ìŒ</div>"; return; }
            
            Object.keys(snapshot.val()).forEach(async (uid) => {
                const uSnap = await get(ref(db, `users/${uid}`));
                if(uSnap.exists()) {
                    const u = uSnap.val();
                    content.innerHTML += `<div class="p-3 border-b border-gray-100 flex items-center gap-3">
                        <img src="${u.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed='+uid}" class="w-10 h-10 rounded-full bg-gray-100">
                        <span class="font-bold text-sm">${u.nickname || 'ìœ ì €'}</span>
                    </div>`;
                }
            });
        };
        window.closeUserListModal = () => document.getElementById('modal-user-list').classList.add('hidden');
        
        // [ìˆ˜ì •ëœ í•µì‹¬ í•¨ìˆ˜] íƒ­ ì „í™˜ ì‹œ ë””ìì¸ì´ ê¹¨ì§€ì§€ ì•Šë„ë¡ ì²˜ë¦¬
        window.switchTab = (tab) => {
            const tabs = ['posts', 'reels', 'tags'];
            tabs.forEach(t => {
                const content = document.getElementById(`tab-content-${t}`);
                const btn = document.getElementById(`tab-btn-${t}`);
                
                // ë‚´ìš© ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°
                if (t === tab) content.classList.remove('hidden');
                else content.classList.add('hidden');

                // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì œì–´ (í´ë˜ìŠ¤ë¥¼ ë®ì–´ì“°ì§€ ì•Šê³  ê°œë³„ ì œì–´)
                if (t === 'posts') {
                    if (t === tab) btn.className = "flex-1 h-full border-b-2 border-black flex justify-center items-center text-black transition-all";
                    else btn.className = "flex-1 h-full flex justify-center items-center text-gray-400 transition-all";
                } else {
                    // ë¦´ìŠ¤, íƒœê·¸ ë²„íŠ¼ì€ íˆ¬ëª…ë„(opacity)ë¡œ í™œì„± ìƒíƒœ í‘œì‹œ
                    if (t === tab) btn.style.opacity = "1";
                    else btn.style.opacity = "0.5";
                }
            });
            lucide.createIcons();
        };

        lucide.createIcons();
    </script>
</body>
</html>