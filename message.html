<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>POKE RUN: Message & Friends</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* ------------------ í…Œë§ˆ ì„¤ì • ------------------ */
        /* ê¸°ë³¸ ë‹¤í¬ ëª¨ë“œ ì„¤ì • (Base Theme) */
        :root { 
            --volt: #ccff00;  /* ì•¡ì„¼íŠ¸ ìƒ‰ìƒì€ ìœ ì§€ */
            --bg-main: #000000; /* ë°°ê²½ */
            --text-main: #ffffff; /* ê¸°ë³¸ í…ìŠ¤íŠ¸ */
            --border-color: #262626; /* ë³´ë”/êµ¬ë¶„ì„  */
            --bg-card: #111111; /* ì¹´ë“œ/ëª¨ë‹¬ ë°°ê²½ (ë‹¤í¬) */
            --bg-sub: #1f2937; /* ì…ë ¥ì°½/í˜¸ë²„ ë°°ê²½ (ë‹¤í¬) */
            --text-sub: #9ca3af; /* ì„œë¸Œ í…ìŠ¤íŠ¸ */
        }

        /* í™”ì´íŠ¸ ëª¨ë“œ ì˜¤ë²„ë¼ì´ë“œ (White Mode Theme) */
        .white-mode {
            --volt:#2563eb;
            --bg-main: #f8f8f8;
            --text-main: #1f2937;
            --border-color: #e5e7eb;
            --bg-card: #ffffff;
            --bg-sub: #f3f4f6; /* ì…ë ¥ì°½/í˜¸ë²„ ë°°ê²½ (í™”ì´íŠ¸) */
            --text-sub: #6b7280;
        }
        
        /* ------------------ ê¸°ë³¸ ìŠ¤íƒ€ì¼ ------------------ */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg-main); 
            color: var(--text-main); 
        }
        
        .msg-bubble { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 14px; word-wrap: break-word; line-height: 1.4; }
        .msg-me { background: var(--volt); color: black; border-bottom-right-radius: 4px; align-self: flex-end; font-weight: 500; }
        .msg-other { 
            background: var(--bg-sub); /* ë‹¤í¬/í™”ì´íŠ¸ ëª¨ë“œì— ë§ì¶° ë°°ê²½ìƒ‰ ë³€ê²½ */
            color: var(--text-main); 
            border-bottom-left-radius: 4px; 
            align-self: flex-start; 
        }
        
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ - ì˜¤ë²„ë ˆì´ëŠ” ìœ ì§€ */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-overlay.active { display: flex; animation: fadeIn 0.2s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex justify-center h-screen">
    <div class="w-full max-w-md h-full relative bg-[var(--bg-card)] flex flex-col overflow-hidden shadow-2xl border-x border-[var(--border-color)]">
        
        <header class="px-5 py-4 border-b border-[var(--border-color)] bg-[var(--bg-card)] z-10 shrink-0">
            <div class="flex items-center justify-between mb-4">
                <button onclick="location.href='log.html'" class="active:scale-95 transition"><i data-lucide="arrow-left" class="w-6 h-6 text-[var(--text-sub)]"></i></button>
                <span class="font-bold text-lg tracking-tight text-[var(--text-main)]">MESSAGES</span>
                <div class="flex gap-4">
                    <button id="theme-toggle-btn" onclick="toggleTheme()" class="active:scale-95 transition">
                        </button>
                    <button onclick="openFriendModal()" class="relative active:scale-95 transition">
                        <i data-lucide="contact" class="w-6 h-6 text-[var(--volt)]"></i>
                    </button>
                    <button onclick="openGroupCreateModal()" class="active:scale-95 transition">
                        <i data-lucide="message-square-plus" class="w-6 h-6 text-[var(--text-main)]"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex gap-2 overflow-x-auto hide-scrollbar mb-4">
                <button onclick="enterOpenChat('running')" class="whitespace-nowrap px-4 py-2 rounded-full bg-[var(--bg-sub)] text-xs font-bold border border-[var(--border-color)] text-[var(--text-main)] hover:border-[var(--volt)] hover:text-[var(--volt)] transition">ğŸƒ ëŸ°ë‹</button>
                <button onclick="enterOpenChat('weight')" class="whitespace-nowrap px-4 py-2 rounded-full bg-[var(--bg-sub)] text-xs font-bold border border-[var(--border-color)] text-[var(--text-main)] hover:border-[var(--volt)] hover:text-[var(--volt)] transition">ğŸ’ª ì›¨ì´íŠ¸</button>
                <button onclick="enterOpenChat('pokemon')" class="whitespace-nowrap px-4 py-2 rounded-full bg-[var(--bg-sub)] text-xs font-bold border border-[var(--border-color)] text-[var(--text-main)] hover:border-[var(--volt)] hover:text-[var(--volt)] transition">ğŸ± í¬ì¼“ëª¬</button>
                <button onclick="enterOpenChat('etc')" class="whitespace-nowrap px-4 py-2 rounded-full bg-[var(--bg-sub)] text-xs font-bold border border-[var(--border-color)] text-[var(--text-main)] hover:border-[var(--volt)] hover:text-[var(--volt)] transition">ğŸ’¬ ììœ </button>
            </div>

            <div class="relative">
                <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-[var(--text-sub)]"></i>
                <input type="text" id="chat-search" onkeyup="filterChats()" placeholder="ëŒ€í™”ë°© ì´ë¦„ ê²€ìƒ‰" class="w-full bg-[var(--bg-sub)] border border-[var(--border-color)] rounded-lg pl-9 pr-3 py-2.5 text-sm text-[var(--text-main)] outline-none focus:border-[var(--volt)] transition">
            </div>
        </header>

        <div id="chat-list" class="flex-1 overflow-y-auto">
            <div class="text-center text-[var(--text-sub)] py-20 text-sm">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>

        <div id="chat-room" class="absolute inset-0 bg-[var(--bg-main)] z-40 flex flex-col transform translate-x-full transition-transform duration-300">
            <div class="px-4 py-3 border-b border-[var(--border-color)] flex items-center justify-between bg-[var(--bg-card)]/95 backdrop-blur">
                <div class="flex items-center gap-3">
                    <button onclick="closeChatRoom()"><i data-lucide="chevron-left" class="w-8 h-8 text-[var(--text-sub)]"></i></button>
                    <div>
                        <div id="chat-room-title" class="font-bold text-base text-[var(--text-main)]">Chat</div>
                        <div id="chat-room-type" class="text-[10px] text-[var(--volt)] font-medium tracking-wider"></div>
                    </div>
                </div>
            </div>
            
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col gap-3 scroll-smooth"></div>
            
            <div class="p-3 border-t border-[var(--border-color)] flex gap-2 bg-[var(--bg-card)] safe-area-bottom">
                <input type="text" id="msg-input" onkeypress="if(event.key==='Enter') sendMessage()" class="flex-1 bg-[var(--bg-sub)] border border-[var(--border-color)] rounded-full px-5 py-3 outline-none text-sm text-[var(--text-main)] focus:border-[var(--volt)]" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                <button onclick="sendMessage()" class="bg-[var(--volt)] text-black rounded-full p-3 hover:opacity-80 transition"><i data-lucide="send" class="w-5 h-5"></i></button>
            </div>
        </div>

        <div id="modal-friend" class="modal-overlay">
            <div class="bg-[var(--bg-card)] w-[90%] max-w-sm rounded-2xl p-6 border border-[var(--border-color)] flex flex-col max-h-[85vh] shadow-2xl">
                <div class="flex justify-between items-center mb-5">
                    <h3 class="font-bold text-xl text-[var(--text-main)]">ì¹œêµ¬ ê´€ë¦¬</h3>
                    <button onclick="closeModal('modal-friend')" class="text-[var(--text-sub)]"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                
                <div class="flex gap-2 mb-2">
                    <input type="text" id="friend-search-input" placeholder="ì¹œêµ¬ ë‹‰ë„¤ì„ ê²€ìƒ‰" class="flex-1 bg-[var(--bg-sub)] px-4 py-3 rounded-lg text-sm outline-none border border-[var(--border-color)] focus:border-[var(--volt)] text-[var(--text-main)]">
                    <button onclick="searchFriend()" class="bg-[var(--volt)] text-black font-bold px-4 rounded-lg text-sm whitespace-nowrap">ê²€ìƒ‰</button>
                </div>
                <div id="friend-search-result" class="text-xs text-[var(--text-sub)] mb-6 min-h-[24px] flex items-center ml-1"></div>

                <div class="h-px bg-[var(--border-color)] w-full mb-4"></div>

                <div class="flex justify-between items-end mb-2">
                    <h4 class="text-sm font-bold text-[var(--text-main)]">ë‚´ ì¹œêµ¬ ëª©ë¡ <span id="friend-count" class="text-[var(--volt)] text-xs ml-1">0</span></h4>
                    <span class="text-[10px] text-[var(--text-sub)]">ë“±ë¡ëœ ì¹œêµ¬ë§Œ ë³´ì…ë‹ˆë‹¤</span>
                </div>
                
                <div id="my-friend-list" class="flex-1 overflow-y-auto space-y-3 pr-1 min-h-[200px] mb-4">
                    </div>
            </div>
        </div>

        <div id="modal-group" class="modal-overlay">
            <div class="bg-[var(--bg-card)] w-[90%] max-w-sm rounded-2xl p-6 border border-[var(--border-color)] flex flex-col max-h-[85vh]">
                <h3 class="font-bold text-lg mb-4 text-[var(--text-main)]">ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸°</h3>
                
                <label class="text-xs text-[var(--text-sub)] mb-1 block ml-1">ì±„íŒ…ë°© ì´ë¦„</label>
                <input type="text" id="new-group-name" placeholder="ì˜ˆ: ì£¼ë§ ëŸ°ë‹ ëª¨ì„" class="w-full bg-[var(--bg-sub)] px-4 py-3 rounded-lg text-sm outline-none border border-[var(--border-color)] focus:border-[var(--volt)] mb-5 text-[var(--text-main)]">
                
                <div class="flex justify-between items-center mb-2">
                    <div class="text-xs text-[var(--text-sub)] ml-1">ëŒ€í™” ìƒëŒ€ë¡œ ì´ˆëŒ€í•˜ê¸°</div>
                    <button onclick="loadFriendListForGroup()" class="text-[10px] text-[var(--volt)] underline font-bold cursor-pointer">ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
                </div>

                <div id="friend-list-select" class="flex-1 overflow-y-auto border border-[var(--border-color)] bg-[var(--bg-sub)] rounded-lg p-3 mb-5 space-y-2 max-h-[200px]">
                    </div>

                <div class="flex gap-3">
                    <button onclick="closeModal('modal-group')" class="flex-1 py-3 bg-[var(--border-color)] rounded-lg text-sm text-[var(--text-main)] font-medium">ì·¨ì†Œ</button>
                    <button onclick="createGroupChat()" class="flex-1 py-3 bg-[var(--volt)] text-black font-bold rounded-lg text-sm shadow-[0_0_10px_rgba(204,255,0,0.3)]">ë°© ë§Œë“¤ê¸°</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, onValue, update, get, set, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        
        const app = initializeApp({ apiKey: "AIzaSyAbHwLLXIH8rBQ8gNMVqE5SE208aIbfFZ0", authDomain: "pokbattle.firebaseapp.com", databaseURL: "https://pokbattle-default-rtdb.firebaseio.com", projectId: "pokbattle" });
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        let currentChatId = null;
        let myUid = null;
        let myNickname = "Unknown";

        lucide.createIcons();
        
        // 0. [ì¶”ê°€] í…Œë§ˆ ê´€ë¦¬ ê¸°ëŠ¥
        window.currentTheme = localStorage.getItem('theme') || 'white-mode'; // í™”ì´íŠ¸ ëª¨ë“œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
        const body = document.body;
        const themeButton = document.getElementById('theme-toggle-btn');

        function updateThemeIcon() {
            if (!themeButton) return;
            // í˜„ì¬ í…Œë§ˆì— ë”°ë¼ ì•„ì´ì½˜ ë³€ê²½ (white-mode -> dark-mode ì „í™˜ ì‹œ 'moon' í‘œì‹œ)
            const icon = currentTheme === 'white-mode' ? 'moon' : 'sun';
            themeButton.innerHTML = `<i data-lucide="${icon}" class="w-6 h-6 text-[var(--text-main)]"></i>`;
            lucide.createIcons();
        }

        function applyTheme(theme) {
            // ê¸°ì¡´ í…Œë§ˆ í´ë˜ìŠ¤ ì œê±°
            body.className = body.className.split(' ').filter(c => c !== 'white-mode').join(' ');
            
            if (theme === 'white-mode') {
                body.classList.add('white-mode');
            }
            currentTheme = theme;
            localStorage.setItem('theme', theme);
            updateThemeIcon();
        }

        window.toggleTheme = () => {
            const newTheme = currentTheme === 'white-mode' ? 'dark-mode' : 'white-mode';
            applyTheme(newTheme);
        };
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ í…Œë§ˆ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            applyTheme(currentTheme);
        });

        // 1. ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° ì´ˆê¸°í™”
        onAuthStateChanged(auth, (user) => {
            if (user) {
                myUid = user.uid;
                // ì‚¬ìš©ì ì •ë³´ í™•ì¸ ë° ìë™ ë“±ë¡ (DB)
                const userRef = ref(db, `users/${myUid}`);
                get(userRef).then(snap => {
                    if(!snap.exists()) {
                        myNickname = user.displayName || "User" + myUid.slice(-4);
                        update(userRef, { nickname: myNickname, uid: myUid });
                    } else {
                        myNickname = snap.val().nickname;
                    }
                });
                loadChatList(); // ì±„íŒ… ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            } else {
                document.getElementById('chat-list').innerHTML = "<div class='flex flex-col items-center justify-center h-full text-gray-500 gap-2'><i data-lucide='lock' class='w-6 h-6'></i><span>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</span></div>";
                lucide.createIcons();
            }
        });

        // 2. ì±„íŒ… ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ë¹„ê³µê°œ í•„í„°ë§ í¬í•¨)
        function loadChatList() {
            onValue(ref(db, 'groups'), (snap) => {
                const list = document.getElementById('chat-list');
                list.innerHTML = "";
                const data = snap.val();

                if(!data) {
                    list.innerHTML = "<div class='text-center py-20 text-[var(--text-sub)] text-sm'>ì§„í–‰ ì¤‘ì¸ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ìƒˆë¡œìš´ ì¹œêµ¬ë¥¼ ì‚¬ê·€ì–´ë³´ì„¸ìš”!</div>";
                    return;
                }

                // ì •ë ¬: ìµœì‹  ë©”ì‹œì§€ ì‹œê°„ ìˆœ (ë‚´ë¦¼ì°¨ìˆœ)
                const sortedChats = Object.entries(data).sort((a, b) => (b[1].lastTime || 0) - (a[1].lastTime || 0));

                sortedChats.forEach(([key, g]) => {
                    // [ì¤‘ìš”] ê°œì¸ì •ë³´ ë³´í˜¸: ë©¤ë²„ì— ë‚´ê°€ í¬í•¨ë˜ì–´ ìˆê±°ë‚˜, ì˜¤í”ˆì±„íŒ…('open_')ì¸ ê²½ìš°ë§Œ í‘œì‹œ
                    if ((g.members && g.members[myUid]) || key.startsWith('open_')) {
                        renderChatItem(list, key, g);
                    }
                });
                lucide.createIcons();
            });
        }

        function renderChatItem(container, key, g) {
            const div = document.createElement('div');
            // í˜¸ë²„ ìƒ‰ìƒ, ë³´ë” ìƒ‰ìƒì— ë³€ìˆ˜ ì ìš©
            div.className = "chat-item w-full flex items-center gap-4 p-4 hover:bg-[var(--bg-sub)] active:opacity-90 cursor-pointer border-b border-[var(--border-color)] group transition-colors";
            div.dataset.name = g.name; 
            
            // ì•„ì´ì½˜ ë°°ê²½ ë° í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½
            let iconBgColor = "bg-[var(--bg-sub)] text-[var(--text-sub)]";
            let typeTag = "GROUP";
            // íƒ€ì… íƒœê·¸ ë³´ë” ë° í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½
            let typeColor = "text-[var(--text-sub)] border-[var(--text-sub)]";
            
            if(key.startsWith('open_')) { 
                iconBgColor = "bg-[var(--volt)] text-black"; 
                typeTag = "OPEN"; 
                typeColor = "text-[var(--volt)] border-[var(--volt)]";
            } else if (g.type === 'private') {
                typeTag = "1:1";
            }

            // ì‹œê°„ í¬ë§·íŒ…
            const timeStr = g.lastTime ? new Date(g.lastTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';

            div.innerHTML = `
                <div class="w-12 h-12 rounded-full ${iconBgColor} flex items-center justify-center font-bold text-sm shrink-0 shadow-sm">
                    ${g.name.slice(0,2)}
                </div>
                <div class="flex-1 min-w-0" onclick="openChatRoom('${key}', '${g.name}', '${typeTag}')">
                    <div class="flex justify-between items-center mb-0.5">
                        <div class="font-bold truncate text-sm text-[var(--text-main)]">${g.name} <span class="text-[9px] ${typeColor} border px-1 rounded ml-1 align-middle">${typeTag}</span></div>
                        <div class="text-[10px] text-[var(--text-sub)]">${timeStr}</div>
                    </div>
                    <div class="text-sm text-[var(--text-sub)] truncate pr-2">${g.lastMsg || 'ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”.'}</div>
                </div>
                <button onclick="leaveChat('${key}')" class="p-2 text-[var(--text-sub)] hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity" title="ë‚˜ê°€ê¸°">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                </button>
            `;
            container.appendChild(div);
        }

        // 3. ì±„íŒ…ë°© ì§„ì… & ë©”ì‹œì§€ ì „ì†¡
        window.openChatRoom = (id, title, typeLabel) => {
            currentChatId = id;
            document.getElementById('chat-room-title').innerText = title;
            document.getElementById('chat-room-type').innerText = typeLabel === 'OPEN' ? 'ì˜¤í”ˆ ì±„íŒ…ë°©' : 'ë¹„ê³µê°œ ì±„íŒ…ë°©';
            document.getElementById('chat-room').style.transform = "translateX(0)";
            
            // ë©”ì‹œì§€ ì‹¤ì‹œê°„ ë¡œë“œ
            onValue(ref(db, `messages/${id}`), (snap) => {
                const container = document.getElementById('chat-messages');
                container.innerHTML = "";
                const data = snap.val();
                if(data) {
                    Object.values(data).forEach(m => {
                        const isMe = m.uid === myUid;
                        container.innerHTML += `
                            <div class="w-full flex ${isMe ? 'justify-end' : 'justify-start'}">
                                <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} max-w-[80%]">
                                    <span class="text-[10px] text-[var(--text-sub)] mb-1 px-1 ${isMe ? 'hidden' : 'block'}">${m.nickname}</span>
                                    <div class="msg-bubble ${isMe ? 'msg-me' : 'msg-other'} shadow-sm">
                                        ${m.text}
                                    </div>
                                </div>
                            </div>`;
                    });
                }
                container.scrollTop = container.scrollHeight;
            });
        };

        window.closeChatRoom = () => {
            document.getElementById('chat-room').style.transform = "translateX(100%)";
            currentChatId = null;
        };

        window.sendMessage = () => {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text || !currentChatId) return;
            
            push(ref(db, `messages/${currentChatId}`), { 
                uid: myUid, 
                nickname: myNickname, 
                text, 
                timestamp: Date.now() 
            });
            update(ref(db, `groups/${currentChatId}`), { 
                lastMsg: text, 
                lastTime: Date.now() 
            });
            input.value = "";
            input.focus();
        };

        // 4. ì˜¤í”ˆ ì±„íŒ… ì…ì¥ (ìë™ ìƒì„±/ì…ì¥)
        window.enterOpenChat = (type) => {
            const chatMap = {
                'running': { id: 'open_running', name: 'ğŸƒ ëŸ°ë‹ ì»¤ë®¤ë‹ˆí‹°' },
                'weight': { id: 'open_weight', name: 'ğŸ’ª í—¬ì°½ë“¤ì˜ ìˆ˜ë‹¤' },
                'pokemon': { id: 'open_pokemon', name: 'ğŸ± í¬ì¼“ëª¬ ì •ë³´ê³µìœ ' },
                'etc': { id: 'open_etc', name: 'ğŸ’¬ ììœ  ì¡ë‹´ë°©' }
            };
            const target = chatMap[type];
            if(!target) return;

            const groupRef = ref(db, `groups/${target.id}`);
            get(groupRef).then((snap) => {
                if(!snap.exists()) {
                    set(groupRef, { name: target.name, type: 'open', lastMsg: 'ì˜¤í”ˆì±„íŒ… ì‹œì‘', members: { [myUid]: true } });
                } else {
                    update(ref(db, `groups/${target.id}/members`), { [myUid]: true });
                }
                openChatRoom(target.id, target.name, 'OPEN');
            });
        };

        // 5. ì¹œêµ¬ ê´€ë¦¬ ë¡œì§ (í”„ë¡œí•„, 1:1, ì‚­ì œ)
        window.openFriendModal = () => {
            document.getElementById('modal-friend').classList.add('active');
            loadMyFriendList();
        };

        window.searchFriend = () => {
            const input = document.getElementById('friend-search-input').value.trim();
            const resDiv = document.getElementById('friend-search-result');
            if(!input) return;
            resDiv.innerHTML = "ğŸ” ì°¾ëŠ” ì¤‘...";
            
            get(ref(db, 'users')).then((snap) => {
                if(!snap.exists()) return resDiv.innerHTML = "ê°€ì…ëœ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.";
                let foundUid = null, foundData = null;
                
                snap.forEach(child => {
                    if(child.val().nickname === input) { foundUid = child.key; foundData = child.val(); }
                });

                if(foundUid) {
                    if(foundUid === myUid) {
                        resDiv.innerHTML = "<span class='text-[var(--volt)]'>ë³¸ì¸ì…ë‹ˆë‹¤.</span>";
                    } else {
                        // ê²€ìƒ‰ ê²°ê³¼ UI ë°°ê²½ìƒ‰/ë³´ë”ìƒ‰/ì•„ë°”íƒ€ ë°°ê²½ìƒ‰/í…ìŠ¤íŠ¸ìƒ‰ ë³€ìˆ˜ ì ìš©
                        resDiv.innerHTML = `
                            <div class="flex items-center justify-between w-full p-3 bg-[var(--bg-sub)] rounded-lg border border-[var(--border-color)]">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-[var(--border-color)] flex items-center justify-center text-[var(--text-main)] text-xs">${foundData.nickname[0]}</div>
                                    <span class="font-bold text-sm text-[var(--text-main)]">${foundData.nickname}</span>
                                </div>
                                <button onclick="addFriend('${foundUid}', '${foundData.nickname}')" class="bg-[var(--volt)] text-black text-xs px-3 py-1.5 rounded font-bold hover:brightness-110">ì¹œêµ¬ ì¶”ê°€</button>
                            </div>`;
                    }
                } else {
                    resDiv.innerHTML = "<span class='text-red-500'>ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>";
                }
            });
        };

        window.addFriend = (fUid, fNick) => {
            update(ref(db, `users/${myUid}/friends`), { [fUid]: fNick })
            .then(() => {
                alert(`${fNick}ë‹˜ì´ ì¹œêµ¬ ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                loadMyFriendList();
                document.getElementById('friend-search-input').value = "";
                document.getElementById('friend-search-result').innerHTML = "";
            });
        };

        // ì¹œêµ¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (UI ê°œì„ : í”„ë¡œí•„ + 1:1 ë²„íŠ¼ + ì‚­ì œ)
        window.loadMyFriendList = () => {
            const listDiv = document.getElementById('my-friend-list');
            const countSpan = document.getElementById('friend-count');
            
            onValue(ref(db, `users/${myUid}/friends`), (snap) => {
                listDiv.innerHTML = "";
                if(!snap.exists()) {
                    countSpan.innerText = "0";
                    listDiv.innerHTML = "<div class='text-center text-xs text-[var(--text-sub)] py-6'>ë“±ë¡ëœ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ê²€ìƒ‰í•´ì„œ ì¶”ê°€í•´ë³´ì„¸ìš”!</div>";
                    return;
                }
                
                const friends = snap.val();
                let validCount = 0;

                Object.entries(friends).forEach(([uid, name]) => {
                    // [ë²„ê·¸ ìˆ˜ì •] ì˜ëª»ëœ ë°ì´í„°(boolean ë“±) í•„í„°ë§
                    if (typeof name !== 'string' || !name) return;

                    validCount++;
                    const item = document.createElement('div');
                    // ì¹œêµ¬ ëª©ë¡ ì•„ì´í…œ ë°°ê²½ìƒ‰/ë³´ë”ìƒ‰ì— ë³€ìˆ˜ ì ìš©
                    item.className = "flex items-center justify-between p-3 bg-[var(--bg-sub)] rounded-xl border border-[var(--border-color)] hover:border-[var(--text-sub)] transition";
                    item.innerHTML = `
                        <div class="flex items-center gap-3 flex-1">
                            <div class="w-10 h-10 rounded-full bg-[var(--border-color)] flex items-center justify-center text-sm font-bold text-[var(--text-main)] border border-[var(--text-sub)]">
                                ${name.slice(0,1)}
                            </div>
                            <div class="flex flex-col">
                                <span class="text-sm font-bold text-[var(--text-main)]">${name}</span>
                                <span class="text-[10px] text-[var(--volt)]">ì¹œêµ¬</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="startPrivateChat('${uid}', '${name}')" class="bg-[var(--border-color)] hover:bg-[var(--volt)] hover:text-black text-[var(--text-main)] p-2 rounded-lg transition" title="1:1 ëŒ€í™”">
                                <i data-lucide="message-circle" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteFriend('${uid}')" class="bg-[var(--border-color)] hover:bg-red-500/20 hover:text-red-500 text-[var(--text-sub)] p-2 rounded-lg transition" title="ì¹œêµ¬ ì‚­ì œ">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `;
                    listDiv.appendChild(item);
                });
                countSpan.innerText = validCount;
                lucide.createIcons();
            });
        };

        // ì¹œêµ¬ ì‚­ì œ ë¡œì§ (í™•ì‹¤í•˜ê²Œ ì²˜ë¦¬)
        window.deleteFriend = (fUid) => {
            if(!confirm("ì •ë§ ì´ ì¹œêµ¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në” ì´ìƒ ê·¸ë£¹ì— ì´ˆëŒ€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;
            
            remove(ref(db, `users/${myUid}/friends/${fUid}`))
            .then(() => {
                // UIëŠ” onValue ë¦¬ìŠ¤ë„ˆì— ì˜í•´ ìë™ ê°±ì‹ ë¨
            })
            .catch(err => alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message));
        };

        // 1:1 ë¹„ê³µê°œ ì±„íŒ… ì‹œì‘
        window.startPrivateChat = (fUid, fName) => {
            // ë‚˜ì™€ ì¹œêµ¬ë§Œ ìˆëŠ” ë°© ìƒì„±
            const roomName = `${myNickname}, ${fName}`;
            const members = { [myUid]: true, [fUid]: true };
            
            const newGroupRef = push(ref(db, 'groups'));
            update(newGroupRef, {
                name: roomName,
                type: 'private', // í”„ë¼ì´ë¹— íƒœê·¸
                members: members,
                lastMsg: '1:1 ëŒ€í™”ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.',
                lastTime: Date.now()
            }).then(() => {
                closeModal('modal-friend'); // ì¹œêµ¬ì°½ ë‹«ê³ 
                openChatRoom(newGroupRef.key, roomName, '1:1'); // ë°”ë¡œ ì…ì¥
            });
        };


        // 6. ê·¸ë£¹ ì±„íŒ… ìƒì„± (ì¹œêµ¬ ì´ˆëŒ€ ëª©ë¡: ì˜ëª»ëœ ë°ì´í„° ì œê±°)
        window.openGroupCreateModal = () => {
            document.getElementById('modal-group').classList.add('active');
            loadFriendListForGroup();
        };

        window.loadFriendListForGroup = () => {
            const listDiv = document.getElementById('friend-list-select');
            listDiv.innerHTML = "<div class='text-center text-xs text-[var(--text-sub)] py-4'>ë¡œë”© ì¤‘...</div>";

            get(ref(db, `users/${myUid}/friends`)).then((snap) => {
                listDiv.innerHTML = "";
                if(!snap.exists()) {
                    listDiv.innerHTML = "<div class='text-center text-xs text-[var(--text-sub)] py-6'>ì´ˆëŒ€í•  ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
                    return;
                }
                
                const friends = snap.val();
                let hasValidFriends = false;

                Object.entries(friends).forEach(([uid, name]) => {
                    // [ì¤‘ìš”] 'undefinedtrue' ë°©ì§€: ì´ë¦„ì´ ì •ìƒì ì¸ ë¬¸ìì—´ì´ ì•„ë‹ˆê±°ë‚˜ true/false ê°’ì´ë©´ ê±´ë„ˆëœ€
                    if (typeof name !== 'string' || name === 'true' || !name) return;

                    hasValidFriends = true;
                    listDiv.innerHTML += `
                        <label class="flex items-center gap-3 p-2 hover:bg-[var(--border-color)] rounded-lg cursor-pointer transition">
                            <input type="checkbox" name="group-member" value="${uid}" class="accent-[var(--volt)] w-4 h-4 rounded">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded-full bg-[var(--border-color)] flex items-center justify-center text-[10px] text-[var(--text-main)]">${name[0]}</div>
                                <span class="text-sm text-[var(--text-main)]">${name}</span>
                            </div>
                        </label>
                    `;
                });

                if(!hasValidFriends) {
                    listDiv.innerHTML = "<div class='text-center text-xs text-[var(--text-sub)] py-6'>í‘œì‹œí•  ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.<br>(ì˜ëª»ëœ ë°ì´í„°ê°€ í•„í„°ë§ë˜ì—ˆìŠµë‹ˆë‹¤)</div>";
                }
            });
        };

        window.createGroupChat = () => {
            const nameInput = document.getElementById('new-group-name');
            const name = nameInput.value.trim();
            if(!name) return alert("ì±„íŒ…ë°© ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            
            const checks = document.querySelectorAll('input[name="group-member"]:checked');
            if(checks.length === 0) {
                if(!confirm("ì´ˆëŒ€í•  ì¹œêµ¬ë¥¼ ì„ íƒí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\ní˜¼ì ìˆëŠ” ë°©ì„ ë§Œë“œì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            }

            const members = { [myUid]: true };
            checks.forEach(chk => members[chk.value] = true);

            const newGroupRef = push(ref(db, 'groups'));
            update(newGroupRef, {
                name: name,
                type: 'private', // ê¸°ë³¸ì ìœ¼ë¡œ ë¹„ê³µê°œ
                members: members,
                lastMsg: 'ê·¸ë£¹ ì±„íŒ…ë°© ìƒì„±ë¨',
                lastTime: Date.now()
            }).then(() => {
                closeModal('modal-group');
                nameInput.value = "";
                openChatRoom(newGroupRef.key, name, 'GROUP');
            });
        };

        // ê¸°íƒ€ ê¸°ëŠ¥
        window.leaveChat = (chatId) => {
            if(!confirm("ëŒ€í™”ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?\nëª©ë¡ì—ì„œ ì‚¬ë¼ì§‘ë‹ˆë‹¤.")) return;
            remove(ref(db, `groups/${chatId}/members/${myUid}`));
        };
        
        window.filterChats = () => {
            const query = document.getElementById('chat-search').value.toLowerCase();
            document.querySelectorAll('.chat-item').forEach(item => {
                const name = item.dataset.name.toLowerCase();
                item.style.display = name.includes(query) ? "flex" : "none";
            });
        };

        window.closeModal = (id) => document.getElementById(id).classList.remove('active');
    </script>
</body>
</html>