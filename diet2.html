<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>ë‹¤ì´ì–´íŠ¸ ì›Œí‚¹ ë‚´ë¹„ê²Œì´ì…˜ v36 (í¬ì¼“ëª¬ BMI ì—°ë™)</title>
<style>
  html, body { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Malgun Gothic', dotum, 'ë‹ì›€', sans-serif; background-color: #f0f0f0; }
  .container { width: 100%; height: 100%; display: flex; flex-direction: column; }
  #map { width: 100%; flex-grow: 1; min-height: 400px; }
  .info-panel { width: 100%; padding: 20px; background-color: white; box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1); box-sizing: border-box; z-index: 10; overflow-y: auto; max-height: 45%; }
  .panel-header { display: flex; justify-content: center; align-items: center; margin-bottom: 15px; position: relative; }
  h2 { margin: 0; font-size: 1.5em; color: #333; }
  .version-tag { font-size: 0.5em; font-weight: bold; color: white; background-color: #000; padding: 3px 6px; border-radius: 8px; margin-left: 10px; }
  #bodyStateBtn { position: absolute; right: 0; top: 50%; transform: translateY(-50%); padding: 8px 12px; background-color: #6f42c1; color: white; border: none; border-radius: 5px; font-size: 0.9em; cursor: pointer; }
  .input-group { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
  .input-wrapper { flex-grow: 1; position: relative; min-width: 180px; }
  .input-wrapper::before { position: absolute; top: 50%; left: 12px; transform: translateY(-50%); font-weight: bold; color: #4caf50; }
  .input-wrapper.start::before { content: 'ì¶œë°œ'; }
  .input-wrapper.end::before { content: 'ë„ì°©'; }
  .input-wrapper.target::before { content: 'ğŸ‘Ÿ km'; }
  #calculated-calories { font-size: 0.9em; color: #555; font-weight: bold; flex-shrink: 0; min-width: 90px; }
  input[type='text'], input[type='number'], select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; box-sizing: border-box; }
  .input-wrapper input { padding-left: 60px; }
  #searchBtn { padding: 12px 25px; background-color: #4caf50; color: white; border: none; border-radius: 5px; font-size: 1em; font-weight: bold; cursor: pointer; flex-shrink: 0; height: 45px; }
  #result-area { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; text-align: left; }
  .route-card, .info-message { border: 2px solid #ccc; border-radius: 8px; padding: 15px; flex-basis: 320px; background-color: #f9f9f9; flex-grow: 1; }
  .info-message { border-style: dashed; color: #666; font-size: 0.95em; text-align: center; }
  .route-card.loop { border-color: #ffc107; }
  .route-card.optimal { border-color: #007bff; }
  .route-card.scenic-loop { border-color: #28a745; }
  .route-card.trail-course { border-color: #6f42c1; }
  .route-card h3 { margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #eee; display: flex; align-items: center; }
  .route-card p { margin: 5px 0; font-size: 1em; }
  .route-card b { font-size: 1.1em; color: #e61a5f; }
  .color-box { display: inline-block; width: 14px; height: 14px; margin-right: 8px; border-radius: 3px; vertical-align: middle; }
  .loop .color-box { background-color: #ffc107; }
  .optimal .color-box { background-color: #007bff; }
  .scenic-loop .color-box { background-color: #28a745; }
  .trail-course .color-box { background-color: #6f42c1; }

  /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
  .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
  .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 10px; text-align: center; }
  .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
  .modal-content h3 { margin-top: 0; }
  .modal-input-group { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
  .modal-input-group > div { flex-grow: 1; min-width: 120px; }
  .modal-input-group input, .modal-input-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; box-sizing: border-box; }

  #character-display { font-family: monospace; line-height: 1; font-size: 14px; margin: 15px 0; white-space: pre; background-color: #eee; padding: 15px; border-radius: 5px; display: inline-block; }
  #bmi-status { font-weight: bold; font-size: 1.2em; }
  #calorie-log { margin-top: 5px; color: #e61a5f; font-weight: bold; }

  #goal-progress { margin-top: 15px; }
  #goal-progress-bar { display: flex; flex-wrap: wrap; gap: 2px; justify-content: center; margin-top: 5px; padding: 5px; border: 1px solid #ddd; border-radius: 5px; }
  .progress-block { width: 15px; height: 15px; background-color: #e61a5f; border: 1px solid white; }
  #goal-status { font-weight: bold; }

  .suggestions-list { display: none; position: absolute; top: 100%; left: 0; right: 0; background-color: white; border: 1px solid #ddd; z-index: 1001; max-height: 220px; overflow-y: auto; }
  .suggestion-item { padding: 12px 15px; cursor: pointer; font-size: 0.95em; }
  .suggestion-item:hover { background-color: #f5f5f5; }
  .suggestion-item small { display: block; color: #888; margin-top: 2px; }

  .pokemon-marker {
    background-size: contain;
    background-repeat: no-repeat;
    width: 40px;
    height: 40px;
    background-color: transparent;
    border: none;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 0.7em;
    font-weight: bold;
    color: #333;
    text-shadow: 1px 1px 0 #fff;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .pokemon-marker img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
</style>
</head>
<body>
<div class="container">
<div id="map"></div>
<div class="info-panel">
<div class="panel-header">
<h2>ğŸ‘Ÿ ë§ì¶¤í˜• ê±·ê¸° ì½”ìŠ¤ ì¶”ì²œ <span class="version-tag">v36</span></h2>
<button id="bodyStateBtn">ì˜¤ëŠ˜ ë‚˜ì˜ ëª¸ìƒíƒœ</button>
</div>
<div class="input-group">
<div class="input-wrapper start">
<input type="text" id="start" placeholder="ì¶œë°œì§€ (ì˜ˆ: ë¶€ì²œì—­)" autocomplete="off">
<div id="start-suggestions" class="suggestions-list"></div>
</div>
<div class="input-wrapper end">
<input type="text" id="end" placeholder="ë„ì°©ì§€ (ì„ íƒì‚¬í•­)" autocomplete="off">
<div id="end-suggestions" class="suggestions-list"></div>
</div>
<div class="input-wrapper target">
<input type="number" id="targetDistance" placeholder="ëª©í‘œ ê±°ë¦¬(km)">
</div>
<span id="calculated-calories">ì•½ 0 kcal</span>
<button id="searchBtn">ì½”ìŠ¤ ìƒì„±</button>
</div>
<div id="result-area">
<p class="info-message">ì¶œë°œì§€, ëª©í‘œ ê±°ë¦¬, ë„ì°©ì§€(ì„ íƒ)ë¥¼ ì…ë ¥í•˜ê³  4ê°€ì§€ ë§ì¶¤ ì½”ìŠ¤ë¥¼ ì¶”ì²œë°›ìœ¼ì„¸ìš”.</p>
</div>
</div>
</div>

<div id="bodyStateModal" class="modal">
<div class="modal-content">
<span class="close">&times;</span>
<h3>ì˜¤ëŠ˜ ë‚˜ì˜ ëª¸ìƒíƒœ</h3>
<div class="modal-input-group">
<div><input type="number" id="userHeight" placeholder="í‚¤(cm)"></div>
<div><input type="number" id="userWeight" placeholder="í˜„ì¬ ì²´ì¤‘(kg)"></div>
<div><input type="number" id="userGoalWeight" placeholder="ëª©í‘œ ì²´ì¤‘(kg)"></div>
<div>
<select id="userGender">
<option value="male">ë‚¨ì„±</option>
<option value="female">ì—¬ì„±</option>
</select>
</div>
</div>
<div id="character-display"></div>
<div id="bmi-status">ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
<div id="calorie-log">ì˜¤ëŠ˜ ì†Œëª¨í•œ ì¹¼ë¡œë¦¬: 0 kcal</div>
<div id="goal-progress">
<div id="goal-status">ëª©í‘œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.</div>
<div id="goal-progress-bar"></div>
</div>
</div>
</div>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c96c999113980d67c697b2f5a3d385f1&libraries=services"></script>
<script>
// âœ¨ í¬ì¼“ëª¬ ë°ì´í„°
const pokemonData = [
{ id: 1, name: 'ì´ìƒí•´ì”¨', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/1.png' },
{ id: 2, name: 'ì´ìƒí•´í’€', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/2.png' },
{ id: 3, name: 'ì´ìƒí•´ê½ƒ', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/3.png' },
{ id: 4, name: 'íŒŒì´ë¦¬', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/4.png' },
{ id: 5, name: 'ë¦¬ìë“œ', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/5.png' },
{ id: 6, name: 'ë¦¬ìëª½', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/6.png' },
{ id: 7, name: 'ê¼¬ë¶€ê¸°', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/7.png' },
{ id: 8, name: 'ì–´ë‹ˆë¶€ê¸°', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/8.png' },
{ id: 9, name: 'ê±°ë¶ì™•', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/9.png' },
{ id: 10, name: 'ìºí„°í”¼', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/10.png' },
{ id: 11, name: 'ë‹¨ë°ê¸°', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/11.png' },
{ id: 12, name: 'ë²„í„°í”Œ', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/12.png' },
{ id: 13, name: 'ë¿”ì¶©ì´', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/13.png' },
{ id: 14, name: 'ë”±ì¶©ì´', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/14.png' },
{ id: 15, name: 'ë…ì¹¨ë¶•', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/15.png' },
{ id: 16, name: 'êµ¬êµ¬', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/16.png' },
{ id: 17, name: 'í”¼ì£¤', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/17.png' },
{ id: 18, name: 'í”¼ì£¤íˆ¬', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/18.png' },
{ id: 19, name: 'ê¼¬ë ›', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/19.png' },
{ id: 20, name: 'ë ˆíŠ¸ë¼', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/20.png' },
{ id: 21, name: 'ê¹¨ë¹„ì°¸', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/21.png' },
{ id: 22, name: 'ê¹¨ë¹„ë“œë¦´ì¡°', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/22.png' },
{ id: 23, name: 'ì•„ë³´', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/23.png' },
{ id: 24, name: 'ì•„ë³´í¬', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/24.png' },
{ id: 25, name: 'í”¼ì¹´ì¸„', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/25.png' },
{ id: 26, name: 'ë¼ì´ì¸„', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/26.png' },
{ id: 27, name: 'ëª¨ë˜ë‘ì§€', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/27.png' },
{ id: 28, name of 'ê³ ì§€', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/28.png' },
// â€¦ ë‚˜ë¨¸ì§€ í¬ì¼“ëª¬ ë°ì´í„° ê³„ì† â€¦
];

// ì‹ ì²´ ìƒíƒœ(Body State) ê¸°ëŠ¥ v3
const bodyState = {
modal: document.getElementById('bodyStateModal'),
btn: document.getElementById('bodyStateBtn'),
closeBtn: document.querySelector('.modal .close'),
heightInput: document.getElementById('userHeight'),
weightInput: document.getElementById('userWeight'),
goalWeightInput: document.getElementById('userGoalWeight'),
genderInput: document.getElementById('userGender'),
characterDisplay: document.getElementById('character-display'),
bmiStatus: document.getElementById('bmi-status'),
calorieLog: document.getElementById('calorie-log'),
goalStatus: document.getElementById('goal-status'),
progressBar: document.getElementById('goal-progress-bar'),
data: { height: '', weight: '', goalWeight: '', gender: 'male', burntCalories: 0 },
characters: {
obese: `
  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
 â–ˆâ–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ
`,
overweight: `
  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
â–ˆâ–ˆ  â–ˆâ–ˆ
`,
normal: `
   â–ˆâ–ˆâ–ˆ
  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
   â–ˆâ–ˆâ–ˆ
   â–ˆâ–ˆâ–ˆ
   â–ˆ  â–ˆ
`,
underweight: `
    â–ˆ
 â–ˆâ–ˆâ–ˆ
 â–ˆâ–ˆâ–ˆ
    â–ˆ
 / \\
/ \\
`
},
bmiThresholds: {
male: {
underweight: 18.5,
normal: 25,
overweight: 30,
obese: Infinity
},
female: {
underweight: 18.5,
normal: 24,
overweight: 29,
obese: Infinity
}
},
init() {
this.loadData();
this.updateUI();
this.btn.onclick = () => this.modal.style.display = 'block';
this.closeBtn.onclick = () => this.modal.style.display = 'none';
window.onclick = (event) => {
if (event.target === this.modal) this.modal.style.display = 'none';
};
this.heightInput.oninput = () => this.updateAll();
this.weightInput.oninput = () => this.updateAll();
this.goalWeightInput.oninput = () => this.updateAll();
this.genderInput.onchange = () => this.updateAll();
},
saveData() {
localStorage.setItem('userDataV3', JSON.stringify(this.data));
},
loadData() {
const saved = JSON.parse(localStorage.getItem('userDataV3'));
if (saved) {
this.data = { ...this.data, ...saved };
}
},
updateAll() {
this.updateDataFromInputs();
this.updateCharacter();
this.updateProgressBar();
this.saveData();
},
updateDataFromInputs() {
this.data.height = parseFloat(this.heightInput.value) || '';
this.data.weight = parseFloat(this.weightInput.value) || '';
this.data.goalWeight = parseFloat(this.goalWeightInput.value) || '';
this.data.gender = this.genderInput.value || 'male';
},
getStatusKorean(status) {
switch (status) {
case 'underweight': return 'ì €ì²´ì¤‘';
case 'normal': return 'ì •ìƒ';
case 'overweight': return 'ê³¼ì²´ì¤‘';
case 'obese': return 'ë¹„ë§Œ';
default: return 'ì•Œ ìˆ˜ ì—†ìŒ';
}
},
updateCharacter() {
const { height, weight, gender } = this.data;
if (!height || !weight) {
this.characterDisplay.textContent = 'ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´\nìºë¦­í„°ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.';
this.bmiStatus.textContent = 'í‚¤ì™€ í˜„ì¬ ì²´ì¤‘ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
return;
}
const bmi = weight / ((height / 100) ** 2);
const thresholds = this.bmiThresholds[gender];
let statusKey = '';
if (bmi >= thresholds.obese) {
statusKey = 'obese';
} else if (bmi >= thresholds.overweight) {
statusKey = 'overweight';
} else if (bmi >= thresholds.normal) {
statusKey = 'normal';
} else {
statusKey = 'underweight';
}
const statusText = this.getStatusKorean(statusKey);
const charArt = this.characters[statusKey] || this.characters.normal;
this.characterDisplay.textContent = charArt;
this.bmiStatus.textContent = `BMI: ${bmi.toFixed(1)} (${statusText})`;
},
updateProgressBar() {
const { weight, goalWeight } = this.data;
this.progressBar.innerHTML = '';
if (!weight || !goalWeight || goalWeight >= weight) {
this.goalStatus.textContent = (weight && goalWeight && goalWeight <= weight)
? "ğŸ‰ ëª©í‘œ ì²´ì¤‘ ë‹¬ì„±! ì¶•í•˜í•©ë‹ˆë‹¤!"
: "ëª©í‘œ ì²´ì¤‘ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
return;
}
const diff = weight - goalWeight;
this.goalStatus.textContent = `ëª©í‘œê¹Œì§€ ì•ìœ¼ë¡œ ${diff.toFixed(1)} kg !`;
const blocks = Math.ceil(diff);
for (let i = 0; i < blocks; i++) {
const block = document.createElement('div');
block.className = 'progress-block';
this.progressBar.appendChild(block);
}
},
addBurntCalories(cal) {
this.data.burntCalories += cal;
this.calorieLog.textContent = `ì˜¤ëŠ˜ ì†Œëª¨í•œ ì¹¼ë¡œë¦¬: ${Math.round(this.data.burntCalories)} kcal`;
this.saveData();
},
updateUI() {
this.heightInput.value = this.data.height || '';
this.weightInput.value = this.data.weight || '';
this.goalWeightInput.value = this.data.goalWeight || '';
this.genderInput.value = this.data.gender || 'male';
this.calorieLog.textContent = `ì˜¤ëŠ˜ ì†Œëª¨í•œ ì¹¼ë¡œë¦¬: ${this.data.burntCalories || 0} kcal`;
this.updateAll();
}
};
bodyState.init();

// ë‚´ë¹„ê²Œì´ì…˜ ê¸°ëŠ¥
const REST_API_KEY = '71b46fcb7202af130ab7c6c18bf5163a';
const KCAL_PER_KM = 60;
const elements = {
mapContainer: document.getElementById('map'),
startInput: document.getElementById('start'),
endInput: document.getElementById('end'),
targetDistanceInput: document.getElementById('targetDistance'),
calculatedCalories: document.getElementById('calculated-calories'),
searchBtn: document.getElementById('searchBtn'),
resultArea: document.getElementById('result-area'),
startSuggestions: document.getElementById('start-suggestions'),
endSuggestions: document.getElementById('end-suggestions'),
};

const map = new kakao.maps.Map(elements.mapContainer, {
center: new kakao.maps.LatLng(37.5034, 126.7661),
level: 5
});
const ps = new kakao.maps.services.Places();
let mapObjects = [];

elements.targetDistanceInput.addEventListener('input', () => {
const distance = parseFloat(elements.targetDistanceInput.value) || 0;
elements.calculatedCalories.textContent = `ì•½ ${Math.round(distance * KCAL_PER_KM)} kcal`;
});

const searchPlace = (query) => new Promise((resolve, reject) => {
if (!query.trim()) return reject(new Error('ê²€ìƒ‰ì–´ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.'));
ps.keywordSearch(query, (data, status) => {
if (status === kakao.maps.services.Status.OK && data.length > 0) {
resolve(data[0]);
} else {
reject(new Error(`'${query}' ê²€ìƒ‰ ì‹¤íŒ¨. ì •í™•í•œ ì¥ì†Œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.`));
}
});
});

const getRoute = (waypoints) => new Promise(async (resolve) => {
if (!waypoints || waypoints.length < 2 || waypoints.some(p => !p || !p.x || !p.y)) return resolve(null);
const origin = `${waypoints[0].x},${waypoints[0].y}`;
const destination = `${waypoints[waypoints.length - 1].x},${waypoints[waypoints.length - 1].y}`;
const via = waypoints.slice(1, -1).map(p => `${p.x},${p.y}`).join('|');
const url = `https://apis-navi.kakaomobility.com/v1/directions?origin=${origin}&destination=${destination}${via ? `&waypoints=${via}` : ''}&priority=RECOMMEND&car_avoid=1&walking_mode=WALK`;
try {
const response = await fetch(url, {
headers: { Authorization: `KakaoAK ${REST_API_KEY}` }
});
if (!response.ok) return resolve(null);
const data = await response.json();
if (data.routes && data.routes.length > 0 && data.routes[0].result_code === 0) {
resolve(data.routes[0]);
}
else resolve(null);
} catch (e) {
resolve(null);
}
});

const clearMap = () => {
mapObjects.forEach(obj => obj.setMap(null));
mapObjects = [];
};

const debounce = (func, delay) => {
let t;
return (...args) => {
clearTimeout(t);
t = setTimeout(() => func.apply(null, args), delay);
};
};

const setupAutocomplete = (inputEl, listEl) => {
const showSuggestions = debounce(query => {
if (!query.trim()) {
listEl.style.display = 'none';
return;
}
ps.keywordSearch(query, (data, status) => {
listEl.innerHTML = '';
if (status === kakao.maps.services.Status.OK) {
const frag = document.createDocumentFragment();
data.forEach(p => {
const div = document.createElement('div');
div.className = 'suggestion-item';
div.innerHTML = `${p.place_name}<small>${p.road_address_name || p.address_name}</small>`;
div.addEventListener('click', () => {
inputEl.value = p.place_name;
listEl.style.display = 'none';
});
frag.appendChild(div);
});
listEl.appendChild(frag);
listEl.style.display = 'block';
}
});
}, 250);
inputEl.addEventListener('input', () => showSuggestions(inputEl.value));
};

setupAutocomplete(elements.startInput, elements.startSuggestions);
setupAutocomplete(elements.endInput, elements.endSuggestions);

document.addEventListener('click', e => {
if (!e.target.closest('.input-wrapper')) {
elements.startSuggestions.style.display = 'none';
elements.endSuggestions.style.display = 'none';
}
});

async function generateWaypointLoopCourse(startPoint, targetDistanceKm) {
const targetDistMeters = targetDistanceKm * 1000;
let bestRoute = null;
let bestDiff = Infinity;
let searchRadius = targetDistMeters / 4;

for (let i = 0; i < 3; i++) {
const keywords = ['ì§€í•˜ì² ì—­', 'ì€í–‰', 'í¸ì˜ì ', 'ì¹´í˜', 'ì•½êµ­', 'í•™êµ', 'ë²„ìŠ¤ì •ë¥˜ì¥'];
const bearings = [0, 90, 180, 270];
const R = 6371e3;
const startLatRad = parseFloat(startPoint.y) * Math.PI / 180;
const startLonRad = parseFloat(startPoint.x) * Math.PI / 180;

const waypointPromises = bearings.map(bearing => new Promise(resolve => {
const brngRad = bearing * Math.PI / 180;
const latRad = Math.asin(Math.sin(startLatRad) * Math.cos(searchRadius / R) +
Math.cos(startLatRad) * Math.sin(searchRadius / R) * Math.cos(brngRad));
const lonRad = startLonRad + Math.atan2(
Math.sin(brngRad) * Math.sin(searchRadius / R) * Math.cos(startLatRad),
Math.cos(searchRadius / R) - Math.sin(startLatRad) * Math.sin(latRad)
);
const searchCenter = new kakao.maps.LatLng((latRad * 180) / Math.PI, (lonRad * 180) / Math.PI);
ps.keywordSearch(keywords.join(','), (data, status) => {
if (status === kakao.maps.services.Status.OK && data.length > 0) {
resolve(data[0]);
} else {
resolve(null);
}
}, { location: searchCenter, radius: 700, sort: kakao.maps.services.SortBy.DISTANCE });
}));

const waypoints = (await Promise.all(waypointPromises)).filter(p => p);
if (waypoints.length < 3) continue;
const candidate = await getRoute([startPoint, ...waypoints, startPoint]);
if (candidate) {
const dist = candidate.summary.distance;
const diff = Math.abs(dist - targetDistMeters);
if (diff < bestDiff) {
bestDiff = diff;
bestRoute = candidate;
}
if (bestDiff < targetDistMeters * 0.1) return bestRoute;
const ratio = targetDistMeters / dist;
searchRadius *= (ratio * 0.7 + 0.3);
}
}
return bestRoute;
}

async function generateTrailCourse(startPoint, targetDistanceKm) {
return new Promise(resolve => {
ps.keywordSearch("ê³µì› ì‚° ë“±ì‚°ë¡œ", async (data, status) => {
if (status !== kakao.maps.services.Status.OK || data.length === 0) {
return resolve(null);
}
const trailStart = data[0];
const route = await generateWaypointLoopCourse(trailStart, targetDistanceKm);
resolve(route);
}, {
location: new kakao.maps.LatLng(startPoint.y, startPoint.x),
radius: 3000,
sort: kakao.maps.services.SortBy.DISTANCE
});
});
}

async function generateScenicLoopNearPoint(centerPoint, targetDistanceKm) {
return new Promise(resolve => {
ps.keywordSearch('ê³µì› ì‚°ì±…ë¡œ í•˜ì²œ ë“±ì‚°ë¡œ ê°•ë³€', async (data, status) => {
if (status !== kakao.maps.services.Status.OK || data.length === 0) {
return resolve(null);
}
const scenicStart = data[0];
const route = await generateWaypointLoopCourse(scenicStart, targetDistanceKm);
resolve(route);
}, {
location: new kakao.maps.LatLng(centerPoint.y, centerPoint.x),
radius: 5000,
sort: kakao.maps.services.SortBy.DISTANCE
});
});
}

function drawPolyline(route, color) {
if (!route || !route.sections) return;
const path = [];
route.sections.forEach(sec => {
sec.roads.forEach(road => {
for (let i = 0; i < road.vertexes.length; i += 2) {
const lat = road.vertexes[i + 1];
const lng = road.vertexes[i];
path.push(new kakao.maps.LatLng(lat, lng));
}
});
});
const poly = new kakao.maps.Polyline({
path: path,
strokeWeight: 5,
strokeColor: color,
strokeOpacity: 0.8,
strokeStyle: 'solid'
});
poly.setMap(map);
mapObjects.push(poly);
}

function addMarkers(route, type) {
if (!route || !route.sections) return;
route.sections.forEach(sec => {
sec.roads.forEach(road => {
for (let i = 0; i < road.vertexes.length; i += 2) {
const lat = road.vertexes[i + 1];
const lng = road.vertexes[i];
const marker = new kakao.maps.Marker({
position: new kakao.maps.LatLng(lat, lng),
map: map
});
mapObjects.push(marker);
}
});
});
}

function labelColor(label) {
switch (label) {
case 'loop': return '#ffc107';
case 'trail-course': return '#6f42c1';
case 'scenic-loop': return '#28a745';
case 'optimal': return '#007bff';
default: return '#007bff';
}
}

async function buildRoutes(startPoint, targetDistanceKm) {
clearMap();
elements.resultArea.innerHTML = '';

const [loopRoute, trailRoute, scenicRoute] = await Promise.all([
generateWaypointLoopCourse(startPoint, targetDistanceKm),
generateTrailCourse(startPoint, targetDistanceKm),
generateScenicLoopNearPoint(startPoint, targetDistanceKm)
]);

const results = [];
if (loopRoute) results.push({ route: loopRoute, label: 'loop', name: 'Loop ì½”ìŠ¤' });
if (trailRoute) results.push({ route: trailRoute, label: 'trail-course', name: 'íŠ¸ë ˆì¼ ì½”ìŠ¤' });
if (scenicRoute) results.push({ route: scenicRoute, label: 'scenic-loop', name: 'í’ê²½ ë£¨í”„ ì½”ìŠ¤' });

if (results.length === 0) {
elements.resultArea.innerHTML = `<p class="info-message">ì¶”ì²œí•  ì½”ìŠ¤ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¡°ê±´ì„ ì¡°ì ˆí•´ë³´ì„¸ìš”.</p>`;
return;
}

results.forEach((item, idx) => {
const { route, label, name } = item;
const distKm = (route.summary.distance / 1000).toFixed(1);
const kcal = Math.round(distKm * KCAL_PER_KM);

const card = document.createElement('div');
card.className = `route-card ${label}`;
card.innerHTML = `
<h3><span class="color-box"></span>${name}</h3>
<p>ê±°ë¦¬: <b>${distKm} km</b></p>
<p>ì˜ˆìƒ ì†Œëª¨ ì¹¼ë¡œë¦¬: <b>${kcal} kcal</b></p>
<button data-idx="${idx}">ì§€ë„ì— í‘œì‹œ</button>
`;
elements.resultArea.appendChild(card);

card.querySelector('button').addEventListener('click', () => {
clearMap();
drawPolyline(route, labelColor(label));
addMarkers(route, label);
// ì§€ë„ ì¤‘ì‹¬ ì¡°ì •
const firstSec = route.sections[0];
if (firstSec && firstSec.roads && firstSec.roads[0] && firstSec.roads[0].vertexes.length >= 2) {
const startLat = firstSec.roads[0].vertexes[1];
const startLng = firstSec.roads[0].vertexes[0];
map.setCenter(new kakao.maps.LatLng(startLat, startLng));
}
bodyState.addBurntCalories(kcal);
});
});
}

elements.searchBtn.addEventListener('click', async () => {
const startName = elements.startInput.value.trim();
const targetDistance = parseFloat(elements.targetDistanceInput.value);
if (!startName || isNaN(targetDistance) || targetDistance <= 0) {
alert('ì¶œë°œì§€ì™€ ëª©í‘œ ê±°ë¦¬ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
return;
}
try {
const startPlace = await searchPlace(startName);
const startPoint = { x: startPlace.x, y: startPlace.y };
await buildRoutes(startPoint, targetDistance);
} catch (err) {
alert(err.message);
}
});

document.addEventListener('DOMContentLoaded', () => {
const obs = new MutationObserver(() => {
document.querySelectorAll('.route-card').forEach(card => {
const box = card.querySelector('.color-box');
if (card.classList.contains('loop')) box.style.backgroundColor = labelColor('loop');
if (card.classList.contains('trail-course')) box.style.backgroundColor = labelColor('trail-course');
if (card.classList.contains('scenic-loop')) box.style.backgroundColor = labelColor('scenic-loop');
if (card.classList.contains('optimal')) box.style.backgroundColor = labelColor('optimal');
});
});
obs.observe(elements.resultArea, { childList: true });
});

</script>
</body>
</html>