<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>포켓몬 러닝 월드 (v2.1 - 수정판)</title>
<!-- Tailwind CSS 로드 -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Tone.js (진화 효과음용) 로드 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

<!-- 기존 스타일 유지 -->
<style>
    html, body {
        width: 100%; height: 100%; margin: 0; padding: 0;
        font-family: 'Malgun Gothic', dotum, '돋움', sans-serif; background-color: #f0f0f0;
        overscroll-behavior: none;
    }
    .main-container { width: 100%; max-width: 800px; margin: 0 auto; padding: 20px; box-sizing: border-box; }
    .map-wrapper { position: relative; width: 100%; }
    #map { width: 100%; height: 500px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); background-color: #e9e9e9; }
    
    #modeToggleBtn { position: absolute; top: 15px; left: 15px; z-index: 500; padding: 10px 15px; font-size: 1em; font-weight: bold; color: white; background-color: #e61a5f; border: none; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); cursor: pointer; transition: background-color 0.3s; }
    #modeToggleBtn:hover { background-color: #c91450; }
    
    .header-bar { background-color: #3B82F6; color: white; padding: 15px 20px; text-align: center; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .header-bar h1 { margin: 0; font-size: 1.8em; font-weight: bold; }
    
    .user-info, .run-controls, .results-display, .character-display, .goal-progress {
        background-color: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; align-items: center; }
    .form-grid label { font-weight: bold; color: #333; }
    .form-grid input[type="number"], .form-grid select {
        width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1em;
    }
    .form-grid .full-width { grid-column: 1 / -1; }
    
    .button-group { display: flex; gap: 10px; margin-top: 15px; }
    .button-group button, .btn-primary, .btn-secondary {
        flex: 1; padding: 12px 15px; font-size: 1.1em; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s;
    }
    .btn-primary { background-color: #3B82F6; color: white; }
    .btn-primary:hover { background-color: #2563EB; }
    .btn-secondary { background-color: #EF4444; color: white; }
    .btn-secondary:hover { background-color: #DC2626; }
    
    .results-display { display: none; } /* [수정] 기본값 hidden 대신 none 사용 */
    .results-display h3 { font-size: 1.4em; color: #10B981; margin-top: 0; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    .results-display p { font-size: 1.1em; color: #555; margin: 8px 0; }
    
    .character-display { display: none; flex-direction: column; align-items: center; }
    #characterImage { max-width: 150px; height: auto; margin-top: 10px; border-radius: 8px; }
    
    .goal-progress { display: none; } /* [수정] 기본값 hidden 대신 none 사용 */
    .goal-progress h3 { font-size: 1.4em; margin-top: 0; margin-bottom: 15px; color: #333; }
    .progress-bar-container { background-color: #e9ecef; border-radius: 20px; height: 30px; overflow: hidden; }
    .progress-bar {
        background-color: #10B981; height: 100%; width: 0%; border-radius: 20px;
        display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;
        transition: width 0.5s ease-in-out;
    }
    
    /* --- 새로운 기능 스타일 --- */
    
    /* 탭 네비게이션 */
    .tab-navigation {
        display: flex;
        justify-content: space-around;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        margin-bottom: 20px;
        padding: 10px;
    }
    .tab-button {
        flex: 1;
        padding: 10px 15px;
        font-size: 1em;
        font-weight: bold;
        border: none;
        background-color: transparent;
        color: #555;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s;
    }
    .tab-button.active {
        background-color: #3B82F6;
        color: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .page {
        display: none; /* 페이지 기본 숨김 */
    }
    .page.active {
        display: block; /* 활성 페이지만 보임 */
    }
    
    /* 모달 공통 */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: none; /* 기본 숨김 */
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .modal-content {
        background-color: white;
        padding: 2rem;
        border-radius: 0.5rem;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        width: 90%;
        max-width: 500px;
    }

    /* 진화 애니메이션 */
    #evolution-modal {
        background-color: rgba(0, 0, 0, 0.8);
    }
    #evolution-content {
        text-align: center;
        color: white;
    }
    #evolution-image-container {
        position: relative;
        width: 200px;
        height: 200px;
        margin: 2rem auto;
    }
    #evolution-image-container img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        position: absolute;
        top: 0;
        left: 0;
        animation: pulse 1.5s infinite ease-in-out;
    }
    #evolution-image-container img.evolving {
        animation: evolve-effect 3s forwards;
    }
    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.7; }
        100% { transform: scale(1); opacity: 1; }
    }
    @keyframes evolve-effect {
        0% { filter: brightness(1) saturate(1); transform: scale(1); }
        30% { filter: brightness(3) saturate(2); transform: scale(1.2); opacity: 0.5; }
        60% { filter: brightness(1) saturate(1); transform: scale(1); opacity: 1; }
        80% { filter: brightness(5) saturate(3); transform: scale(1.3); opacity: 0; }
        100% { filter: brightness(1) saturate(1); transform: scale(1); opacity: 1; }
    }
</style>
</head>
<body class="bg-gray-100">

<div class="main-container">
    <div class="header-bar">
        <h1>포켓몬 러닝 월드</h1>
    </div>

    <!-- 상태 표시줄 -->
    <div id="status-bar" class="bg-white p-4 rounded-lg shadow-md mb-4 text-center" style="display: none;"> <!-- [수정] 기본 숨김 -->
        <p class="text-lg font-bold">내 ID: <span id="user-id-display" class="text-blue-600"></span></p>
        <p class="text-xl font-bold">총 달린 거리: <span id="total-distance-display" class="text-green-600">0.00</span> km</p>
        <p class="text-xl font-bold">보유 포인트: <span id="challenge-points-display" class="text-purple-600">0</span> P</p>
    </div>

    <!-- 탭 네비게이션 -->
    <div class="tab-navigation">
        <button id="tab-map" class="tab-button active">맵 & 정보</button>
        <button id="tab-challenges" class="tab-button">도전과제</button>
        <button id="tab-pokedex" class="tab-button">포켓몬 도감</button>
        <button id="tab-groups" class="tab-button">그룹</button>
        <button id="tab-admin" class="tab-button">관리자</button>
    </div>

    <!-- === 1. 맵 & 정보 페이지 === -->
    <div id="page-map" class="page active">
        <!-- 기존 1.html 의 맵과 정보 입력창 -->
        <div class="map-wrapper">
            <div id="map">
                <!-- [수정] 맵 로딩 실패 시 메시지 -->
                <div class="w-full h-full flex items-center justify-center bg-gray-200 text-gray-500 p-4 text-center">
                    <p>지도를 불러오는 중입니다...<br>지도가 계속 표시되지 않으면, Kakao API 키가 올바른지 확인해주세요.</p>
                </div>
            </div>
            <button id="modeToggleBtn">지도/스카이뷰</button>
        </div>

        <div class="user-info mt-5">
            <div class="form-grid">
                <label for="height">키 (cm):</label>
                <input type="number" id="height" placeholder="예: 175">
                <label for="weight">현재 체중 (kg):</label>
                <input type="number" id="weight" placeholder="예: 70">
                <label for="goalWeight">목표 체중 (kg):</label>
                <input type="number" id="goalWeight" placeholder="예: 65">
                <label for="age">나이:</label>
                <input type="number" id="age" placeholder="예: 30">
                <label for="gender">성별:</label>
                <select id="gender">
                    <option value="male">남성</option>
                    <option value="female">여성</option>
                </select>
                <label for="targetDistance" class="full-width">이번 목표 거리 (km):</label>
                <input type="number" id="targetDistance" class="full-width" placeholder="예: 5">
            </div>
            <div class="button-group">
                <button id="calculateBtn" class="btn-primary">정보 계산 & 캐릭터 보기</button>
            </div>
        </div>

        <div class="run-controls">
            <div class="button-group">
                <button id="startRunBtn" class="btn-primary">러닝 시작</button>
                <button id="stopRunBtn" class="btn-secondary">러닝 종료</button>
            </div>
            <!-- [신규] 타이머 표시 영역 -->
            <p id="runTimer" class="mt-4 text-center text-3xl font-bold text-blue-600" style="display: none;">00:00:00</p>
            <p id="runStatus" class="mt-2 text-center text-lg font-bold">러닝 대기 중...</p>
        </div>
        
        <div class="results-display"> <!-- [수정] hidden 클래스 제거, JS로 제어 -->
            <h3>예상 결과</h3>
            <p id="calorie-result"></p>
            <p id="weight-loss-result"></p>
            <p id="bmi-result"></p>
            <p id="bmr-result"></p>
        </div>
        
        <div id="character-display" class="character-display">
            <h3>내 아바타</h3>
            <img id="characterImage" src="" alt="캐릭터 아바타">
        </div>
        
        <div class="goal-progress"> <!-- [수정] hidden 클래스 제거, JS로 제어 -->
            <h3>목표 체중 달성도</h3>
            <div class="progress-bar-container">
                <div id="weight-progress-bar" class="progress-bar">0%</div>
            </div>
            <p id="weight-progress-text" class="text-center mt-2"></p>
        </div>
    </div>
    
    <!-- === 2. 도전과제 페이지 === -->
    <div id="page-challenges" class="page">
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-4 border-b pb-2">누적 걷기 도전과제</h2>
            <p class="mb-4 text-gray-600">달린 거리는 자동으로 누적되며, 목표 달성 시 보상이 지급됩니다. (보상은 1회만 지급)</p>
            <div id="challenge-list" class="space-y-4">
                <!-- 도전과제 항목이 여기에 동적으로 추가됩니다. -->
                <p class="text-gray-500">도전과제 목록을 불러오는 중... (Firebase 연결 필요)</p>
            </div>
        </div>
    </div>

    <!-- === 3. 포켓몬 도감 페이지 === -->
    <div id="page-pokedex" class="page">
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-4 border-b pb-2">포켓몬 도감</h2>
            <div id="pokedex-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                <!-- 잡은 포켓몬이 여기에 동적으로 추가됩니다. -->
            </div>
            <p id="pokedex-empty" class="text-gray-500 text-center">아직 잡은 포켓몬이 없습니다. 러닝을 시작하세요! (Firebase 연결 필요)</p>
        </div>
    </div>

    <!-- === 4. 그룹 페이지 === -->
    <div id="page-groups" class="page">
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-4 border-b pb-2">그룹 (친구)</h2>
            <p class="mb-4 text-gray-700">친구의 ID를 추가하고 친선전을 신청하세요!</p>
            <p class="mb-4 font-bold text-blue-600">내 ID: <span id="user-id-display-group">불러오는 중...</span> (이 ID를 친구에게 알려주세요)</p>
            
            <div class="flex gap-2 mb-4">
                <input type="text" id="friend-id-input" class="flex-grow p-2 border rounded-md" placeholder="친구의 ID 입력">
                <button id="add-friend-btn" class="btn-primary px-4 py-2">친구 추가</button>
            </div>
            
            <h3 class="text-xl font-semibold mt-6 mb-3">친구 목록</h3>
            <div id="friend-list" class="space-y-2">
                <!-- 친구 목록이 여기에 동적으로 추가됩니다. -->
            </div>
            <p id="friend-list-empty" class="text-gray-500 text-center">아직 추가된 친구가 없습니다. (Firebase 연결 필요)</p>
        </div>
    </div>

    <!-- === 5. 관리자 페이지 === -->
    <div id="page-admin" class="page">
        <div class="bg-white p-6 rounded-lg shadow-md border-4 border-red-500">
            <h2 class="text-2xl font-bold mb-4 border-b pb-2 text-red-600">관리자 테스트 패널</h2>
            <p class="mb-4 text-gray-700">걷지 않고도 도전과제 보상이 정상적으로 지급되는지 테스트합니다.</p>
            <div class="grid grid-cols-2 gap-4">
                <button id="admin-grant-1k" class="btn-primary">1km 보상 테스트</button>
                <button id="admin-grant-3k" class="btn-primary">3km 보상 테스트</button>
                <button id="admin-grant-5k" class="btn-primary">5km 보상 테스트</button>
                <button id="admin-grant-10k" class="btn-primary">10km 보상 테스트</button>
                <button id="admin-reset-challenges" class="btn-secondary col-span-2">모든 도전과제 초기화</button>
                <button id="admin-reset-pokemon" class="btn-secondary col-span-2">모든 포켓몬 삭제</button>
            </div>
        </div>
    </div>

</div> <!-- .main-container 끝 -->

<!-- 포켓몬 상세정보 모달 -->
<div id="pokemon-detail-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="modal-pokemon-name" class="text-3xl font-bold mb-4 text-center"></h3>
        <img id="modal-pokemon-image" src="" alt="포켓몬" class="w-40 h-40 mx-auto mb-4">
        
        <div class="mb-4">
            <label for="modal-pokemon-nickname" class="block font-bold mb-1">이름 수정:</label>
            <input type="text" id="modal-pokemon-nickname" class="w-full p-2 border rounded-md">
        </div>
        
        <div class="bg-gray-100 p-3 rounded-md mb-4">
            <h4 class="font-bold text-lg mb-2">특성</h4>
            <p id="modal-pokemon-hp" class="text-md"></p>
            <p id="modal-pokemon-attack" class="text-md"></p>
            <h5 class="font-semibold mt-2">스킬:</h5>
            <ul id="modal-pokemon-skills" class="list-disc list-inside">
                <!-- 스킬 목록 -->
            </ul>
        </div>

        <div class="button-group">
            <button id="modal-save-btn" class="btn-primary">저장</button>
            <button id="modal-evolve-btn" class="btn-primary bg-purple-600 hover:bg-purple-700">진화</button>
        </div>
        <button id="modal-close-btn" class="btn-secondary w-full mt-2">닫기</button>
        <p id="modal-evolve-status" class="text-center mt-2 text-sm text-red-500"></p>
    </div>
</div>

<!-- 진화 애니메이션 모달 -->
<div id="evolution-modal" class="modal-overlay">
    <div id="evolution-content" class="modal-content bg-transparent border-0 shadow-none">
        <h2 id="evolution-text" class="text-4xl font-bold mb-4">진화중...</h2>
        <div id="evolution-image-container">
            <img id="evolution-image-before" src="" alt="진화 전">
            <img id="evolution-image-after" src="" alt="진화 후" class="opacity-0">
        </div>
        <h2 id="evolution-result-text" class="text-5xl font-bold text-yellow-400 opacity-0 transform scale-50">성공!</h2>
    </div>
</div>

<!-- 커스텀 알림 모달 -->
<div id="alert-modal" class="modal-overlay">
    <div class="modal-content text-center">
        <p id="alert-message" class="text-lg mb-6"></p>
        <button id="alert-close-btn" class="btn-primary px-8 py-2">확인</button>
    </div>
</div>


<!--
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    [1] 여기에 카카오 맵 API 키를 입력하세요!
    'YOUR_KAKAO_JAVASCRIPT_KEY' 부분을 본인의 키로 교체해야 합니다.
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
-->
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_JAVASCRIPT_KEY&libraries=drawing"></script>

<!-- Firebase SDK -->
<script type="module">
    // Firebase SDK import
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        signInAnonymously, 
        signInWithCustomToken, 
        onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        getDoc, 
        setDoc, 
        updateDoc, 
        deleteDoc, 
        onSnapshot, 
        collection, 
        query, 
        where, 
        addDoc, 
        getDocs,
        writeBatch,
        serverTimestamp,
        increment,
        runTransaction
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-util.js";

    // --- (0) Firebase 설정 및 앱 ID ---
    
    // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    // [2] 여기에 본인의 Firebase 설정 객체를 입력하세요!
    // Firebase 콘솔에서 '프로젝트 설정' > '내 앱' > 'SDK 설정 및 구성'
    // 에서 `firebaseConfig` 객체를 복사하여 아래 `...` 부분을 교체합니다.
    // (이 코드는 로컬 테스트용 Fallback입니다)
    // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    const firebaseConfig = typeof __firebase_config !== 'undefined' 
        ? JSON.parse(__firebase_config) 
        : { 
            apiKey: "YOUR_API_KEY", 
            authDomain: "YOUR_AUTH_DOMAIN", 
            projectId: "YOUR_PROJECT_ID", 
            storageBucket: "YOUR_STORAGE_BUCKET", 
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID", 
            appId: "YOUR_APP_ID" 
        };

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'pokemon-run-default';
    
    // Firebase 앱 초기화
    let app, db, auth;
    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        setLogLevel('Debug'); // Firestore 로그 활성화
    } catch (e) {
        console.error("Firebase 초기화 오류:", e);
        customAlert("앱을 초기화하는 데 실패했습니다. Firebase 설정(firebaseConfig)이 올바른지 확인해주세요.");
    }

    // --- (1) 전역 변수 및 상태 ---
    let currentUserId = null;
    let userProfile = {
        totalDistance: 0,
        challengePoints: 0,
        completedChallenges: {}
    };
    let userPokedex = []; // { id: docId, ...data }
    let userFriends = [];

    // Firestore 경로
    let profileDocRef = null;
    let pokedexCollectionRef = null;
    let friendsCollectionRef = null;

    // 카카오맵 관련 변수
    let map;
    let polyline;
    let distanceOverlay;
    let currentDistance = 0;
    let path = [];
    let isDrawing = false;
    let mapMode = 'map'; // 'map' or 'hybrid'

    // [신규] 러닝 타이머 변수
    let runTimerInterval = null; // setInterval을 저장할 변수
    let runStartTime = 0;      // 시작 시간 (timestamp)
    let elapsedTime = 0;         // 총 경과 시간 (ms)
    
    // 기존 UI 요소
    const heightInput = document.getElementById('height');
    const weightInput = document.getElementById('weight');
    const goalWeightInput = document.getElementById('goalWeight');
    const ageInput = document.getElementById('age');
    const genderSelect = document.getElementById('gender');
    const targetDistanceInput = document.getElementById('targetDistance');
    const calculateBtn = document.getElementById('calculateBtn');
    const resultsDisplay = document.querySelector('.results-display');
    const characterDisplay = document.getElementById('character-display');
    const goalProgress = document.querySelector('.goal-progress');
    const startRunBtn = document.getElementById('startRunBtn');
    const stopRunBtn = document.getElementById('stopRunBtn');
    const runStatus = document.getElementById('runStatus');
    const runTimer = document.getElementById('runTimer'); // [신규] 타이머 UI

    // 새로운 UI 요소
    const statusBar = document.getElementById('status-bar');
    const totalDistanceDisplay = document.getElementById('total-distance-display');
    const challengePointsDisplay = document.getElementById('challenge-points-display');
    const userIdDisplay = document.getElementById('user-id-display');
    const userIdDisplayGroup = document.getElementById('user-id-display-group');
    const challengeList = document.getElementById('challenge-list');
    const pokedexGrid = document.getElementById('pokedex-grid');
    const pokedexEmpty = document.getElementById('pokedex-empty');
    const friendIdInput = document.getElementById('friend-id-input');
    const addFriendBtn = document.getElementById('add-friend-btn');
    const friendList = document.getElementById('friend-list');
    const friendListEmpty = document.getElementById('friend-list-empty');

    // 모달 요소
    const pokemonDetailModal = document.getElementById('pokemon-detail-modal');
    const evolutionModal = document.getElementById('evolution-modal');
    const alertModal = document.getElementById('alert-modal');
    const alertMessage = document.getElementById('alert-message');

    // --- (2) 포켓몬 정적 데이터베이스 ---
    const POKEMON_DB = {
        1: { name: "Bulbasaur", name_ko: "이상해씨", evolution: 2, evolutionCost: 30 },
        2: { name: "Ivysaur", name_ko: "이상해풀", evolution: 3, evolutionCost: 100 },
        3: { name: "Venusaur", name_ko: "이상해꽃" },
        4: { name: "Charmander", name_ko: "파이리", evolution: 5, evolutionCost: 30 },
        5: { name: "Charmeleon", name_ko: "리자드", evolution: 6, evolutionCost: 100 },
        6: { name: "Charizard", name_ko: "리자몽" },
        7: { name: "Squirtle", name_ko: "꼬부기", evolution: 8, evolutionCost: 30 },
        8: { name: "Wartortle", name_ko: "어니부기", evolution: 9, evolutionCost: 100 },
        9: { name: "Blastoise", name_ko: "거북왕" },
        25: { name: "Pikachu", name_ko: "피카츄", evolution: 26, evolutionCost: 30 },
        26: { name: "Raichu", name_ko: "라이츄" },
        133: { name: "Eevee", name_ko: "이브이", evolution: 134, evolutionCost: 25 }, // 단순화를 위해 134(샤미드)로만 진화
        134: { name: "Vaporeon", name_ko: "샤미드" },
        147: { name: "Dratini", name_ko: "미뇽", evolution: 148, evolutionCost: 30 },
        148: { name: "Dragonair", name_ko: "신뇽", evolution: 149, evolutionCost: 100 },
        149: { name: "Dragonite", name_ko: "망나뇽" }
    };
    const CATCHABLE_POKEMON_IDS = [1, 4, 7, 25, 133, 147];
    const getPokemonImageUrl = (pokedexId) => {
        return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${pokedexId}.png`;
    }
    const SKILL_POOL = ["몸통박치기", "할퀴기", "울음소리", "전광석화", "불꽃세례", "물대포", "덩굴채찍", "10만볼트", "용의숨결"];

    // --- (3) 도전과제 데이터 ---
    const CHALLENGES = {
        'challenge_1k': { distance: 1, pokemon: 1, points: 0, label: "1km 달성" },
        'challenge_3k': { distance: 3, pokemon: 1, points: 30, label: "3km 달성" },
        'challenge_5k': { distance: 5, pokemon: 2, points: 45, label: "5km 달성" },
        'challenge_10k': { distance: 10, pokemon: 4, points: 90, label: "10km 달성" }
    };

    // --- (4) 핵심 로직: Firebase 인증 및 데이터 리스너 ---
    async function setupFirebaseAuth() {
        if (!auth) {
            console.error("Firebase Auth가 초기화되지 않았습니다.");
            customAlert("인증 서비스에 연결할 수 없습니다. Firebase 설정을 확인하세요.");
            return;
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
            } else {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        // 로컬 테스트용 익명 로그인
                        // (Firebase 콘솔에서 'Authentication' > 'Sign-in method' > '익명' 활성화 필수!)
                        await signInAnonymously(auth);
                    }
                    currentUserId = auth.currentUser.uid;
                } catch (error) {
                    console.error("Firebase 로그인 오류:", error);
                    customAlert("인증에 실패했습니다. Firebase '익명 로그인'이 활성화되었는지 확인하세요.");
                    return;
                }
            }
            
            console.log("로그인 성공. UserID:", currentUserId);
            userIdDisplay.textContent = currentUserId;
            userIdDisplayGroup.textContent = currentUserId;
            statusBar.style.display = 'block'; // [수정] 상태 바 표시
            
            profileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile`, 'data');
            pokedexCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/pokemon`);
            friendsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/friends`);

            listenToProfile();
            listenToPokedex();
            listenToFriends();
        });
    }

    // 사용자 프로필 실시간 감지
    function listenToProfile() {
        if (!profileDocRef) return;
        
        onSnapshot(profileDocRef, (docSnap) => {
            if (docSnap.exists()) {
                userProfile = docSnap.data();
                console.log("프로필 데이터 로드:", userProfile);
            } else {
                userProfile = {
                    totalDistance: 0,
                    challengePoints: 0,
                    completedChallenges: {}
                };
                setDoc(profileDocRef, userProfile);
                console.log("새 프로필 생성");
            }
            
            updateProfileUI();
            renderChallenges();
            checkAndGrantChallenges(); 
            
        }, (error) => {
            console.error("프로필 리스너 오류:", error);
            customAlert("프로필 정보를 불러오는 데 실패했습니다.");
        });
    }

    // 포켓몬 도감 실시간 감지
    function listenToPokedex() {
        if (!pokedexCollectionRef) return;
        
        const q = query(pokedexCollectionRef); 
        onSnapshot(q, (querySnapshot) => {
            userPokedex = [];
            querySnapshot.forEach((doc) => {
                userPokedex.push({ id: doc.id, ...doc.data() });
            });
            console.log("포켓몬 도감 로드:", userPokedex.length, "마리");
            renderPokedex();
        }, (error) => {
            console.error("도감 리스너 오류:", error);
        });
    }

    // 친구 목록 실시간 감지
    function listenToFriends() {
        if (!friendsCollectionRef) return;

        onSnapshot(friendsCollectionRef, (querySnapshot) => {
            userFriends = [];
            querySnapshot.forEach((doc) => {
                userFriends.push({ id: doc.id, ...doc.data() });
            });
            console.log("친구 목록 로드:", userFriends.length, "명");
            renderFriends();
        }, (error) => {
            console.error("친구 리스너 오류:", error);
        });
    }

    // --- (5) UI 렌더링 함수 ---

    // 프로필 UI 업데이트
    function updateProfileUI() {
        totalDistanceDisplay.textContent = (userProfile.totalDistance || 0).toFixed(2);
        challengePointsDisplay.textContent = userProfile.challengePoints || 0;
    }

    // 도전과제 목록 렌더링
    function renderChallenges() {
        challengeList.innerHTML = '';
        const completedChallenges = userProfile.completedChallenges || {};
        const totalDistance = userProfile.totalDistance || 0;

        Object.keys(CHALLENGES).forEach(key => {
            const challenge = CHALLENGES[key];
            const isCompleted = completedChallenges[key] === true;
            
            const progress = Math.min((totalDistance / challenge.distance) * 100, 100);

            let statusHTML = '';
            if (isCompleted) {
                statusHTML = `<span class="font-bold text-green-600">완료</span>`;
            } else if (progress === 100) {
                statusHTML = `<span class="font-bold text-blue-600">보상 수령 대기중...</span>`;
            } else {
                statusHTML = `<span class="text-gray-500">${progress.toFixed(0)}%</span>`;
            }
            
            const card = document.createElement('div');
            card.className = `p-4 border rounded-lg ${isCompleted ? 'bg-green-50' : 'bg-white'} shadow-sm`;
            card.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-bold">${challenge.label}</h3>
                    ${statusHTML}
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progress}%"></div>
                </div>
                <p class="text-sm text-gray-600 mt-2">
                    보상: 포켓몬 ${challenge.pokemon}마리, ${challenge.points} 포인트
                </p>
            `;
            challengeList.appendChild(card);
        });
    }

    // 포켓몬 도감 렌더링
    function renderPokedex() {
        pokedexGrid.innerHTML = '';
        if (userPokedex.length === 0) {
            pokedexEmpty.style.display = 'block';
            return;
        }
        
        pokedexEmpty.style.display = 'none';
        
        const sortedPokedex = [...userPokedex].sort((a, b) => (a.nickname || a.name_ko).localeCompare(b.nickname || b.name_ko));

        sortedPokedex.forEach(pokemon => {
            const pokemonData = POKEMON_DB[pokemon.pokedexId];
            if (!pokemonData) { // 데이터베이스에 없는 포켓몬 (오류 방지)
                console.warn("알 수 없는 포켓몬 ID:", pokemon.pokedexId);
                return; 
            }
            const name = pokemon.nickname || pokemonData.name_ko;
            
            const card = document.createElement('div');
            card.className = 'border rounded-lg p-3 text-center shadow-sm bg-white cursor-pointer hover:shadow-md transition-shadow';
            card.innerHTML = `
                <img src="${getPokemonImageUrl(pokemon.pokedexId)}" alt="${name}" class="w-24 h-24 mx-auto mb-2" onerror="this.src='https://placehold.co/150x150/EEEEEE/000000?text=${name}'">
                <p class="font-bold truncate">${name}</p>
                <p class="text-sm text-gray-500">HP: ${pokemon.stats.hp} / ATK: ${pokemon.stats.attack}</p>
            `;
            card.onclick = () => showPokemonDetail(pokemon.id, pokemon);
            pokedexGrid.appendChild(card);
        });
    }

    // 친구 목록 렌더링
    function renderFriends() {
        friendList.innerHTML = '';
        if (userFriends.length === 0) {
            friendListEmpty.style.display = 'block';
            return;
        }
        
        friendListEmpty.style.display = 'none';
        
        userFriends.forEach(friend => {
            const item = document.createElement('div');
            item.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
            item.innerHTML = `
                <span class="font-medium truncate" title="${friend.friendId}">${friend.friendId}</span>
                <button class="bg-blue-500 hover:bg-blue-600 text-white text-sm px-3 py-1 rounded-md">친선전 (준비중)</button>
            `;
            item.querySelector('button').onclick = () => {
                customAlert("친선전 기능은 현재 준비 중입니다.");
            };
            friendList.appendChild(item);
        });
    }

    // --- (6) 핵심 게임 로직: 도전과제, 보상, 진화 ---

    // [수정] 러닝 종료 시 누적 거리 업데이트
    async function handleRunStop(distanceKm) {
        if (!profileDocRef) return;
        
        // 거리가 0 이상일 때만 저장
        if (distanceKm <= 0) {
            customAlert(`러닝 종료. 달린 거리가 없습니다.`);
            return;
        }
        
        customAlert(`러닝 종료! ${distanceKm.toFixed(2)}km를 달렸습니다. 총 거리에 합산됩니다.`);
        
        try {
            await updateDoc(profileDocRef, {
                totalDistance: increment(distanceKm)
            });
            console.log(`총 거리 업데이트: +${distanceKm}km`);
            // onSnapshot이 자동으로 checkAndGrantChallenges()를 트리거합니다.
        } catch (e) {
            console.error("거리 업데이트 실패:", e);
            customAlert("거리 업데이트에 실패했습니다. 다시 시도해주세요.");
        }
    }

    // [신규] 도전과제 달성 체크 및 보상 지급
    function checkAndGrantChallenges() {
        if (!userProfile) return;
        
        const { totalDistance, completedChallenges } = userProfile;
        let rewardsGranted = false;
        
        Object.keys(CHALLENGES).forEach(key => {
            const challenge = CHALLENGES[key];
            if ((completedChallenges[key] !== true) && (totalDistance >= challenge.distance)) {
                console.log(`도전과제 달성: ${challenge.label}`);
                grantReward(key);
                rewardsGranted = true;
            }
        });
        
        if (rewardsGranted) {
            renderChallenges(); 
        }
    }

    // [신규] 보상 지급 함수 (관리자 패널과 공용)
    async function grantReward(challengeId) {
        if (!profileDocRef) return;

        // 트랜잭션으로 중복 지급 방지
        try {
            await runTransaction(db, async (transaction) => {
                const profileSnap = await transaction.get(profileDocRef);
                if (!profileSnap.exists()) {
                    throw "프로필을 찾을 수 없습니다.";
                }

                const currentData = profileSnap.data();
                if (currentData.completedChallenges[challengeId] === true) {
                    console.log(`이미 완료된 도전과제: ${challengeId}`);
                    // 이미 완료되었음을 알리기 위해 throw 대신 return
                    return Promise.reject("이미 완료된 도전과제입니다."); 
                }

                const challenge = CHALLENGES[challengeId];
                if (!challenge) {
                    throw "존재하지 않는 도전과제입니다.";
                }

                console.log(`보상 지급 시작 (트랜잭션): ${challengeId}`);
                
                // 1. 프로필 업데이트 (포인트, 완료 상태)
                const fieldToUpdate = `completedChallenges.${challengeId}`;
                transaction.update(profileDocRef, {
                    challengePoints: increment(challenge.points),
                    [fieldToUpdate]: true
                });

                // 2. 포켓몬 추가 (Batch Write는 트랜잭션과 별도 실행)
                const pokemonBatch = writeBatch(db);
                const newPokemonNames = [];
                for (let i = 0; i < challenge.pokemon; i++) {
                    const randomPokedexId = CATCHABLE_POKEMON_IDS[Math.floor(Math.random() * CATCHABLE_POKEMON_IDS.length)];
                    const newPokemon = generateNewPokemon(randomPokedexId);
                    
                    const newPokemonDocRef = doc(pokedexCollectionRef);
                    pokemonBatch.set(newPokemonDocRef, newPokemon);
                    newPokemonNames.push(newPokemon.name_ko);
                }
                
                // 트랜잭션이 성공한 *후에* 배치 쓰기 커밋
                // (엄밀히는 트랜잭션 밖에서 실행)
                return { batch: pokemonBatch, names: newPokemonNames, points: challenge.points, label: challenge.label }; 
            });

            // 트랜잭션이 성공했으므로, 반환된 객체로 후속 처리
            // (위에서 reject된 경우는 이 .then() 블록이 실행되지 않음)
            // customAlert는 비동기 트랜잭션 밖에서 호출해야 함.
            const { batch, names, points, label } = await Promise.resolve(arguments[0]); // 트랜잭션 반환값 받기
            
            await batch.commit(); // 포켓몬 일괄 추가
            
            customAlert(`${label} 달성!\n포인트 +${points} 획득!\n${names.join(', ')} 획득!`);
            console.log(`보상 지급 완료: ${challengeId}`);

        } catch (e) {
            console.error("보상 지급 오류:", e);
            if (e !== "이미 완료된 도전과제입니다.") { // 이미 완료된 경우는 오류 메시지 표시 안함
                customAlert(`보상 지급 중 오류가 발생했습니다: ${e}`);
            } else {
                customAlert(e); // "이미 완료된 도전과제입니다."
            }
        }
    }


    // [신규] 새 포켓몬 데이터 생성
    function generateNewPokemon(pokedexId) {
        const baseData = POKEMON_DB[pokedexId];
        const hp = Math.floor(Math.random() * 30) + 50; // 50~79
        const attack = Math.floor(Math.random() * 30) + 20; // 20~49
        const skills = [];
        for (let i = 0; i < 3; i++) {
            skills.push(SKILL_POOL[Math.floor(Math.random() * SKILL_POOL.length)]);
        }
        
        return {
            pokedexId: pokedexId,
            name_ko: baseData.name_ko,
            nickname: "", 
            stats: {
                hp: hp,
                attack: attack,
                skills: skills
            },
            caughtAt: serverTimestamp()
        };
    }

    // [신규] 포켓몬 상세정보 모달 열기
    let currentOpenPokemonId = null; 
    
    function showPokemonDetail(docId, pokemon) {
        currentOpenPokemonId = docId;
        const baseData = POKEMON_DB[pokemon.pokedexId];
        
        document.getElementById('modal-pokemon-name').textContent = baseData.name_ko;
        document.getElementById('modal-pokemon-image').src = getPokemonImageUrl(pokemon.pokedexId);
        document.getElementById('modal-pokemon-nickname').value = pokemon.nickname || '';
        
        document.getElementById('modal-pokemon-hp').textContent = `❤️ HP: ${pokemon.stats.hp}`;
        document.getElementById('modal-pokemon-attack').textContent = `⚔️ 공격력: ${pokemon.stats.attack}`;
        
        const skillsList = document.getElementById('modal-pokemon-skills');
        skillsList.innerHTML = '';
        pokemon.stats.skills.forEach(skill => {
            skillsList.innerHTML += `<li>${skill}</li>`;
        });

        const evolveBtn = document.getElementById('modal-evolve-btn');
        const evolveStatus = document.getElementById('modal-evolve-status');
        
        if (baseData.evolution) {
            evolveBtn.style.display = 'block';
            const cost = baseData.evolutionCost;
            const evolvedName = POKEMON_DB[baseData.evolution].name_ko;
            
            const samePokemonCount = userPokedex.filter(p => p.pokedexId === pokemon.pokedexId).length;
            
            evolveBtn.textContent = `${evolvedName}(으)로 진화 (${cost}P)`;
            
            if (samePokemonCount < 2) {
                evolveBtn.disabled = true;
                evolveStatus.textContent = `진화하려면 같은 포켓몬이 2마리 필요합니다. (현재: ${samePokemonCount}마리)`;
            } else if (userProfile.challengePoints < cost) {
                evolveBtn.disabled = true;
                evolveStatus.textContent = `진화 포인트가 부족합니다. (필요: ${cost}P, 보유: ${userProfile.challengePoints}P)`;
            } else {
                evolveBtn.disabled = false;
                evolveStatus.textContent = `진화 가능! (2마리 합성, ${cost}P 소모)`;
            }
            
            evolveBtn.onclick = () => attemptEvolution(pokemon);

        } else {
            evolveBtn.style.display = 'none';
            evolveStatus.textContent = "이 포켓몬은 더 이상 진화할 수 없습니다.";
        }
        
        pokemonDetailModal.style.display = 'flex';
    }

    // [신규] 포켓몬 닉네임 저장
    async function saveNickname() {
        if (!currentOpenPokemonId) return;
        
        const newNickname = document.getElementById('modal-pokemon-nickname').value;
        const pokemonDocRef = doc(db, pokedexCollectionRef.path, currentOpenPokemonId);
        
        try {
            await updateDoc(pokemonDocRef, {
                nickname: newNickname
            });
            customAlert("이름이 저장되었습니다.");
            pokemonDetailModal.style.display = 'none';
        } catch (e) {
            console.error("닉네임 저장 오류:", e);
            customAlert("이름 저장에 실패했습니다.");
        }
    }

    // [신규] 진화 시도
    async function attemptEvolution(pokemon) {
        const baseData = POKEMON_DB[pokemon.pokedexId];
        const cost = baseData.evolutionCost;
        const evolvedPokedexId = baseData.evolution;
        
        const samePokemon = userPokedex.filter(p => p.pokedexId === pokemon.pokedexId);
        if (samePokemon.length < 2) {
            customAlert("진화 재료(포켓몬)가 부족합니다.");
            return;
        }
        if (userProfile.challengePoints < cost) {
            customAlert("진화 포인트가 부족합니다.");
            return;
        }

        const docId1 = samePokemon[0].id;
        const docId2 = samePokemon[1].id;
        
        try {
            await runTransaction(db, async (transaction) => {
                const profileSnap = await transaction.get(profileDocRef);
                if (!profileSnap.exists()) {
                    throw "프로필을 찾을 수 없습니다.";
                }
                
                const currentPoints = profileSnap.data().challengePoints;
                if (currentPoints < cost) {
                    throw "포인트가 부족합니다.";
                }
                
                transaction.update(profileDocRef, { challengePoints: currentPoints - cost });
                
                const docRef1 = doc(db, pokedexCollectionRef.path, docId1);
                const docRef2 = doc(db, pokedexCollectionRef.path, docId2);
                transaction.delete(docRef1);
                transaction.delete(docRef2);
            });
            
            console.log("트랜잭션 성공. 재료 소모.");
            pokemonDetailModal.style.display = 'none';
            
            await showEvolutionAnimation(pokemon.pokedexId, evolvedPokedexId);
            
            const newEvolvedPokemon = generateNewPokemon(evolvedPokedexId);
            await addDoc(pokedexCollectionRef, newEvolvedPokemon);
            
            customAlert(`${baseData.name_ko} 2마리가 ${POKEMON_DB[evolvedPokedexId].name_ko}(으)로 진화했습니다!`);

        } catch (e) {
            console.error("진화 트랜잭션 실패:", e);
            customAlert(`진화에 실패했습니다: ${e}`);
        }
    }

    // [신규] 진화 애니메이션
    function showEvolutionAnimation(beforeId, afterId) {
        return new Promise(resolve => {
            const beforeImg = document.getElementById('evolution-image-before');
            const afterImg = document.getElementById('evolution-image-after');
            const evolveText = document.getElementById('evolution-text');
            const resultText = document.getElementById('evolution-result-text');

            beforeImg.src = getPokemonImageUrl(beforeId);
            afterImg.src = getPokemonImageUrl(afterId);

            evolveText.textContent = "진화중...";
            evolveText.classList.remove('opacity-0');
            resultText.classList.add('opacity-0', 'scale-50');
            afterImg.classList.add('opacity-0');
            afterImg.classList.remove('evolving');
            beforeImg.classList.remove('opacity-0');
            
            evolutionModal.style.display = 'flex';

            try {
                const synth = new Tone.Synth().toDestination();
                const now = Tone.now();
                synth.triggerAttackRelease("C4", "8n", now);
                synth.triggerAttackRelease("E4", "8n", now + 0.2);
                synth.triggerAttackRelease("G4", "8n", now + 0.4);
                synth.triggerAttackRelease("C5", "4n", now + 0.6);
            } catch(e) { console.warn("Tone.js 효과음 재생 실패", e); }

            setTimeout(() => {
                beforeImg.classList.add('opacity-0');
                afterImg.classList.remove('opacity-0');
                afterImg.classList.add('evolving');
            }, 1000); 
            
            setTimeout(() => {
                evolveText.classList.add('opacity-0');
                resultText.classList.remove('opacity-0', 'scale-50');
                resultText.style.transition = 'all 0.5s ease-out';
            }, 3000); 
            
            setTimeout(() => {
                evolutionModal.style.display = 'none';
                resolve();
            }, 4500); 
        });
    }

    // [신규] 친구 추가
    async function addFriend() {
        const friendId = friendIdInput.value.trim();
        if (!friendId) {
            customAlert("친구의 ID를 입력하세요.");
            return;
        }
        if (friendId === currentUserId) {
            customAlert("자기 자신은 친구로 추가할 수 없습니다.");
            return;
        }
        if (userFriends.some(f => f.friendId === friendId)) {
            customAlert("이미 추가된 친구입니다.");
            return;
        }

        try {
            await addDoc(friendsCollectionRef, {
                friendId: friendId,
                addedAt: serverTimestamp()
            });
            
            customAlert("친구를 추가했습니다.");
            friendIdInput.value = '';
        } catch (e) {
            console.error("친구 추가 오류:", e);
            customAlert("친구 추가에 실패했습니다.");
        }
    }
    
    // --- (7) 관리자 기능 ---
    function setupAdminPanel() {
        // confirm/alert는 모달로 대체되었으므로, 네이티브 confirm을 임시로 사용
        const adminConfirm = (message) => window.confirm(message);

        document.getElementById('admin-grant-1k').onclick = () => {
            customAlert("[관리자] 1km 보상을 강제 지급합니다.");
            grantReward('challenge_1k');
        };
        document.getElementById('admin-grant-3k').onclick = () => {
            customAlert("[관리자] 3km 보상을 강제 지급합니다.");
            grantReward('challenge_3k');
        };
        document.getElementById('admin-grant-5k').onclick = () => {
            customAlert("[관리자] 5km 보상을 강제 지급합니다.");
            grantReward('challenge_5k');
        };
        document.getElementById('admin-grant-10k').onclick = () => {
            customAlert("[관리자] 10km 보상을 강제 지급합니다.");
            grantReward('challenge_10k');
        };

        document.getElementById('admin-reset-challenges').onclick = async () => {
            if (adminConfirm("[관리자] 정말 모든 도전과제 완료 상태를 초기화하시겠습니까? (포인트, 포켓몬은 유지됨)")) {
                try {
                    await updateDoc(profileDocRef, {
                        completedChallenges: {}
                    });
                    customAlert("도전과제 상태가 초기화되었습니다.");
                } catch (e) { console.error("도전과제 초기화 오류:", e); }
            }
        };

        document.getElementById('admin-reset-pokemon').onclick = async () => {
            if (adminConfirm("[관리자] 정말 도감의 모든 포켓몬을 삭제하시겠습니까? (되돌릴 수 없음)")) {
                try {
                    const batch = writeBatch(db);
                    const q = query(pokedexCollectionRef);
                    const snapshot = await getDocs(q);
                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    customAlert("모든 포켓몬이 삭제되었습니다.");
                } catch (e) { console.error("포켓몬 삭제 오류:", e); }
            }
        };
    }

    // --- (8) 탭 및 모달 이벤트 리스너 ---
    function setupTabs() {
        const tabs = document.querySelectorAll('.tab-button');
        const pages = document.querySelectorAll('.page');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                pages.forEach(p => p.classList.remove('active'));
                
                tab.classList.add('active');
                const targetPageId = tab.id.replace('tab-', 'page-');
                document.getElementById(targetPageId).classList.add('active');
            });
        });
    }

    function setupModals() {
        document.getElementById('modal-close-btn').onclick = () => {
            pokemonDetailModal.style.display = 'none';
        };
        document.getElementById('modal-save-btn').onclick = saveNickname;
        document.getElementById('alert-close-btn').onclick = () => {
            alertModal.style.display = 'none';
        };
    }
    
    // [신규] 커스텀 alert 함수 (window.alert 대체)
    function customAlert(message) {
        alertMessage.textContent = message;
        alertModal.style.display = 'flex';
    }


    // --- (9) 카카오맵, 타이머, 계산 로직 ---
    
    // 캐릭터 이미지
    const characterImages = {
        male: {
            lean: 'https://placehold.co/150x200/E0F2FE/0C4A6E?text=Male(Lean)',
            average: 'https://placehold.co/150x200/D1FAE5/065F46?text=Male(Avg)',
            overweight: 'https://placehold.co/150x200/FEF3C7/92400E?text=Male(Over)',
            obese: 'https://placehold.co/150x200/FEE2E2/991B1B?text=Male(Obese)'
        },
        female: {
            lean: 'https://placehold.co/150x200/E0F2FE/0C4A6E?text=Female(Lean)',
            average: 'https://placehold.co/150x200/D1FAE5/065F46?text=Female(Avg)',
            overweight: 'https://placehold.co/150x200/FEF3C7/92400E?text=Female(Over)',
            obese: 'https://placehold.co/150x200/FEE2E2/991B1B?text=Female(Obese)'
        }
    };
    
    // 맵 초기화
    function initMap() {
        try {
            const mapContainer = document.getElementById('map');
            const mapOption = {
                center: new kakao.maps.LatLng(37.566826, 126.9786567), // 서울시청
                level: 5
            };
            map = new kakao.maps.Map(mapContainer, mapOption);
            
            document.getElementById('modeToggleBtn').onclick = () => {
                if (mapMode === 'map') {
                    map.setMapTypeId(kakao.maps.MapTypeId.HYBRID);
                    mapMode = 'hybrid';
                } else {
                    map.setMapTypeId(kakao.maps.MapTypeId.MAP);
                    mapMode = 'map';
                }
            };
            
            polyline = new kakao.maps.Polyline({
                path: [],
                strokeWeight: 4,
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeStyle: 'solid'
            });
            
            distanceOverlay = new kakao.maps.CustomOverlay({
                content: '<div class="bg-white p-2 rounded-md shadow-lg font-bold">거리: 0 km</div>',
                position: map.getCenter(),
                yAnchor: 1
            });
            
            kakao.maps.event.addListener(map, 'click', (mouseEvent) => {
                if (isDrawing) {
                    const latlng = mouseEvent.latLng;
                    path.push(latlng);
                    polyline.setPath(path);
                    
                    currentDistance = polyline.getLength() / 1000;
                    updateDistanceDisplay(latlng, currentDistance);
                }
            });

        } catch (e) {
            console.error("맵 초기화 중 오류:", e);
            document.getElementById('map').innerHTML = '<p class="p-4 text-center text-red-500">카카오맵을 초기화하는 데 실패했습니다. API 키가 유효한지, 인터넷 연결이 정상인지 확인해주세요.</p>';
        }
    }
    
    // 거리 표시 업데이트
    function updateDistanceDisplay(position, distance) {
        const content = `<div class="bg-white p-2 rounded-md shadow-lg font-bold">거리: ${distance.toFixed(2)} km</div>`;
        distanceOverlay.setContent(content);
        distanceOverlay.setPosition(position);
    }

    // [신규] 시간 포맷팅 함수 (HH:MM:SS)
    function formatTime(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        
        return [hours, minutes, seconds]
            .map(v => v.toString().padStart(2, '0'))
            .join(':');
    }

    // [신규] 타이머 업데이트 함수
    function updateTimer() {
        const now = Date.now();
        elapsedTime = now - runStartTime;
        runTimer.textContent = formatTime(elapsedTime);
    }
    
    // [수정] 러닝 시작
    function startRun() {
        if (isDrawing) return;
        isDrawing = true;
        
        // 경로 초기화
        path = [];
        polyline.setPath(path);
        polyline.setMap(map);
        distanceOverlay.setMap(map);
        currentDistance = 0;
        updateDistanceDisplay(map.getCenter(), 0);

        // 타이머 초기화 및 시작
        clearInterval(runTimerInterval); // 이전 타이머가 있다면 제거
        runStartTime = Date.now();
        elapsedTime = 0;
        runTimer.textContent = "00:00:00";
        runTimer.style.display = 'block';
        runTimerInterval = setInterval(updateTimer, 1000);
        
        runStatus.textContent = "러닝 중... (맵에 경로를 그리세요)";
        runStatus.classList.add("text-green-600");
        runStatus.classList.remove("text-red-600");
    }

    // [수정] 러닝 종료
    function stopRun() {
        if (!isDrawing) return;
        isDrawing = false;
        
        // 타이머 정지
        clearInterval(runTimerInterval);
        elapsedTime = Date.now() - runStartTime;
        
        runStatus.textContent = `러닝 종료. 총 거리: ${currentDistance.toFixed(2)} km / 총 시간: ${formatTime(elapsedTime)}`;
        runStatus.classList.remove("text-green-600");
        runStatus.classList.add("text-red-600");
        
        // 타이머 숨기기 (선택 사항)
        // runTimer.style.display = 'none';
        
        // 거리 저장 핸들러 호출
        handleRunStop(currentDistance); 
    }
    
    // 정보 계산 (수정: display: none/block 사용)
    function calculateInfo() {
        try {
            const height = parseFloat(heightInput.value);
            const weight = parseFloat(weightInput.value);
            const goalWeight = parseFloat(goalWeightInput.value);
            const age = parseInt(ageInput.value);
            const gender = genderSelect.value;
            
            if (isNaN(height) || isNaN(weight) || isNaN(age) || height <= 0 || weight <= 0 || age <= 0) {
                customAlert("키, 현재 체중, 나이를 올바르게 입력하세요.");
                return;
            }
            
            const targetDist = parseFloat(targetDistanceInput.value || 0);
            document.getElementById('calorie-result').textContent = `이번 목표(${targetDist}km) 예상 소모 칼로리: ${Math.round(targetDist * weight)} kcal`;
            document.getElementById('weight-loss-result').textContent = `(약 ${(Math.round(targetDist * weight) / 7700).toFixed(2)}kg 감량)`;
            
            const bmi = weight / ((height / 100) ** 2);
            document.getElementById('bmi-result').textContent = `BMI: ${bmi.toFixed(2)}`;
            
            const bmr = (gender === 'male')
                ? 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age)
                : 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
            document.getElementById('bmr-result').textContent = `기초대사량(BMR): ${bmr.toFixed(0)} kcal`;
            
            resultsDisplay.style.display = 'block'; // [수정] 표시
            
            let bodyType;
            if (bmi < 18.5) bodyType = 'lean';
            else if (bmi < 23) bodyType = 'average';
            else if (bmi < 25) bodyType = 'overweight';
            else bodyType = 'obese';
            
            document.getElementById('characterImage').src = characterImages[gender][bodyType];
            characterDisplay.style.display = 'flex'; // [수정] 표시
            
            if (!isNaN(goalWeight) && goalWeight > 0) {
                const startWeight = Math.max(goalWeight * 1.2, weight, goalWeight + 0.1); 
                const achieved = Math.max(0, startWeight - weight);
                const totalToGo = Math.max(0.1, startWeight - goalWeight); 
                
                let achievedPercent = (achieved / totalToGo) * 100;
                if (achievedPercent > 100) achievedPercent = 100;
                if (achievedPercent < 0) achievedPercent = 0;
                
                document.getElementById('weight-progress-bar').style.width = `${achievedPercent}%`;
                document.getElementById('weight-progress-bar').textContent = `${achievedPercent.toFixed(1)}%`;
                document.getElementById('weight-progress-text').textContent = `목표까지 ${Math.max(0, weight - goalWeight).toFixed(1)}kg 남았습니다!`;
                goalProgress.style.display = 'block'; // [수정] 표시
            } else {
                goalProgress.style.display = 'none'; // [수정] 숨김
            }
            
        } catch(e) {
            console.error("계산 오류:", e);
            customAlert("정보를 계산하는 중 오류가 발생했습니다.");
        }
    }

    // --- (10) 앱 초기화 실행 ---
    document.addEventListener('DOMContentLoaded', () => {
        // [수정] Firebase 인증을 먼저 시도
        setupFirebaseAuth();

        setupTabs();
        setupModals();
        setupAdminPanel();

        // [수정] 카카오맵 로드는 kakao 객체가 로드된 *후에* 실행
        if (typeof kakao !== 'undefined' && kakao.maps) {
            kakao.maps.load(initMap);
        } else {
            console.error("카카오맵 SDK 스크립트 로드 실패. API 키를 확인하세요.");
            // 맵 컨테이너에 에러 메시지 표시
            document.getElementById('map').innerHTML = '<p class="p-4 text-center text-red-500">카카오맵 SDK를 불러오는 데 실패했습니다. API 키가 정확한지, 인터넷 연결이 정상인지 확인해주세요.</p>';
        }
        
        calculateBtn.onclick = calculateInfo;
        startRunBtn.onclick = startRun;
        stopRunBtn.onclick = stopRun;
        addFriendBtn.onclick = addFriend;
    });

</script>

</body>
</html>

