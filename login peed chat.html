<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>POKE RUN: INTEGRATED</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:ital,wght@0,400;0,700;1,900&family=Inter:wght@400;700;900&family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        /* 테마 변수 정의 */
        :root {
            --volt: #ccff00;
            
            /* 다크 모드 (기본) */
            --bg-main: #000000;
            --bg-card: #111111;
            --bg-sub: #262626; /* 입력창, 버튼 등 */
            --bg-panel: rgba(20, 20, 20, 0.95);
            
            --text-main: #ffffff;
            --text-sub: #9ca3af; /* gray-400 */
            
            --border-color: #262626;
        }

        /* 화이트 모드 */
        .light-mode {
            --volt: #0784eb; /* 흰 배경에서 잘 보이도록 약간 어둡게 조정 */
            
            --bg-main: #ffffff;
            --bg-card: #f3f4f6; /* gray-100 */
            --bg-sub: #e5e7eb; /* gray-200 */
            --bg-panel: rgba(255, 255, 255, 0.95);
            
            --text-main: #000000;
            --text-sub: #4b5563; /* gray-600 */
            
            --border-color: #e5e7eb;
        }

        body { font-family: 'Inter', 'Noto Sans KR', sans-serif; background-color: var(--bg-main); color: var(--text-main); overflow: hidden; transition: background-color 0.3s, color 0.3s; }
        .font-sport { font-family: 'Chakra Petch', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-main);
            transition: transform 0.3s ease-in-out, opacity 0.3s, background-color 0.3s;
            display: none; flex-direction: column; z-index: 10;
        }
        .screen.active { display: flex; }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            z-index: 50; display: none; justify-content: center; align-items: center; padding: 20px;
        }
        .modal-overlay.open { display: flex; }
        .modal-content {
            background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px;
            width: 100%; max-width: 400px; padding: 24px; max-height: 90vh; overflow-y: auto;
            color: var(--text-main);
        }

        .bottom-sheet-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 60;
            visibility: hidden; opacity: 0;
            transition: visibility 0s linear 0.3s, opacity 0.3s ease;
            display: flex; align-items: flex-end; justify-content: center;
        }
        .bottom-sheet-overlay.open {
            visibility: visible; opacity: 1;
            transition-delay: 0s;
        }
        
        .bottom-sheet {
            background: var(--bg-card); 
            width: 100%; max-width: 450px; 
            height: 80vh; 
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            display: flex; flex-direction: column;
            transform: translateY(100%); 
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            box-shadow: 0 -4px 30px rgba(0,0,0,0.2); 
            touch-action: none; 
            color: var(--text-main);
        }
        .bottom-sheet-overlay.open .bottom-sheet { transform: translateY(0); }
        .bottom-sheet.dragging { transition: none; } 

        .sheet-handle-area {
            width: 100%; padding: 15px 0;
            display: flex; justify-content: center;
            cursor: grab;
        }
        .sheet-handle-area:active { cursor: grabbing; }
        .sheet-handle {
            width: 40px; height: 5px; background: var(--text-sub); border-radius: 10px; opacity: 0.5;
        }

        .input-dark {
            width: 100%; background: var(--bg-main); border: 1px solid var(--border-color); color: var(--text-main);
            padding: 12px; border-radius: 8px; margin-bottom: 8px; outline: none; transition: border-color 0.2s, background-color 0.3s;
        }
        .input-dark:focus { border-color: var(--volt); }
        
        select.input-dark {
            appearance: none; 
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        @keyframes likeBounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        .like-active { color: #ef4444; animation: likeBounce 0.3s ease; }

        .msg-bubble { max-width: 75%; padding: 10px 14px; border-radius: 20px; font-size: 14px; line-height: 1.4; word-break: break-word; }
        .msg-me { background: var(--volt); color: black; border-bottom-right-radius: 4px; align-self: flex-end; }
        .msg-other { background: var(--bg-sub); color: var(--text-main); border-bottom-left-radius: 4px; align-self: flex-start; }
    </style>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, update, onValue, push, get, remove, child, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAbHwLLXIH8rBQ8gNMVqE5SE208aIbfFZ0",
            authDomain: "pokbattle.firebaseapp.com",
            databaseURL: "https://pokbattle-default-rtdb.firebaseio.com",
            projectId: "pokbattle",
            storageBucket: "pokbattle.firebasestorage.app",
            messagingSenderId: "445300582484",
            appId: "1:445300582484:web:f8f1373a3bbf643face5c1",
            measurementId: "G-PNXLYD0D0X"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        window.fb = { auth, db, ref, set, update, onValue, push, get, remove, child, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, signOut, query, orderByChild, equalTo };
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.currentUser = user;
                document.getElementById('landing-screen').classList.remove('active');
                document.getElementById('main-screen').classList.add('active');
                loadUserProfile(user.uid);
                loadFeed();
            } else {
                document.getElementById('landing-screen').classList.add('active');
                document.getElementById('main-screen').classList.remove('active');
            }
        });
    </script>
</head>
<body class="flex justify-center h-screen w-full bg-[var(--bg-main)] text-[var(--text-main)]">

    <div class="w-full max-w-md h-full relative overflow-hidden bg-[var(--bg-main)] shadow-2xl transition-colors duration-300">
        
        <!-- 1. LANDING / LOGIN SCREEN -->
        <div id="landing-screen" class="screen active z-50">
            <div class="flex-1 flex flex-col items-center justify-center p-6 text-center relative">
                <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1516724562728-afc824a36e84?q=80&w=1000')] bg-cover bg-center opacity-40"></div>
                <div class="absolute inset-0 bg-gradient-to-b from-black/20 via-black/80 to-black"></div>

                <div class="relative z-10 w-full">
                    <h1 class="text-5xl font-sport font-black italic tracking-tighter text-white mb-2">
                        POKE<span class="text-[var(--volt)]">RUN</span>
                    </h1>
                    <p class="text-gray-300 mb-10 text-sm">Run, Battle, and Socialize.</p>

                    <div class="space-y-3">
                        <input type="email" id="login-email" class="input-dark bg-black/50 backdrop-blur-sm border-gray-600 text-white" placeholder="이메일">
                        <input type="password" id="login-pw" class="input-dark bg-black/50 backdrop-blur-sm border-gray-600 text-white" placeholder="비밀번호">
                        <button onclick="handleLogin()" class="w-full bg-[var(--volt)] text-black font-bold py-3.5 rounded-xl hover:bg-white transition-colors">
                            로그인 / 시작하기
                        </button>
                        <button onclick="openModal('signup')" class="w-full border border-gray-600 text-white font-bold py-3.5 rounded-xl hover:bg-gray-800 transition-colors">
                            회원가입
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. MAIN HOME SCREEN -->
        <div id="main-screen" class="screen flex flex-col bg-[var(--bg-main)]"> 
            <!-- Header -->
            <header class="px-4 py-4 flex justify-between items-center bg-[var(--bg-main)]/90 backdrop-blur-sm z-20 border-b border-[var(--border-color)] absolute top-0 w-full max-w-md transition-colors duration-300">
                <div id="header-title-area">
                    <h1 class="text-2xl font-black italic tracking-tighter text-[var(--text-main)] font-sport">
                        RUN<span class="text-[var(--volt)]">FEED</span>
                    </h1>
                </div>
                <div class="flex gap-4" id="header-action-area">
                    <button onclick="openSocialScreen()" class="relative">
                        <div class="relative">
                            <i data-lucide="send" class="w-6 h-6 text-[var(--text-main)] hover:text-[var(--volt)] transition-colors transform -rotate-45 mb-1"></i>
                            <span class="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-[var(--bg-main)]"></span>
                        </div>
                    </button>
                </div>
            </header>

            <!-- Main Content -->
            <main id="main-content" class="flex-1 overflow-y-auto scrollbar-hide pt-16 pb-20">
                <div id="view-feed" class="view-section px-4">
                    <div id="feed-container" class="mt-4 space-y-6 pb-20">
                        <div class="text-center text-[var(--text-sub)] py-10">
                            <p>피드를 불러오는 중...</p>
                        </div>
                    </div>
                </div>

                <div id="view-upload" class="view-section hidden p-4 h-full overflow-y-auto">
                    <h2 class="text-xl font-bold mb-4 text-[var(--text-main)]">기록 공유하기</h2>
                    <div class="relative w-full aspect-square bg-[var(--bg-card)] rounded-xl border-2 border-dashed border-[var(--border-color)] flex flex-col items-center justify-center mb-6 text-[var(--text-sub)] hover:border-[var(--volt)] cursor-pointer overflow-hidden group transition-colors">
                        <input type="file" id="upload-file-input" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="previewImage(this)">
                        <div id="upload-placeholder" class="flex flex-col items-center">
                            <i data-lucide="camera" class="w-10 h-10 mb-2 group-hover:text-[var(--volt)] transition-colors"></i>
                            <span>사진 선택</span>
                        </div>
                        <img id="upload-preview" class="absolute inset-0 w-full h-full object-cover hidden">
                    </div>
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="bg-[var(--bg-card)] p-3 rounded-xl border border-[var(--border-color)] flex flex-col items-center transition-colors">
                            <i data-lucide="timer" class="w-5 h-5 text-[var(--volt)] mb-1"></i>
                            <input type="text" id="upload-time" placeholder="00:00" class="bg-transparent text-center w-full text-[var(--text-main)] font-bold outline-none text-sm">
                            <span class="text-[10px] text-[var(--text-sub)] mt-1">시간</span>
                        </div>
                        <div class="bg-[var(--bg-card)] p-3 rounded-xl border border-[var(--border-color)] flex flex-col items-center transition-colors">
                            <i data-lucide="map-pin" class="w-5 h-5 text-blue-400 mb-1"></i>
                            <div class="flex items-center justify-center w-full">
                                <input type="text" id="upload-dist" placeholder="0.0" class="bg-transparent text-right w-12 text-[var(--text-main)] font-bold outline-none text-sm">
                                <span class="text-[var(--text-main)] text-sm ml-1">km</span>
                            </div>
                            <span class="text-[10px] text-[var(--text-sub)] mt-1">거리</span>
                        </div>
                        <div class="bg-[var(--bg-card)] p-3 rounded-xl border border-[var(--border-color)] flex flex-col items-center transition-colors">
                            <i data-lucide="flame" class="w-5 h-5 text-orange-500 mb-1"></i>
                            <div class="flex items-center justify-center w-full">
                                <input type="text" id="upload-cal" placeholder="0" class="bg-transparent text-right w-12 text-[var(--text-main)] font-bold outline-none text-sm">
                                <span class="text-[var(--text-main)] text-sm ml-1">kcal</span>
                            </div>
                            <span class="text-[10px] text-[var(--text-sub)] mt-1">칼로리</span>
                        </div>
                    </div>
                    <textarea id="upload-content" class="w-full bg-[var(--bg-card)] p-4 rounded-xl text-[var(--text-main)] outline-none h-32 border border-[var(--border-color)] focus:border-[var(--volt)] transition-colors" placeholder="오늘 러닝은 어떠셨나요?"></textarea>
                    <button onclick="handleUpload()" class="w-full bg-[var(--volt)] text-black font-bold py-3.5 mt-6 rounded-xl hover:bg-opacity-80 transition-colors shadow-lg">업로드</button>
                </div>

                <div id="view-profile" class="view-section hidden p-4">
                    <div class="flex flex-col items-center pt-8 pb-8 relative">
                        <!-- Theme Toggle Button -->
                        <button onclick="toggleTheme()" class="absolute top-0 right-0 p-2 rounded-full bg-[var(--bg-sub)] text-[var(--text-main)] hover:text-[var(--volt)] transition-colors">
                            <i data-lucide="sun-moon" class="w-6 h-6"></i>
                        </button>

                        <div class="w-24 h-24 rounded-full p-[2px] bg-gradient-to-tr from-[var(--volt)] to-purple-500 mb-4">
                            <img id="profile-img-display" src="" class="w-full h-full rounded-full bg-[var(--bg-card)] object-cover">
                        </div>
                        <h2 id="profile-name-display" class="text-2xl font-bold text-[var(--text-main)] mb-1">-</h2>
                        <p id="profile-email-display" class="text-sm text-[var(--text-sub)] mb-6">-</p>
                        <button onclick="openModal('edit-profile')" class="bg-[var(--bg-card)] hover:bg-[var(--bg-sub)] text-[var(--text-main)] px-6 py-2 rounded-full text-sm font-bold mb-8 border border-[var(--border-color)] transition-colors">프로필 수정</button>
                        <div class="w-full bg-[var(--bg-card)] rounded-xl border border-[var(--border-color)] p-4 space-y-4 mt-8 transition-colors">
                            <div class="flex justify-between border-b border-[var(--border-color)] pb-2">
                                <span class="text-[var(--text-sub)] text-sm">실명</span>
                                <span id="profile-realname-display" class="text-[var(--text-main)] text-sm font-medium">-</span>
                            </div>
                            <div class="flex justify-between border-b border-[var(--border-color)] pb-2">
                                <span class="text-[var(--text-sub)] text-sm">생년월일</span>
                                <span id="profile-dob-display" class="text-[var(--text-main)] text-sm font-medium">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-[var(--text-sub)] text-sm">전화번호</span>
                                <span id="profile-phone-display" class="text-[var(--text-main)] text-sm font-medium">-</span>
                            </div>
                        </div>
                        <button onclick="window.fb.signOut(window.fb.auth)" class="mt-8 text-red-500 text-sm underline">로그아웃</button>
                    </div>
                </div>
            </main>

            <!-- Bottom Navigation -->
            <nav class="absolute bottom-0 w-full bg-[var(--bg-main)] border-t border-[var(--border-color)] px-6 py-4 flex justify-between items-center z-20 pb-8 transition-colors duration-300">
                <button onclick="switchTab('feed')" id="nav-feed" class="flex flex-col items-center gap-1 text-[var(--text-sub)] transition-colors">
                    <i data-lucide="home" class="w-6 h-6"></i>
                    <span class="text-[10px] font-bold">피드</span>
                </button>
                <button onclick="switchTab('upload')" class="bg-[var(--volt)] text-black p-4 rounded-full -mt-8 shadow-[0_0_15px_rgba(204,255,0,0.4)] border-4 border-[var(--bg-main)] transition-all active:scale-95">
                    <i data-lucide="plus" class="w-7 h-7"></i>
                </button>
                <button onclick="switchTab('profile')" id="nav-profile" class="flex flex-col items-center gap-1 text-[var(--text-sub)] transition-colors">
                    <i data-lucide="user" class="w-6 h-6"></i>
                    <span class="text-[10px] font-bold">프로필</span>
                </button>
            </nav>
        </div>

        <!-- 3. SOCIAL SCREEN -->
        <div id="social-screen" class="screen flex flex-col bg-[var(--bg-main)] z-30 transform translate-x-full transition-transform duration-300">
            <!-- DM List Header -->
            <div id="dm-list-view" class="flex flex-col h-full">
                <header class="px-5 py-4 flex items-center justify-between bg-[var(--bg-main)] border-b border-[var(--border-color)] shrink-0 transition-colors duration-300">
                    <div class="flex items-center gap-3">
                        <button onclick="closeSocialScreen()" class="text-[var(--text-main)]">
                            <i data-lucide="arrow-left" class="w-7 h-7"></i>
                        </button>
                        <h1 class="text-xl font-bold text-[var(--text-main)]">Direct</h1>
                    </div>
                    <div class="flex gap-3">
                        <!-- Add Friend Button -->
                        <button onclick="openModal('add-friend')" class="text-[var(--text-main)]">
                            <i data-lucide="user-plus" class="w-6 h-6"></i>
                        </button>
                        <!-- New Chat (Pencil) Button -->
                        <button onclick="openFriendSelector('start-chat')" class="text-[var(--text-main)]">
                            <i data-lucide="square-pen" class="w-6 h-6"></i>
                        </button>
                    </div>
                </header>

                <!-- NEW: Open Communities Section -->
                <div class="px-4 pt-4 pb-2">
                    <h3 class="text-xs font-bold text-[var(--text-sub)] mb-3 uppercase tracking-wider">Open Communities</h3>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <!-- 달리기 크루 -->
                        <button onclick="enterPublicChat('public_run', '달리기 크루', 'footprints')" class="flex flex-col items-center gap-1 group">
                            <div class="w-14 h-14 rounded-full bg-[var(--bg-sub)] border border-[var(--border-color)] flex items-center justify-center group-hover:border-[var(--volt)] transition-colors">
                                <i data-lucide="footprints" class="w-6 h-6 text-[var(--volt)]"></i>
                            </div>
                            <span class="text-[10px] text-[var(--text-sub)] font-medium">달리기</span>
                        </button>
                        <!-- 웨이트 -->
                        <button onclick="enterPublicChat('public_weight', '웨이트', 'dumbbell')" class="flex flex-col items-center gap-1 group">
                            <div class="w-14 h-14 rounded-full bg-[var(--bg-sub)] border border-[var(--border-color)] flex items-center justify-center group-hover:border-[var(--volt)] transition-colors">
                                <i data-lucide="dumbbell" class="w-6 h-6 text-blue-400"></i>
                            </div>
                            <span class="text-[10px] text-[var(--text-sub)] font-medium">웨이트</span>
                        </button>
                        <!-- 포켓몬 -->
                        <button onclick="enterPublicChat('public_poke', '포켓몬', 'zap')" class="flex flex-col items-center gap-1 group">
                            <div class="w-14 h-14 rounded-full bg-[var(--bg-sub)] border border-[var(--border-color)] flex items-center justify-center group-hover:border-[var(--volt)] transition-colors">
                                <i data-lucide="zap" class="w-6 h-6 text-yellow-400"></i>
                            </div>
                            <span class="text-[10px] text-[var(--text-sub)] font-medium">포켓몬</span>
                        </button>
                        <!-- 기타 -->
                        <button onclick="enterPublicChat('public_etc', '기타', 'message-circle')" class="flex flex-col items-center gap-1 group">
                            <div class="w-14 h-14 rounded-full bg-[var(--bg-sub)] border border-[var(--border-color)] flex items-center justify-center group-hover:border-[var(--volt)] transition-colors">
                                <i data-lucide="message-circle" class="w-6 h-6 text-[var(--text-sub)]"></i>
                            </div>
                            <span class="text-[10px] text-[var(--text-sub)] font-medium">기타</span>
                        </button>
                    </div>
                </div>

                <!-- Search Bar -->
                <div class="px-4 py-2 border-t border-[var(--border-color)] pt-4 transition-colors">
                    <h3 class="text-xs font-bold text-[var(--text-sub)] mb-3 uppercase tracking-wider">Messages</h3>
                    <div class="bg-[var(--bg-sub)] rounded-xl flex items-center px-3 py-2 transition-colors">
                        <i data-lucide="search" class="w-4 h-4 text-[var(--text-sub)] mr-2"></i>
                        <input type="text" placeholder="채팅방 검색" class="bg-transparent text-sm text-[var(--text-main)] w-full outline-none" oninput="filterChatRooms(this.value)">
                    </div>
                </div>

                <!-- Chat List -->
                <div id="chat-list" class="flex-1 overflow-y-auto p-0">
                    <div class="text-center text-[var(--text-sub)] py-10">메시지를 불러오는 중...</div>
                </div>
            </div>

            <!-- Chat Room (Overlay) -->
            <div id="chat-room" class="absolute inset-0 bg-[var(--bg-main)] z-40 flex flex-col transform translate-x-full transition-transform duration-300">
                <!-- Chat Room Header -->
                <div class="px-4 py-3 bg-[var(--bg-main)] border-b border-[var(--border-color)] flex items-center justify-between shrink-0 transition-colors">
                    <div class="flex items-center gap-3">
                        <button onclick="closeChatRoom()" class="text-[var(--text-main)]"><i data-lucide="arrow-left" class="w-7 h-7"></i></button>
                        <div class="flex items-center gap-3">
                            <div id="chat-header-icon-container" class="w-8 h-8 rounded-full bg-[var(--bg-sub)] overflow-hidden flex items-center justify-center">
                                <img id="chat-room-avatar" class="w-full h-full object-cover">
                            </div>
                            <span id="chat-room-title" class="font-bold text-[var(--text-main)] text-sm">User</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <button onclick="openFriendSelector('invite')" class="text-[var(--text-main)]"><i data-lucide="user-plus" class="w-6 h-6"></i></button>
                        <i data-lucide="info" class="w-6 h-6 text-[var(--text-main)]"></i>
                    </div>
                </div>

                <!-- Messages Area -->
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col gap-2"></div>

                <!-- Input Area -->
                <div class="p-3 bg-[var(--bg-main)] flex items-center gap-3 pb-8 border-t border-[var(--border-color)] transition-colors">
                    <div class="bg-[var(--bg-sub)] rounded-full flex-1 flex items-center px-4 py-2 border border-[var(--border-color)] transition-colors">
                        <input type="text" id="msg-input" class="bg-transparent text-sm text-[var(--text-main)] w-full outline-none" placeholder="메시지 보내기..." onkeypress="if(event.key==='Enter') sendMessage()">
                    </div>
                    <button onclick="sendMessage()" class="text-[var(--volt)] font-bold text-sm whitespace-nowrap px-2">보내기</button>
                </div>
            </div>
        </div>

    </div>

    <!-- 4. MODALS & SHEETS -->
    
    <!-- Signup Modal -->
    <div id="modal-signup" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-xl font-bold text-[var(--text-main)] mb-4">회원가입</h2>
            <input type="email" id="signup-email" class="input-dark" placeholder="이메일">
            <div class="flex gap-2 mb-2">
                <input type="text" id="signup-nickname" class="input-dark flex-1 mb-0" placeholder="닉네임">
                <button onclick="checkNickname()" class="bg-[var(--bg-sub)] hover:bg-[var(--volt)] hover:text-black text-xs px-3 rounded-lg border border-[var(--border-color)] text-[var(--text-sub)] whitespace-nowrap transition-colors">중복확인</button>
            </div>
            <p id="nick-msg" class="text-[10px] text-[var(--text-sub)] mb-2 pl-1"></p>
            <input type="password" id="signup-pw" class="input-dark" placeholder="비밀번호 (6자리 이상)">
            <input type="password" id="signup-pw-confirm" class="input-dark" placeholder="비밀번호 확인">
            <p id="pw-msg" class="text-[10px] text-red-500 mb-2 pl-1 hidden">비밀번호가 일치하지 않습니다.</p>
            <input type="text" id="signup-realname" class="input-dark" placeholder="실명">
            <label class="text-xs text-[var(--text-sub)] ml-1 mt-1 mb-1 block">생년월일</label>
            <div class="flex gap-2 mb-2">
                <select id="signup-year" class="input-dark bg-[var(--bg-sub)] flex-1"></select>
                <select id="signup-month" class="input-dark bg-[var(--bg-sub)] flex-1"></select>
                <select id="signup-day" class="input-dark bg-[var(--bg-sub)] flex-1"></select>
            </div>
            <input type="text" id="signup-phone" class="input-dark" placeholder="전화번호">
            <div class="flex gap-2 mt-4">
                <button onclick="closeModal('signup')" class="flex-1 py-3 rounded-xl bg-[var(--bg-sub)] text-[var(--text-sub)]">취소</button>
                <button onclick="handleSignup()" class="flex-1 py-3 rounded-xl bg-[var(--volt)] text-black font-bold">가입하기</button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="modal-edit-profile" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-xl font-bold text-[var(--text-main)] mb-4">프로필 수정</h2>
            <div class="space-y-3">
                <div>
                    <label class="text-xs text-[var(--text-sub)] ml-1">닉네임</label>
                    <input type="text" id="edit-nickname" class="input-dark">
                </div>
                <div>
                    <label class="text-xs text-[var(--text-sub)] ml-1">실명</label>
                    <input type="text" id="edit-realname" class="input-dark">
                </div>
                <div>
                    <label class="text-xs text-[var(--text-sub)] ml-1">생년월일</label>
                    <input type="text" id="edit-dob" class="input-dark">
                </div>
                <div>
                    <label class="text-xs text-[var(--text-sub)] ml-1">전화번호</label>
                    <input type="text" id="edit-phone" class="input-dark">
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="closeModal('edit-profile')" class="flex-1 py-3 rounded-xl bg-[var(--bg-sub)] text-[var(--text-sub)]">취소</button>
                <button onclick="updateUserProfile()" class="flex-1 py-3 rounded-xl bg-[var(--volt)] text-black font-bold">저장</button>
            </div>
        </div>
    </div>

    <!-- Add Friend Modal -->
    <div id="modal-add-friend" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-xl font-bold text-[var(--text-main)] mb-4">친구 추가</h2>
            <p class="text-[var(--text-sub)] text-sm mb-4">닉네임으로 검색하여 친구를 추가하세요.</p>
            <div class="flex gap-2 mb-4">
                <input type="text" id="add-friend-input" class="input-dark flex-1 mb-0" placeholder="닉네임 입력">
                <button onclick="searchUserForFriend()" class="bg-[var(--volt)] text-black font-bold px-4 rounded-lg text-sm">검색</button>
            </div>
            <div id="add-friend-result" class="hidden bg-[var(--bg-sub)] p-3 rounded-xl border border-[var(--border-color)]">
                <!-- Search Result -->
            </div>
            <div class="flex justify-end mt-4">
                <button onclick="closeModal('add-friend')" class="text-[var(--text-sub)] text-sm">닫기</button>
            </div>
        </div>
    </div>

    <!-- Swipeable Comment Sheet -->
    <div id="sheet-reply" class="bottom-sheet-overlay">
        <div class="bottom-sheet">
            <div class="sheet-handle-area">
                <div class="sheet-handle"></div>
            </div>
            <div class="px-4 pb-2 border-b border-[var(--border-color)] text-center relative">
                <h3 class="font-bold text-[var(--text-main)] text-sm">댓글</h3>
            </div>
            <div id="reply-list" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
            <div class="p-3 border-t border-[var(--border-color)] flex gap-3 bg-[var(--bg-main)] pb-8 transition-colors">
                <div class="w-8 h-8 rounded-full bg-[var(--bg-sub)] overflow-hidden flex-shrink-0">
                    <img id="reply-my-avatar" class="w-full h-full object-cover">
                </div>
                <div class="flex-1 flex items-center bg-[var(--bg-sub)] border border-[var(--border-color)] rounded-full px-4 transition-colors">
                    <input type="text" id="reply-input" class="bg-transparent text-sm text-[var(--text-main)] w-full outline-none py-2" placeholder="댓글 달기..." onkeypress="if(event.key==='Enter') submitReply()">
                    <button onclick="submitReply()" class="text-[var(--volt)] font-bold text-sm ml-2">게시</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Friend Selector Sheet -->
    <div id="sheet-friends" class="bottom-sheet-overlay">
        <div class="bottom-sheet" style="height: 70vh;">
            <div class="flex justify-center pt-3 pb-1" onclick="closeFriendSelector()">
                <div class="w-10 h-1 bg-[var(--text-sub)] rounded-full cursor-pointer opacity-50"></div>
            </div>
            <div class="px-4 py-2 border-b border-[var(--border-color)] text-center relative">
                <h3 id="friend-sheet-title" class="font-bold text-[var(--text-main)] text-sm">친구 선택</h3>
            </div>
            
            <div class="p-4 border-b border-[var(--border-color)]" id="create-group-btn-area">
                <button onclick="createNewGroup()" class="w-full bg-[var(--bg-sub)] py-3 rounded-xl text-sm font-bold text-[var(--volt)] flex items-center justify-center gap-2">
                    <i data-lucide="users" class="w-4 h-4"></i>
                    새 그룹 만들기
                </button>
            </div>

            <div id="friend-list-container" class="flex-1 overflow-y-auto p-0">
                <!-- Friends injected here -->
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        let currentPostIdForReply = null;
        let isNicknameChecked = false;
        let friendSelectorMode = 'start-chat';

        // Theme Toggle Function
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
        }

        function initDobSelects() {
            const yearSel = document.getElementById('signup-year');
            const monthSel = document.getElementById('signup-month');
            const daySel = document.getElementById('signup-day');
            const currYear = new Date().getFullYear();
            for(let i=currYear; i>=1950; i--) yearSel.add(new Option(i + '년', i));
            for(let i=1; i<=12; i++) monthSel.add(new Option(i + '월', i));
            for(let i=1; i<=31; i++) daySel.add(new Option(i + '일', i));
        }
        initDobSelects();

        function switchTab(tab) {
            document.querySelectorAll('#main-content .view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            
            document.getElementById('nav-feed').className = "flex flex-col items-center gap-1 text-[var(--text-sub)] transition-colors";
            document.getElementById('nav-profile').className = "flex flex-col items-center gap-1 text-[var(--text-sub)] transition-colors";
            
            if(tab === 'feed' || tab === 'profile') {
                document.getElementById(`nav-${tab}`).className = "flex flex-col items-center gap-1 text-[var(--volt)] transition-colors";
            }
        }

        function openModal(id) { document.getElementById(`modal-${id}`).classList.add('open'); }
        function closeModal(id) { document.getElementById(`modal-${id}`).classList.remove('open'); }

        function checkNickname() {
            const nick = document.getElementById('signup-nickname').value;
            if(nick.length < 2) return alert("닉네임은 2글자 이상이어야 합니다.");
            const msg = document.getElementById('nick-msg');
            msg.innerText = "사용 가능한 닉네임입니다.";
            msg.className = "text-[10px] text-[var(--text-sub)] mb-2 pl-1";
            isNicknameChecked = true;
        }

        async function handleSignup() {
            const email = document.getElementById('signup-email').value;
            const pw = document.getElementById('signup-pw').value;
            const pwConf = document.getElementById('signup-pw-confirm').value;
            const nick = document.getElementById('signup-nickname').value;
            const y = document.getElementById('signup-year').value;
            const m = document.getElementById('signup-month').value;
            const d = document.getElementById('signup-day').value;
            const dob = `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;

            if(pw !== pwConf) return document.getElementById('pw-msg').classList.remove('hidden');
            if(!email || !pw || !nick) return alert("필수 정보를 입력해주세요.");

            try {
                const cred = await window.fb.createUserWithEmailAndPassword(window.fb.auth, email, pw);
                const user = cred.user;
                await window.fb.set(window.fb.ref(window.fb.db, 'users/' + user.uid), {
                    nickname: nick, email, realName: document.getElementById('signup-realname').value,
                    dob, phone: document.getElementById('signup-phone').value,
                    avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${nick}`
                });
                closeModal('signup');
                alert("가입 완료! 환영합니다.");
            } catch(e) {
                if (e.code === 'auth/email-already-in-use') {
                    alert("이미 가입된 이메일입니다. 로그인해주세요.");
                } else {
                    alert("가입 오류: " + e.message);
                }
            }
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('upload-preview');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    document.getElementById('upload-placeholder').classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function handleUpload() {
            const user = window.fb.auth.currentUser;
            if(!user) return;
            const content = document.getElementById('upload-content').value;
            const stats = {
                time: document.getElementById('upload-time').value,
                dist: document.getElementById('upload-dist').value,
                cal: document.getElementById('upload-cal').value
            };
            let imageUrl = 'https://images.unsplash.com/photo-1502904550040-7534597429ae?w=800&q=80';
            const previewSrc = document.getElementById('upload-preview').src;
            const fileInput = document.getElementById('upload-file-input');
            if(fileInput.files && fileInput.files[0] && previewSrc) imageUrl = previewSrc;

            const userInfo = await getUserInfo(user.uid);
            await window.fb.set(window.fb.push(window.fb.ref(window.fb.db, 'posts')), {
                uid: user.uid,
                authorName: userInfo.nickname || "User",
                authorAvatar: userInfo.avatar || "",
                content, stats, image: imageUrl,
                timestamp: Date.now(), likes: {}
            });

            document.getElementById('upload-content').value = "";
            document.getElementById('upload-time').value = "";
            document.getElementById('upload-dist').value = "";
            document.getElementById('upload-cal').value = "";
            document.getElementById('upload-file-input').value = "";
            document.getElementById('upload-preview').classList.add('hidden');
            document.getElementById('upload-placeholder').classList.remove('hidden');
            switchTab('feed');
            loadFeed();
        }

        function getUserInfo(uid) {
            return window.fb.get(window.fb.ref(window.fb.db, 'users/' + uid)).then(s => s.val() || {});
        }

        function loadFeed() {
            const feedContainer = document.getElementById('feed-container');
            const postsRef = window.fb.query(window.fb.ref(window.fb.db, 'posts'), window.fb.orderByChild('timestamp'));
            window.fb.onValue(postsRef, (snapshot) => {
                feedContainer.innerHTML = "";
                const data = snapshot.val();
                if(!data) return feedContainer.innerHTML = `<div class="text-center text-[var(--text-sub)] py-10">첫 번째 게시글을 올려보세요!</div>`;
                const posts = Object.entries(data).map(([k, v]) => ({id: k, ...v})).reverse();
                posts.forEach(post => {
                    const isLiked = post.likes && post.likes[window.fb.auth.currentUser?.uid];
                    const likeCount = post.likes ? Object.keys(post.likes).length : 0;
                    const commentCount = post.comments ? Object.keys(post.comments).length : 0;
                    const timeAgo = new Date(post.timestamp).toLocaleDateString();
                    const html = `
                        <div class="bg-[var(--bg-card)] border border-[var(--border-color)] rounded-xl overflow-hidden transition-colors">
                            <div class="p-3 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-[var(--bg-sub)] rounded-full overflow-hidden">
                                        <img src="${post.authorAvatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed='+post.authorName}" class="w-full h-full object-cover">
                                    </div>
                                    <div>
                                        <span class="font-bold text-sm block text-[var(--text-main)]">${post.authorName}</span>
                                        <span class="text-[10px] text-[var(--text-sub)]">${timeAgo}</span>
                                    </div>
                                </div>
                                ${post.uid !== window.fb.auth.currentUser?.uid ? 
                                    `<button onclick="startChat('${post.uid}', '${post.authorName}')" class="text-[var(--text-sub)] hover:text-[var(--text-main)]"><i data-lucide="send" class="w-5 h-5 transform -rotate-45"></i></button>` 
                                    : ''}
                            </div>
                            <div class="relative">
                                <img src="${post.image}" class="w-full h-64 object-cover bg-[var(--bg-sub)]">
                                ${ (post.stats && (post.stats.dist || post.stats.time)) ? `
                                <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-[var(--bg-main)]/90 to-transparent p-4 pt-10 flex justify-around text-center">
                                    <div><div class="text-[var(--volt)] font-black text-lg italic">${post.stats.dist || '0'} <span class="text-xs font-normal text-white">km</span></div></div>
                                    <div><div class="text-white font-bold text-lg">${post.stats.time || '00:00'}</div></div>
                                    <div><div class="text-orange-500 font-bold text-lg">${post.stats.cal || '0'} <span class="text-xs font-normal text-white">kcal</span></div></div>
                                </div>` : '' }
                            </div>
                            <div class="p-3">
                                <div class="flex gap-4 mb-2">
                                    <button onclick="toggleLike('${post.id}')" class="flex items-center gap-1 text-sm ${isLiked ? 'like-active font-bold' : 'text-[var(--text-sub)] hover:text-[var(--text-main)]'}">
                                        <i data-lucide="heart" class="w-6 h-6 ${isLiked ? 'fill-current' : ''}"></i>
                                        <span>${likeCount > 0 ? likeCount : ''}</span>
                                    </button>
                                    <button onclick="openReplySheet('${post.id}')" class="flex items-center gap-1 text-sm text-[var(--text-sub)] hover:text-[var(--text-main)]">
                                        <i data-lucide="message-circle" class="w-6 h-6"></i>
                                        <span>${commentCount > 0 ? commentCount : ''}</span>
                                    </button>
                                </div>
                                <p class="text-sm text-[var(--text-main)]">${post.content}</p>
                            </div>
                        </div>
                    `;
                    feedContainer.insertAdjacentHTML('beforeend', html);
                });
                lucide.createIcons();
            });
        }

        function toggleLike(postId) {
            const uid = window.fb.auth.currentUser.uid;
            const ref = window.fb.ref(window.fb.db, `posts/${postId}/likes/${uid}`);
            window.fb.get(ref).then(snap => {
                if(snap.exists()) window.fb.remove(ref);
                else window.fb.set(ref, true);
            });
        }

        const sheet = document.querySelector('.bottom-sheet');
        const handle = document.querySelector('.sheet-handle-area');
        let startY = 0;
        let isDragging = false;
        let currentTranslateY = 0;

        function startDrag(e) {
            isDragging = true;
            startY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
            sheet.classList.add('dragging'); 
        }

        function moveDrag(e) {
            if (!isDragging) return;
            const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
            const deltaY = clientY - startY;
            if(deltaY > 0) {
                currentTranslateY = deltaY;
                sheet.style.transform = `translateY(${deltaY}px)`;
            }
        }

        function endDrag(e) {
            if (!isDragging) return;
            isDragging = false;
            sheet.classList.remove('dragging'); 
            if(currentTranslateY > 100) closeReplySheet();
            else sheet.style.transform = 'translateY(0)';
            currentTranslateY = 0;
        }

        handle.addEventListener('mousedown', startDrag);
        handle.addEventListener('touchstart', startDrag, {passive: true});
        window.addEventListener('mousemove', moveDrag);
        window.addEventListener('touchmove', moveDrag, {passive: true});
        window.addEventListener('mouseup', endDrag);
        window.addEventListener('touchend', endDrag);

        function openReplySheet(postId) {
            currentPostIdForReply = postId;
            document.getElementById('sheet-reply').classList.add('open');
            sheet.style.transform = ''; 
            const myAvatar = document.getElementById('profile-img-display').src;
            document.getElementById('reply-my-avatar').src = myAvatar;
            loadReplies(postId);
        }

        function closeReplySheet() {
            document.getElementById('sheet-reply').classList.remove('open');
            currentPostIdForReply = null;
        }

        function loadReplies(postId) {
            const list = document.getElementById('reply-list');
            const ref = window.fb.ref(window.fb.db, `posts/${postId}/comments`);
            window.fb.onValue(ref, (snap) => {
                list.innerHTML = "";
                const data = snap.val();
                if(!data) {
                    list.innerHTML = "<div class='text-center text-[var(--text-sub)] py-10 text-sm'>아직 댓글이 없습니다.<br>첫 번째 댓글을 남겨보세요.</div>";
                    return;
                }
                Object.values(data).forEach(c => {
                    const time = new Date(c.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    const el = document.createElement('div');
                    el.className = "flex gap-3";
                    el.innerHTML = `
                        <div class="w-8 h-8 rounded-full bg-[var(--bg-sub)] overflow-hidden flex-shrink-0">
                             <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${c.author}" class="w-full h-full object-cover">
                        </div>
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-sm text-[var(--text-main)]">${c.author}</span>
                                <span class="text-[10px] text-[var(--text-sub)]">${time}</span>
                            </div>
                            <p class="text-sm text-[var(--text-main)] mt-0.5">${c.text}</p>
                        </div>
                    `;
                    list.appendChild(el);
                });
                list.scrollTop = list.scrollHeight;
            });
        }

        async function submitReply() {
            if(!currentPostIdForReply) return;
            const text = document.getElementById('reply-input').value;
            if(!text) return;
            const user = window.fb.auth.currentUser;
            const userInfo = await getUserInfo(user.uid);
            await window.fb.push(window.fb.ref(window.fb.db, `posts/${currentPostIdForReply}/comments`), {
                author: userInfo.nickname, uid: user.uid, text, timestamp: Date.now()
            });
            document.getElementById('reply-input').value = "";
        }

        // --- Social & Chat Logic ---
        
        async function enterPublicChat(chatId, title, iconName) {
            openSocialScreen();
            setTimeout(() => { 
                const container = document.getElementById('chat-header-icon-container');
                container.innerHTML = `<i data-lucide="${iconName}" class="w-5 h-5 text-[var(--text-main)]"></i>`;
                lucide.createIcons();
                openChatRoom(chatId, title, null);
            }, 300);
        }

        async function startChat(targetUid, targetName) {
            const myUid = window.fb.auth.currentUser.uid;
            const chatRoomId = myUid < targetUid ? `${myUid}_${targetUid}` : `${targetUid}_${myUid}`;
            const roomRef = window.fb.ref(window.fb.db, `groups/${chatRoomId}`);
            
            const snap = await window.fb.get(roomRef);
            if(!snap.exists()) {
                await window.fb.set(roomRef, {
                    name: targetName,
                    members: { [myUid]: true, [targetUid]: true },
                    type: 'dm',
                    lastMsg: "대화가 시작되었습니다.",
                    timestamp: Date.now(),
                    targetAvatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${targetName}`
                });
            }
            closeFriendSelector();
            openSocialScreen();
            setTimeout(() => { openChatRoom(chatRoomId, targetName); }, 300);
        }

        function openSocialScreen() {
            document.getElementById('social-screen').style.transform = "translateX(0)";
            loadChatRooms();
        }
        function closeSocialScreen() {
            document.getElementById('social-screen').style.transform = "translateX(100%)";
        }

        function createNewGroup() {
            const name = prompt("새 그룹 이름:");
            if(!name) return;
            const newRef = window.fb.push(window.fb.ref(window.fb.db, 'groups'));
            window.fb.set(newRef, {
                name, host: window.fb.auth.currentUser.uid, createdAt: Date.now(), type: 'group',
                lastMsg: "그룹이 생성되었습니다.", timestamp: Date.now(),
                targetAvatar: '',
                members: { [window.fb.auth.currentUser.uid]: true }
            });
            closeFriendSelector();
        }
        
        async function deleteChatRoom(id) {
            if(!confirm("이 채팅방을 영구 삭제하시겠습니까?\n모든 대화 내용이 사라집니다.")) return;
            try {
                await window.fb.remove(window.fb.ref(window.fb.db, 'groups/' + id));
                await window.fb.remove(window.fb.ref(window.fb.db, 'messages/' + id));
            } catch(e) {
                alert("삭제 실패: " + e.message);
            }
        }
        
        async function inviteUserToChat(targetUid = null) {
            if(!currentChatId) return;
            if(currentChatId.startsWith('public_')) return alert("오픈 커뮤니티는 누구나 자유롭게 참여할 수 있습니다.");

            if(targetUid) {
                await window.fb.update(window.fb.ref(window.fb.db, `groups/${currentChatId}/members`), {
                    [targetUid]: true
                });
                alert("초대되었습니다.");
                closeFriendSelector();
            }
        }

        function filterChatRooms(query) {
            const list = document.getElementById('chat-list');
            const items = list.getElementsByClassName('chat-item');
            query = query.toLowerCase();
            
            Array.from(items).forEach(item => {
                const name = item.dataset.name.toLowerCase();
                if(name.includes(query)) {
                    item.style.display = "flex";
                } else {
                    item.style.display = "none";
                }
            });
        }

        function loadChatRooms() {
            const listEl = document.getElementById('chat-list');
            const myUid = window.fb.auth.currentUser?.uid;
            if(!myUid) return;

            window.fb.onValue(window.fb.query(window.fb.ref(window.fb.db, 'groups'), window.fb.orderByChild('timestamp')), (snap) => {
                listEl.innerHTML = "";
                const groups = snap.val();
                if(!groups) return listEl.innerHTML = "<div class='text-center text-[var(--text-sub)] py-10'>참여 중인 채팅방이 없습니다.</div>";

                const sortedGroups = Object.entries(groups).sort((a,b) => b[1].timestamp - a[1].timestamp);

                sortedGroups.forEach(([id, g]) => {
                    if(g.members && !g.members[myUid]) return;
                    
                    const isDM = g.type === 'dm';
                    let displayName = g.name;
                    let avatar = g.targetAvatar;
                    
                    if(!isDM) {
                         avatar = `https://api.dicebear.com/7.x/initials/svg?seed=${g.name}`;
                    } else {
                         if(!avatar) avatar = `https://api.dicebear.com/7.x/avataaars/svg?seed=${displayName}`;
                    }
                    
                    const timeStr = new Date(g.timestamp || 0).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

                    const div = document.createElement('div');
                    div.className = "chat-item group flex items-center gap-4 p-4 hover:bg-[var(--bg-sub)] cursor-pointer transition-colors border-b border-[var(--border-color)] relative overflow-hidden";
                    div.dataset.name = displayName;
                    
                    div.onclick = (e) => {
                        if(e.target.closest('.delete-btn')) return;
                        openChatRoom(id, displayName, avatar);
                    };
                    
                    div.innerHTML = `
                        <div class="w-14 h-14 rounded-full bg-[var(--bg-sub)] flex-shrink-0 overflow-hidden relative">
                            <img src="${avatar}" class="w-full h-full object-cover">
                            ${!isDM ? '<div class="absolute bottom-0 right-0 w-4 h-4 bg-[var(--volt)] rounded-full border-2 border-black"></div>' : ''}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-[var(--text-main)] text-sm truncate">${displayName}</h4>
                            <div class="flex items-center gap-1 text-xs text-[var(--text-sub)] mt-1">
                                <span class="truncate max-w-[150px]">${g.lastMsg || '대화 내용 없음'}</span>
                                <span>· ${timeStr}</span>
                            </div>
                        </div>
                        <button class="delete-btn p-2 text-[var(--text-sub)] hover:text-red-500 transition-colors z-10" onclick="deleteChatRoom('${id}')">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    `;
                    listEl.appendChild(div);
                });
                lucide.createIcons();
            });
        }

        let currentChatId = null;
        function openChatRoom(id, title, avatar = '') {
            currentChatId = id;
            document.getElementById('chat-room-title').innerText = title;
            
            const container = document.getElementById('chat-header-icon-container');
            if(avatar === null) {
                // Keep existing icon
            } else {
                container.innerHTML = `<img id="chat-room-avatar" class="w-full h-full object-cover" src="${avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${title}`}">`;
            }
            
            document.getElementById('chat-room').style.transform = "translateX(0)";
            
            const msgsRef = window.fb.ref(window.fb.db, `messages/${id}`);
            window.fb.onValue(msgsRef, (snap) => {
                const container = document.getElementById('chat-messages');
                container.innerHTML = "";
                const data = snap.val();
                if(!data) return;

                Object.values(data).forEach(m => {
                    const isMe = m.uid === window.fb.auth.currentUser.uid;
                    const el = document.createElement('div');
                    el.className = `msg-bubble ${isMe ? 'msg-me' : 'msg-other'}`;
                    el.innerText = m.text;
                    container.appendChild(el);
                });
                container.scrollTop = container.scrollHeight;
            });
        }

        function closeChatRoom() {
            document.getElementById('chat-room').style.transform = "translateX(100%)";
            currentChatId = null;
        }

        function sendMessage() {
            if(!currentChatId) return;
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text) return;
            const now = Date.now();
            window.fb.push(window.fb.ref(window.fb.db, `messages/${currentChatId}`), {
                uid: window.fb.auth.currentUser.uid, text, timestamp: now
            });
            
            if(!currentChatId.startsWith('public_')) {
                window.fb.update(window.fb.ref(window.fb.db, `groups/${currentChatId}`), {
                    lastMsg: text, timestamp: now
                });
            }
            input.value = "";
        }

        // --- Friend System Logic ---

        function searchUserForFriend() {
            const input = document.getElementById('add-friend-input').value;
            if(!input) return;
            
            const resultDiv = document.getElementById('add-friend-result');
            resultDiv.innerHTML = "검색 중...";
            resultDiv.classList.remove('hidden');

            window.fb.get(window.fb.ref(window.fb.db, 'users')).then((snap) => {
                const users = snap.val();
                let found = null;
                if(users) {
                    for(const [uid, u] of Object.entries(users)) {
                        if(u.nickname === input) {
                            found = { uid, ...u };
                            break;
                        }
                    }
                }

                if(found) {
                    resultDiv.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <img src="${found.avatar}" class="w-10 h-10 rounded-full bg-[var(--bg-sub)]">
                                <span class="font-bold text-[var(--text-main)] text-sm">${found.nickname}</span>
                            </div>
                            <button onclick="addToFriends('${found.uid}', '${found.nickname}')" class="bg-[var(--bg-sub)] border border-[var(--border-color)] text-xs px-3 py-1 rounded-full hover:bg-[var(--volt)] hover:text-black hover:border-transparent transition-colors text-[var(--text-main)]">추가</button>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = "<span class='text-[var(--text-sub)] text-xs'>사용자를 찾을 수 없습니다.</span>";
                }
            });
        }

        async function addToFriends(targetUid, nickname) {
            const myUid = window.fb.auth.currentUser.uid;
            if(targetUid === myUid) return alert("자신은 추가할 수 없습니다.");
            
            await window.fb.update(window.fb.ref(window.fb.db, `users/${myUid}/friends`), {
                [targetUid]: true
            });
            alert(`${nickname}님이 친구로 추가되었습니다.`);
            closeModal('add-friend');
            document.getElementById('add-friend-result').classList.add('hidden');
            document.getElementById('add-friend-input').value = "";
        }

        function openFriendSelector(mode) {
            friendSelectorMode = mode;
            document.getElementById('sheet-friends').classList.add('open');
            document.getElementById('friend-sheet-title').innerText = mode === 'invite' ? '대화 상대 초대' : '새로운 메시지';
            
            const groupBtn = document.getElementById('create-group-btn-area');
            if(mode === 'invite') groupBtn.style.display = 'none';
            else groupBtn.style.display = 'block';

            loadFriendsList();
        }

        function closeFriendSelector() {
            document.getElementById('sheet-friends').classList.remove('open');
        }

        function loadFriendsList() {
            const container = document.getElementById('friend-list-container');
            const myUid = window.fb.auth.currentUser.uid;
            
            container.innerHTML = "<div class='text-center py-10 text-[var(--text-sub)] text-xs'>로딩 중...</div>";

            window.fb.get(window.fb.ref(window.fb.db, `users/${myUid}/friends`)).then(async (snap) => {
                const friends = snap.val();
                container.innerHTML = "";
                
                if(!friends) {
                    container.innerHTML = "<div class='text-center py-10 text-[var(--text-sub)] text-xs'>친구가 없습니다.<br>친구를 추가해보세요!</div>";
                    return;
                }

                for(const friendUid of Object.keys(friends)) {
                    const userSnap = await window.fb.get(window.fb.ref(window.fb.db, `users/${friendUid}`));
                    const user = userSnap.val();
                    if(user) {
                        const div = document.createElement('div');
                        div.className = "flex items-center justify-between p-4 border-b border-[var(--border-color)] hover:bg-[var(--bg-sub)] cursor-pointer transition-colors";
                        div.onclick = () => {
                            if(friendSelectorMode === 'start-chat') {
                                startChat(friendUid, user.nickname);
                            } else {
                                inviteUserToChat(friendUid);
                            }
                        };
                        
                        div.innerHTML = `
                            <div class="flex items-center gap-3">
                                <img src="${user.avatar}" class="w-12 h-12 rounded-full bg-[var(--bg-sub)] object-cover">
                                <div>
                                    <h4 class="font-bold text-[var(--text-main)] text-sm">${user.nickname}</h4>
                                    <span class="text-xs text-[var(--text-sub)]">${user.realName || ''}</span>
                                </div>
                            </div>
                            <div class="w-6 h-6 rounded-full border border-[var(--border-color)]"></div>
                        `;
                        container.appendChild(div);
                    }
                }
            });
        }

        function loadUserProfile(uid) {
            window.fb.onValue(window.fb.ref(window.fb.db, 'users/' + uid), (snap) => {
                const data = snap.val();
                if(!data) return;
                document.getElementById('profile-name-display').innerText = data.nickname || "User";
                document.getElementById('profile-email-display').innerText = data.email || "";
                document.getElementById('profile-realname-display').innerText = data.realName || "-";
                document.getElementById('profile-dob-display').innerText = data.dob || "-";
                document.getElementById('profile-phone-display').innerText = data.phone || "-";
                document.getElementById('profile-img-display').src = data.avatar || "";
                document.getElementById('edit-nickname').value = data.nickname || "";
                document.getElementById('edit-realname').value = data.realName || "";
                document.getElementById('edit-dob').value = data.dob || "";
                document.getElementById('edit-phone').value = data.phone || "";
            });
        }
        async function updateUserProfile() {
            const uid = window.fb.auth.currentUser.uid;
            const updates = {
                nickname: document.getElementById('edit-nickname').value,
                realName: document.getElementById('edit-realname').value,
                dob: document.getElementById('edit-dob').value,
                phone: document.getElementById('edit-phone').value
            };
            try {
                await window.fb.update(window.fb.ref(window.fb.db, 'users/' + uid), updates);
                closeModal('edit-profile');
                alert("프로필이 수정되었습니다.");
            } catch(e) {
                alert("수정 실패: " + e.message);
            }
        }
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const pw = document.getElementById('login-pw').value;
            try { await window.fb.signInWithEmailAndPassword(window.fb.auth, email, pw); } 
            catch(e) { alert("로그인 실패: " + e.message); }
        }
    </script>
</body>
</html>