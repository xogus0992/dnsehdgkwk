<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>POKÃ‰ RUN: BATTLE RECORDS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:ital,wght@0,400;0,700;1,900&family=Inter:wght@400;0,700;0,900&family=Noto+Sans+KR:wght@400;0,700;0,900&display=swap" rel="stylesheet">
    <style>
        /* --- 1. ê¸°ë³¸ í…Œë§ˆ (ë‹¤í¬ ëª¨ë“œ, BLACK) ë³€ìˆ˜ --- */
        :root { 
            --volt: #2563eb; 
            --bg-main: #ffffff;
            --bg-card: #f3f4f6;
            --bg-sub: #e5e7eb;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border-color: #d1d5db;
        }

        /* 3. í°íŠ¸ ë° ê³µí†µ ìŠ¤íƒ€ì¼ */
        .font-sport { font-family: 'Chakra Petch', sans-serif; }
        body { 
            background-color: var(--bg-main); 
            color: var(--text-main); 
            font-family: 'Noto Sans KR', sans-serif; 
            transition: background-color 0.3s, color 0.3s;
        }
        .pokemon-img-list img {
            width: 32px;
            height: 32px;
            object-fit: contain;
            border-radius: 50%;
            border: 1px solid var(--border-color);
            background-color: white;
            margin-right: -8px; /* ì´ë¯¸ì§€ ê²¹ì¹¨ íš¨ê³¼ */
            position: relative;
            z-index: 0;
        }
        .pokemon-img-list img:hover {
            z-index: 10;
            transform: scale(1.1);
        }
        
        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-[var(--bg-main)] min-h-screen scrollbar-hide"> 
    
    <main class="max-w-xl mx-auto container pb-10">
        <div id="profile-content" class="p-4 opacity-0 transition-opacity duration-500">
            
            <div id="rank-info" class="pt-2 pb-4 mb-4 border-b border-[var(--border-color)]">
                <div class="flex justify-between items-center bg-[var(--bg-card)] p-4 rounded-xl shadow border border-[var(--border-color)]">
                    <div class="text-center flex-1">
                        <i data-lucide="award" class="w-8 h-8 text-yellow-500 mx-auto mb-1"></i>
                        <span id="player-rank" class="font-bold text-3xl font-sport text-[var(--text-main)] block">--</span>
                        <span class="text-xs text-[var(--text-sub)] block mt-1">RANK (ìˆœìœ„)</span>
                    </div>
                    <div class="w-px h-12 bg-[var(--border-color)]"></div>
                    <div class="text-center flex-1">
                        <i data-lucide="star" class="w-8 h-8 text-[var(--volt)] mx-auto mb-1"></i>
                        <span id="player-score" class="font-bold text-3xl font-sport text-[var(--volt)] block">0</span>
                        <span class="text-xs text-[var(--text-sub)] block mt-1">SCORE (ì ìˆ˜)</span>
                    </div>
                </div>
            </div>
            
            <div id="battle-records" class="pt-2"> 
                <h4 class="text-lg font-bold font-sport text-[var(--text-main)] mb-4 pb-2 border-b border-[var(--border-color)] flex items-center gap-2">
                    <i data-lucide="bar-chart-2" class="w-5 h-5 text-[var(--volt)]"></i> ëˆ„ì  ëŒ€ì „ ê¸°ë¡
                </h4> 
                
                <div class="grid grid-cols-2 gap-3 text-center">
                    <button id="btn-win" onclick="toggleBattleHistory('win')" class="bg-[var(--bg-card)] p-4 rounded-xl shadow transition-all hover:border-[var(--volt)] border border-transparent active:scale-[0.98]">
                        <span id="win-count-total" class="font-bold text-4xl font-sport text-green-500">0</span>
                        <span class="text-xs text-[var(--text-sub)] block mt-1 font-bold">VICTORY (ìŠ¹)</span>
                    </button>
                    <button id="btn-lose" onclick="toggleBattleHistory('lose')" class="bg-[var(--bg-card)] p-4 rounded-xl shadow transition-all hover:border-red-500 border border-transparent active:scale-[0.98]">
                        <span id="lose-count-total" class="font-bold text-4xl font-sport text-red-500">0</span>
                        <span class="text-xs text-[var(--text-sub)] block mt-1 font-bold">DEFEAT (íŒ¨)</span>
                    </button>
                </div>
            </div>
            
            <div id="battle-history" class="mt-6 hidden transition-all duration-300">
                <h5 id="history-title" class="text-md font-bold text-[var(--text-main)] mb-3 flex items-center gap-2">
                    <i data-lucide="list" class="w-4 h-4"></i> ìƒì„¸ ê¸°ë¡
                </h5>
                <ul id="history-list" class="space-y-3 pb-10">
                    </ul>
            </div>
        </div>
    </main>
    
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    
    <script>
        // ----------------------------------------------------
        // ğŸš¨ Firebase ì„¤ì • (ì‚¬ìš©ì ì œê³µ ì„¤ì • ìœ ì§€)
        // ----------------------------------------------------
        const firebaseConfig = {
             apiKey: "AIzaSyAbHwLLXIH8rBQ8gNMVqE5SE208aIbfFZ0",
             authDomain: "pokbattle.firebaseapp.com",
             databaseURL: "https://pokbattle-default-rtdb.firebaseio.com",
             projectId: "pokbattle",
             storageBucket: "pokbattle.firebasestorage.app",
             messagingSenderId: "445300582484",
             appId: "1:445300582484:web:f8f1373a3bbf643face5c1"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let currentPokemonId = null; 
        let allBattleHistory = [];
        let currentFilter = null; 

        // ----------------------------------------------------
        // 1. ë”ë¯¸ ë°ì´í„° (ì„œë²„ ë°ì´í„° ì—†ì„ ì‹œ ì‚¬ìš©)
        // ----------------------------------------------------
        const dummyBattleHistory = [
            { id: 1, date: "2025-12-09 14:30", result: "ìŠ¹ë¦¬", 
              myNickname: "íŠ¸ë ˆì´ë„ˆ Seocup", myPokemon: ["í”¼ì¹´ì¸„", "ë¦¬ìëª½", "ê¼¬ë¶€ê¸°"], 
              opponentNickname: "ë¼ì´ë²Œ ì² ìˆ˜", opponentPokemon: ["ë¼ì´ì¸„", "ì´ìƒí•´ê½ƒ", "ë§ë‚˜ë‡½"], reason: "ìƒì„± ìš°ìœ„" },
            { id: 2, date: "2025-12-08 10:15", result: "íŒ¨ë°°", 
              myNickname: "íŠ¸ë ˆì´ë„ˆ Seocup", myPokemon: ["íŒŒì´ë¦¬", "ê¼¬ë ›", "ë²„í„°í”Œ"], 
              opponentNickname: "íŠ¸ë ˆì´ë„ˆ ìœ ë¦¬", opponentPokemon: ["ê¼¬ë¶€ê¸°", "ë®¤ì¸ ", "ì ë§Œë³´"], reason: "í™”ë ¥ ë¶€ì¡±" }
        ];
        
        // ----------------------------------------------------
        // 2. í¬ì¼“ëª¬ ì´ë¯¸ì§€ URL ë§¤í•‘
        // ----------------------------------------------------
        const POKEMON_URL_MAP = {
            "í”¼ì¹´ì¸„": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/25.png",
            "ë¦¬ìëª½": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/6.png",
            "ê¼¬ë¶€ê¸°": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/7.png",
            "ë¼ì´ì¸„": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/26.png",
            "ì´ìƒí•´ê½ƒ": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/3.png",
            "ë§ë‚˜ë‡½": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/149.png",
            "íŒŒì´ë¦¬": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/4.png",
            "ê¼¬ë ›": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/19.png",
            "ë²„í„°í”Œ": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/12.png",
            "ë®¤ì¸ ": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/150.png",
            "ì ë§Œë³´": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/143.png",
            "íŒ¬í…€": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/94.png",
            "DEFAULT": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/0.png"
        };
        
        function getPokemonImageHTML(pokemonArray) {
            if (!pokemonArray || !Array.isArray(pokemonArray) || pokemonArray.length === 0) {
                return '<span class="text-[var(--text-sub)] text-xs">ì •ë³´ ì—†ìŒ</span>';
            }
            
            const images = pokemonArray.map(name => {
                const url = POKEMON_URL_MAP[name] || POKEMON_URL_MAP["DEFAULT"];
                return `<img src="${url}" alt="${name}" title="${name}" class="bg-white rounded-full border border-gray-200">`;
            }).join('');
            
            return `<div class="pokemon-img-list flex items-center pl-2">${images}</div>`;
        }

        // ----------------------------------------------------
        // 3. UI ì—…ë°ì´íŠ¸
        // ----------------------------------------------------
        function updateUI(data) {
            const battle = data.battle || { wins: 0, loses: 0 };
            
            document.getElementById('player-rank').innerText = data.rank ? data.rank : '--';
            document.getElementById('player-score').innerText = data.score ? data.score.toLocaleString() : 0;

            document.getElementById('win-count-total').innerText = battle.wins;
            document.getElementById('lose-count-total').innerText = battle.loses;
            
            // í˜ì´ì§€ í˜ì´ë“œ ì¸
            document.getElementById('profile-content').classList.remove('opacity-0');
            document.getElementById('profile-content').classList.add('opacity-100');
        }

        // ----------------------------------------------------
        // 4. ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        // ----------------------------------------------------
        function renderBattleHistory(historyData, filter) {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            
            // í•„í„°ë§
            const filteredData = historyData.filter(record => {
                if (filter === 'win') return record.result === "ìŠ¹ë¦¬";
                if (filter === 'lose') return record.result === "íŒ¨ë°°";
                return true;
            });
            
            if (filteredData.length === 0) {
                 historyList.innerHTML = `<li class="p-6 bg-[var(--bg-card)] rounded-lg text-sm text-[var(--text-sub)] text-center border border-dashed border-[var(--border-color)]">
                    ê¸°ë¡ëœ ${filter === 'win' ? 'ìŠ¹ë¦¬' : 'íŒ¨ë°°'} ì „íˆ¬ê°€ ì—†ìŠµë‹ˆë‹¤.
                 </li>`;
                 return;
            }

            filteredData.forEach(record => {
                const isWin = record.result === "ìŠ¹ë¦¬";
                const resultColor = isWin ? 'text-green-500' : 'text-red-500';
                const resultBg = isWin ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
                const icon = isWin ? 'trophy' : 'x-circle';
                
                // ë‚´ í¬ì¼“ëª¬, ìƒëŒ€ í¬ì¼“ëª¬ ì´ë¯¸ì§€
                const myPokemonHTML = getPokemonImageHTML(record.myPokemon);
                const opponentPokemonHTML = getPokemonImageHTML(record.opponentPokemon);

                const item = document.createElement('li');
                item.className = `p-4 bg-[var(--bg-card)] rounded-xl border border-[var(--border-color)] flex flex-col gap-3 shadow-sm hover:shadow-md transition-shadow`;
                
                item.innerHTML = `
                    <div class="flex justify-between items-start border-b border-[var(--border-color)] pb-2">
                        <div>
                            <span class="font-bold ${resultColor} text-lg flex items-center gap-1">
                                <i data-lucide="${icon}" class="w-5 h-5"></i> ${record.result}
                            </span>
                            <p class="text-xs text-[var(--text-sub)] mt-1 font-mono">${record.date}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-xs font-bold text-[var(--text-sub)] px-2 py-1 rounded bg-[var(--bg-sub)]">
                                ${record.reason || 'ì‚¬ìœ  ì—†ìŒ'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between pt-1">
                        <div class="flex-1">
                            <p class="text-xs font-bold text-[var(--text-main)] mb-1 pl-1">ME</p>
                            ${myPokemonHTML}
                        </div>
                        
                        <div class="px-2 text-[var(--text-sub)] font-bold italic">VS</div>
                        
                        <div class="flex-1 text-right">
                             <p class="text-xs font-bold text-[var(--text-main)] mb-1 pr-1">OPPONENT</p>
                            <div class="flex justify-end">
                                ${opponentPokemonHTML}
                            </div>
                        </div>
                    </div>
                `;
                historyList.appendChild(item);
            });
            lucide.createIcons();
        }

        // ----------------------------------------------------
        // 5. ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬ (í† ê¸€ ê¸°ëŠ¥)
        // ----------------------------------------------------
        window.toggleBattleHistory = function(filterType) {
            const historyDiv = document.getElementById('battle-history');
            const historyTitle = document.getElementById('history-title');
            const btnWin = document.getElementById('btn-win');
            const btnLose = document.getElementById('btn-lose');
            
            // ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
            btnWin.classList.remove('border-[var(--volt)]', 'ring-2', 'ring-blue-100');
            btnLose.classList.remove('border-red-500', 'ring-2', 'ring-red-100');
            
            if (currentFilter === filterType) {
                // ë‹«ê¸°
                historyDiv.classList.add('hidden');
                currentFilter = null;
            } else {
                // ì—´ê¸°
                currentFilter = filterType;
                
                // ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼
                if (filterType === 'win') {
                    btnWin.classList.add('border-[var(--volt)]', 'ring-2', 'ring-blue-100');
                } else {
                    btnLose.classList.add('border-red-500', 'ring-2', 'ring-red-100');
                }

                historyTitle.innerHTML = filterType === 'win' 
                    ? `<i data-lucide="trophy" class="w-4 h-4 text-green-500"></i> ìŠ¹ë¦¬ ê¸°ë¡ ëª¨ì•„ë³´ê¸°`
                    : `<i data-lucide="x-circle" class="w-4 h-4 text-red-500"></i> íŒ¨ë°° ê¸°ë¡ ëª¨ì•„ë³´ê¸°`;

                renderBattleHistory(allBattleHistory, currentFilter);
                historyDiv.classList.remove('hidden');
            }
            lucide.createIcons();
        }

        // ----------------------------------------------------
        // 6. ë°ì´í„° ë¡œë“œ (í•µì‹¬ Firebase ì—°ë™)
        // ----------------------------------------------------
        window.loadPokemonProfile = (pokemonId) => {
            // 1. ë”ë¯¸ í…ŒìŠ¤íŠ¸
            if (!pokemonId || pokemonId === 'dummy_test') {
                const dummyData = {
                    rank: 12,
                    score: 1250,
                    battle: { wins: 2, loses: 1 } // ê³„ì‚°ëœ ê°’ ì˜ˆì‹œ
                };
                updateUI(dummyData);
                currentPokemonId = 'dummy_test';
                allBattleHistory = dummyBattleHistory;
                return;
            }

            // 2. Firebase ì‹¤ì‹œê°„ ë°ì´í„°
            const userRef = db.ref('users/' + pokemonId);

            userRef.on('value', (snap) => {
                try {
                    const data = snap.val();

                    if (data) {
                        let historyList = [];
                        if (data.battleHistory) {
                            // FirebaseëŠ” ë°°ì—´ ëŒ€ì‹  ê°ì²´ í‚¤(push ID)ë¡œ ì €ì¥í•  ë•Œê°€ ë§ìœ¼ë¯€ë¡œ Object.values ì‚¬ìš©
                            historyList = Object.values(data.battleHistory);
                        }

                        // ìŠ¹íŒ¨ ê³„ì‚°
                        let wins = 0;
                        let losses = 0;
                        historyList.forEach(record => {
                            if (record.result === "ìŠ¹ë¦¬") wins++;
                            else if (record.result === "íŒ¨ë°°") losses++;
                        });

                        // UI ë°ì´í„° êµ¬ì„±
                        const uiData = {
                            rank: '--', // ë­í‚¹ì€ ì „ì²´ ìœ ì € ë¹„êµê°€ í•„ìš”í•˜ë¯€ë¡œ ì¼ë‹¨ -- ì²˜ë¦¬
                            score: (wins * 100) + (losses * 10), // ê°„ë‹¨ ì ìˆ˜ ê³„ì‚°ì‹
                            battle: { wins: wins, loses: losses }
                        };

                        updateUI(uiData);
                        
                        // ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
                        allBattleHistory = historyList.sort((a, b) => new Date(b.date) - new Date(a.date));

                    } else {
                        // ë°ì´í„° ì—†ìŒ (ì‹ ê·œ)
                        updateUI({ rank: '--', score: 0, battle: { wins: 0, loses: 0 } });
                        allBattleHistory = [];
                    }
                    currentPokemonId = pokemonId;

                } catch (error) {
                    console.error("Firebase Data Error:", error);
                    alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            });
        };

        // ì´ˆê¸°í™”
        window.onload = () => {
            // í…Œë§ˆ ë¡œë“œ
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'white' || savedTheme === 'light') {
                 document.documentElement.setAttribute('data-theme', 'white');
            }
            
            // ì•„ì´ì½˜ ìƒì„±
            lucide.createIcons();

            // ID íŒŒì‹± ë° ë¡œë“œ
            const urlParams = new URLSearchParams(window.location.search);
            let targetId = urlParams.get('id'); 

            if (!targetId) {
                const savedNickname = localStorage.getItem('pokerun_name');
                if (savedNickname && savedNickname !== "Trainer") {
                    targetId = savedNickname; 
                }
            }

            loadPokemonProfile(targetId || 'dummy_test');
        };
    </script>
</body>
</html>