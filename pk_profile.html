<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>POKÃ‰ RUN: BATTLE RECORDS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:ital,wght@0,400;0,700;1,900&family=Inter:wght@400;0,700;0,900&family=Noto+Sans+KR:wght@400;0,700;0,900&display=swap" rel="stylesheet">
    <style>
        /* --- 1. ê¸°ë³¸ í…Œë§ˆ (ë‹¤í¬ ëª¨ë“œ, BLACK) ë³€ìˆ˜ --- */
        :root { 
            --volt: #2563eb; /* ë¸”ë£¨ */
            --bg-main: #ffffff;
            --bg-card: #f3f4f6;
            --bg-sub: #e5e7eb;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border-color: #d1d5db; 
        }
        
        /* âšª 2. í™”ì´íŠ¸ ëª¨ë“œ ë””ìì¸ ë³€ìˆ˜ ì ìš© (WHITE) */
        .white-mode {
            --volt: #2563eb; /* ë¸”ë£¨ */
            --bg-main: #ffffff;
            --bg-card: #f3f4f6;
            --bg-sub: #e5e7eb;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border-color: #d1d5db;
        }

        /* 3. í°íŠ¸ ë° ê³µí†µ ìŠ¤íƒ€ì¼ */
        .font-sport { font-family: 'Chakra Petch', sans-serif; }
        body { 
            background-color: var(--bg-main); 
            color: var(--text-main); 
            font-family: 'Noto Sans KR', sans-serif; 
            transition: background-color 0.3s, color 0.3s;
        }
        .pokemon-img-list img {
            width: 32px; /* í¬ì¼“ëª¬ ì´ë¯¸ì§€ í¬ê¸° ì¡°ì ˆ */
            height: 32px;
            object-fit: contain;
            border-radius: 50%;
            border: 1px solid var(--border-color);
            background-color: white;
        }
    </style>
</head>
<body class="bg-[var(--bg-main)] min-h-screen"> 
    
    <main class="max-w-xl mx-auto container">
        <div id="profile-content" class="p-4 opacity-100 transition-opacity duration-500">
            
            <div id="rank-info" class="pt-2 pb-4 mb-4 border-b border-[var(--border-color)]">
                <div class="flex justify-between items-center bg-[var(--bg-card)] p-4 rounded-xl shadow">
                    <div class="text-center flex-1">
                        <i data-lucide="award" class="w-6 h-6 text-yellow-500 mx-auto"></i>
                        <span id="player-rank" class="font-bold text-3xl font-sport text-yellow-500 block mt-1">--</span>
                        <span class="text-xs text-[var(--text-sub)] block mt-1">ë­í‚¹ (ìˆœìœ„)</span>
                    </div>
                    <div class="w-px h-12 bg-[var(--border-color)]"></div>
                    <div class="text-center flex-1">
                        <i data-lucide="star" class="w-6 h-6 text-[var(--volt)] mx-auto"></i>
                        <span id="player-score" class="font-bold text-3xl font-sport text-[var(--volt)] block mt-1">0</span>
                        <span class="text-xs text-[var(--text-sub)] block mt-1">ì ìˆ˜ (SCORE)</span>
                    </div>
                </div>
            </div>
            
            <div id="battle-records" class="pt-2"> 
                <h4 class="text-lg font-bold font-sport text-[var(--volt)] mb-4 pb-2 border-b border-[var(--border-color)]">ëˆ„ì  ëŒ€ì „ ê¸°ë¡</h4> 
                
                <div class="grid grid-cols-2 gap-3 text-center">
                    <button id="btn-win" onclick="toggleBattleHistory('win')" class="bg-[var(--bg-sub)] p-4 rounded-xl shadow-lg transition-all hover:ring-2 hover:ring-[var(--volt)] active:ring-4 active:ring-[var(--volt)] active:scale-[0.98]">
                        <span id="win-count-total" class="font-bold text-4xl font-sport text-green-400">0</span>
                        <span class="text-xs text-[var(--text-sub)] block mt-1">WIN (ìŠ¹)</span>
                    </button>
                    <button id="btn-lose" onclick="toggleBattleHistory('lose')" class="bg-[var(--bg-sub)] p-4 rounded-xl shadow-lg transition-all hover:ring-2 hover:ring-[var(--volt)] active:ring-4 active:ring-[var(--volt)] active:scale-[0.98]">
                        <span id="lose-count-total" class="font-bold text-4xl font-sport text-red-400">0</span>
                        <span class="text-xs text-[var(--text-sub)] block mt-1">LOSE (íŒ¨)</span>
                    </button>
                </div>
            </div>
            
            <div id="battle-history" class="mt-6 hidden">
                <h5 id="history-title" class="text-md font-bold text-[var(--text-main)] mb-3">ì „íˆ¬ ìƒì„¸ ê¸°ë¡</h5>
                <ul id="history-list" class="space-y-2">
                    </ul>
            </div>
            </div>
    </main>
    
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    
    <script>
        // ğŸš¨ğŸš¨ğŸš¨ ì‚¬ìš©ìë‹˜ì˜ Firebase í”„ë¡œì íŠ¸ ì„¤ì • ğŸš¨ğŸš¨ğŸš¨
        const firebaseConfig = {
             apiKey: "AIzaSyAbHwLLXIH8rBQ8gNMVqE5SE208aIbfFZ0",
             authDomain: "pokbattle.firebaseapp.com",
             databaseURL: "https://pokbattle-default-rtdb.firebaseio.com",
             projectId: "pokbattle",
             storageBucket: "pokbattle.firebasestorage.app",
             messagingSenderId: "445300582484",
             appId: "1:445300582484:web:f8f1373a3bbf643face5c1"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        
        let currentPokemonId = null; 

        // ----------------------------------------------------
        // 1. ğŸ†• ë”ë¯¸ ë°ì´í„° ìˆ˜ì •: í¬ì¼“ëª¬ í•„ë“œë¥¼ 3ë§ˆë¦¬ ë°°ì—´ë¡œ ë³€ê²½
        // ----------------------------------------------------
        const dummyBattleHistory = [
            { id: 1, date: "2025-12-09 14:30", result: "ìŠ¹ë¦¬", 
              myNickname: "íŠ¸ë ˆì´ë„ˆ Seocup", myPokemon: ["í”¼ì¹´ì¸„", "ë¦¬ìëª½", "ê¼¬ë¶€ê¸°"], 
              opponentNickname: "ë¼ì´ë²Œ ì² ìˆ˜", opponentPokemon: ["ë¼ì´ì¸„", "ì´ìƒí•´ê½ƒ", "ë§ë‚˜ë‡½"], reason: "ê¸°ìˆ ë ¥ ìš°ìœ„" },
              
            { id: 2, date: "2025-12-08 10:15", result: "íŒ¨ë°°", 
              myNickname: "íŠ¸ë ˆì´ë„ˆ Seocup", myPokemon: ["íŒŒì´ë¦¬", "ê¼¬ë ›", "ë²„í„°í”Œ"], 
              opponentNickname: "íŠ¸ë ˆì´ë„ˆ ìœ ë¦¬", opponentPokemon: ["ê¼¬ë¶€ê¸°", "ë®¤ì¸ ", "ì ë§Œë³´"], reason: "ìƒì„± ë¶ˆë¦¬" },
              
            { id: 3, date: "2025-12-07 18:00", result: "ìŠ¹ë¦¬", 
              myNickname: "íŠ¸ë ˆì´ë„ˆ Seocup", myPokemon: ["í”¼ì¹´ì¸„", "í‘¸ë¦°", "ë˜ê°€ìŠ¤"], 
              opponentNickname: "ì²´ìœ¡ê´€ ê´€ì¥", opponentPokemon: ["ì´ìƒí•´ì”¨", "ë¼í”„ë¼ìŠ¤", "íŒ¬í…€"], reason: "ìŠ¤í”¼ë“œ ìš°ìœ„" },
              
            { id: 4, date: "2025-12-06 09:00", result: "íŒ¨ë°°", 
              myNickname: "íŠ¸ë ˆì´ë„ˆ Seocup", myPokemon: ["íŒŒì´ë¦¬", "êµ¬êµ¬", "ë¡±ìŠ¤í†¤"], 
              opponentNickname: "ë ˆë²¨ì—… ë§ˆìŠ¤í„°", opponentPokemon: ["ë§ë‚˜ë‡½", "í”„ë¦¬ì ¸", "ì¬ë”"], reason: "ë ˆë²¨ ì°¨ì´" },
              
            { id: 5, date: "2025-12-05 12:00", result: "ìŠ¹ë¦¬", 
              myNickname: "íŠ¸ë ˆì´ë„ˆ Seocup", myPokemon: ["ë¦¬ìëª½", "ë®¤", "ì „ë£¡"], 
              opponentNickname: "ì „ì„¤ì˜ íŠ¸ë ˆì´ë„ˆ", opponentPokemon: ["ë®¤ì¸ ", "ì¹ ìƒ‰ì¡°", "ë£¨ê¸°ì•„"], reason: "ê·¹ì ì¸ ìŠ¹ë¦¬" },
        ];
        
        // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
        let allBattleHistory = [];
        let currentFilter = null; // 'win', 'lose', or null
        
        // ----------------------------------------------------
        // 2. í¬ì¼“ëª¬ ì´ë¦„ê³¼ ì™¸ë¶€ ì´ë¯¸ì§€ URL ë§¤í•‘ (API ëŒ€ì²´)
        // ----------------------------------------------------
        const POKEMON_URL_MAP = {
            "í”¼ì¹´ì¸„": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/25.png",
            "ë¦¬ìëª½": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/6.png",
            "ê¼¬ë¶€ê¸°": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/7.png",
            "ë¼ì´ì¸„": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/26.png",
            "ì´ìƒí•´ê½ƒ": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/3.png",
            "ë§ë‚˜ë‡½": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/149.png",
            "íŒŒì´ë¦¬": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/4.png",
            "ê¼¬ë ›": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/19.png",
            "ë²„í„°í”Œ": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/12.png",
            "ë®¤ì¸ ": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/150.png",
            "ì ë§Œë³´": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/143.png",
            "í‘¸ë¦°": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/39.png",
            "ë˜ê°€ìŠ¤": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/109.png",
            "ì´ìƒí•´ì”¨": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/1.png",
            "ë¼í”„ë¼ìŠ¤": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/131.png",
            "íŒ¬í…€": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/94.png",
            "êµ¬êµ¬": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/16.png",
            "ë¡±ìŠ¤í†¤": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/95.png",
            "í”„ë¦¬ì ¸": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/144.png",
            "ì¬ë”": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/145.png",
            "ë®¤": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/151.png",
            "ì „ë£¡": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/181.png",
            "ì¹ ìƒ‰ì¡°": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/250.png",
            "ë£¨ê¸°ì•„": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/249.png",
            // ë§¤í•‘ë˜ëŠ” í¬ì¼“ëª¬ì´ ì—†ì„ ê²½ìš° í‘œì‹œí•  ê¸°ë³¸ ì´ë¯¸ì§€
            "DEFAULT": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/0.png"
        };
        
        function getPokemonImageHTML(pokemonArray) {
            
            if (!pokemonArray || pokemonArray.length === 0) {
                return '<span class="text-[var(--text-sub)] text-xs">ì¡°í•© ì •ë³´ ì—†ìŒ</span>';
            }
            
            const images = pokemonArray.map(name => {
                const url = POKEMON_URL_MAP[name] || POKEMON_URL_MAP["DEFAULT"];
                return `<img src="${url}" alt="${name}" title="${name}" class="inline-block mr-1">`;
            }).join('');
            
            return `<div class="pokemon-img-list flex items-center">${images}</div>`;
        }


        // ----------------------------------------------------
        // 3. ğŸ†• UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ìˆ˜ì • (ë­í‚¹, ì ìˆ˜ ë°˜ì˜)
        // ----------------------------------------------------
        function updateUI(data) {
            const battle = data.battle || {};
            
            // ë­í‚¹ ë° ì ìˆ˜ ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('player-rank').innerText = data.rank !== undefined ? data.rank + 'ìœ„' : '--'; // ìˆœìœ„
            document.getElementById('player-score').innerText = data.score !== undefined ? data.score.toLocaleString() : 0; // ì ìˆ˜ (ì½¤ë§ˆ í‘œì‹œ)

            // ì „ì  íƒ­ ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('win-count-total').innerText = battle.wins || 0;
            document.getElementById('lose-count-total').innerText = battle.loses || 0;
        }

        // ----------------------------------------------------
        // 4. ë°°í‹€ ê¸°ë¡ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ í•¨ìˆ˜ (ì´ë¯¸ì§€ ì‚½ì…)
        // ----------------------------------------------------
        function renderBattleHistory(historyData, filter) {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            
            const filteredData = historyData.filter(record => {
                if (filter === 'win') return record.result === "ìŠ¹ë¦¬";
                if (filter === 'lose') return record.result === "íŒ¨ë°°";
                return true;
            });
            
            if (filteredData.length === 0) {
                 historyList.innerHTML = `<li class="p-3 bg-[var(--bg-sub)] rounded-lg text-sm text-[var(--text-sub)] text-center">ê¸°ë¡ëœ ${filter === 'win' ? 'ìŠ¹ë¦¬' : 'íŒ¨ë°°'} ì „íˆ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</li>`;
                 return;
            }

            filteredData.forEach(record => {
                const isWin = record.result === "ìŠ¹ë¦¬";
                const resultClass = isWin ? 'text-green-400' : 'text-red-400';
                const icon = isWin ? 'trophy' : 'swords';
                
                const myName = record.myNickname || 'ë‚˜ (Unknown)';
                const opponentName = record.opponentNickname || 'ìƒëŒ€ (Unknown)';
                
                // í¬ì¼“ëª¬ ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸ HTML ìƒì„±
                const myPokemonHTML = getPokemonImageHTML(record.myPokemon);
                const opponentPokemonHTML = getPokemonImageHTML(record.opponentPokemon);

                const item = document.createElement('li');
                item.className = "p-3 bg-[var(--bg-sub)] rounded-lg border border-[var(--border-color)] flex flex-col space-y-2 transition-all hover:shadow-xl hover:ring-2 hover:ring-[var(--volt)] cursor-pointer";
                
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="font-bold ${resultClass} text-md">${record.result}</span>
                            <p class="text-[10px] text-[var(--text-sub)] mt-0.5">
                                ${record.date} | ì‚¬ìœ : ${record.reason || 'ìƒì„¸ ì •ë³´ ì—†ìŒ'}
                            </p>
                        </div>
                        <i data-lucide="${icon}" class="w-6 h-6 ${resultClass} flex-shrink-0 mt-1"></i>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 pt-2 border-t border-[var(--border-color)]">
                        <div>
                            <p class="text-xs font-semibold text-[var(--text-main)] mb-1">${myName} (ë‚˜)</p>
                            ${myPokemonHTML}
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-[var(--text-main)] mb-1">${opponentName} (ìƒëŒ€)</p>
                            ${opponentPokemonHTML}
                        </div>
                    </div>
                `;
                historyList.appendChild(item);
            });
            lucide.createIcons();
        }


        // ------------------------------------
        // 5. ìŠ¹/íŒ¨ ë²„íŠ¼ í´ë¦­ ì‹œ ê¸°ë¡ í† ê¸€ í•¨ìˆ˜ (í•„í„° ê´€ë¦¬)
        // ------------------------------------
        window.toggleBattleHistory = function(filterType) {
            const historyDiv = document.getElementById('battle-history');
            const historyTitle = document.getElementById('history-title');
            const btnWin = document.getElementById('btn-win');
            const btnLose = document.getElementById('btn-lose');
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” (ì„ íƒë˜ì§€ ì•Šì€ ë²„íŠ¼ì˜ ë¶ˆ ë„ê¸°)
            btnWin.classList.remove('ring-4', 'ring-[var(--volt)]');
            btnLose.classList.remove('ring-4', 'ring-[var(--volt)]');
            
            if (currentFilter === filterType) {
                // ì´ë¯¸ í•´ë‹¹ í•„í„°ê°€ í™œì„±í™”ëœ ê²½ìš° -> ë‹«ê¸° (í† ê¸€)
                historyDiv.classList.add('hidden');
                currentFilter = null;
            } else {
                // ìƒˆë¡œìš´ í•„í„° í™œì„±í™”
                currentFilter = filterType;
                
                // ì œëª© ì—…ë°ì´íŠ¸
                historyTitle.innerText = `${currentFilter === 'win' ? 'ìŠ¹ë¦¬' : 'íŒ¨ë°°'} ì „íˆ¬ ìƒì„¸ ê¸°ë¡`;
                
                // ë²„íŠ¼ì— í™œì„±í™” ìŠ¤íƒ€ì¼ ì ìš© (ë¶ˆ ì¼œê¸°)
                if (filterType === 'win') {
                    btnWin.classList.add('ring-4', 'ring-[var(--volt)]');
                } else {
                    btnLose.classList.add('ring-4', 'ring-[var(--volt)]');
                }

                // ê¸°ë¡ ë Œë”ë§ ë° í‘œì‹œ
                renderBattleHistory(allBattleHistory, currentFilter);
                historyDiv.classList.remove('hidden');
            }
        }


        // ===============================================
        // 6. í•µì‹¬ ê¸°ëŠ¥: í¬ì¼“ëª¬ í”„ë¡œí•„ ë°ì´í„° ë¡œë“œ
        // ===============================================
        window.loadPokemonProfile = async (pokemonId) => {
            const profileContent = document.getElementById('profile-content');
            
            profileContent.classList.add('opacity-100'); 

            if (!pokemonId || pokemonId === 'dummy_test') {
                // ğŸ†• ë­í‚¹, ì ìˆ˜ ë”ë¯¸ ë°ì´í„° ì¶”ê°€
                const dummyData = {
                    rank: 15, // ë­í‚¹
                    score: 2500, // ì ìˆ˜
                    battle: { wins: 30, loses: 10, draws: 0 }, 
                };
                updateUI(dummyData);
                currentPokemonId = 'dummy_test'; 
                allBattleHistory = dummyBattleHistory;

            } else {
                // â­ï¸ ì‹¤ì œ Firebase ë°ì´í„° ë¡œë“œ â­ï¸
                try {
                    const snap = await db.ref(`pokemon_profiles/${pokemonId}`).once('value');
                    
                    if (snap.exists()) {
                        const data = snap.val();
                        // â­ï¸ ì‹¤ì œ ë°ì´í„° êµ¬ì¡°ê°€ { rank: 15, score: 2500, battle: { ... }, ...} í˜•íƒœì—¬ì•¼ í•©ë‹ˆë‹¤.
                        updateUI(data);
                        allBattleHistory = data.battleHistory || []; 
                    } else {
                        updateUI({}); 
                        allBattleHistory = [];
                    }
                    currentPokemonId = pokemonId; 

                } catch (error) {
                    console.error("ğŸ”¥ í¬ì¼“ëª¬ í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨:", error);
                    updateUI({}); 
                    allBattleHistory = [];
                }
            }
            
            document.getElementById('battle-history').classList.add('hidden');
            currentFilter = null;
            lucide.createIcons();
        };

        // ===============================================
        // 7. UI ê³µí†µ ê¸°ëŠ¥ (í…Œë§ˆ)
        // ===============================================
        
        window.loadTheme = () => {
            if (localStorage.getItem('theme') === 'white') {
                document.body.classList.add('white-mode');
            }
        };

        // í˜ì´ì§€ ë¡œë“œì‹œ ì‹¤í–‰
        window.onload = () => {
            loadTheme();
            const urlParams = new URLSearchParams(window.location.search);
            currentPokemonId = urlParams.get('id'); 

            loadPokemonProfile(currentPokemonId || 'dummy_test'); 
        };
    </script>
</body>
</html>