<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>RUN: POKEMON CLUB ULTIMATE (PvP)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        main: 'var(--bg-main)',       
                        card: 'var(--bg-card)',       
                        accent: 'var(--accent)',      
                        txt: 'var(--text-main)',      
                        sub: 'var(--text-sub)',       
                        line: 'var(--border-color)',  
                    },
                    fontFamily: {
                        sport: ['Chakra Petch', 'sans-serif'],
                        base: ['Noto Sans KR', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, update, onValue, push, get, child, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAbHwLLXIH8rBQ8gNMVqE5SE2O8aibfFZO",
            authDomain: "pokbattle.firebaseapp.com",
            databaseURL: "https://pokbattle-default-rtdb.firebaseio.com",
            projectId: "pokbattle",
            storageBucket: "pokbattle.firebasestorage.app",
            messagingSenderId: "445300582484",
            appId: "1:445300582484:web:f8f1373a3bbf643face5c1",
            measurementId: "G-PNXLYD0D0X"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.fb = { db, ref, set, update, onValue, push, get, child, remove, onDisconnect };
        console.log("üî• ÌååÏù¥Ïñ¥Î≤†Ïù¥Ïä§ ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÏÑ±Í≥µ!");
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:ital,wght@0,400;0,700;1,900&family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-main: #050505;
            --bg-card: rgba(25, 25, 25, 0.85);
            --text-main: #ffffff;
            --text-sub: #9ca3af;
            --accent: #ccff00; 
            --border-color: rgba(255, 255, 255, 0.1);
            --rank-s: #a855f7; 
            --rank-a: #eab308;
            --rank-b: #3b82f6; 
            --rank-c: #9ca3af; 
        }
        [data-theme="light"] {
            --bg-main: #f0f4f8;
            --bg-card: rgba(255, 255, 255, 0.85);
            --text-main: #1a1a1a;
            --text-sub: #4b5563;
            --accent: #2563eb; 
            --border-color: rgba(0, 0, 0, 0.1);
            --rank-s: #9333ea; 
            --rank-a: #d97706;
            --rank-b: #2563eb; 
            --rank-c: #6b7280; 
        }
        
        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            font-family: 'Noto Sans KR', sans-serif;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            transition: background-color 0.3s, color 0.3s;
        }

        .glass {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            transition: background 0.3s, border-color 0.3s;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        .anim-pop { animation: pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop-in { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* Ï∫êÎ¶≠ÌÑ∞ Í∏∞Î≥∏ */
        .sprite-player { transform: scaleX(-1); filter: drop-shadow(0 10px 10px rgba(0,0,0,0.3)); transition: transform 0.2s; }
        .sprite-enemy { filter: drop-shadow(0 10px 10px rgba(0,0,0,0.3)); transition: transform 0.2s; }
        .sprite-dead { filter: grayscale(1) brightness(0.3) blur(2px); opacity: 0.5; transition: all 1s; transform: scale(0.8) !important; }
        
        /* --- [UPGRADED] Ï†ÑÌà¨ Ïï†ÎãàÎ©îÏù¥ÏÖò V2 --- */

        /* 1. Í∞ïÎ†•Ìïú ÎèåÏßÑ (Smash Dash) */
        @keyframes smash-dash {
            0% { transform: translate(0,0) scale(1); }
            20% { transform: translate(0,0) scale(0.9); } /* ÏõÄÏ∏†Î¶¨Í∏∞ */
            40% { transform: translate(var(--tx), var(--ty)) scale(1.3) skewX(-20deg); } /* ÌÉÄÍ≤© ÏßÄÏ†ê */
            50% { transform: translate(var(--tx), var(--ty)) scale(1.1); } /* Ï∂©Îèå ÌõÑ Ïû†Ïãú Ï†ïÏßÄ */
            100% { transform: translate(0,0) scale(1); } /* Î≥µÍ∑Ä */
        }
        .anim-dash {
            animation: smash-dash 0.5s cubic-bezier(0.1, 0.9, 0.2, 1); /* ÏïÑÏ£º Îπ†Î•∏ ÌÉÄÍ≤©Í∞ê */
            z-index: 100 !important;
        }

        /* 2. ÌîºÍ≤© ÌùîÎì§Î¶º (Heavy Shake) */
        @keyframes heavy-shake { 
            0% { transform: translate(0,0); filter: brightness(1); } 
            10% { transform: translate(-15px, 0) skewX(-15deg); filter: brightness(10) sepia(1) saturate(5) hue-rotate(-50deg); } /* Í∞ïÌïú ÏÑ¨Í¥ë */
            30% { transform: translate(15px, 0) skewX(15deg); filter: brightness(2); } 
            50% { transform: translate(-10px, 0); } 
            70% { transform: translate(5px, 0); } 
            100% { transform: translate(0,0); filter: brightness(1); } 
        }
        .anim-hit { animation: heavy-shake 0.5s ease-out; }

        /* 3. ÌôîÎ©¥ Ï†ÑÏ≤¥ ÌùîÎì§Î¶º (Camera Shake) */
        @keyframes cam-shake {
            0% { transform: translate(0,0); }
            25% { transform: translate(-5px, 5px) rotate(-1deg); }
            50% { transform: translate(5px, -5px) rotate(1deg); }
            75% { transform: translate(-3px, -3px); }
            100% { transform: translate(0,0); }
        }
        .anim-cam-shake { animation: cam-shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }

        /* 4. ÏõêÍ±∞Î¶¨ Ìà¨ÏÇ¨Ï≤¥ */
        @keyframes projectile-shoot {
            0% { transform: translate(0,0) scale(0.5); opacity: 0; }
            20% { opacity: 1; transform: translate(0,0) scale(1.2); }
            100% { transform: translate(var(--tx), var(--ty)) scale(0.8); opacity: 1; }
        }
        .fx-projectile {
            position: absolute; width: 40px; height: 40px;
            z-index: 90;
            border-radius: 50%;
            filter: drop-shadow(0 0 10px currentColor);
            animation: projectile-shoot 0.4s ease-in forwards;
        }

        /* 5. ÌååÌã∞ÌÅ¥ Ìè≠Î∞ú */
        @keyframes particle-out {
            0% { transform: translate(0,0) scale(1); opacity: 1; }
            100% { transform: translate(var(--vx), var(--vy)) scale(0); opacity: 0; }
        }
        .fx-particle {
            position: absolute; width: 8px; height: 8px; border-radius: 50%;
            pointer-events: none; z-index: 95;
            animation: particle-out 0.6s ease-out forwards;
        }

        /* --- ÌÉÄÏûÖÎ≥Ñ ÏÉâÏÉÅ ÌÖåÎßà --- */
        .type-fire { color: #ef4444; background: radial-gradient(circle, #fcd34d 0%, #ef4444 100%); box-shadow: 0 0 20px #ef4444; }
        .type-water { color: #3b82f6; background: radial-gradient(circle, #bfdbfe 0%, #3b82f6 100%); box-shadow: 0 0 20px #3b82f6; }
        .type-grass { color: #22c55e; background: radial-gradient(circle, #86efac 0%, #22c55e 100%); box-shadow: 0 0 20px #22c55e; }
        .type-electric { color: #eab308; background: radial-gradient(circle, #fef08a 0%, #eab308 100%); box-shadow: 0 0 25px #eab308; }
        .type-psychic { color: #a855f7; background: radial-gradient(circle, #e9d5ff 0%, #a855f7 100%); box-shadow: 0 0 20px #a855f7; }
        .type-normal { color: #9ca3af; background: radial-gradient(circle, #f3f4f6 0%, #9ca3af 100%); }

        .rank-S { color: var(--rank-s); font-weight: 900; }
        .rank-A { color: var(--rank-a); font-weight: 800; }
        .rank-B { color: var(--rank-b); font-weight: 700; }
        .rank-C { color: var(--rank-c); font-weight: 600; }
        .nav-active { color: var(--accent) !important; transform: translateY(-4px); }
    </style>
</head>
<body class="flex justify-center h-[100dvh] w-full bg-gray-900">

    <div id="app" class="relative w-full max-w-md h-full bg-main shadow-2xl overflow-hidden flex flex-col border-x border-line transition-colors duration-300 pt-[env(safe-area-inset-top)] pb-[env(safe-area-inset-bottom)]">
        
        <header id="main-header" class="relative w-full z-30 px-5 py-4 flex justify-between items-center glass border-b border-line shrink-0">
            <div class="flex items-center gap-2">
                <div class="bg-accent p-1 rounded text-white shadow-lg transition-colors duration-300">
                    <i data-lucide="zap" class="w-5 h-5 fill-current"></i>
                </div>
                <h1 class="text-xl font-sport font-black italic tracking-tighter text-txt">POKE<span class="text-accent">RUN</span> <span class="text-xs align-top text-red-500">PRO</span></h1>
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="app.nav('settings')" class="p-2 rounded-full bg-gray-200/20 hover:bg-gray-200/40 transition-colors">
                    <i data-lucide="settings" class="w-5 h-5 text-txt"></i>
                </button>
                <button onclick="app.toggleTheme()" class="p-2 rounded-full bg-gray-200/20 hover:bg-gray-200/40 transition-colors">
                    <i id="theme-icon" data-lucide="sun" class="w-5 h-5 text-txt"></i>
                </button>
                <div class="flex items-center gap-2 bg-black/10 px-4 py-1.5 rounded-full border border-line">
                    <span class="text-yellow-400 text-xs font-bold">‚óè</span>
                    <span id="display-coins" class="font-sport font-bold text-sm text-txt">0</span>
                </div>
            </div>
        </header>

        <main id="main-content" class="flex-1 relative overflow-y-auto scrollbar-hide bg-main transition-colors duration-300 pb-24">
        </main>

        <nav id="main-nav" class="absolute bottom-0 w-full glass border-t border-line px-2 py-2 flex justify-around items-end z-40 pb-[calc(1.5rem+env(safe-area-inset-bottom))] transition-colors duration-300">
            <button onclick="app.nav('lobby')" id="nav-lobby" class="nav-btn group flex flex-col items-center gap-1 p-2 w-16 transition-all text-sub hover:text-txt">
                <i data-lucide="home" class="w-6 h-6"></i>
                <span class="text-[10px] font-black italic font-sport">HOME</span>
            </button>
            <button onclick="app.nav('team')" id="nav-team" class="nav-btn group flex flex-col items-center gap-1 p-2 w-16 transition-all text-sub hover:text-txt">
                <i data-lucide="users" class="w-6 h-6"></i>
                <span class="text-[10px] font-black italic font-sport">TEAM</span>
            </button>
            <button onclick="app.nav('battle')" class="mb-4 transform transition-transform active:scale-95 group">
                <div class="w-16 h-16 bg-accent rounded-full flex items-center justify-center border-4 border-main shadow-xl relative z-10 group-hover:scale-105 transition-all">
                    <i data-lucide="swords" class="w-8 h-8 text-white fill-current"></i>
                </div>
            </button>
            <button onclick="app.nav('shop')" id="nav-shop" class="nav-btn group flex flex-col items-center gap-1 p-2 w-16 transition-all text-sub hover:text-txt">
                <i data-lucide="shopping-bag" class="w-6 h-6"></i>
                <span class="text-[10px] font-black italic font-sport">SHOP</span>
            </button>
            <button onclick="app.nav('dex')" id="nav-dex" class="nav-btn group flex flex-col items-center gap-1 p-2 w-16 transition-all text-sub hover:text-txt">
                <i data-lucide="book-open" class="w-6 h-6"></i>
                <span class="text-[10px] font-black italic font-sport">DEX</span>
            </button>
        </nav>

        <div id="toast" class="absolute top-24 left-1/2 -translate-x-1/2 bg-accent text-white px-6 py-3 rounded-full font-black italic shadow-2xl transform scale-0 transition-transform z-50 pointer-events-none text-sm whitespace-nowrap border-2 border-white flex items-center gap-2">
            <i data-lucide="info" class="w-4 h-4"></i>
            <span id="toast-msg">Notification</span>
        </div>
        
        <div id="camera-shake-layer" class="pointer-events-none absolute inset-0 z-0"></div>
    </div>

    <script>
        const $ = (id) => document.getElementById(id);
        const wait = (ms) => new Promise(r => setTimeout(r, ms));
        const rnd = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

        window.showToast = function(msg, type='success') {
            const t = $('toast');
            if(!t) return;
            const msgEl = $('toast-msg');
            msgEl.innerText = msg;
            t.style.backgroundColor = type === 'error' ? '#ef4444' : 'var(--accent)'; 
            requestAnimationFrame(() => t.style.transform = 'translate(-50%, 0) scale(1)');
            setTimeout(() => t.style.transform = 'translate(-50%, 0) scale(0)', 2500);
        };

        const BALLS = [
            { id: 'poke', name: 'Pok√© Ball', price: 200, img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png', rates: {S: 0, A: 5, B: 20, C: 75}, color: 'border-gray-500' },
            { id: 'great', name: 'Great Ball', price: 500, img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/great-ball.png', rates: {S: 5, A: 15, B: 40, C: 40}, color: 'border-blue-500' },
            { id: 'ultra', name: 'Ultra Ball', price: 1500, img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/ultra-ball.png', rates: {S: 15, A: 45, B: 30, C: 10}, color: 'border-yellow-500' },
            { id: 'master', name: 'Master Ball', price: 5000, img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png', rates: {S: 100, A: 0, B: 0, C: 0}, color: 'border-purple-500' }
        ];

        const state = {
            coins: 5000,
            inventory: [],
            team: [null, null, null],
            battle: { active: false, roomId: null, role: null, myTeam: [], enemyTeam: [], lastActionId: 0 },
            theme: 'dark',
            selectedSlot: null,
            profileImg: localStorage.getItem('pokerun_avatar') || null,
            nickname: localStorage.getItem('pokerun_name') || "Trainer"
        };

        // ÌÉÄÏûÖÎ≥Ñ Ìö®Í≥º Îç∞Ïù¥ÌÑ∞ Ï†ïÏùò
        const TYPE_FX = {
            fire: { style: 'type-fire', icon: 'flame', particleColor: '#ef4444' },
            water: { style: 'type-water', icon: 'droplets', particleColor: '#3b82f6' },
            electric: { style: 'type-electric', icon: 'zap', particleColor: '#eab308' },
            grass: { style: 'type-grass', icon: 'leaf', particleColor: '#22c55e' },
            psychic: { style: 'type-psychic', icon: 'eye', particleColor: '#a855f7' },
            ice: { style: 'type-water', icon: 'snowflake', particleColor: '#a5f3fc' },
            dragon: { style: 'type-psychic', icon: 'swords', particleColor: '#6366f1' },
            normal: { style: 'type-normal', icon: 'circle-dot', particleColor: '#9ca3af' },
            fighting: { style: 'type-fire', icon: 'hammer', particleColor: '#f97316' },
            poison: { style: 'type-psychic', icon: 'skull', particleColor: '#a020f0' },
            ground: { style: 'type-normal', icon: 'mountain', particleColor: '#d2691e' },
            rock: { style: 'type-normal', icon: 'hexagon', particleColor: '#8b4513' },
            bug: { style: 'type-grass', icon: 'bug', particleColor: '#9acd32' },
            ghost: { style: 'type-psychic', icon: 'ghost', particleColor: '#4b0082' },
            steel: { style: 'type-normal', icon: 'shield', particleColor: '#c0c0c0' },
            flying: { style: 'type-normal', icon: 'wind', particleColor: '#87ceeb' },
            fairy: { style: 'type-psychic', icon: 'sparkles', particleColor: '#ffb6c1' }
        };

        const app = {
            init: () => {
                if(state.inventory.length === 0) {
                    app.addPokemon({id: 25, name: 'Pikachu', type: 'electric', rank: 'A', hp: 100, atk: 55, move: 'Thunderbolt'}, true);
                    app.addPokemon({id: 6, name: 'Charizard', type: 'fire', rank: 'S', hp: 160, atk: 90, move: 'Flamethrower'}, true);
                    app.addPokemon({id: 9, name: 'Blastoise', type: 'water', rank: 'A', hp: 140, atk: 75, move: 'Hydro Pump'}, true);
                    state.team = [state.inventory[1], state.inventory[0], state.inventory[2]];
                }
                app.updateCoins(0);
                app.nav('lobby');
                app.applyTheme();
            },

            toggleTheme: () => {
                state.theme = state.theme === 'dark' ? 'light' : 'dark';
                app.applyTheme();
            },

            applyTheme: () => {
                const root = document.documentElement;
                const icon = $('theme-icon');
                if (state.theme === 'light') {
                    root.setAttribute('data-theme', 'light');
                    icon.setAttribute('data-lucide', 'moon'); 
                } else {
                    root.removeAttribute('data-theme');
                    icon.setAttribute('data-lucide', 'sun'); 
                }
                lucide.createIcons();
            },

            addPokemon: (pkm, silent=false) => {
                pkm.uid = Date.now() + Math.random();
                pkm.sprite = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/${pkm.id}.gif`;
                pkm.static = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${pkm.id}.png`;
                pkm.level = 1;
                pkm.maxHp = pkm.hp;
                pkm.currentHp = pkm.hp;
                
                if(!pkm.move) pkm.move = 'Tackle';

                state.inventory.push(pkm);
                if(!silent) showToast(`Got ${pkm.name}!`);
            },

            updateCoins: (amt) => {
                state.coins += amt;
                $('display-coins').innerText = state.coins.toLocaleString();
            },

            nav: (view) => {
                const main = $('main-content');
                main.innerHTML = '';
                state.selectedSlot = null;

                document.querySelectorAll('.nav-btn').forEach(b => {
                    const isActive = b.id === `nav-${view}`;
                    b.classList.remove('nav-active');
                    if(isActive) b.classList.add('nav-active');
                });

                if(view === 'lobby') app.renderLobby(main);
                if(view === 'shop') app.renderShop(main);
                if(view === 'dex') app.renderDex(main);
                if(view === 'team') app.renderTeam(main);
                if(view === 'battle') app.renderBattleSetup(main);
                if(view === 'settings') app.renderSettings(main);
                lucide.createIcons();
            },

            selectSlot: (index) => {
                state.selectedSlot = (state.selectedSlot === index) ? null : index;
                app.renderTeam($('main-content'));
            },

            equip: (invIndex) => {
                if (state.selectedSlot === null) return showToast("Î®ºÏ†Ä ÏúÑÏ™Ω Ïä¨Î°ØÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî!", "error");
                const pkm = state.inventory[invIndex];
                if (state.team.some(p => p && p.uid === pkm.uid)) return showToast("Ïù¥ÎØ∏ ÌåÄÏóê ÏûàÏäµÎãàÎã§!", "error");

                state.team[state.selectedSlot] = pkm;
                state.selectedSlot = null;
                showToast(state.selectedSlot === 0 ? `ÌååÌä∏ÎÑà Ìè¨ÏºìÎ™¨ ÏÑ§Ï†ï: ${pkm.name}!` : `${pkm.name} Î∞∞Ïπò ÏôÑÎ£å!`);
                app.renderTeam($('main-content'));
            },

            uploadProfile: (input) => {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const MAX_SIZE = 150;
                            let width = img.width;
                            let height = img.height;
                            if (width > height) {
                                if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                            } else {
                                if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                            }
                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                            state.profileImg = dataUrl;
                            localStorage.setItem('pokerun_avatar', dataUrl);
                            const preview = $('profile-preview');
                            if(preview) preview.src = dataUrl;
                        }
                    }
                    reader.readAsDataURL(input.files[0]);
                }
            },

            saveSettings: () => {
                const nameInput = $('input-nickname').value;
                if(nameInput.trim()) {
                    state.nickname = nameInput.trim();
                    localStorage.setItem('pokerun_name', state.nickname);
                }
                showToast("Saved Successfully!");
                app.nav('lobby');
            },

            renderSettings: (c) => {
                c.innerHTML = `
                    <div class="p-6 h-full flex flex-col anim-pop">
                        <h2 class="text-3xl font-sport font-black italic text-txt mb-8">SETTINGS</h2>
                        <div class="glass p-6 rounded-2xl flex flex-col items-center mb-6">
                            <h3 class="text-sub font-bold text-sm mb-4 uppercase tracking-widest">Profile Settings</h3>
                            <div class="relative w-32 h-32 mb-4 group cursor-pointer" onclick="$('file-upload').click()">
                                <img id="profile-preview" src="${state.profileImg || 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png'}" class="w-full h-full object-cover rounded-full border-4 border-accent shadow-xl bg-black/50">
                                <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                    <i data-lucide="camera" class="w-8 h-8 text-white"></i>
                                </div>
                            </div>
                            <input type="file" id="file-upload" class="hidden" accept="image/*" onchange="app.uploadProfile(this)">
                            <div class="w-full">
                                <label class="text-xs text-sub font-bold ml-1 mb-1 block">NICKNAME</label>
                                <input id="input-nickname" type="text" value="${state.nickname}" class="w-full glass bg-transparent text-txt p-3 rounded-lg font-bold focus:outline-none focus:border-accent border border-white/10 text-center" placeholder="Enter your name">
                            </div>
                        </div>
                        <div class="flex-1"></div>
                        <button onclick="app.saveSettings()" class="w-full bg-accent text-white font-black italic text-xl py-4 rounded-full shadow-lg hover:scale-105 transition-transform">SAVE CHANGES</button>
                    </div>
                `;
            },

            renderLobby: (c) => {
                const partner = state.team[0] || state.inventory[0];
                const typeInfo = TYPE_FX[partner.type] || TYPE_FX.normal;
                const typeColor = typeInfo.particleColor;

                c.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full p-6 anim-pop">
                        <div class="relative w-full aspect-square flex items-center justify-center mb-6">
                            <div class="absolute inset-0 bg-gradient-to-tr from-${partner.rank==='S'?'purple':partner.rank==='A'?'yellow':'blue'}-500/30 to-transparent blur-[60px] rounded-full animate-pulse"></div>
                            <img src="${partner.sprite}" class="w-64 h-64 object-contain relative z-10 sprite-player drop-shadow-2xl">
                            
                            <div class="absolute bottom-0 right-4 glass px-3 py-1 rounded-full flex items-center gap-1 border-accent/50">
                                <i data-lucide="crown" class="w-4 h-4 text-yellow-400 fill-current"></i>
                                <span class="text-[10px] font-black italic">MAIN</span>
                            </div>
                        </div>

                        <h2 class="font-sport font-black italic text-5xl uppercase mb-2 text-txt drop-shadow-sm tracking-tighter">${partner.name}</h2>
                        
                        <div class="glass px-6 py-2 rounded-full flex items-center gap-3 mb-8 border border-white/10">
                            <span class="font-black text-2xl italic rank-${partner.rank}">${partner.rank}</span>
                            <div class="h-4 w-[1px] bg-sub"></div>
                            <div class="flex items-center gap-1" style="color:${typeColor}">
                                <i data-lucide="${typeInfo.icon}" class="w-4 h-4"></i>
                                <span class="text-xs font-bold uppercase tracking-widest">${partner.type}</span>
                            </div>
                        </div>

                        <div class="w-full glass p-4 rounded-xl mb-4 border-l-4" style="border-color: ${typeColor}">
                            <div class="flex justify-between items-center">
                                <span class="text-[10px] text-sub font-bold uppercase">Signature Move</span>
                                <span class="text-xs font-bold text-white uppercase bg-white/10 px-2 py-0.5 rounded">${partner.type} Type</span>
                            </div>
                            <div class="text-2xl font-sport font-black italic text-txt mt-1">${partner.move || 'Tackle'}</div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 w-full">
                            <div class="glass p-4 rounded-xl flex flex-col items-center">
                                <p class="text-[10px] text-sub font-bold uppercase mb-1">PvP Rank</p>
                                <p class="text-xl font-sport font-black italic text-txt">Bronze</p>
                            </div>
                            <div class="glass p-4 rounded-xl flex flex-col items-center">
                                <p class="text-[10px] text-sub font-bold uppercase mb-1">Win Rate</p>
                                <p class="text-xl font-sport font-black italic text-txt">0%</p>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderShop: (c) => {
                const bgImages = {
                    poke: 'https://a-static.besthdwallpaper.com/pokemon-ball-house-wallpaper-960x600-128208_1.jpg',
                    great: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQhIAzIXx8LGPZ0sea3J7hC6JIBuUv3oPWW5w&s',
                    ultra: 'https://i.pinimg.com/originals/e3/7d/8e/e37d8e343789fe5fd2df8f4cae0ec803.jpg',
                    master: 'https://i.imgur.com/Dtbs9Gz.jpg'
                };

                const ballCards = BALLS.map(b => {
                    return `
                        <div onclick="app.confirmBuy('${b.id}')" class="rounded-2xl flex flex-col items-center relative overflow-hidden group active:scale-95 transition-all cursor-pointer border-t-4 p-4 shadow-lg ${b.color}">
                            <div class="absolute inset-0 z-0 bg-cover bg-center" style="background-image: url('${bgImages[b.id]||''}');"></div>
                            <div class="absolute inset-0 z-0 bg-black/60"></div>
                            <div class="absolute top-2 right-2 text-[9px] font-black uppercase bg-black/50 px-2 py-0.5 rounded text-white border border-white/10 z-10 relative">
                                ${b.id === 'master' ? '100% S-RANK' : `S: ${b.rates.S}%`}
                            </div>
                            <img src="${b.img}" class="w-20 h-20 object-contain mb-3 drop-shadow-lg group-hover:scale-110 transition-transform mt-2 relative z-10">
                            <h3 class="font-black italic text-lg uppercase mb-0.5 relative z-10 text-white drop-shadow-md">${b.name}</h3>
                            <p class="text-[#ccff00] drop-shadow-md font-bold text-sm mb-3 relative z-10">${b.price.toLocaleString()} C</p>
                        </div>
                    `;
                }).join('');

                c.innerHTML = `
                    <div class="p-5 pb-24 h-full flex flex-col anim-pop">
                        <h2 class="text-4xl font-sport font-black italic mb-2 text-txt tracking-tighter">ITEM SHOP</h2>
                        <div class="grid grid-cols-2 gap-3 overflow-y-auto pb-4">${ballCards}</div>
                    </div>
                `;
            },

            confirmBuy: async (ballId) => {
                const ball = BALLS.find(b => b.id === ballId);
                if(state.coins < ball.price) return showToast("Not enough coins!", "error");
                app.updateCoins(-ball.price);
                
                const overlay = document.createElement('div');
                overlay.className = "absolute inset-0 z-50 bg-black/95 flex flex-col items-center justify-center anim-pop";
                overlay.innerHTML = `<div class="relative mb-12"><img src="${ball.img}" class="w-48 h-48 object-contain relative z-10 anim-shake"></div>`;
                $('app').appendChild(overlay);

                await wait(1500);

                const rand = Math.random() * 100;
                let rank = 'C';
                if (rand <= ball.rates.S) rank = 'S';
                else if (rand <= ball.rates.S + ball.rates.A) rank = 'A';
                else if (rand <= ball.rates.S + ball.rates.A + ball.rates.B) rank = 'B';

                const id = rnd(1, 151);
                const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`).then(r=>r.json());
                
                let moveName = 'Tackle';
                if (res.moves && res.moves.length > 0) {
                    const moveIdx = Math.floor(Math.random() * Math.min(res.moves.length, 15));
                    moveName = res.moves[moveIdx].move.name.replace(/-/g, ' '); 
                    moveName = moveName.charAt(0).toUpperCase() + moveName.slice(1);
                }

                let bonus = rank === 'S' ? 60 : rank === 'A' ? 40 : rank === 'B' ? 20 : 0;
                const pkm = { 
                    id: id, 
                    name: res.name.charAt(0).toUpperCase() + res.name.slice(1), 
                    type: res.types[0].type.name, 
                    rank: rank, 
                    hp: rnd(60, 100) + bonus, 
                    atk: rnd(40, 80) + bonus,
                    move: moveName
                };
                
                app.addPokemon(pkm, true);

                overlay.innerHTML = `
                    <div class="text-accent font-sport text-6xl font-black italic mb-2 anim-pop">GOTCHA!</div>
                    <div class="text-sub font-sport text-xl font-bold italic mb-8">Move learned: ${pkm.move}</div>
                    <img src="${pkm.sprite}" class="w-56 h-56 object-contain relative z-10 sprite-player mb-4">
                    <h2 class="text-3xl font-black italic uppercase text-white mb-2">${pkm.name}</h2>
                    <div class="glass px-4 py-1 rounded-full text-xs font-bold uppercase mb-8 border border-white/20">${pkm.type}</div>
                    <button onclick="this.parentElement.remove()" class="bg-white text-black px-12 py-4 rounded-full font-black italic">CLOSE</button>
                `;
            },

            renderTeam: (c) => {
                const slots = state.team.map((p, i) => {
                    const isSelected = state.selectedSlot === i;
                    const borderClass = isSelected ? 'border-accent bg-accent/20 ring-2 ring-accent' : 'border-dashed border-line';
                    const isLeader = i === 0;
                    
                    return `
                    <div onclick="app.selectSlot(${i})" class="glass h-32 rounded-xl flex items-center justify-center relative cursor-pointer border-2 transition-all duration-200 ${borderClass}">
                        ${isLeader ? `<div class="absolute top-2 left-2 z-20"><i data-lucide="crown" class="w-4 h-4 text-yellow-400 fill-current drop-shadow-md"></i></div>` : ''}
                        ${p ? `<div class="text-center relative z-10">
                                <img src="${p.sprite}" class="w-20 h-20 object-contain sprite-player mx-auto">
                                <div class="bg-black/50 px-2 rounded text-[9px] text-white mt-1 backdrop-blur-sm">${p.move}</div>
                               </div>` 
                            : `<i data-lucide="${isSelected ? 'check' : 'plus'}" class="w-6 h-6 text-sub"></i>`}
                    </div>`;
                }).join('');

                const inv = state.inventory.map((p, i) => {
                    const isInTeam = state.team.some(t => t && t.uid === p.uid);
                    return `
                    <div onclick="app.equip(${i})" class="glass p-2 rounded-xl flex items-center gap-3 cursor-pointer hover:bg-white/5 ${isInTeam ? 'opacity-50' : ''}">
                        <div class="w-12 h-12 bg-black/10 rounded-lg flex items-center justify-center"><img src="${p.static}" class="w-10 h-10 object-contain"></div>
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <p class="font-black text-xs uppercase text-txt">${p.name}</p>
                                <span class="text-[9px] font-bold text-sub uppercase border border-white/10 px-1 rounded">${p.type}</span>
                            </div>
                            <p class="text-[10px] text-sub flex items-center gap-1"><i data-lucide="swords" class="w-3 h-3"></i> ${p.move}</p>
                        </div>
                    </div>`;
                }).join('');

                c.innerHTML = `
                    <div class="p-5 pb-24 h-full flex flex-col anim-pop">
                        <h2 class="text-3xl font-sport font-black italic text-txt mb-4">MY TEAM</h2>
                        <div class="text-xs text-sub mb-2 ml-1">* Ï≤´Î≤àÏß∏ Ïä¨Î°ØÏù¥ ÎåÄÌëú Ìè¨ÏºìÎ™¨(ÌîÑÎ°úÌïÑ)Ïù¥ Îê©ÎãàÎã§.</div>
                        <div class="grid grid-cols-3 gap-2 mb-6">${slots}</div>
                        <div class="flex-1 overflow-y-auto pt-4 grid grid-cols-1 gap-2">${inv}</div>
                    </div>
                `;
                lucide.createIcons();
            },

            // =======================================================
            // ‚≠êÔ∏è [ÏàòÏ†ï] Ìè¨ÏºìÎ™¨ ÎèÑÍ∞ê Í∏∞Îä• Ï∂îÍ∞Ä (Owned/Unowned Íµ¨Î∂Ñ)
            // =======================================================
            renderDex: (c) => {
                // 1. ÌòÑÏû¨ Ïù∏Î≤§ÌÜ†Î¶¨Ïóê ÏûàÎäî Ìè¨ÏºìÎ™¨ IDÎ•º Ï†ÄÏû•ÌïòÎäî Set ÏÉùÏÑ±
                const ownedIds = new Set(state.inventory.map(p => p.id));
                const totalDexSize = 151; 
                let dexHtml = '';

                for (let id = 1; id <= totalDexSize; id++) {
                    const isOwned = ownedIds.has(id);
                    // state.inventoryÏóêÏÑú Ìï¥Îãπ IDÎ•º Í∞ÄÏßÑ Ìè¨ÏºìÎ™¨ÏùÑ Ï∞æÏùå (Ïù¥Î¶Ñ, Ïù¥ÎØ∏ÏßÄ ÏÇ¨Ïö©)
                    const pokemon = isOwned ? state.inventory.find(p => p.id === id) : null;
                    const name = isOwned ? pokemon.name : '???';
                    
                    // CSS ÌÅ¥ÎûòÏä§ Î∞è Ïä§ÌÉÄÏùº Ï°∞Ï†ï
                    const opacityClass = isOwned ? '' : 'opacity-30 grayscale';
                    const nameClass = isOwned ? 'text-txt' : 'text-sub';
                    
                    // ÏÜåÏú† Ïó¨Î∂ÄÏóê Îî∞Îùº ÏïÑÏù¥ÏΩò ÎòêÎäî Ïù¥ÎØ∏ÏßÄÎ•º ÌëúÏãú
                    const iconOrImg = isOwned 
                        ? `<img src="${pokemon.static}" class="w-16 h-16 object-contain">`
                        : `<i data-lucide="help-circle" class="w-10 h-10 text-sub"></i>`;

                    dexHtml += `
                        <div class="glass p-2 rounded-xl flex flex-col items-center justify-between min-h-[120px] active:scale-95 transition-transform duration-100">
                            <span class="text-[9px] font-bold uppercase text-sub">${id.toString().padStart(3, '0')}</span>
                            <div class="w-20 h-20 bg-black/10 rounded-full flex items-center justify-center mb-1 overflow-hidden ${opacityClass}">
                                ${iconOrImg}
                            </div>
                            <span class="font-black text-xs uppercase ${nameClass} text-center">${name}</span>
                        </div>
                    `;
                }

                const totalOwned = ownedIds.size;
                
                c.innerHTML = `
                    <div class="p-5 pb-24 h-full flex flex-col anim-pop">
                        <h2 class="text-3xl font-sport font-black italic mb-4 text-txt tracking-tighter">POKEDEX</h2>
                        
                        <div class="glass p-4 rounded-xl mb-6 border-l-4 border-accent shrink-0">
                            <span class="text-xs text-sub font-bold uppercase">Completion Rate</span>
                            <div class="text-2xl font-sport font-black italic text-txt mt-1">${totalOwned} / ${totalDexSize}</div>
                            <div class="w-full h-2 bg-gray-700 rounded-full mt-2">
                                <div class="h-2 bg-accent rounded-full transition-all duration-500" style="width: ${Math.floor((totalOwned/totalDexSize)*100)}%"></div>
                            </div>
                        </div>

                        <div class="flex-1 overflow-y-auto pt-2 grid grid-cols-3 gap-2">
                            ${dexHtml}
                        </div>
                    </div>
                `;
                lucide.createIcons(); // ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú ÏïÑÏù¥ÏΩòÏùÑ Î†åÎçîÎßÅ
            },

            renderBattleSetup: (c) => {
                const ready = state.team.filter(p=>p).length === 3;
                
                if (!ready) {
                     c.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full p-6 text-center">
                            <i data-lucide="alert-triangle" class="w-12 h-12 text-yellow-500 mb-4"></i>
                            <h2 class="text-xl font-bold text-white mb-2">Team Incomplete</h2>
                            <p class="text-sm text-sub mb-6">You need 3 Pokemon to battle.</p>
                            <button onclick="app.nav('team')" class="bg-accent text-white font-bold py-3 px-8 rounded-full">GO TO TEAM</button>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                c.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full p-6 anim-pop text-center bg-[url('https://images.unsplash.com/photo-1620108097950-8b4382559530?auto=format&fit=crop&w=800&q=80')] bg-cover bg-center">
                        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
                        <div class="relative z-10 w-full flex flex-col items-center max-w-xs">
                            <h2 class="text-4xl font-sport font-black italic text-white mb-8">BATTLE MODE</h2>
                            
                            <div class="w-full mb-8">
                                <button onclick="app.startBattle()" class="w-full bg-accent text-white font-black italic text-xl py-4 rounded-xl shadow-lg hover:scale-105 transition-transform flex items-center justify-center gap-2">
                                    <i data-lucide="swords" class="w-6 h-6"></i> QUICK MATCH
                                </button>
                                <p class="text-xs text-sub mt-2">Find a random opponent</p>
                            </div>

                            <div class="w-full h-[1px] bg-white/10 mb-8"></div>

                            <div class="w-full">
                                <h3 class="text-white font-bold mb-3 uppercase tracking-wider text-sm">Private Room</h3>
                                
                                <div class="flex gap-2 mb-3">
                                    <input id="room-code-input" type="number" placeholder="Enter Code" class="w-full glass bg-transparent text-white p-3 rounded-lg text-center font-sport font-bold focus:outline-none focus:border-accent border border-white/20">
                                    <button onclick="app.joinPrivateRoom()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold px-6 rounded-lg transition-colors">JOIN</button>
                                </div>
                                
                                <button onclick="app.createPrivateRoom()" class="w-full glass py-3 rounded-lg text-sub hover:text-white border border-white/10 hover:border-white/30 transition-all text-sm font-bold">
                                    + CREATE NEW ROOM
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                lucide.createIcons();
            },

            createPrivateRoom: async () => {
                const myTeamData = state.team.map((p, i) => ({
                    uid: p.uid, name: p.name, sprite: p.sprite,
                    maxHp: p.hp, currentHp: p.hp, rank: p.rank, atk: p.atk,
                    move: p.move, type: p.type,
                    trainerAvatar: (i === 0) ? state.profileImg : null,
                    trainerName: (i === 0) ? state.nickname : null
                }));

                const code = Math.floor(10000 + Math.random() * 90000).toString(); 
                state.battle.roomId = code;
                state.battle.role = 'host';

                const main = $('main-content');
                main.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full p-6 anim-pop bg-black/90">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-accent mb-6"></div>
                        <p class="text-sub font-bold mb-2">WAITING FOR PLAYER...</p>
                        <h1 class="text-6xl font-sport font-black text-accent tracking-widest mb-8">${code}</h1>
                        <p class="text-xs text-gray-500">Share this code with your friend</p>
                        <button onclick="app.nav('battle')" class="mt-12 text-gray-400 hover:text-white underline">Cancel</button>
                    </div>
                `;

                const roomRef = window.fb.ref(window.fb.db, `battles/${code}`);
                await window.fb.set(roomRef, {
                    host: myTeamData,
                    status: 'waiting',
                    private: true,
                    createdAt: Date.now()
                });
                window.fb.onDisconnect(roomRef).remove();

                app.listenToBattle();
            },

            joinPrivateRoom: async () => {
                const code = $('room-code-input').value;
                if (!code || code.length < 5) return showToast("Please enter a valid code!", "error");

                const myTeamData = state.team.map((p, i) => ({
                    uid: p.uid, name: p.name, sprite: p.sprite,
                    maxHp: p.hp, currentHp: p.hp, rank: p.rank, atk: p.atk,
                    move: p.move, type: p.type,
                    trainerAvatar: (i === 0) ? state.profileImg : null,
                    trainerName: (i === 0) ? state.nickname : null
                }));

                const roomRef = window.fb.ref(window.fb.db, `battles/${code}`);
                const snapshot = await window.fb.get(roomRef);

                if (!snapshot.exists()) {
                    return showToast("Room not found!", "error");
                }
                const data = snapshot.val();
                if (data.status !== 'waiting') {
                    return showToast("Room is full or already started!", "error");
                }

                state.battle.roomId = code;
                state.battle.role = 'guest';

                await window.fb.update(roomRef, {
                    guest: myTeamData,
                    status: 'ready'
                });

                showToast("Joining room...");
                app.listenToBattle();
            },

            startBattle: async () => {
                const myTeamData = state.team.map((p, i) => ({
                    uid: p.uid, name: p.name, sprite: p.sprite,
                    maxHp: p.hp, currentHp: p.hp, rank: p.rank, atk: p.atk,
                    move: p.move, type: p.type,
                    trainerAvatar: (i === 0) ? state.profileImg : null,
                    trainerName: (i === 0) ? state.nickname : null
                }));

                showToast("Searching for opponent...", "info");
                
                const roomsRef = window.fb.ref(window.fb.db, 'battles');
                let snapshot;
                try {
                    snapshot = await window.fb.get(roomsRef);
                } catch(e) {
                    return showToast("Connection failed!", "error");
                }

                let joinedRoomId = null;
                const now = Date.now();

                if (snapshot.exists()) {
                    const rooms = snapshot.val();
                    for (const [id, room] of Object.entries(rooms)) {
                        if (room.status === 'waiting' && !room.private) {
                             if (room.createdAt && (now - room.createdAt < 300000)) {
                                 joinedRoomId = id;
                                 break;
                             }
                        }
                    }
                }

                if (joinedRoomId) {
                    state.battle.roomId = joinedRoomId;
                    state.battle.role = 'guest';
                    await window.fb.update(window.fb.ref(window.fb.db, `battles/${joinedRoomId}`), {
                        guest: myTeamData,
                        status: 'ready'
                    });
                    showToast("Opponent found!");
                } else {
                    const newRoomRef = window.fb.push(roomsRef);
                    state.battle.roomId = newRoomRef.key;
                    state.battle.role = 'host';
                    await window.fb.set(newRoomRef, {
                        host: myTeamData,
                        status: 'waiting',
                        private: false,
                        createdAt: Date.now() 
                    });
                    window.fb.onDisconnect(newRoomRef).remove();
                    showToast("Waiting for opponent...");
                }
                app.listenToBattle();
            },

            listenToBattle: () => {
                const roomRef = window.fb.ref(window.fb.db, `battles/${state.battle.roomId}`);
                window.fb.onValue(roomRef, (snapshot) => {
                    const data = snapshot.val();
                    if (!data) return;

                    if (data.status === 'ready' && !state.battle.active) {
                        state.battle.active = true;
                        const enemyData = state.battle.role === 'host' ? data.guest : data.host;
                        state.battle.enemyTeam = enemyData;
                        state.battle.myTeam = state.team.map(p => ({...p, currentHp: p.hp}));

                        app.renderBattleArena($('main-content'));
                        
                        if (state.battle.role === 'host') {
                            app.hostBattleLoop();
                        }
                    }

                    if (data.lastAction && data.lastAction.id !== state.battle.lastActionId) {
                        state.battle.lastActionId = data.lastAction.id;
                        app.playAction(data.lastAction);
                    }
                });
            },

            // [ÏàòÏ†ïÎê®] Ï†ÑÌà¨ ÌôîÎ©¥ Î†åÎçîÎßÅ - HPÎ∞î ÏúÑÏπò Í∞úÏÑ†
            renderBattleArena: (c) => {
                const myLeader = state.battle.myTeam[0];
                const enLeader = state.battle.enemyTeam[0];

                const myAvatar = state.profileImg ? state.profileImg : myLeader.sprite;
                const enAvatar = enLeader.trainerAvatar ? enLeader.trainerAvatar : enLeader.sprite;
                
                const myName = state.nickname || "MY TEAM";
                const enName = enLeader.trainerName || "ENEMY TEAM";

                // HPÎ∞îÎ•º relative ÏòÅÏó≠ Î∞ñÏúºÎ°ú ÎùÑÏö∞Í≥†, Ïä§ÌîÑÎùºÏù¥Ìä∏ ÏúÑÏ™ΩÏúºÎ°ú Î∞∞Ïπò
                const renderUnit = (p, i, isP) => `
                    <div id="unit-${isP?'p':'e'}-${i}" class="relative w-32 h-32 flex items-end justify-center transition-transform duration-100 will-change-transform">
                        <div class="absolute -top-6 left-1/2 -translate-x-1/2 w-20 flex flex-col items-center z-50 pointer-events-none">
                            <div class="w-full h-1.5 bg-gray-800 rounded-full overflow-hidden border border-white/30 shadow-md">
                                <div id="hp-${isP?'p':'e'}-${i}" class="h-full bg-accent transition-all duration-300" style="width:${(p.currentHp/p.maxHp)*100}%"></div>
                            </div>
                        </div>
                        <img src="${p.sprite}" class="w-28 h-28 object-contain ${isP?'sprite-player':'sprite-enemy'} z-10 filter drop-shadow-xl">
                        <div class="absolute bottom-2 w-16 h-4 bg-black/30 rounded-[100%] blur-sm z-0"></div>
                    </div>
                `;

                c.innerHTML = `
                    <div class="relative h-full w-full bg-gray-900 flex flex-col overflow-hidden select-none">
                        <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=1000')] bg-cover bg-center opacity-40"></div>
                        
                        <div class="absolute top-4 left-4 z-40 flex items-center gap-2 pt-[env(safe-area-inset-top)]">
                            <div class="w-14 h-14 rounded-full border-2 border-red-500 overflow-hidden bg-black/50 shadow-xl">
                                <img src="${enAvatar}" class="w-full h-full object-cover">
                            </div>
                            <div class="flex flex-col items-start bg-black/40 p-2 rounded-lg border border-white/10 backdrop-blur-sm">
                                <span class="text-[10px] font-black italic text-red-400 mb-1 uppercase">${enName}</span>
                                <div class="w-36 h-4 bg-gray-800 rounded-full border border-gray-600 overflow-hidden relative">
                                    <div id="total-hp-e" class="h-full bg-red-500 transition-all duration-500" style="width:100%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-0 font-sport font-black text-9xl text-white/5 italic select-none">VS</div>

                        <div class="relative z-10 flex justify-end gap-1 p-6 pt-32 pr-4 perspective-[1000px]">${state.battle.enemyTeam.map((p,i)=>renderUnit(p,i,false)).join('')}</div>
                        
                        <div class="flex-1 flex items-center justify-center z-20 pointer-events-none">
                            <div id="battle-log" class="glass px-8 py-2 rounded-full text-white font-black italic text-xs tracking-widest border border-white/20 shadow-lg text-center transform scale-0 transition-transform">BATTLE START!</div>
                        </div>
                        
                        <div class="relative z-10 flex justify-start gap-1 p-6 pb-40 pl-4 perspective-[1000px]">${state.battle.myTeam.map((p,i)=>renderUnit(p,i,true)).join('')}</div>

                        <div class="absolute bottom-4 right-4 z-40 flex items-center gap-2 flex-row-reverse pb-24">
                            <div class="w-14 h-14 rounded-full border-2 border-accent overflow-hidden bg-black/50 shadow-xl">
                                <img src="${myAvatar}" class="w-full h-full object-cover">
                            </div>
                            <div class="flex flex-col items-end bg-black/40 p-2 rounded-lg border border-white/10 backdrop-blur-sm">
                                <span class="text-[10px] font-black italic text-accent mb-1 uppercase">${myName}</span>
                                <div class="w-36 h-4 bg-gray-800 rounded-full border border-gray-600 overflow-hidden relative">
                                    <div id="total-hp-p" class="h-full bg-accent transition-all duration-500" style="width:100%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            updateTotalHp: () => {
                const calcPct = (team) => {
                    const totalMax = team.reduce((sum, p) => sum + p.maxHp, 0);
                    const totalCur = team.reduce((sum, p) => sum + Math.max(0, p.currentHp), 0);
                    return (totalCur / totalMax) * 100;
                };
                $('total-hp-p').style.width = `${calcPct(state.battle.myTeam)}%`;
                $('total-hp-e').style.width = `${calcPct(state.battle.enemyTeam)}%`;
            },

            hostBattleLoop: async () => {
                while(state.battle.active) {
                    await wait(2200); 

                    const hostUnits = state.battle.myTeam.map((p, i) => ({...p, idx: i, side: 'host'})).filter(p => p.currentHp > 0);
                    const guestUnits = state.battle.enemyTeam.map((p, i) => ({...p, idx: i, side: 'guest'})).filter(p => p.currentHp > 0);

                    if (hostUnits.length === 0 || guestUnits.length === 0) {
                        const winner = hostUnits.length > 0 ? 'host' : 'guest';
                        window.fb.update(window.fb.ref(window.fb.db, `battles/${state.battle.roomId}`), {
                            lastAction: { type: 'end', winner: winner, id: Date.now() }
                        });
                        return;
                    }

                    const isHostTurn = Math.random() > 0.5;
                    const attacker = isHostTurn ? hostUnits[rnd(0, hostUnits.length-1)] : guestUnits[rnd(0, guestUnits.length-1)];
                    const target = isHostTurn ? guestUnits[rnd(0, guestUnits.length-1)] : hostUnits[rnd(0, hostUnits.length-1)];

                    let damage = rnd(25, 40);
                    if (attacker.rank === 'S') damage += 20;

                    window.fb.update(window.fb.ref(window.fb.db, `battles/${state.battle.roomId}`), {
                        lastAction: {
                            type: 'attack',
                            attackerSide: attacker.side,
                            attackerIdx: attacker.idx,
                            targetSide: target.side,
                            targetIdx: target.idx,
                            damage: damage,
                            move: attacker.move, 
                            pkmType: attacker.type, 
                            id: Date.now()
                        }
                    });
                }
            },

            createParticles: (x, y, color) => {
                for(let i=0; i<8; i++) {
                    const p = document.createElement('div');
                    p.classList.add('fx-particle');
                    p.style.backgroundColor = color;
                    p.style.left = x + 'px';
                    p.style.top = y + 'px';
                    
                    // ÎûúÎç§ Î∞©Ìñ•
                    const angle = Math.random() * 360;
                    const velocity = Math.random() * 80 + 20;
                    const vx = Math.cos(angle * Math.PI / 180) * velocity + 'px';
                    const vy = Math.sin(angle * Math.PI / 180) * velocity + 'px';
                    
                    p.style.setProperty('--vx', vx);
                    p.style.setProperty('--vy', vy);
                    
                    document.body.appendChild(p);
                    setTimeout(() => p.remove(), 600);
                }
            },

            // [ÎåÄÌè≠ ÏàòÏ†ïÎê®] Ï†ÑÌà¨ Ïï°ÏÖò Ï≤òÎ¶¨ Î°úÏßÅ (Ïï†ÎãàÎ©îÏù¥ÏÖò Í∞ïÌôî)
            playAction: async (action) => {
                if (action.type === 'end') {
                    const isWin = action.winner === state.battle.role;
                    app.endBattle(isWin);
                    return;
                }

                if (action.type === 'attack') {
                    const isMyAttack = action.attackerSide === state.battle.role;
                    const atkIdx = action.attackerIdx;
                    const defIdx = action.targetIdx;

                    const atkEl = $(`unit-${isMyAttack ? 'p' : 'e'}-${atkIdx}`);
                    const defEl = $(`unit-${!isMyAttack ? 'p' : 'e'}-${defIdx}`);
                    if(!atkEl || !defEl) return;

                    const atkName = isMyAttack ? state.battle.myTeam[atkIdx].name : state.battle.enemyTeam[atkIdx].name;
                    const moveName = action.move || 'Attack';
                    
                    const log = $('battle-log');
                    log.innerHTML = `<span class="${isMyAttack ? 'text-accent' : 'text-red-400'}">${atkName}</span> used <span class="text-white">${moveName}!</span>`;
                    log.style.transform = 'scale(1)';

                    const typeKey = action.pkmType || 'normal';
                    const fxData = TYPE_FX[typeKey] || TYPE_FX.normal;
                    
                    atkEl.style.zIndex = 100;
                    
                    // Ï¢åÌëú Í≥ÑÏÇ∞
                    const rectAtk = atkEl.getBoundingClientRect();
                    const rectDef = defEl.getBoundingClientRect();
                    
                    // 1. Í≥µÍ≤© Ïï†ÎãàÎ©îÏù¥ÏÖò (Í∑ºÏ†ë)
                    const deltaX = (rectDef.left + rectDef.width/2) - (rectAtk.left + rectAtk.width/2);
                    const deltaY = (rectDef.top + rectDef.height/2) - (rectAtk.top + rectAtk.height/2);

                    // Í∑ºÏ†ë Í≥µÍ≤©Ïù∏ Í≤ΩÏö∞ ÎèåÏßÑ
                    atkEl.style.setProperty('--tx', `${deltaX * 0.8}px`); // ÏôÑÏ†ÑÌûà Í≤πÏπòÏßÄ ÏïäÍ≥† ÏïΩÍ∞Ñ ÏïûÏóêÏÑú ÌÉÄÍ≤©
                    atkEl.style.setProperty('--ty', `${deltaY * 0.8}px`);
                    atkEl.classList.add('anim-dash');
                    
                    // 2. ÌÉÄÍ≤© ÏãúÏ†ê (Ïï†ÎãàÎ©îÏù¥ÏÖò Ï§ëÍ∞Ñ ÏØ§)
                    await wait(250); 
                    
                    // ÌÉÄÍ≤© Ïù¥ÌéôÌä∏ (ÌååÌã∞ÌÅ¥)
                    const hitX = rectDef.left + rectDef.width/2;
                    const hitY = rectDef.top + rectDef.height/2;
                    app.createParticles(hitX, hitY, fxData.particleColor);

                    // ÌÉÄÍ≤© Ïãú ÌïòÏñÄ ÏÑ¨Í¥ë
                    const flash = document.createElement('div');
                    flash.className = 'fixed inset-0 bg-white z-[60] opacity-50 pointer-events-none mix-blend-overlay';
                    document.body.appendChild(flash);
                    setTimeout(()=>flash.remove(), 100);

                    // Ï†Å ÌîºÍ≤© Î™®ÏÖò + ÌôîÎ©¥ ÌùîÎì§Î¶º
                    defEl.classList.add('anim-hit');
                    $('camera-shake-layer').classList.add('anim-cam-shake');
                    
                    let targetUnit = !isMyAttack ? state.battle.myTeam[defIdx] : state.battle.enemyTeam[defIdx];
                    targetUnit.currentHp = Math.max(0, targetUnit.currentHp - action.damage);
                    
                    const hpBar = $(`hp-${!isMyAttack ? 'p' : 'e'}-${defIdx}`);
                    hpBar.style.width = `${(targetUnit.currentHp / targetUnit.maxHp) * 100}%`;
                    if((targetUnit.currentHp / targetUnit.maxHp) < 0.3) hpBar.style.backgroundColor = '#ef4444';

                    app.updateTotalHp();

                    await wait(300);
                    atkEl.classList.remove('anim-dash');
                    defEl.classList.remove('anim-hit');
                    $('camera-shake-layer').classList.remove('anim-cam-shake');
                    log.style.transform = 'scale(0)';
                    atkEl.style.zIndex = '';

                    if(targetUnit.currentHp <= 0) {
                        defEl.querySelector('img').classList.add('sprite-dead');
                        hpBar.parentElement.style.opacity = 0;
                    }
                }
            },

            endBattle: (win) => {
                state.battle.active = false;
                app.updateCoins(win ? 500 : 50);
                const overlay = document.createElement('div');
                overlay.className = "absolute inset-0 z-50 bg-black/95 flex flex-col items-center justify-center anim-pop";
                overlay.innerHTML = `
                    <div class="relative mb-6">
                        <div class="absolute inset-0 ${win ? 'bg-accent' : 'bg-red-500'} blur-[80px] opacity-30 rounded-full animate-pulse"></div>
                        <h1 class="text-7xl font-sport font-black italic relative z-10 ${win?'text-accent':'text-gray-500'} tracking-tighter">${win?'VICTORY':'DEFEAT'}</h1>
                    </div>
                    <div class="glass px-8 py-3 rounded-full mb-8 border-l-4 ${win?'border-accent':'border-red-500'}"><span class="text-white font-bold text-xl">+${win?500:50} Coins</span></div>
                    <button onclick="app.nav('lobby'); this.parentElement.remove()" class="bg-white text-black px-12 py-4 rounded-full font-black italic hover:scale-105 transition-transform shadow-xl">RETURN HOME</button>
                `;
                $('app').appendChild(overlay);
            }
        };

        window.app = app;
        app.init();
    </script>
</body>
</html>