<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ì¹´ì¹´ì˜¤ ë„ë³´ ê¸¸ì°¾ê¸°</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Malgun Gothic', dotum, 'ë‹ì›€', sans-serif;
        }
        #map {
            width: 100%;
            height: 70%;
        }
        .info-panel {
            padding: 15px;
            box-sizing: border-box;
            height: 30%;
            width: 100%;
            background-color: #f9f9f9;
            border-top: 1px solid #ccc;
        }
        .search-box {
            margin-bottom: 15px;
        }
        #destination {
            width: 250px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #searchBtn {
            padding: 8px 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #searchBtn:hover {
            background-color: #45a049;
        }
        #result {
            font-size: 1.1em;
            color: #333;
        }
        #result p {
            margin: 8px 0;
        }
        b {
            color: #E61A5F;
        }
    </style>
</head>
<body>

<div class="info-panel">
    <h2>ğŸš¶ ë„ë³´ ê¸¸ì°¾ê¸°</h2>
    <div class="search-box">
        <input type="text" id="destination" placeholder="ëª©ì ì§€ ì…ë ¥ (ì˜ˆ: ë¶€ì²œì—­, ì‹œí¥ëŒ€ë¡œ96ê¸¸ 15)">
        <button id="searchBtn">ê¸¸ì°¾ê¸°</button>
    </div>
    <div id="result">
        <p>ëª©ì ì§€ë¥¼ ê²€ìƒ‰í•˜ì‹œë©´ ì˜ˆìƒ ê±°ë¦¬ì™€ ì†Œëª¨ ì¹¼ë¡œë¦¬ë¥¼ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.</p>
    </div>
</div>
<div id="map"></div>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=71b46fcb7202af130ab7c6c18bf5163a&libraries=services"></script>
<script>
    // ===================================================================
    // âš ï¸ ê²½ê³ : ì•„ë˜ í‚¤ëŠ” JavaScript í‚¤ì…ë‹ˆë‹¤. ê¸¸ì°¾ê¸° ê¸°ëŠ¥ì€ ì´ í‚¤ë¡œ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    // ê¸¸ì°¾ê¸°ë¥¼ ìœ„í•´ì„œëŠ” [ì¹´ì¹´ì˜¤ ê°œë°œì] ì‚¬ì´íŠ¸ì—ì„œ í™•ì¸í•œ ì§„ì§œ 'REST API í‚¤'ë¡œ ë°˜ë“œì‹œ êµì²´í•´ì•¼ í•©ë‹ˆë‹¤!
    const REST_API_KEY = '71b46fcb7202af130ab7c6c18bf5163a'; 
    // ===================================================================
    
    // ì¹¼ë¡œë¦¬ ê³„ì‚° ìƒìˆ˜ (ì„±ì¸ í‰ê· , 1kmë‹¹ ì•½ 50kcal ì†Œëª¨ ê¸°ì¤€)
    const KCAL_PER_KM = 50;

    const mapContainer = document.getElementById('map');
    const searchBtn = document.getElementById('searchBtn');
    const destinationInput = document.getElementById('destination');
    const resultDiv = document.getElementById('result');

    let map;
    let currentPolyline = null;
    let startMarker = null;
    let endMarker = null;
    let myPosition;

    // 1. ì§€ë„ ì´ˆê¸°í™” ë° í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
    function initMap() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                myPosition = new kakao.maps.LatLng(lat, lon);
                
                const mapOption = { 
                    center: myPosition, 
                    level: 4 
                };
                map = new kakao.maps.Map(mapContainer, mapOption);
                startMarker = new kakao.maps.Marker({ position: myPosition, title: 'í˜„ì¬ ìœ„ì¹˜' });
                startMarker.setMap(map);

            }, function() {
                alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ìœ„ì¹˜ì—ì„œ ì‹œì‘í•©ë‹ˆë‹¤.');
                setDefaultMap();
            });
        } else {
            alert('ì´ ë¸Œë¼ìš°ì €ëŠ” Geolocationì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê¸°ë³¸ ìœ„ì¹˜ì—ì„œ ì‹œì‘í•©ë‹ˆë‹¤.');
            setDefaultMap();
        }
    }
    
    // ìœ„ì¹˜ ì •ë³´ ì‚¬ìš© ë¶ˆê°€ ì‹œ ê¸°ë³¸ ì§€ë„ ì„¤ì •
    function setDefaultMap() {
        myPosition = new kakao.maps.LatLng(37.5035, 126.766); // ë¶€ì²œì‹œì²­
        const mapOption = { center: myPosition, level: 4 };
        map = new kakao.maps.Map(mapContainer, mapOption);
    }

    // 2. ì¥ì†Œ ê²€ìƒ‰ ë° ê¸¸ì°¾ê¸° ì‹¤í–‰ í•¨ìˆ˜
    function searchAndNavigate() {
        const destination = destinationInput.value;
        if (!destination.trim()) {
            alert('ëª©ì ì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            return;
        }
        
        const ps = new kakao.maps.services.Places();
        ps.keywordSearch(destination, function(data, status) {
            if (status === kakao.maps.services.Status.OK) {
                const destCoords = new kakao.maps.LatLng(data[0].y, data[0].x);
                getWalkingRoute(myPosition, destCoords);
            } else {
                alert('ì¥ì†Œ ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + status);
            }
        });
    }
    
    // 3. REST APIë¥¼ ì´ìš©í•´ ë„ë³´ ê¸¸ì°¾ê¸° ë°ì´í„° ìš”ì²­
    async function getWalkingRoute(start, end) {
        const url = `https://apis-navi.kakaomobility.com/v1/directions?origin=${start.getLng()},${start.getLat()}&destination=${end.getLng()},${end.getLat()}&waypoints=&priority=RECOMMEND&car_type=1&car_fuel=GASOLINE&alternatives=false&road_details=false`;

        try {
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `KakaoAK ${REST_API_KEY}`
                }
            });

            if (!response.ok) {
                // ì¸ì¦ ì‹¤íŒ¨(401) ì‹œ ë” êµ¬ì²´ì ì¸ ì•ˆë‚´ ì œê³µ
                if (response.status === 401) {
                    throw new Error('ì¸ì¦ ì‹¤íŒ¨(401): REST API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ì½”ë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
                throw new Error(`HTTP ì—ëŸ¬! Status: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.routes && data.routes.length > 0) {
                const route = data.routes[0];
                const linePath = [];
                
                route.sections.forEach(section => {
                    section.roads.forEach(road => {
                        for (let i = 0; i < road.vertexes.length; i += 2) {
                            linePath.push(new kakao.maps.LatLng(road.vertexes[i+1], road.vertexes[i]));
                        }
                    });
                });

                drawPolyline(linePath);
                
                const distanceKm = (route.summary.distance / 1000).toFixed(2);
                const calories = Math.round(distanceKm * KCAL_PER_KM);
                
                resultDiv.innerHTML = `
                    <p>ğŸ“ ì´ ê±°ë¦¬: <b>${distanceKm} km</b></p>
                    <p>ğŸ”¥ ì˜ˆìƒ ì†Œëª¨ ì¹¼ë¡œë¦¬: <b>${calories} kcal</b></p>
                    <p>â³ ì˜ˆìƒ ì†Œìš” ì‹œê°„: <b>${Math.round(route.summary.duration / 60)} ë¶„</b></p>
                `;
                
                if (endMarker) endMarker.setMap(null);
                endMarker = new kakao.maps.Marker({ position: end, title: 'ë„ì°©ì§€' });
                endMarker.setMap(map);

                const bounds = new kakao.maps.LatLngBounds();
                linePath.forEach(point => bounds.extend(point));
                map.setBounds(bounds);
                
            } else {
                 alert('ë„ë³´ ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

        } catch (error) {
            console.error("ê¸¸ì°¾ê¸° API ìš”ì²­ ì‹¤íŒ¨:", error);
            alert("ê¸¸ì°¾ê¸° ì„œë¹„ìŠ¤ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. " + error.message);
        }
    }
    
    // 4. ì§€ë„ì— ê²½ë¡œ(Polyline)ë¥¼ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
    function drawPolyline(linePath) {
        if (currentPolyline) {
            currentPolyline.setMap(null);
        }
        currentPolyline = new kakao.maps.Polyline({
            path: linePath,
            strokeWeight: 5,
            strokeColor: '#00FF00',
            strokeOpacity: 0.8,
            strokeStyle: 'solid'
        });
        currentPolyline.setMap(map);
    }
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    searchBtn.addEventListener('click', searchAndNavigate);
    destinationInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            searchAndNavigate();
        }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì§€ë„ ì´ˆê¸°í™”
    initMap();

</script>

</body>
</html>