<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>포켓몬 테스트 - 내 위치 50m</title>
<style>
  html,body,#map { height:100%; margin:0; font-family:system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif; }
  #map { position:relative; }
  .pokemon-marker { display:flex; align-items:center; justify-content:center; width:48px; height:48px; border-radius:50%; overflow:hidden; box-shadow:0 4px 10px rgba(0,0,0,0.25); cursor:pointer; background:white; }
  .pokemon-marker img{ width:44px; height:44px; image-rendering:pixelated }
</style>
</head>
<body>
<div id="map"></div>

<!-- Kakao Maps SDK -->
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c96c999113980d67c697b2f5a3d385f1"></script>
<script>
const CAPTURE_RADIUS_METERS = 50; // 테스트용 50m
let map, userPos, marker, pokemon;

function initMap(){
  map = new kakao.maps.Map(document.getElementById('map'), { center: new kakao.maps.LatLng(36.5,127.8), level:5 });

  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(async pos=>{
      userPos = {lat: pos.coords.latitude, lng: pos.coords.longitude};
      map.setCenter(new kakao.maps.LatLng(userPos.lat,userPos.lng));

      // 사용자 위치 마커
      new kakao.maps.Marker({
        position: new kakao.maps.LatLng(userPos.lat,userPos.lng),
        map
      });

      // 내 위치 근처 50m 이내에 포켓몬 하나 배치
      await placePokemonNearUser();
    });
  }
}

async function placePokemonNearUser(){
  // 포켓몬 ID 1 (이상해씨)
  const res = await fetch("https://pokeapi.co/api/v2/pokemon/1");
  const data = await res.json();

  const angle = Math.random()*2*Math.PI;
  const distance = 0.00045; // 약 50m 정도 (위도경도 변환 단순 계산)
  const lat = userPos.lat + distance*Math.cos(angle);
  const lng = userPos.lng + distance*Math.sin(angle);

  const el = document.createElement('div');
  el.className = 'pokemon-marker';
  const img = document.createElement('img');
  img.src = data.sprites.front_default;
  el.appendChild(img);

  marker = new kakao.maps.CustomOverlay({
    position: new kakao.maps.LatLng(lat,lng),
    content: el,
    yAnchor: 1
  });
  marker.setMap(map);

  el.addEventListener('click', ()=>{
    attemptCapture(lat,lng,data);
  });
}

function haversineDistance(lat1, lng1, lat2, lng2){
  function toRad(d){return d*Math.PI/180}
  const R = 6371000;
  const dLat = toRad(lat2-lat1), dLon = toRad(lng2-lng1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function attemptCapture(lat,lng,data){
  if(!userPos){ alert('위치 정보를 불러오지 못했습니다.'); return; }
  const d = haversineDistance(userPos.lat,userPos.lng,lat,lng);
  if(d<=CAPTURE_RADIUS_METERS){
    alert(`${data.name} 포획 성공!`);
  } else {
    alert(`너무 멀어요. 현재 거리: ${Math.round(d)}m`);
  }
}

initMap();
</script>
</body>
</html>
