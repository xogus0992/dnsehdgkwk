<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>카카오 도보 길찾기</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Malgun Gothic', dotum, '돋움', sans-serif;
        }
        #map {
            width: 100%;
            height: 70%;
        }
        .info-panel {
            padding: 15px;
            box-sizing: border-box;
            height: 30%;
            width: 100%;
            background-color: #f9f9f9;
            border-top: 1px solid #ccc;
        }
        .search-box {
            margin-bottom: 15px;
        }
        #destination {
            width: 250px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #searchBtn {
            padding: 8px 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #searchBtn:hover {
            background-color: #45a049;
        }
        #result {
            font-size: 1.1em;
            color: #333;
        }
        #result p {
            margin: 8px 0;
        }
        b {
            color: #E61A5F;
        }
    </style>
</head>
<body>

<div class="info-panel">
    <h2>🚶 도보 길찾기</h2>
    <div class="search-box">
        <input type="text" id="destination" placeholder="목적지 입력 (예: 부천역, 시흥대로96길 15)">
        <button id="searchBtn">길찾기</button>
    </div>
    <div id="result">
        <p>목적지를 검색하시면 예상 거리와 소모 칼로리를 알려드립니다.</p>
    </div>
</div>
<div id="map"></div>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=71b46fcb7202af130ab7c6c18bf5163a&libraries=services"></script>
<script>
    // ===================================================================
    // ⚠️ 경고: 아래 키는 JavaScript 키입니다. 길찾기 기능은 이 키로 작동하지 않습니다.
    // 길찾기를 위해서는 [카카오 개발자] 사이트에서 확인한 진짜 'REST API 키'로 반드시 교체해야 합니다!
    const REST_API_KEY = '71b46fcb7202af130ab7c6c18bf5163a'; 
    // ===================================================================
    
    // 칼로리 계산 상수 (성인 평균, 1km당 약 50kcal 소모 기준)
    const KCAL_PER_KM = 50;

    const mapContainer = document.getElementById('map');
    const searchBtn = document.getElementById('searchBtn');
    const destinationInput = document.getElementById('destination');
    const resultDiv = document.getElementById('result');

    let map;
    let currentPolyline = null;
    let startMarker = null;
    let endMarker = null;
    let myPosition;

    // 1. 지도 초기화 및 현재 위치 가져오기
    function initMap() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                myPosition = new kakao.maps.LatLng(lat, lon);
                
                const mapOption = { 
                    center: myPosition, 
                    level: 4 
                };
                map = new kakao.maps.Map(mapContainer, mapOption);
                startMarker = new kakao.maps.Marker({ position: myPosition, title: '현재 위치' });
                startMarker.setMap(map);

            }, function() {
                alert('위치 정보를 가져올 수 없습니다. 기본 위치에서 시작합니다.');
                setDefaultMap();
            });
        } else {
            alert('이 브라우저는 Geolocation을 지원하지 않습니다. 기본 위치에서 시작합니다.');
            setDefaultMap();
        }
    }
    
    // 위치 정보 사용 불가 시 기본 지도 설정
    function setDefaultMap() {
        myPosition = new kakao.maps.LatLng(37.5035, 126.766); // 부천시청
        const mapOption = { center: myPosition, level: 4 };
        map = new kakao.maps.Map(mapContainer, mapOption);
    }

    // 2. 장소 검색 및 길찾기 실행 함수
    function searchAndNavigate() {
        const destination = destinationInput.value;
        if (!destination.trim()) {
            alert('목적지를 입력해주세요!');
            return;
        }
        
        const ps = new kakao.maps.services.Places();
        ps.keywordSearch(destination, function(data, status) {
            if (status === kakao.maps.services.Status.OK) {
                const destCoords = new kakao.maps.LatLng(data[0].y, data[0].x);
                getWalkingRoute(myPosition, destCoords);
            } else {
                alert('장소 검색에 실패했습니다: ' + status);
            }
        });
    }
    
    // 3. REST API를 이용해 도보 길찾기 데이터 요청
    async function getWalkingRoute(start, end) {
        const url = `https://apis-navi.kakaomobility.com/v1/directions?origin=${start.getLng()},${start.getLat()}&destination=${end.getLng()},${end.getLat()}&waypoints=&priority=RECOMMEND&car_type=1&car_fuel=GASOLINE&alternatives=false&road_details=false`;

        try {
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `KakaoAK ${REST_API_KEY}`
                }
            });

            if (!response.ok) {
                // 인증 실패(401) 시 더 구체적인 안내 제공
                if (response.status === 401) {
                    throw new Error('인증 실패(401): REST API 키가 올바르지 않습니다. 코드를 확인해주세요.');
                }
                throw new Error(`HTTP 에러! Status: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.routes && data.routes.length > 0) {
                const route = data.routes[0];
                const linePath = [];
                
                route.sections.forEach(section => {
                    section.roads.forEach(road => {
                        for (let i = 0; i < road.vertexes.length; i += 2) {
                            linePath.push(new kakao.maps.LatLng(road.vertexes[i+1], road.vertexes[i]));
                        }
                    });
                });

                drawPolyline(linePath);
                
                const distanceKm = (route.summary.distance / 1000).toFixed(2);
                const calories = Math.round(distanceKm * KCAL_PER_KM);
                
                resultDiv.innerHTML = `
                    <p>📍 총 거리: <b>${distanceKm} km</b></p>
                    <p>🔥 예상 소모 칼로리: <b>${calories} kcal</b></p>
                    <p>⏳ 예상 소요 시간: <b>${Math.round(route.summary.duration / 60)} 분</b></p>
                `;
                
                if (endMarker) endMarker.setMap(null);
                endMarker = new kakao.maps.Marker({ position: end, title: '도착지' });
                endMarker.setMap(map);

                const bounds = new kakao.maps.LatLngBounds();
                linePath.forEach(point => bounds.extend(point));
                map.setBounds(bounds);
                
            } else {
                 alert('도보 경로를 찾을 수 없습니다.');
            }

        } catch (error) {
            console.error("길찾기 API 요청 실패:", error);
            alert("길찾기 서비스에 오류가 발생했습니다. " + error.message);
        }
    }
    
    // 4. 지도에 경로(Polyline)를 그리는 함수
    function drawPolyline(linePath) {
        if (currentPolyline) {
            currentPolyline.setMap(null);
        }
        currentPolyline = new kakao.maps.Polyline({
            path: linePath,
            strokeWeight: 5,
            strokeColor: '#00FF00',
            strokeOpacity: 0.8,
            strokeStyle: 'solid'
        });
        currentPolyline.setMap(map);
    }
    
    // 이벤트 리스너 등록
    searchBtn.addEventListener('click', searchAndNavigate);
    destinationInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            searchAndNavigate();
        }
    });

    // 페이지 로드 시 지도 초기화
    initMap();

</script>

</body>
</html>