<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>다이어트 워킹 내비게이션 v3</title>
    <style>
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0;
            font-family: 'Malgun Gothic', dotum, '돋움', sans-serif; background-color: #f0f0f0;
        }
        .container { width: 100%; height: 100%; display: flex; flex-direction: column; }
        #map { width: 100%; flex-grow: 1; min-height: 400px; }
        .info-panel {
            width: 100%; padding: 20px; background-color: white;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1); box-sizing: border-box; z-index: 10;
            overflow-y: auto; max-height: 40%;
        }
        h2 { margin: 0 0 15px 0; font-size: 1.5em; color: #333; text-align: center; }
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .input-wrapper { flex-grow: 1; position: relative; }
        .input-wrapper::before {
            position: absolute; top: 50%; left: 12px; transform: translateY(-50%);
            font-weight: bold; color: #4CAF50;
        }
        .input-wrapper.start::before { content: '출발'; }
        .input-wrapper.end::before { content: '도착'; }
        
        input[type="text"] {
            width: 100%; padding: 12px 12px 12px 55px; border: 1px solid #ccc;
            border-radius: 5px; font-size: 1em; box-sizing: border-box;
        }
        
        #searchBtn {
            padding: 12px 25px; background-color: #4CAF50; color: white; border: none;
            border-radius: 5px; font-size: 1em; font-weight: bold; cursor: pointer;
            transition: background-color 0.2s;
        }
        #searchBtn:hover { background-color: #45a049; }

        #result-area {
            display: flex; gap: 10px; justify-content: center;
            flex-wrap: wrap; text-align: left;
        }
        .route-card {
            border: 2px solid #ddd; border-radius: 8px; padding: 15px;
            min-width: 250px; background-color: #f9f9f9;
        }
        .route-card h3 { margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #eee; }
        .route-card p { margin: 5px 0; font-size: 1em; }
        .route-card b { font-size: 1.1em; }

        /* 경로별 색상 스타일 */
        .color-box { display: inline-block; width: 12px; height: 12px; margin-right: 5px; border-radius: 3px;}
        .color-green { background-color: #00FF00; }
        .color-yellow { background-color: #FFFF00; }
        .color-orange { background-color: #FFA500; }
        .color-blue { background-color: #0000FF; }
        
    </style>
</head>
<body>

<div class="container">
    <div id="map"></div>
    <div class="info-panel">
        <h2>🏃‍♀️ 원형 코스 추천</h2>
        <div class="input-group">
            <div class="input-wrapper start">
                <input type="text" id="start" placeholder="예: 부천시청">
            </div>
            <div class="input-wrapper end">
                <input type="text" id="end" placeholder="예: 부천역">
            </div>
            <button id="searchBtn">코스 추천받기</button>
        </div>
        <div id="result-area">
            <p>출발지와 도착지를 입력하고 코스를 추천받으세요.</p>
        </div>
    </div>
</div>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c96c999113980d67c697b2f5a3d385f1&libraries=services"></script>
<script>
    const REST_API_KEY = '71b46fcb7202af130ab7c6c18bf5163a';
    const KCAL_PER_KM = 60; // 1km당 소모 칼로리

    const mapContainer = document.getElementById('map');
    const startInput = document.getElementById('start');
    const endInput = document.getElementById('end');
    const searchBtn = document.getElementById('searchBtn');
    const resultArea = document.getElementById('result-area');

    const map = new kakao.maps.Map(mapContainer, {
        center: new kakao.maps.LatLng(37.5034, 126.7661),
        level: 5
    });

    const ROUTE_COLORS = ["#FFFF00", "#FFA500", "#0000FF"]; // 노랑, 주황, 파랑

    let polylines = [];
    let markers = [];
    
    // 장소 검색
    function searchPlace(query) {
        return new Promise((resolve, reject) => {
            if (!query.trim()) return reject(new Error("검색어가 비어있습니다."));
            new kakao.maps.services.Places().keywordSearch(query, (data, status) => {
                if (status === kakao.maps.services.Status.OK) {
                    resolve(new kakao.maps.LatLng(data[0].y, data[0].x));
                } else {
                    reject(new Error(`'${query}' 검색 실패`));
                }
            });
        });
    }

    // 길찾기 API (대안 경로 포함)
    async function getRouteAlternatives(origin, destination) {
        const url = `https://apis-navi.kakaomobility.com/v1/directions?origin=${origin.getLng()},${origin.getLat()}&destination=${destination.getLng()},${destination.getLat()}&priority=RECOMMEND&alternatives=true`;
        try {
            const response = await fetch(url, {
                method: 'GET',
                headers: { 'Authorization': `KakaoAK ${REST_API_KEY}` }
            });
            if (!response.ok) throw new Error(`HTTP 에러: ${response.status}`);
            const data = await response.json();
            return data.routes || [];
        } catch (error) {
            console.error("길찾기 API 오류:", error);
            alert("길찾기 서비스에 오류가 발생했습니다.");
            return [];
        }
    }
    
    function clearMap() {
        polylines.forEach(p => p.setMap(null));
        polylines = [];
        markers.forEach(m => m.setMap(null));
        markers = [];
    }

    function drawRoute(route, color) {
        const linePath = [];
        route.sections.forEach(s => s.roads.forEach(r => {
            for (let i = 0; i < r.vertexes.length; i += 2) {
                linePath.push(new kakao.maps.LatLng(r.vertexes[i+1], r.vertexes[i]));
            }
        }));
        const polyline = new kakao.maps.Polyline({
            path: linePath, strokeWeight: 7, strokeColor: color,
            strokeOpacity: 0.8, strokeStyle: 'solid'
        });
        polyline.setMap(map);
        polylines.push(polyline);
        return linePath;
    }

    function createResultCard(title, onewayRoute, returnRoute, colorClass) {
        const onewayDist = onewayRoute.summary.distance / 1000;
        const returnDist = returnRoute.summary.distance / 1000;
        const totalDist = onewayDist + returnDist;
        const totalDuration = Math.round((onewayRoute.summary.duration + returnRoute.summary.duration) / 60);
        const totalCalories = Math.round(totalDist * KCAL_PER_KM);

        return `
            <div class="route-card">
                <h3><span class="color-box ${colorClass}"></span>${title}</h3>
                <p>총 거리: <b>${totalDist.toFixed(2)} km</b></p>
                <p>예상 시간: <b>${totalDuration} 분</b></p>
                <p>소모 칼로리: <b>${totalCalories} kcal</b></p>
            </div>
        `;
    }

    async function searchAndNavigate() {
        if (!startInput.value || !endInput.value) {
            alert('출발지와 도착지를 모두 입력해주세요!');
            return;
        }
        
        clearMap();
        resultArea.innerHTML = '<p>최적의 원형 코스를 찾고 있습니다...</p>';

        try {
            const [startCoords, endCoords] = await Promise.all([
                searchPlace(startInput.value), searchPlace(endInput.value)
            ]);

            const [onewayRoutes, returnRoutes] = await Promise.all([
                getRouteAlternatives(startCoords, endCoords),
                getRouteAlternatives(endCoords, startCoords)
            ]);

            if (onewayRoutes.length === 0 || returnRoutes.length === 0) {
                resultArea.innerHTML = '<p>경로를 찾을 수 없습니다. 장소를 다시 확인해주세요.</p>';
                return;
            }

            const onewayRoute = onewayRoutes[0]; // 가는 길은 첫번째 경로로 고정
            const bounds = new kakao.maps.LatLngBounds();
            
            // 1. 가는 길 그리기 (초록색)
            const onewayPath = drawRoute(onewayRoute, '#00FF00');
            onewayPath.forEach(p => bounds.extend(p));

            let resultHTML = "";

            // 2. 오는 길들 그리기 (최대 3개: 기본1 + 추천2)
            for (let i = 0; i < returnRoutes.length && i < 3; i++) {
                const returnRoute = returnRoutes[i];
                const color = ROUTE_COLORS[i];
                const path = drawRoute(returnRoute, color);
                path.forEach(p => bounds.extend(p));

                let title = i === 0 ? "기본 왕복 코스" : `추천 원형 코스 ${i}`;
                let colorClass = i === 0 ? "color-yellow" : i === 1 ? "color-orange" : "color-blue";
                resultHTML += createResultCard(title, onewayRoute, returnRoute, colorClass);
            }

            resultArea.innerHTML = resultHTML;

            // 마커 및 지도 범위 설정
            const startMarker = new kakao.maps.Marker({ position: startCoords, title: '출발지' });
            const endMarker = new kakao.maps.Marker({ position: endCoords, title: '도착지' });
            startMarker.setMap(map);
            endMarker.setMap(map);
            markers.push(startMarker, endMarker);
            map.setBounds(bounds);

        } catch (error) {
            alert(error.message);
            resultArea.innerHTML = '<p>오류가 발생했습니다. 잠시 후 다시 시도해주세요.</p>';
        }
    }

    searchBtn.addEventListener('click', searchAndNavigate);
    [startInput, endInput].forEach(input => {
        input.addEventListener('keydown', (e) => e.key === 'Enter' && searchBtn.click());
    });

</script>

</body>
</html>